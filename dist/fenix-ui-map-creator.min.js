define(["jquery","loglevel","underscore","leaflet","hashmap","bootstrap","fenix-ui-pivotator","fenix-ui-pivotator-utils","amplify-pubsub"],function(__WEBPACK_EXTERNAL_MODULE_3__,__WEBPACK_EXTERNAL_MODULE_4__,__WEBPACK_EXTERNAL_MODULE_7__,__WEBPACK_EXTERNAL_MODULE_9__,__WEBPACK_EXTERNAL_MODULE_10__,__WEBPACK_EXTERNAL_MODULE_11__,__WEBPACK_EXTERNAL_MODULE_12__,__WEBPACK_EXTERNAL_MODULE_13__,__WEBPACK_EXTERNAL_MODULE_14__){return function(e){function t(a){if(i[a])return i[a].exports;var n=i[a]={exports:{},id:a,loaded:!1};return e[a].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){e.exports=i(1)},function(e,t,i){var a,n;a=[i(3),i(7),i(4),i(5),i(6),i(2),i(8),i(12),i(13),i(14)],n=function(e,t,i,a,n,o,r,l,s,d){"use strict";function c(e){i.info("FENIX MapCreator"),i.info(e),t.extend(this,o,{initial:e}),this._parseInput(e),this.fenix_ui_mapConfig=e.fenix_ui_map;var a=this._validateInput();return a===!0?(this._initVariables(),this._bindEventListeners(),this._renderMap(),this):(i.error("Impossible to create MapCreator"),void i.error(a))}return c.prototype.on=function(e,t,i){var a=i||this;return this.channels[e]||(this.channels[e]=[]),this.channels[e].push({context:a,callback:t}),this},c.prototype.addBaseLayer=function(e){return this.fenixMap.addTileLayer(e,!0),this},c.prototype.addLayer=function(e){var t;return!!e&&(e instanceof L.TileLayer?this.fenixMap.map.addLayer(e):(!this.errors||e&&e.hasOwnProperty("metadata")||(this.errors.metadata="Model does not contain 'metadata' attribute."),t="string"==typeof e?this.createLayerFenixUid(e):e.hasOwnProperty("data")?this.createLayerFenixJoin(e):this.createLayerFenix(e),t=new r.layer(t),"object"==typeof e&&e.metadata&&e.metadata.title&&e.metadata.title.EN&&(t.layer.layertitle=e.metadata.title.EN),this.initial.legendtitle&&(t.layer.layertitle=this.initial.legendtitle),this.fenixMap.addLayer(t),t))},c.prototype.removeLayer=function(e){if(this.status.ready===!0)return this},c.prototype.invalidateSize=function(){if(this.status.ready===!0)return this.fenixMap.invalidateSize(),this},c.prototype._parseInput=function(){this.id=this.initial.id,this.$el=e(this.initial.el),this.model=this.initial.model;var t={};t.aggregationFn=this.initial.aggregationFn,t.aggregations=this.initial.aggregations||[],t.hidden=this.initial.hidden||[],t.columns=this.initial.x,t.values=this.initial.y||["value"],t.rows=this.initial.series,t.formatter=this.initial.formatter||"value",t.valueOutputType=this.initial.valueOutputType,t.showRowHeaders=this.initial.showRowHeaders||!1,t.decimals=this.initial.decimals||2,t.showCode=this.initial.showCode||!1,t.showFlag=this.initial.showFlag||!1,t.showUnit=this.initial.showUnit||!1,this.pivotatorConfig=t},c.prototype._validateInput=function(){var e=!0,t=[];return this.id||(window.fx_map_id>=0?window.fx_map_id++:window.fx_map_id=0,this.id=String(window.fx_map_id),i.warn("Impossible to find MapCreator id. Set auto id to: "+this.id)),0===this.$el.length&&(t.push({code:a.MISSING_CONTAINER}),i.warn("Impossible to find box container")),t.length>0?t:e},c.prototype._initVariables=function(){this.channels={},this.status={},this.status.ready=!1,this.pivotator=new l,this.fenixTool=new s},c.prototype._bindEventListeners=function(){d.subscribe(this._getEventName(n.WINDOW_RESIZE),this,this.invalidateSize)},c.prototype._renderMap=function(){var e=this;e.fenixMap=new r.Map(e.$el,e.fenix_ui_mapConfig),e.fenixMap.createMap(),e.leafletMap=e.fenixMap.map,e.model?e.addLayer(e.model):this.initial.uid&&e.addLayer(this.initial.uid),e.status.ready=!0,setTimeout(t.bind(function(){e._trigger("ready")},e),0)},c.prototype._trigger=function(e){if(!this.channels[e])return!1;for(var t=Array.prototype.slice.call(arguments,1),i=0,a=this.channels[e].length;i<a;i++){var n=this.channels[e][i];n.callback.apply(n.context,t)}return this},c.prototype._getEventName=function(e){return this.id.concat(e)},c.prototype._unbindEventListeners=function(){d.unsubscribe(this._getEventName(n.WINDOW_RESIZE),this.invalidateSize)},c.prototype.dispose=function(){this._unbindEventListeners(),this.status.ready===!0&&this.fenixMap.destroyMap(),this.$el.empty()},c.prototype.createLayerFenix=function(e,t){var i=e.metadata,a={};if(!i.hasOwnProperty("dsd"))throw this.errors.dsd="Model['metadata'] does not contain 'dsd' attribute.",new Error("FENIX Map creator has not a valid configuration");return a.layers="",i.dsd.hasOwnProperty("workspace")&&(a.layers+=i.dsd.workspace+":"),a.layers+=i.dsd.layerName,a.urlWMS=this.fenix_ui_map.DEFAULT_WMS_SERVER,a.layertitle={en:"Data Layer"},a.opacity="0.9",a},c.prototype.createLayerFenixUid=function(e){var t={urlWMS:this.DEFAULT_WMS_SERVER,layertitle:{en:"Data Layer"},opacity:"0.9",layers:e};return t},c.prototype.createLayerFenixJoin=function(e){if(this._validateJoinInput(e)===!0){var i=this.getJoinLayer(e);t.extend(i,this.join.style);var a="<div class='fm-popup'>{{"+i.joincolumnlabel+"}}<div class='fm-popup-join-content'>{{{"+i.joincolumn+"}}} {{measurementunit}}</div></div>";e.metadata.hasOwnProperty("title")?e.metadata.title[this.lang]&&(i.layertitle=e.metadata.title[this.lang]):i.layertitle=e.metadata.uid,this.hasOwnProperty("layer")&&this.layer.hasOwnProperty("layertitle")&&(i.layertitle=this.layer.layertitle),this.hasOwnProperty("layer")&&this.layer.hasOwnProperty("popupBuilder")&&(i.popupBuilder=this.layer.popupBuilder),i.customgfi={showpopup:!0,content:{EN:t.isFunction(i.popupBuilder)?i.popupBuilder(i.joincolumnlabel,i.joincolumn):a}};var n=[];i.joindata.forEach(function(e){t.keys(e).forEach(function(e){t.isNumber(parseInt(e))&&n.push(e)})});var o=i.layers.split(":");return o=o.length>1?o[1]:o[0],this.fenixMap.zoomTo(o,i.joincolumn,n),this.initial.colorRamp&&(i.colorramp=this.initial.colorRamp),i}},c.prototype.getJoinLayer=function(e){var i=e.metadata,a={},n={},o={};if(i.dsd.columns.forEach(t.bind(function(e,t){e.subject!==this.geoSubject&&e.id!==this.geoSubject||(a=e,a.index=t),e.subject!==this.valueSubject&&e.id!==this.valueSubject||(n=e,n.index=t),e.subject===this.muSubject&&(o=e,o.index=t)},this)),i.dsd.columns.forEach(t.bind(function(e,t){o.id+"_"+this.lang&&(o=e,o.index=t)},this)),this._validateJoinColumnInput(a)){var r=null,l=a.domain.codes[0].idCodeList.toLowerCase();if(this.join.layerMapping[l])r=this.join.layerMapping[l];else{a.domain.codes[0].idCodeList.toLowerCase();var s=i.meContent.seReferencePopulation.referenceArea.codes[0].code.toLowerCase();r=this.join.layerMapping[l+"_"+s]}return r.joindata=this.getJoinData(e.data,a.index,n.index),r.measurementunit=e.data[0][o.index],r.legendtitle=r.measurementunit,r.layertitle="OCD",r}console.error("Error JoinColumnInput not valid")},c.prototype.getJoinData=function(e,i,a){var n=[],o={};return e.forEach(t.bind(function(e){var t={},r=e[i],l=e[a];r&&l&&(t[r]=l,o.hasOwnProperty(r)||(o[r]=!0,n.push(t)))},this)),n},c.prototype._validateJoinInput=function(e){return this.errors={},e.hasOwnProperty("metadata")||(this.errors.metadata="'metadata' attribute not present."),e.hasOwnProperty("data")||(this.errors.data="'data' attribute not present."),0===t.keys(this.errors).length},c.prototype._validateJoinColumnInput=function(e){return this.errors={},e.hasOwnProperty("key")?e.key!==!0&&(this.errors.column="'key' is not true."):this.errors.column="'key' attribute not present.",e.hasOwnProperty("dataType")?"code"!==e.dataType&&(this.errors.column="'dataType' attribute is not a coding system."):this.errors.column="'dataType' attribute not present.",0===Object.keys(this.errors).length},c}.apply(t,a),!(void 0!==n&&(e.exports=n))},function(e,t,i){var a;a=function(){"use strict";return{WMS_URL:"http://fenix.fao.org/demo/fenix/geoserver",DEFAULT_WMS_SERVER:"http://fenix.fao.org/demo/fenix/geoserver",url:{wms:"http://fenix.fao.org/demo/fenix/geoserver"},fenix_ui_map:{plugins:{disclaimerfao:!0,geosearch:!0,mouseposition:!1,controlloading:!0,zoomcontrol:"bottomright"},guiController:{overlay:!1,baselayer:!0,wmsLoader:!1},gui:{disclaimerfao:!0}},leaflet:{zoomControl:!1,attributionControl:!1,minZoom:1},layers:{gaul0:{layers:"fenix:gaul0_3857",urlWMS:"http://fenix.fao.org/demo/fenix/geoserver",opacity:"0.9",joincolumn:"adm0_code",joincolumnlabel:"areanamee",layertype:"JOIN",jointype:"shaded",openlegend:!0,defaultgfi:!0,colorramp:"YlGn",lang:"en"}},geoSubject:"geo",colorRamp:"Reds",valueSubject:"value",muSubject:null,join:{style:{layertype:"JOIN",jointype:"shaded",defaultgfi:!0,openlegend:!0,lang:"EN",opacity:"0.7",colorramp:"Greens",decimalvalues:2},layerMapping:{escap_area:{layers:"fenix:gaul0_3857",joincolumn:"adm0_code",joincolumnlabel:"adm0_name"},gaul0:{layers:"fenix:gaul0_3857",joincolumn:"adm0_code",joincolumnlabel:"adm0_name"},gaul1:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},uae_gaul:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},gaul_adm1:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},faostat_countrycodes:{layers:"fenix:gaul0_faostat_3857",joincolumn:"faost_code",joincolumnlabel:"areanamee"},faostat_countries:{layers:"fenix:gaul0_faostat_3857",joincolumn:"faost_code",joincolumnlabel:"areanamee"},gaul:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},uneca_partner:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"},gaul1_afg:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},iso3:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"},uneca_iso3:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"}}}}}.call(t,i,t,e),!(void 0!==a&&(e.exports=a))},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_3__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_4__},function(e,t,i){var a;a=function(){"use strict";return{MISSING_CONTAINER:"missing_container"}}.call(t,i,t,e),!(void 0!==a&&(e.exports=a))},function(e,t,i){var a;a=function(){"use strict";return{WINDOW_RESIZE:"fs.window.resize.event"}}.call(t,i,t,e),!(void 0!==a&&(e.exports=a))},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_7__},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;(function(jQuery){__WEBPACK_AMD_DEFINE_ARRAY__=[__webpack_require__(3),__webpack_require__(7),__webpack_require__(9),__webpack_require__(10),__webpack_require__(11)],__WEBPACK_AMD_DEFINE_RESULT__=function($,_,L,HashMap,Bootstrap){$.i18n={properties:function(e){},prop:function(e){return e}};var FM={};return FM.CONFIG={BASEURL_LANG:"http://fenixrepo.fao.org/cdn/js/fenix-ui-map/0.1.4/i18n/",MAP_SERVICE_SHADED:"http://fenix.fao.org/test/geo/fenix/mapclassify/join/",DEFAULT_WMS_SERVER:"http://fenix.fao.org/demo/fenix/geoserver",MAP_SERVICE_GFI_STANDARD:"http://fenix.fao.org/test/geo/fenix/mapclassify/request/",ZOOM_TO_BBOX:"http://fenix.fao.org/geo/fenix/spatialquery/db/spatial/bbox/layer/",BASEURL_MAPS:"http://fenixapps2.fao.org/maps-demo",MAP_SERVICE_WMS_GET_CAPABILITIES:"http://fenixapps2.fao.org/maps-demo/rest/service/request",LAYER_BOUNDARIES:"fenix:gaul0_line_3857",LAYER_LABELS:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"},FMCONFIG=FM.CONFIG,FM.Class=function(){},FM.Class.extend=function(e){var t=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},i=function(){};i.prototype=this.prototype;var a=new i;a.constructor=t,t.prototype=a;for(var n in this)this.hasOwnProperty(n)&&"prototype"!==n&&(t[n]=this[n]);e.statics&&(FM.extend(t,e.statics),delete e.statics),e.includes&&(FM.Util.extend.apply(null,[a].concat(e.includes)),delete e.includes),e.options&&a.options&&(e.options=FM.extend({},a.options,e.options)),FM.extend(a,e),a._initHooks=[];var o=this;return a.callInitHooks=function(){if(!this._initHooksCalled){o.prototype.callInitHooks&&o.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var e=0,t=a._initHooks.length;e<t;e++)a._initHooks[e].call(this)}},t},FM.Class.include=function(e){FM.extend(this.prototype,e)},FM.Class.mergeOptions=function(e){FM.extend(this.prototype.options,e)},FM.Class.addInitHook=function(e){var t=Array.prototype.slice.call(arguments,1),i="function"==typeof e?e:function(){this[e].apply(this,t)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i)},FM.Util={initializeLangProperties:function(e){var t="";switch(e){case"FR":t="fr";break;case"ES":t="es";break;default:t="en"}var i=FMCONFIG.BASEURL_LANG;$.i18n.properties({name:"I18N",path:i,mode:"both",language:t})},extend:function(e){var t,i,a,n,o=Array.prototype.slice.call(arguments,1);for(i=0,a=o.length;i<a;i++){n=o[i]||{};for(t in n)n.hasOwnProperty(t)&&(e[t]=n[t])}return e},bind:function(e,t){var i=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return e.apply(t,i||arguments)}},stamp:function(){var e=0,t="_leaflet_id";return function(i){return i[t]=i[t]||++e,i[t]}}(),limitExecByInterval:function(e,t,i){var a,n;return function o(){var r=arguments;return a?void(n=!0):(a=!0,setTimeout(function(){a=!1,n&&(o.apply(i,r),n=!1)},t),void e.apply(i,r))}},falseFn:function(){return!1},formatNum:function(e,t){var i=Math.pow(10,t||5);return Math.round(e*i)/i},splitWords:function(e){return e.replace(/^\s+|\s+$/g,"").split(/\s+/)},setOptions:function(e,t){return e.options=L.extend({},e.options,t),e.options},getParamString:function(e,t){var i=[];for(var a in e)e.hasOwnProperty(a)&&i.push(a+"="+e[a]);return(t&&t.indexOf("?")!==-1?"&":"?")+i.join("&")},template:function(e,t){return e.replace(/\{ *([\w_]+) *\}/g,function(e,i){var a=t[i];if(!t.hasOwnProperty(i))throw new Error("No value provided for variable "+e);return a})},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function getPrefixed(e){var t,i,a=["webkit","moz","o","ms"];for(t=0;t<a.length&&!i;t++)i=window[a[t]+e];return i}function timeoutDefer(e){var t=+new Date,i=Math.max(0,16-(t-lastTime));return lastTime=t+i,window.setTimeout(e,i)}var lastTime=0,requestFn=window.requestAnimationFrame||getPrefixed("RequestAnimationFrame")||timeoutDefer,cancelFn=window.cancelAnimationFrame||getPrefixed("CancelAnimationFrame")||getPrefixed("CancelRequestAnimationFrame")||function(e){window.clearTimeout(e)};FM.Util.requestAnimFrame=function(e,t,i,a){return e=L.bind(e,t),i&&requestFn===timeoutDefer?void e():requestFn.call(window,e,a)},FM.Util.cancelAnimFrame=function(e){e&&cancelFn.call(window,e)},FM.Util.replaceAll=function(e,t,i){return e.replace(new RegExp(t,"g"),i)},FM.Util.parseLayerRequest=function(layer){var layerValues=eval(layer),layerRequest="";return $.each(layerValues,function(e,t){layerRequest+="&"+e+"="+t}),layerRequest},FM.Util.randomID=function(){var e=Math.random().toString(36).substring(7);return(e+Date.now()).toLocaleLowerCase()},FM.Util.fire=function(e,t,i){var a=document.createEvent("CustomEvent");a.initCustomEvent(t,!0,!0,i),e.dispatchEvent(a)},FM.Util.on=function(e,t,i,a){e.addEventListener(t,a,!1)}}(),FM.extend=FM.Util.extend,FM.bind=FM.Util.bind,FM.stamp=FM.Util.stamp,FM.setOptions=FM.Util.setOptions,FM.loadModuleLibs=FM.Util.loadModuleLibs,FM.initializeLangProperties=FM.Util.initializeLangProperties,FM.UIUtils={loadingPanel:function(e,t){var i="25px";t?document.getElementById(e).innerHTML="<div class='fm-loadingPanel' style='height:"+i+"'></div>":document.getElementById(e).innerHTML="<div class='fm-loadingPanel'></div>"}},FM.WMSUtils=FM.Class.extend({_divID:"",_dropdowndID:"",_outputID:"",_fenixMap:"",_wmsServers:"",_mapID:"",_lang:"EN",WMSCapabilities:function(e,t,i,a,n){this._divID=e,this._dropdowndID=e+"-dropdown",this._outputID=t,this._fenixmap=i,this._wmsServers=a,n&&(this._lang=n),this._createWMSDropDown(this._wmsServers,this._divID,this._dropdowndID,this._outputID,i)},_createWMSDropDown:function(e,t,i,a,n){var o='<select id="'+i+'" style="width:200px;" data-placeholder="'+$.i18n.prop("_selectaWMSServer")+'" class="">';o+='<option value=""></option>';for(var r=0;r<e.length;r++)o+='<option value="'+e[r].url+'">'+e[r].label+"</option>";o+="</select>",$("#"+t).empty(),$("#"+t).append(o);try{$("#"+i).chosen({disable_search_threshold:6,width:"100%"})}catch(e){}var l=this;$("#"+i).change({},function(e){l._createWMSOutputRequest(a,n,$(this).val())})},_createWMSOutputRequest:function(e,t,i){$("#"+e).empty(),FM.UIUtils.loadingPanel(e,"30px");var a=FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;a+=a.indexOf("?")>0?"&":"?",a+="SERVICE=WMS",a+="&VERSION=1.1.1",a+="&request=GetCapabilities",a+="&urlWMS="+i;var n=this;$.ajax({type:"GET",url:a,success:function(a){var o=$.parseXML(a);n._createWMSOutput(e,t,o,i)}})},_createWMSOutput:function(e,t,i,a){$("#"+e).empty(),$(i).find("Layer").each(function(){if($(this).children("Name").text()&&""!=$(this).children("Name").text()){var i={};i.layers=$(this).children("Name").text(),i.layername=$(this).children("Name").text(),i.layertitle=$(this).children("Title").text(),i.layertitle=i.layertitle.replace(/_/g," "),i.layertitle=i.layertitle.replace(/3857/g," "),i.styles=$(this).children("Style").children("Name").text(),i.urlWMS=a,i.srs=t.map.options.crs.code,i.openlegend=!0;var n=FM.Util.randomID(),o=FM.Util.replaceAll(FM.guiController.wmsLoaderLayer,"REPLACE",n);$("#"+e).append(o),$("#"+n+"-WMSLayer-title").append(i.layertitle),$("#"+n+"-WMSLayer-box").on("click",{fenixmap:t,layer:i},function(e){e.data.layer.openlegend=!1;var t=new FM.layer(e.data.layer);e.data.fenixmap.addLayer(t);try{FMPopUp.init({parentID:e.data.fenixmap.id,content:"The Layer <b>"+e.data.layer.layertitle+"</b><br> has been added to the map"})}catch(e){}});var r=t,l=$.extend(!0,{},i),s=new FM.layer(l);try{$("#"+n+"-WMSLayer-box").hoverIntent({over:function(){r.addLayer(s)},out:function(){r.removeLayer(s)},timeout:500})}catch(e){}}})},addWMSServer:function(){},_WMSCapabilities:function(e,t,i){var a=FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;a+=a.indexOf("?")>0?"&":"?",a+="SERVICE=WMS",a+="&VERSION=1.1.1",a+="&request=GetCapabilities",a+="&urlWMS="+i;var n=this;$.ajax({type:"GET",url:a,success:function(a){var o=$.parseXML(a);n._createWMSDropwDown(e,t,o,i)}})},_createWMSDropwDown:function(e,t,i,a){FM.Util.randomID();$(i).find("Layer").each(function(){var i=FM.Util.randomID();if($(this).children("Name").text()){var n={};n.layers=$(this).children("Name").text(),n.layername=$(this).children("Name").text(),n.layertitle=$(this).children("Title").text(),n.styles=$(this).children("Style").children("Name").text(),n.urlWMS=a,n.openlegend=!0,$("#"+e).append("<div id='WMSLayer-"+i+"'>ddd"+n.layertitle+" + "+n.styles+" <div>"),n.srs=t.map.options.crs.code,$("#WMSLayer-"+i).click({fenixmap:t,layer:n},function(e){var t=new FM.layer(e.data.layer);e.data.fenixmap.addLayerWMS(t)})}})},WFSCapabilities:function(e,t,i){var a=FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;a+=a.indexOf("?")>0?"&":"?",a+="SERVICE=WFS",a+="&VERSION=1.0.0",a+="&request=GetCapabilities",a+="&urlWMS="+i;$.ajax({type:"GET",url:a,success:function(a){var n=$.parseXML(a);FM.WMSUtils._createWMSDropwDown(e,t,n,i)}})},_createWFSDropwDown:function(e,t,i,a){$(i).find("Layer").each(function(){var i=FM.Util.randomID();if($(this).children("Name").text()){$("#"+e).append("<div id='WMSLayer-"+i+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var n={};n.layers=$(this).children("Name").text(),n.layername=$(this).children("Name").text(),n.layertitle=$(this).children("Title").text(),n.style=$(this).children("Style").children("Name").text(),n.urlWMS=a,n.openlegend=!0,n.srs=t.map.options.crs.code,$("#WMSLayer-"+i).click({fenixmap:t,layer:n},function(e){var t=new FM.layer(e.data.layer);e.data.fenixmap.addLayerWMS(t)})}})}}),function(){var e={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},t="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.exitFullscreen)e.supportsFullScreen=!0;else for(var i=0,a=t.length;i<a;i++)if(e.prefix=t[i],"undefined"!=typeof document[e.prefix+"CancelFullScreen"]){e.supportsFullScreen=!0;break}e.supportsFullScreen&&(e.fullScreenEventName=e.prefix+"fullscreenchange",e.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},e.requestFullScreen=function(e){return""===this.prefix?e.requestFullscreen():e[this.prefix+"RequestFullScreen"]()},e.cancelFullScreen=function(e){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var t=jQuery(this);e.supportsFullScreen&&e.requestFullScreen(t)})}),window.fullScreenApi=e}(),FMDEFAULTLAYER={getLayer:function(e,t,i){switch(e.toUpperCase()){case"GAUL0":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","adm0_code","the_geom",t,"faost_n",i,"GAUL");case"GAUL0_FAOSTAT":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","faost_code","the_geom",t,"faost_n",i,"FAOSTAT");case"GAUL0_ISO2":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso2_code","the_geom",t,"faost_n",i,"ISO2");case"GAUL0_ISO3":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso3_code","the_geom",t,"faost_n",i,"ISO3");case"GAUL0_BOUNDARIES":return FMDEFAULTLAYER._getWMSLayer("gaul0_line_3857");case"GAUL1":return FMDEFAULTLAYER._getGAUL("gaul1_3857","adm1_code","the_geom",t,"adm1_name",i,null);case"GAUL2":return FMDEFAULTLAYER._getGAUL("gaul2_3857","adm2_code","the_geom",t,"adm2_name",i,null)}},_getGAUL:function(e,t,i,a,n,o,r){var l={};return l.layers=e,l.styles="",l.joincolumn=t?t:null,l.joincolumnlabel=n?n:null,l.measurementunit=o?o:null,l.srs="EPSG:3857",l.geometrycolumn=i?i:"",a&&(FMDEFAULTLAYER.joinDefaultPopUp(l),l.joinboundary=r),l},_getWMSLayer:function(e,t,i,a){var n={};return n.layers=e,n.styles=i?i:"",n.srs=a?a:"EPSG:3857",n.urlWMS=t?t:FMCONFIG.DEFAULT_WMS_SERVER,n},joinDefaultPopUp:function(e){var t=e.measurementunit?" "+e.measurementunit:"",i=e.joincolumnlabel?"<div class='fm-popup-join-title'>{{"+e.joincolumnlabel+"}}</div>":"";e.customgfi={content:{en:"<div class='fm-popup'>"+i+"<div class='fm-popup-join-content'>{{{"+e.joincolumn+"}}} <i>"+t+"</i></div></div>",fr:"<div class='fm-popup'>"+i+"{{{"+e.joincolumn+"}}} <i>"+t+"</i></div>",es:"<div class='fm-popup'>"+i+"{{{"+e.joincolumn+"}}} <i>"+t+"</i></div>"},showpopup:!0,output:{show:!0,id:"gfiid"},callback:function(e,t){$("#"+t.outputid).empty(),$("#"+t.outputid).append(e)}}}},FM.TILELAYER={OSM:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",title_en:"OSM - OpenStreetMap"},OSM_GRAYSCALE:{url:"http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",title_en:"OSM - OpenStreetMap grayscale"},MAPQUEST:{url:"http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",title_en:"MapQuest"},MAPQUEST_NASA_AERIAL:{url:"http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",title_en:"MapQuest Aerial"},ESRI_WORLDSTREETMAP:{url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png",title_en:"ESRI - World Street Map"},ESRI_WORLDTERRAINBASE:{url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",title_en:"ESRI - World Terrain Base"},ACETATE_LABELS:{url:"http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png",title_en:"Acetate Labels"},ACETATE_TERRAIN:{url:"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png",title_en:"Acetate Terrain"},STAMEN_TONER_BACKGROUND:{url:"http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",title_en:"Stamen"},ESRI_HISTORICAL_MERCATOR:{url:"http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png",title_en:"ESRI_HISTORICAL_MERCATOR"}},FM.WMSSERVERS={DEFAULT_EXTERNAL_WMS_SERVERS:[{label:"FENIX Crops Area",label_EN:"FENIX",url:"http://fenix.fao.org/demo/fenix/geoserver/earthstat/wms"},{label:"Greenhouse gases Data",label_EN:"FENIX",url:"http://fenix.fao.org/demo/ghg/geoserver/wms"},{label:"DATA.FAO.ORG",label_EN:"data.fao.org WMS Server",url:"http://data.fao.org/maps/wms"},{label:"UNREDD Congo",label_EN:"UNREDD Congo",url:"http://rdc-snsf.org/diss_geoserver/gwc/service/wms"},{label:"Wales OpenData",label_EN:"Wales OpenData",url:"http://inspire.wales.gov.uk/maps/ows"},{label:"Scotland OpenData",label_EN:"Scotland OpenData",url:"http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer"},{label:"Netherlands OpenData",label_EN:"Netherlands OpenData",url:"http://geodata.nationaalgeoregister.nl/ahn2/wcs"},{label:"German OpenData",label_EN:"German OpenData",url:"http://geo.sv.rostock.de/geodienste/verwaltung/wms"},{label:"ENVIRONMENT OpenData",label_EN:"Scotland OpenData",url:"http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer"},{label:"OpenGeo Demo Server",label_EN:"OpenGeo Demo Server",url:"http://demo.opengeo.org/geoserver/ows"},{label:"Alberts Map Service",url:"http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer",urlParameters:"service=WMS"},{label:"Cubert Map Service",label_EN:"Cubert",url:"http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi"},{label:"GP Map Service",label_EN:"gp map service201",url:"http://geoportal.logcluster.org:8081/gp_map_service201/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"}]},FM.Map=FM.Class.extend({id:"",suffix:"",mapContainerID:"",tilePaneID:"",map:"",controller:"",plugins:{},options:{url:{},lang:"EN",guiController:{container:null,overlay:!0,baselayer:!0,wmsLoader:!0,enablegfi:!0,layersthumbs:!1},plugins:{fullscreen:!0,zoomcontrol:!0,scalecontrol:!0,legendcontrol:!0,disclaimerfao:!0},baselayers:null,boundaries:null,labels:null,legendOptions:null,zoomToCountry:null,highlightCountry:null,style:{color:"#337ab7",opacity:.8,weight:2,fillColor:"#337ab7",fillOpacity:.1}},mapOptions:{zoomControl:!1,attributionControl:!1,center:[0,0],lat:0,lng:0,zoom:1},initialize:function(e,t,i){this.options=$.extend(!0,{},this.options,t),this.mapOptions=$.extend(!0,{},this.mapOptions,i),FMCONFIG&&(this.options.url=$.extend(!0,{},FMCONFIG,t&&t.url)),FM.initializeLangProperties(this.options.lang);var a=FM.Util.randomID(),n=a+"-container-map",o=a+"-map",r="<div class='fm-map-box fm-box' id='"+n+"'><div>";$(e).length>0?$(e).append(r):$("#"+e).append(r),this.id=o,this.$map=$("#"+n),this.$map.append("<div style='width:100%; height: 100%;' id='"+o+"'><div>"),this.map=new L.Map(this.id,this.mapOptions),this.mapContainerID=n,this.suffix=a,this.setTilePaneID(),this.controller=new FM.mapController(a,this,this.map,this.options.guiController),this.controller.initializeGUI(),this.map._fenixMap=this,this.options.guiController.enablegfi&&this.map.on("click",this.getFeatureInfo,this);(function(){var e=new L.Control;return e.onAdd=function(e){return $("<div  class='fm-swipe' id='"+a+"-swipe'><div style='display:none' class='fm-swipe-handle'id='"+a+"-handle'>&nbsp</div></div>")[0]},e})().addTo(this.map);this.$map.append(FM.Util.replaceAll(FM.guiController.popUpJoinPoint,"REPLACE",a))},initStyles:function(){function e(e){for(var t={},i=document.styleSheets.length-1,a=document.styleSheets[i].rules||document.styleSheets[i].cssRules,n=0;n<a.length;n++)console.log(a[n].selectorText),a[n].selectorText.indexOf(e)>-1&&(console.log(a[n].selectorText),t[e]||(t[e]=[]),t[e].push(a[n].cssText?a[n].cssText:a[n].style.cssText));return t}$("<h1>PALETTE<h1>").addClass("color-main-light-10").prependTo(this.$map),this.fenixStyles=e(".color-main"),console.log("FMMAP fenixStyles",fenixStyles)},createMap:function(e,t,i){var a=this;this.mapOptions.lat=e||this.mapOptions.lat,this.mapOptions.lng=t||this.mapOptions.lng,this.mapOptions.zoom=i||this.mapOptions.zoom,this.map.setView(new L.LatLng(this.mapOptions.lat,this.mapOptions.lng),this.mapOptions.zoom),this.initializePlugins(),null===this.options.baselayers&&(this.options.baselayers={OSM:FM.TILELAYER.OSM,OSM_GRAYSCALE:FM.TILELAYER.OSM_GRAYSCALE,ESRI_WORLDSTREETMAP:FM.TILELAYER.ESRI_WORLDSTREETMAP,ESRI_WORLDTERRAINBASE:FM.TILELAYER.ESRI_WORLDTERRAINBASE});for(var n in this.options.baselayers){var o=this.options.baselayers[n],r=new FM.layer({layername:n,layertype:"TILE",layertitle:o["title_"+this.options.lang.toLowerCase()],lang:this.options.lang.toUpperCase()}),l=o.url;delete o.url,r.leafletLayer=new L.TileLayer(l,o),this.addTileLayer(r,!0)}return this.options.url.LAYER_BOUNDARIES&&(this.layerBoundaries=new FM.layer({layers:this.options.url.LAYER_BOUNDARIES,layertitle:"Country Boundaries",urlWMS:this.options.url.DEFAULT_WMS_SERVER,opacity:"0.9",lang:"en",hideLayerInControllerList:!0})),this.options.url.LAYER_LABELS&&(this.layerLabels=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19,opacity:.8})),this.highlightLayer=L.geoJson(null,{style:function(e){return a.options.style}}).addTo(this.map),this.options.zoomToCountry&&this.options.zoomToCountry.length>0&&("string"==typeof this.options.zoomToCountry[0]?this.zoomToCountry("iso3",this.options.zoomToCountry):"number"==typeof this.options.zoomToCountry[0]&&this.zoomToCountry("adm0_code",this.options.zoomToCountry)),this.options.highlightCountry&&this.highlightCountry("iso3_code",this.options.highlightCountry),this.options.boundaries&&this.boundariesShow(),this.options.labels&&this.labelsShow(),this},destroyMap:function(){this.map.remove(),this.$map.empty()},setTilePaneID:function(){this.tilePaneID=this.suffix+"-leaflet-tile-pane";var e=document.getElementById(this.id).childNodes,t=e[1].childNodes;$(t[0]).attr("id",this.tilePaneID)},addTileLayer:function(e,t){return t?this.controller.addBaseLayer(e):(this.controller.layerAdded(e),this.map.addLayer(e.leafletLayer)),this.controller.setZIndex(e),this},addLayer:function(e){if(e._fenixmap=this,this.options.legendOptions&&(e.layer.legendOptions=$.extend(e.layer.legendOptions,this.options.legendOptions)),e.layer.layertype)switch(e.layer.layertype){case"JOIN":"SHADED"==e.layer.jointype.toLocaleUpperCase()?this.addShadedLayer(e):"POINT"==e.layer.jointype.toLocaleUpperCase()&&this.addPointLayer(e);break;case"WMS":this.addLayerWMS(e);break;default:this.addLayerWMS(e)}else this.addLayerWMS(e);return this},removeLayer:function(e){return this.controller.removeLayer(e),this},addLayerWMS:function(e){return this.controller.layerAdded(e),this.map.addLayer(e.createLayerWMS()),this.controller.setZIndex(e),this._openlegend(e,!1),this.controller.showHide(e.id,!1),this},addShadedLayer:function(e){e.layerAdded||this.controller.layerAdded(e),this.createShadeLayerRequest(e,e.isadded)},createShadeLayerRequest:function(e,t){t||($("#"+e.id+"-controller-item-getlegend").css("display","inline-block"),$("#"+e.id+"-controller-item-opacity").css("display","block"));var i=this,a=this.options.url.MAP_SERVICE_SHADED;$.ajax({type:"POST",url:a,data:JSON.stringify(e.layer),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){i._createShadeLayer(e,a,t)}})},_createShadeLayer:function(e,t,i){"string"==typeof t&&(t=$.parseJSON(t)),e.layer.sldurl=t.url,e.layer.urlWMS=this.options.url.DEFAULT_WMS_SERVER,t.geoserverwms&&(e.layer.urlWMS=t.geoserverwms),e.layer.legendHTML=t.legendHTML,e.createLayerWMSSLD(),this._loadLayer(e,i)},_loadLayer:function(e,t){var t=!(null==t||!t);t?e.leafletLayer.redraw():(this.map.addLayer(e.leafletLayer),this.controller.setZIndex(e),e.isadded=!0),this._openlegend(e,t),this.controller.showHide(e.id,t)},reAddLayer:function(e){this.map.addLayer(e.leafletLayer),
this.controller.setZIndex(e)},_openlegend:function(e,t){try{e.layer.openlegend&&FM.Legend.getLegend(e,e.id+"-controller-item-getlegend",t)}catch(e){console.war("_openlegend error:"+e)}},addPointLayer:function(e){this.controller.layerAdded(e),this.createPointLayerRequest(e)},createPointLayerRequest:function(e){$("#"+e.id+"-controller-item-getlegend").css("display","none"),$("#"+e.id+"-controller-item-getlegend-holder").slideUp("slow"),$("#"+e.id+"-controller-item-opacity").css("display","none");var t=this,i=this.options.url.MAP_SERVICE_SHADED,a=new RequestHandler;a.open("POST",i),a.setContentType("application/x-www-form-urlencoded"),a.request.onload=function(){t._createPointLayer(e,this.responseText)},a.send(FM.Util.parseLayerRequest(e.layer)),a.request.onerror=function(){if(e.layer.pointsLayers)for(var t=0;t<e.layer.pointsLayers.length;t++)this.map.removeLayer(e.layer.pointsLayers[t])}},_createPointLayer:function(e,t){"string"==typeof t&&(t=$.parseJSON(t)),e.layer.sldurl=t.sldurl,e.layer.urlWMS=t.geoserverwms,e.layer.legendHTML=t.legendHTML,e.layer.pointsJSON=t.pointsJSON,this._refreshPointLayer(e)},_refreshPointLayer:function(e){if(e.layer.pointsLayers)for(var t=0;t<e.layer.pointsLayers.length;t++)this.map.removeLayer(e.layer.pointsLayers[t]);"string"==typeof e.layer.pointsJSON&&(e.layer.pointsJSON=$.parseJSON(e.layer.pointsJSON));var i=this;e.layer.pointsLayers=[];for(var t=0;t<e.layer.pointsJSON.length;t++){var a=new L.LatLng(e.layer.pointsJSON[t].lat,e.layer.pointsJSON[t].lon),n=e.layer.pointsJSON[t].properties;e.layer.pointsJSON[t].properties.measurementunit="",null!=e.layer.measurementuni&&(e.layer.pointsJSON[t].properties.measurementunit=e.layer.measurementunit),null!=e.layer.pointColor&&(n.color=e.layer.pointColor),null!=e.layer.pointFillColor&&(n.fillColor=e.layer.pointFillColor),null!=e.layer.pointFillOpacity&&(n.fillOpacity=e.layer.pointFillOpacity);var o=new L.CircleMarker(a,n).addTo(this.map);o.setRadius(e.layer.pointsJSON[t].radius),o.bindPopup(n.title+" - "+n.value),o.on("mouseover",function(){$("#"+i.suffix+"-popup-join-point-holder").show(),$("#"+i.suffix+"-popup-join-point-text").empty(),$("#"+i.suffix+"-popup-join-point-value").empty(),$("#"+i.suffix+"-popup-join-point-text").append(this.options.title),$("#"+i.suffix+"-popup-join-point-value").append(this.options.value+"  <i>"+e.layer.measurementunit+"</i>")}),o.on("mouseout",function(){$("#"+i.suffix+"-popup-join-point-holder").hide()}),e.layer.pointsLayers.push(o)}},syncOnMove:function(e){FM.MapUtils.syncMapsOnMove(this.map,e)},getFeatureInfo:function(e,t){var i=this,t=t?t:i.controller.selectedLayer;t&&(null!=t.layer.layertype&&"JOIN"==t.layer.layertype?FM.SpatialQuery.getFeatureInfoJoin(t,e.layerPoint,e.latlng,i):FM.SpatialQuery.getFeatureInfoStandard(t,e.layerPoint,e.latlng,i))},invalidateSize:function(){this.map.invalidateSize()},initializePlugins:function(){if(null!=this.options.plugins){var e=this;$.each(this.options.plugins,function(t,i){var a=t.toLowerCase(),n="_add"+a;FM.Plugins[n]&&(e.plugins[a]=FM.Plugins[n](e,i))})}},cloneMap:function(e){var t=this.exportMap(),i=(JSON.stringify(t.layers,function(e,t){return"function"==typeof t?t+"":t}),new FM.Map(e,t.map.options,t.map.mapOptions));return i.createMap(),i.createMapFromJSON(t),i},createMapFromJSON:function(e){this.loadOverlays(e.layers.overlays)},exportMap:function(){var e={};return e.map=this._getMapOptions(),e.layers=this._getMapLayers(),e},exportMapToJSONFile:function(){var e=this.exportMap(),t=FM.Util.randomID(),i="data:application/octet-stream;filename=mapview-"+t+".fnx,"+encodeURIComponent(JSON.stringify(e)),a=window.open(i,"mapview-"+t+".fnx");a.focus()},_getMapOptions:function(){return{options:$.extend(!0,{},this.options),plugins:$.extend(!0,{},this.plugins),mapOptions:$.extend(!0,_getCurrentMapOptions,this.mapOptions)}},_getMapLayers:function(){return{overlays:this.controller.exportOverlays()}},loadOverlays:function(e){for(var t=0;t<e.length;t++)this.addLayer(new FM.layer(e[t]))},zoomTo:function(e,t,i){FM.MapUtils.zoomTo(this,e,t,i)},zoomToCountry:function(e,t){FM.MapUtils.zoomToCountry(this,e,t)},labelsShow:function(){this.layerLabels.addTo(this.map).bringToFront()},labelsHide:function(){this.map.removeLayer(this.layerLabels)},boundariesShow:function(){this.addLayer(this.layerBoundaries)},boundariesHide:function(){this.removeLayer(this.layerBoundaries)},highlightCountry:function(e,t){e=e||"iso3_code";var i=this,a=this.options.url.DEFAULT_WMS_SERVER+"/ows";i.highlightLayer.clearLayers();for(var n in t){var o=_.uniqueId("getJson"),r={service:"WFS",version:"1.0.0",request:"GetFeature",typeName:"fenix:gaul0_bounds",maxFeatures:50,outputFormat:"text/javascript",format_options:"callback: "+o,viewparams:e+":"+t[n]},l=L.Util.extend(r),s=a+L.Util.getParamString(l);$.ajax({url:s,dataType:"jsonp",jsonpCallback:o,success:function(e){i.highlightLayer.addData(e),i.highlightLayer.bringToFront()}})}}}),FM.map=function(e,t,i){return new FM.Map(e,t,i)},FM.LayerUtils={setLayerOpacity:function(e,t){e.leafletLayer&&e.leafletLayer.setOpacity(t),e.layer.opacity=t},filterLayerMinEqualThan:function(e,t,i){t=FM.LayerUtils.getValuesMinEqualThan(t,i),t.redraw()},filterLayerGreaterEqualThan:function(e,t,i){t=FM.LayerUtils.getValuesGreaterEqualThan(t,i),t.redraw()},filterLayerInBetweenEqualThan:function(e,t,i,a){t=FM.LayerUtils.getValuesInBetweenEqualThan(t,i,a),t.redraw()},filterLayerOuterEqualThan:function(e,t,i,a){t=FM.LayerUtils.getValuesOuterEqualThan(t,i,a),t.redraw()},getValuesMinEqualThan:function(e,t){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(a,n){n<=t&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e},getValuesGreaterEqualThan:function(e,t){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(a,n){n>=t&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e},getValuesInBetweenEqualThan:function(e,t,a){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(n,o){o>=t&&o<=a&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e},getValuesOuterEqualThan:function(e,t,a){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(n,o){(t&&o<=t||a&&o>=a)&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e}},FM.Legend={getLegend:function(e,t,i){var a=$.extend({forceLabels:"on",forceRule:"true",dx:"0",dy:"0",mx:"0",my:"0",fontAntiAliasing:"true",fontColor:"0x47576F",bgColor:"0xF9F7F3",border:"false",fontSize:"10"},e.layer.legendOptions);$("#"+t+"-legend-layertitle").empty(),$("#"+t+"-legendtitle").empty(),$("#"+t+"-legendsubtitle").empty(),$("#"+t+"-content").empty(),e.layer.layertitle&&$("#"+t+"-legend-layertitle").append(e.layer.layertitle),e.layer.legendtitle&&$("#"+t+"-legendtitle").append(e.layer.legendtitle),e.layer.legendsubtitle&&$("#"+t+"-legendsubtitle").append(e.layer.legendsubtitle);var n="";if(e.layer.legendHTML)n=e.layer.legendHTML,$("#"+t+"-content").append(n);else{var o=e.layer.urlWMS+"?";o+="&service=WMS&version=1.1.0&REQUEST=GetLegendGraphic&layer="+e.layer.layers+"&Format=image/png",null!=e.layer.style&&""!=e.layer.style&&(o+="&style="+e.layer.style),e.layer.sldurl&&(o+="&sld="+e.layer.sldurl);var r=o;o+="&LEGEND_OPTIONS=";for(var l in a)o+=l+":"+a[l]+";";FM.Legend._loadLegend(o,r,t)}i?$("#"+t+"-holder").is(":visible")&&($("#"+t+"-holder").hide(),$("#"+t+"-holder").slideDown(),e.layer.openlegend=!0):$("#"+t+"-holder").is(":visible")?($("#"+t+"-holder").slideUp(),e.layer.openlegend=!1):($("#"+t+"-holder").slideDown(),e.layer.openlegend=!0),$("#"+t+"-remove").click({id:t+"-holder"},function(t){$("#"+t.data.id).slideUp(),e.layer.openlegend=!1})},_loadLegend:function(e,t,i){var a=new Image;a.name=e,a.src=e;var n='<img id="'+i+'-img" src="'+a.src+'" class="decoded">';a.onload=function(){$("#"+i+"-content").append(n),$("#"+i+"-img").css("width",this.width),$("#"+i+"-img").css("height",this.height)},a.onerror=function(){t?FM.Legend._loadLegend(t,null,i):FM.Legend._nolegend(i)}},_nolegend:function(e){var t='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+e+"-content").append(t)}},FM.MapUtils=function(){var e=function(e,t){var i=e.map?e.map:e,a=t.map?t.map:t;i.on("dragend zoomend",function(e){i.getCenter()!=a.getCenter&&i.getZoom()!=a.getZoom&&a.setView(i.getCenter(),i.getZoom())})},t=function(e){},i=function(e,t,i,a){var n=e.options.url.ZOOM_TO_BBOX+t+"/"+i+"/"+a.toString();$.ajax({type:"GET",url:n,success:function(t){e.hasOwnProperty("map")?e.map.fitBounds(t):e.fitBounds(t)}})},a=function(e,t,a){i(e,"country",t,a)},n=function(e,t){var i=L.latLngBounds([[-90,-180],[90,180]]),a=t instanceof L.LatLngBounds?t:i,n=190,o=190,r=a.getSouthWest().lng,l=a.getNorthEast().lng,s=l-r,d=a.getNorthEast().lat,c=a.getSouthWest().lat,p=d-c,u=e.getSize().x,y=e.getSize().y;s<0&&(s+=360),p<0&&(p+=360);var f=Math.round(Math.log(360*u/s/n)/Math.LN2),m=Math.round(Math.log(360*y/p/o)/Math.LN2),h=Math.max(f,m)-1;e.setZoom(h,{animate:!1})};return{syncMapsOnMove:e,exportLayers:t,zoomTo:i,zoomToCountry:a,fitWorldByScreen:n}}(),FM.Plugins={_addzoomcontrol:function(e,t){if(t){var i="string"==typeof e.options.plugins.zoomcontrol?e.options.plugins.zoomcontrol:"bottomright";return new L.Control.Zoom({position:i}).addTo(e.map)}},_addfullscreen:function(e,t){if(t&&window.fullScreenApi&&window.fullScreenApi.supportsFullScreen)return function(){var t="string"==typeof e.options.plugins.zoomcontrol?e.options.plugins.zoomcontrol:"bottomright",i="string"==typeof e.options.plugins.fullscreen?e.options.plugins.fullscreen:t,a=new L.Control({position:i});return a.onAdd=function(t){var i=L.DomUtil.create("div","leaflet-control-fullscreen fm-icon-box-background"),a=L.DomUtil.create("a","fm-icon-sprite fm-btn-icon",i);return L.DomEvent.disableClickPropagation(a).addListener(a,"click",function(){var t=e.options.plugins.fullscreen.id||e.id,i=document.getElementById(t);window.fullScreenApi.isFullScreen(i)?window.fullScreenApi.cancelFullScreen(i):window.fullScreenApi.requestFullScreen(i)},a),i},a}().addTo(e.map)},_addzoomresetcontrol:function(e,t){if(t)return function(){var t="string"==typeof e.options.plugins.zoomcontrol?e.options.plugins.zoomcontrol:"bottomright",i="string"==typeof e.options.plugins.zoomresetcontrol?e.options.plugins.zoomresetcontrol:t,a=new L.Control({position:i}),n=e.plugins.zoomcontrol._container;return a.onAdd=function(e){var t=L.DomUtil.create("div","leaflet-control-zoom-reset",n);t.innerHTML="&nbsp;",t.title="Zoom Reset",L.DomEvent.disableClickPropagation(t).addListener(t,"click",function(){e.setView(e.options.center,e.options.zoom)},t);var i=L.DomUtil.create("span");return i.style.display="none",i},a}().addTo(e.map)},_adddisclaimerfao:function(e,t){if(t)return function(){var t="string"==typeof e.options.plugins.disclaimerfao?e.options.plugins.disclaimerfao:"bottomright",i=new L.Control({position:t}),a=e.options.lang.toLowerCase();return i.onAdd=function(e){var t=L.DomUtil.create("div","leaflet-control-disclaimer fm-icon-box-background"),i=L.DomUtil.create("a","fm-icon-sprite fm-icon-info",t);return i.title=FM.guiMap["disclaimerfao_"+a],$(i).tooltip({placement:"left"}),t},i}().addTo(e.map)},_addlayercontroller:function(e,t){t?$("#"+this.suffix+"-controller").show():$("#"+this.suffix+"-controller").hide()},_addgeosearch:function(e,t){if(t&&L.GeoSearch)return new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap}).addTo(e.map)},_addgeocoder:function(e,t){if(t&&L.Control.OSMGeocoder)return(new L.Conpluginstrol.OSMGeocoder).addTo(e.map)},_addmouseposition:function(e,t){t&&L.control.mousePosition&&L.control.mousePosition().addTo(e.map)},_addexport:function(e,t){t&&L.Control.Export&&e.map.addControl(new L.Control.Export)},_addprintmodule:function(e,t){if(t&&L.print)var i=L.print.provider({method:"GET",url:"http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf",autoLoad:!0,dpi:254});var a=L.control.print({provider:i});e.map.addControl(a)},_adddrawcontrol:function(e,t){if(t&&L.Control.Draw){var i=new L.FeatureGroup;e.map.addLayer(i);var a=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a polygon!",allowIntersection:!1,drawError:{color:"#b00b00",timeout:1e3},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:i}});e.map.addControl(a),e.map.on("draw:created",function(t){var a=t.layerType,n=t.layer;"marker"===a&&n.bindPopup("A popup!"),l=n,l.layerType=a,i.addLayer(n),e.spatialQuery(n)}),e.map.on("draw:edited",function(e){var t=e.layers,i=0;t.eachLayer(function(e){i++})})}},_addcontrolloading:function(e,t){if(t&&L.Control.loading){var i=L.Control.loading({separate:!0,position:"topright"});e.map.addControl(i)}},_addscalecontrol:function(e,t){if(t&&L.Control.Scale){var i="string"==typeof e.options.plugins.scalecontrol?e.options.plugins.scalecontrol:"topleft";L.control.scale({position:i}).addTo(e.map)}},_addlegendcontrol:function(e,t){if(t)return function(){var t="string"==typeof e.options.plugins.legendcontrol?e.options.plugins.legendcontrol:"topright",i=new L.Control({position:t});return i.onAdd=function(e){var t=L.DomUtil.create("div","leaflet-control-legend");return t},i}().addTo(e.map)}},FM.SpatialQuery={getFeatureInfoJoin:function(e,t,i,a){null==e.layer.customgfi&&FMDEFAULTLAYER.joinDefaultPopUp(e.layer),FM.SpatialQuery.getFeatureInfoStandard(e,t,i,a)},getFeatureInfoStandard:function(e,t,i,a){var n=a.map,o=n.getBounds(),r=n.options.crs.project(o.getSouthWest()),l=n.options.crs.project(o.getNorthEast()),s=r.x+","+r.y+","+l.x+","+l.y,d=n.getSize().x,c=n.getSize().y,p=n.layerPointToContainerPoint(t).x,u=n.layerPointToContainerPoint(t).y;p=new Number(p),p=p.toFixed(0),u=new Number(u),u=u.toFixed(0);var y=a.options.url.MAP_SERVICE_GFI_STANDARD;y+="?SERVICE=WMS",y+="&VERSION=1.1.1",y+="&REQUEST=GetFeatureInfo",y+="&BBOX="+s,y+="&HEIGHT="+c,y+="&WIDTH="+d,y+="&X="+p,y+="&Y="+u,y+="&FORMAT=image/png",y+="&INFO_FORMAT=text/html",""!=e&&null!=e&&(y+="&LAYERS="+e.layer.layers,y+="&QUERY_LAYERS="+e.layer.layers,y+="&STYLES=",y+="&SRS=EPSG:3857",y+="&urlWMS="+e.layer.urlWMS,FM.SpatialQuery.getFeatureInfoJoinRequest(y,"GET",i,n,e))},customPopup:function(e,t,i,a,n){var o='<div class="fm-popup">{{'+n.joincolumnlabel+"}} <br /><b>{{{"+n.joincolumn+"}}} </b> "+n.mu+"</div>";t.content&&t.content[i]&&(o=t.content[i]);var r=this._parseHTML(o);if(r.id.length>0||r.joinid.length>0){var l=$("<div></div>").append(e),s=l.find("table");if(s)return FM.SpatialQuery._customizePopUp(o,r,s,a,n)}},getFeatureInfoJoinRequest:function(e,t,i,a,n){var o=null!=n.layer.lang?n.layer.lang:a.options.lang,r=a,l=n;$.ajax({type:"GET",url:e,success:function(e){if(null!=e){var t=$("#"+r._fenixMap.id).width()-15,a=$("#"+r._fenixMap.id).height()-15,s=new L.Popup({maxWidth:t,maxHeight:a}),d=e;if(l.layer.customgfi){var c=null!=l.layer.joindata?l.layer.joindata:l.layer.data,p=FM.SpatialQuery.customPopup(e,l.layer.customgfi,o,c,n.layer);d=null!=p?p[0]:e}else{var p=FM.SpatialQuery.transposeHTMLTable(e,l.layer.layertitle);d=null!=p?p[0]:e}d=FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(d),l.layer.customgfi?(l.layer.customgfi&&l.layer.customgfi.callback&&l.layer.customgfi.callback(d,l.layer),l.layer.customgfi&&l.layer.customgfi.output&&l.layer.customgfi.output.show&&($("#"+l.layer.customgfi.output.id).empty(),d&&$("#"+l.layer.customgfi.output.id).append(d)),l.layer.customgfi&&l.layer.customgfi.showpopup&&d&&(s.setLatLng(i).setContent(d),r.openPopup(s))):d&&(s.setLatLng(i).setContent(d),r.openPopup(s))}}})},_checkGeoserverDefaultEmptyOutput:function(e){return e},_customizePopUp:function(e,t,i,a,n){for(var o=i.find("tr"),r=$(o[0]).find("th"),l=[],s=[],d=0;d<r.length;d++)for(var c=0;c<t.id.length;c++)if(t.id[c].toUpperCase()==r[d].innerHTML.toUpperCase()){s.push(d);break}if(a)for(var p=[],d=0;d<r.length;d++)for(var c=0;c<t.joinid.length;c++)if(t.joinid[c].toUpperCase()==r[d].innerHTML.toUpperCase()){p.push(d);break}for(var d=1;d<o.length;d++)l.push($(o[d]).find("td"));for(var u=[],c=0;c<l.length;c++){for(var y=e,d=0;d<s.length;d++){var f="{{"+r[s[d]].innerHTML+"}}",m=l[c][s[d]].innerHTML;y=FM.Util.replaceAll(y,f,m)}var h=!1;if(a)for(var d=0;d<p.length;d++){var f="{{{"+r[p[d]].innerHTML+"}}}",m=l[c][p[d]].innerHTML,g=FM.SpatialQuery._getJoinValueFromCode(m,a);g="NA"!==g&&n.decimalvalues?g.toFixed(n.decimalvalues):g,y=FM.Util.replaceAll(y,f,g),"NA"!==g&&(h=!0)}u.push(y)}return u[0]=FM.Util.replaceAll(u[0],"{{measurementunit}}",h?n.measurementunit:""),u},_getJoinValueFromCode:function(e,t){for(var i=parseInt(e)?parseInt(e):null,a="string"==typeof t?$.parseJSON(t):t,n=0;n<a.length;n++)if(a[n][e]||a[n][i])return a[n][e]?a[n][e]:a[n][i];return"NA"},_parseHTML:function(e){var t={};t.id=[],t.joinid=[];for(var i=e.match(/\{\{.*?\}\}/g),a=0;a<i.length;a++)i[a]=FM.Util.replaceAll(i[a],"{{",""),i[a]=FM.Util.replaceAll(i[a],"}}",""),i[a].indexOf("{")>=0?(i[a]=FM.Util.replaceAll(i[a],"{",""),i[a]=FM.Util.replaceAll(i[a],"}",""),t.joinid.push(i[a])):t.id.push(i[a]);return t},transposeHTMLTable:function(e,t){var i=$("<div></div>").append(e),a=i.find("table");if(a){var n=FM.SpatialQuery.transposeHTML(a,t);if(null!=n)return n}return null},transposeHTML:function(e,t){var i=$('<div class="fm-transpose-popup"></div>');e.find("caption");try{i.append(t);for(var a=e.find("tr"),n=$(a[0]).find("th"),o=[],r=1;r<a.length;r++)o.push($(a[r]).find("td"));for(var l=$("<table></table>"),s=$("<tbody></tbody>"),r=0;r<n.length;r++){for(var d="<tr>",c="<td>"+n[r].innerHTML+"</td>",p=0;p<o.length;p++)c+="<td>"+o[p][r].innerHTML+"</td>";d+=c,d+="</tr>",s.append(d)}return i.append(l.append(s))}catch(e){return null}},filterLayerMinEqualThan:function(e,t){FM.LayerUtils.filterLayerMinEqualThan(this,e,t)},filterLayerGreaterEqualThan:function(e,t){FM.LayerUtils.filterLayerGreaterEqualThan(this,e,t)},filterLayerInBetweenEqualThan:function(e,t,i){FM.LayerUtils.filterLayerInBetweenEqualThan(this,e,t,i)},filterLayerOuterEqualThan:function(e,t,i){FM.LayerUtils.filterLayerOuterEqualThan(this,e,t,i)}},FM.LayerSwipe={swipeActivate:function(e,t,i,a){function n(e){e=Math.max(0,Math.min(e,a.getSize().x)),r.style.left=e+"px";var t=a.containerPointToLayerPoint(e,0).x;o.style.clip="rect(-99999px "+t+"px 999999px -99999px)"}e.layer.swipeActive=!0;var o=e.leafletLayer._container,r=document.getElementById(t),l=!1;r.onmousedown=function(){return l=!0,!1},document.onmouseup=function(){l=!1},document.onmousemove=function(e){l&&n(e.x)};e.redraw=function(t){o=e.leafletLayer._container,n(parseInt(r.style.left))},e.mousemoveSwipe=function(t){o=e.leafletLayer._container,n(t.containerPoint.x)},a.on("zoomend",e.redraw),a.on("moveend",e.redraw),a.on("drag",e.redraw),a.on("mousemove",e.mousemoveSwipe);var s=$("#"+i).width();n(s/2)},swipeDeactivate:function(e,t){t.off("zoomend",e.redraw),t.off("moveend",e.redraw),t.off("drag",e.redraw),t.off("mousemove",e.mousemoveSwipe),e.layer.swipeActive=!1;var i=e.leafletLayer._container;i.style.clip="auto"}},FM.MAPController=FM.Class.extend({id:"",suffix:"",_map:"",_fenixMap:"",_guiController:{container:null,overlay:!0,baselayer:!0,layersthumbs:!0},baseLayersMap:"",currentBaseLayer:"",layersMap:"",layersMapZIndexes:"",zIndexBaseLayer:10,zIndex:100,selectedLayer:"",$boxIcons:"",$boxMenu:"",$boxMenuContainer:"",$boxMenuSelected:"",getFeautureInfoLayer:[],initialize:function(e,t,i,a){this._map=i,this._fenixMap=t,this.suffix=e,this.id=e+"-controller",this._guiController=$.extend({},this._guiController,a),this.baseLayersMap=new HashMap,this.layersMap=new HashMap,this.layersMapZIndexes=new HashMap},initializeGUI:function(){var e=this;if(e._guiController&&(e._guiController.overlay||e._guiController.baselayer||e._guiController.wmsLoader)){$("#"+e.id);if(e.$boxMenu=$(FM.Util.replaceAll(FM.guiController.boxMenu,"REPLACE",e.suffix)),e.$boxMenuContainer=e.$boxMenu.find("#"+e.suffix+"-controller-box-content"),e.$boxIcons=$(FM.Util.replaceAll(FM.guiController.boxIcons,"REPLACE",e.suffix)),e.visibleBoxMenu,e._guiController.container){var t=$('<div class="fm-controller-external">').append(e.$boxIcons,e.$boxMenu);t.prependTo(e._guiController.container),e.visibleBoxMenu=!0}else{e.visibleBoxMenu=!1;(function(){var t=new L.Control({position:"bottomleft"});return t.onAdd=function(t){var i=$('<div class="leaflet-control-controller">').append(e.$boxIcons,e.$boxMenu);return L.Browser.touch?L.DomEvent.on(i[0],"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(i[0]),L.DomEvent.on(i[0],"mousewheel",L.DomEvent.stopPropagation)),i[0]},t})().addTo(e._map)}if(e._guiController.overlay&&(e.loadIcon("overlay",e.visibleBoxMenu),e.initializeOverlayDragging()),e._guiController.baselayer&&e.loadIcon("baselayer",e.visibleBoxMenu),e._guiController.wmsLoader){e.loadIcon("wmsLoader",e.visibleBoxMenu);var i=new FM.WMSUtils,a=this.suffix+"-controller-wmsLoader-dropdown",n=this.suffix+"-controller-wmsLoader-content",o=FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;i.WMSCapabilities(a,n,this._fenixMap,o)}}},loadIcon:function(e,t){var i=e+"Box",a=e+"Icon";t="undefined"!=typeof t&&t,this.$boxMenuContainer.append(FM.Util.replaceAll(FM.guiController[i],"REPLACE",this.suffix)),t===!1?this.$boxMenu.hide():(this.$boxMenu.show(),this.$boxMenuContainer.find(".fm-box-zindex").show());var n=$(FM.Util.replaceAll(FM.guiController[a],"REPLACE",this.suffix));n.appendTo(this.$boxIcons),t===!0&&this.$boxIcons.hide();var o=this,r=$("#"+o.suffix+"-controller-"+e+"-box");$("#"+this.suffix+"-controller-"+e+"Icon").on("click",{$id:r,suffix:this.suffix},function(e){var t=e.data.$id;o.$boxMenu.is(":visible")?o.$boxMenuSelected==t?(o.$boxMenu.slideUp(),t.hide(),o.$boxMenuSelected=""):(t.slideDown(),o.$boxMenuSelected=t):(o.$boxMenuSelected=t,o.$boxMenu.slideDown())}),$("#"+this.suffix+"-controller-"+e+"-remove").on("click",{$id:r,suffix:this.suffix},function(e){var t=e.data.$id,i=e.data.suffix;$("#"+i+"-controller-box").slideUp(),t.hide()})},initializeOverlayDragging:function(){},layerAdded:function(e){var t=this;if(e.layerAdded=!0,e.layer.zindex||(e.layer.zindex=t.zIndex,e.leafletLayer.setZIndex=e.layer.zindex),t.zIndex=t.zIndex+2,!e.layer.hideLayerInControllerList){var i=$(FM.Util.replaceAll(FM.guiController.legend,"REPLACE",e.id)),a=i[0];L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(a),L.DomEvent.on(a,"mousewheel",L.DomEvent.stopPropagation)),t._fenixMap.$map.find(".leaflet-control-legend").append(i);var n="#"+t.suffix+"-controller-overlay-content",o="#"+e.id+"-controller-item",r=e.id+"-controller-item",l=FM.Util.replaceAll(FM.guiController.overlay,"REPLACE",e.id);$(n).prepend(l),$("#"+e.id+"-controller-item-box").data("layer",e);$("#"+e.id+"-controller-item-box").index()+1;t._layerGUIOptions(e),t.layersMap.set(e.id,e),t.layersMapZIndexes.set(e.layer.zindex,e.id),$(o+"-title").append(e.layer.layertitle),$(o+"-enabledisable").on("click",{id:e.id},function(e){t.showHide(e.data.id)});var s=1;null!=e.layer.opacity&&(s=e.layer.opacity),$(o+"-opacity");var d=$(o+"-getfeatureinfo");e.layer.enablegfi?(d.on("click",{id:e.id},function(e){var i=t.layersMap.get(e.data.id);t.selectedLayer.id==e.data.id?($("#"+t.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),t.selectedLayer="",i.layer.defaultgfi=!1):($("#"+t.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+e.data.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"),t.selectedLayer=i,i.layer.defaultgfi=!0)}),e.layer.defaultgfi&&(t.selectedLayer=e,$("#"+t.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+e.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"))):$(o+"-getfeatureinfo").css("display","none");var c=$(o+"-getlegend");null!=e.layer.showlegend&&0==e.layer.showlegend||c.on("click",{id:e.id,idToRender:r+"-getlegend"},function(e){var i=t.layersMap.get(e.data.id);FM.Legend.getLegend(i,e.data.idToRender)}),c.css("display","inline-block"),e.layer.layertype&&"JOIN"==e.layer.layertype&&(null==e.layer.switchjointype||e.layer.switchjointype)&&$(o+"-switchjointype").css("display","inline-block").on("click",{id:e.id},function(e){t.switchJoinType(e.data.id)});var p=$(o+"-swipe");p.on("click",{id:e.id},function(e){var i=t.layersMap.get(e.data.id);null!=i.layer.swipeActive&&i.layer.swipeActive?(FM.LayerSwipe.swipeDeactivate(i,t._map),p.removeClass("fm-icon-swipe-selected")):(FM.LayerSwipe.swipeActivate(i,t._fenixMap.suffix+"-handle",t._fenixMap.suffix+"-map",t._map),p.addClass("fm-icon-swipe-selected"))});var u=$(o+"-zoomtolayer");e.layer.zoomToBBOX&&(u.css("display","inline-block"),u.attr("title",$.i18n.prop("_zoomtolayer")),u.on("click",{id:e.id},function(e){var i=t.layersMap.get(e.data.id);FM.LayerUtils.zoomToLayer(t._map,i.layer)})),e.layer.zoomTo&&(u.css("display","inline-block"),u.attr("title",$.i18n.prop("_zoomtolayer")),u.on("click",{id:e.id},function(e){var i=t.layersMap.get(e.data.id);FM.LayerUtils.zoomToLayer(t._map,i.layer)}));var y=$(o+"-showhide-subicons"),f=$(o+"-subicons");y.on("click",function(e){f.slideToggle("fast"),y.hasClass("fm-icon-up")?(y.removeClass("fm-icon-up"),y.addClass("fm-icon-down")):(y.removeClass("fm-icon-down"),y.addClass("fm-icon-up"))})}},_layerGUIOptions:function(e){e.gui;"JOIN"==e.layer.layertype&&null!=e.layer.gui&&null!=e.layer.gui.nojoinlayerswitch&&e.layer.gui.nojoinlayerswitch&&$("#"+e.id+"-controller-item-switchjointype").css("display","none")},addBaseLayer:function(e){var t=this;e.layer.zindex=this.zIndexBaseLayer,this.zIndexBaseLayer=this.zIndexBaseLayer+2,this.baseLayersMap.set(e.id,e),this.layersMapZIndexes.set(e.layer.zindex,e.id);var i="#"+this.suffix+"-controller-baselayer-content",a="#"+e.id+"-controller-item",n=FM.Util.replaceAll(FM.guiController.baselayer,"REPLACE",e.id);n=FM.Util.replaceAll(n,"MAPID",this._fenixMap.id),$(i).append(n),$(a+"-title").append(e.layer.layertitle),t._guiController.layersthumbs?$("#"+e.id+"-controller-item-baselayer-image").addClass("fm-icon-baselayer-"+e.layer.layername):$("#"+e.id+"-controller-item-baselayer-image").remove(),$(a+"-enabledisable").on("click",{id:e.id},function(e){t.showHide(e.data.id)});var o=1;null!=e.layer.opacity&&(o=e.layer.opacity),$("#"+e.id+"-controller-box-item").on("click",{id:e.id},function(e){var i=e.data.id,a=t.baseLayersMap.get(i);t.removeBaseLayerByID(t.currentBaseLayer.id);var n=t.baseLayersMap.get(t.currentBaseLayer.id);$("#"+n.id+"-controller-box-item").removeClass("fm-controller-box-item-baselayer-content-selected"),$("#"+n.id+"-controller-item-opacity").hide(),$("#"+a.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+a.id+"-controller-item-opacity").show(),t._map.addLayer(a.leafletLayer),t.currentBaseLayer=a,t.setZIndex(a)}),1==this.baseLayersMap.count()&&($(a+"-radio").attr("checked",!0),this._map.addLayer(e.leafletLayer),this.currentBaseLayer=e,$("#"+e.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+e.id+"-controller-item-opacity").show(),t.setZIndex(e))},removeLayer:function(e){null!=e.layer.jointype&&"point"==e.layer.jointype?this.removeLayerPoint(e):this.removeLayerDefault(e)},removeLayerDefault:function(e){this._map.removeLayer(e.leafletLayer),this.layersMap.remove(e.id),this.layersMapZIndexes.remove(e.layer.zindex),$("#"+e.id+"-controller-item-box").remove(),$("#"+e.id+"-controller-item-getlegend-holder").remove()},removeLayerPoint:function(e){for(var t=0;t<e.layer.pointsLayers.length;t++)this._map.removeLayer(e.layer.pointsLayers[t]);this.layersMap.remove(e.id),this.layersMapZIndexes.remove(e.layer.zindex),$("#"+id+"-controller-item-box").remove()},removeBaseLayerByID:function(e){var t=this.baseLayersMap.get(e);this._map.removeLayer(t.leafletLayer)},switchJoinType:function(e){var t=this.layersMap.get(e);"point"==t.layer.jointype.toLowerCase()?($("#"+t.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtopoint")),this.switchToShaded(e)):"shaded"==t.layer.jointype.toLowerCase()&&($("#"+t.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")),this.switchToPoint(e))},switchToPointswitchToPoint:function(e){var t=this.layersMap.get(e);t.layer.jointype="point",null!=t.leafletLayer&&this._map.removeLayer(t.leafletLayer),this._fenixMap.createPointLayerRequest(t)},switchToShaded:function(e){var t=this.layersMap.get(e);if(t.layer.jointype="shaded",null!=t.layer.pointsLayers)for(var i=0;i<t.layer.pointsLayers.length;i++)this._map.removeLayer(t.layer.pointsLayers[i]);this._fenixMap.createShadeLayerRequest(t)},showHide:function(e,t){try{var i=this.layersMap.get(e);i&&(i.layer.jointype&&"point"==i.layer.jointype.toLowerCase()?this.showHidePointLayer(e):this.showHideLayer(e,t))}catch(e){}},showHidePointLayer:function(e){for(var t=this.layersMap.get(e),i=0;i<t.layer.pointsLayers.length;i++)if(null==t.layer.visibility||t.layer.visibility){t.layer.visibility=!1,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-disable");for(var i=0;i<t.layer.pointsLayers.length;i++)this._map.removeLayer(t.layer.pointsLayers[i])}else{t.layer.visibility=!0,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-enable");for(var i=0;i<t.layer.pointsLayers.length;i++)this._map.addLayer(t.layer.pointsLayers[i])}},showHideLayer:function(e,t){try{var i=this.layersMap.get(e);null==t||t?null!=t&&t||(null==i.layer.visibility||i.layer.visibility?(i.layer.visibility=!1,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(i.leafletLayer)):(i.layer.visibility=!0,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-enable"),this._map.addLayer(i.leafletLayer),this.setZIndex(i))):0==i.layer.visibility&&($("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(i.leafletLayer))}catch(e){}},updateZIndex:function(e,t){var i=this.layersMap.get(e);i.layer.zindex=t,i.leafletLayer.setZindex=t;try{document.getElementById(i.id).style.zIndex=t}catch(e){}},setZIndex:function(e){try{var t=document.getElementById(this._fenixMap.tilePaneID).childNodes;for(i=0,len=t.length;i<len;i++)if(t[i]!==this._container){var a=parseInt(t[i].style.zIndex,10);isNaN(a)&&(t[i].style.zIndex=e.layer.zindex,t[i].id=e.id)}}catch(e){}},selectGetFeatureInfoIcon:function(e){for(var t=0;t<this.layersMap.count();t++)this.layersMap._data[t]==e?$("#"+e+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"):$("#"+e+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected")},exportOverlays:function(){var e=[];this.layersMap.forEach(function(t){e.push(t.layer.zindex)}),e=e.sort();for(var t=[],i=0;i<e.length;i++){var a=!1;a||this.layersMap.forEach(function(n){n.layer.zindex==e[i]&&(t.push(n.layer),a=!0)})}var n=$.map(t,function(e){return $.extend(!0,{},e)});return n},exportBaselayers:function(){return null}}),FM.mapController=function(e,t,i,a){return new FM.MAPController(e,t,i,a)},FM.guiController={
boxIcons:'<div id="REPLACE-controller-box-icons-container" class="fm-icon-box-background fm-controller-box-icons-container"></div>',boxMenu:'<div class="fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box" id="REPLACE-controller-box"><div id="REPLACE-controller-box-content" class="clearfix"></div></div>',baselayerIcon:'<div class="fm-box-zindex fx-toolbar-map-holder "><div class="fm-icon-sprite fm-baselayers" id="REPLACE-controller-baselayerIcon"><div></div>',baselayerBox:'<div class="fm-box-zindex fx-toolbar-map-holder " id="REPLACE-controller-baselayer-box"><div id="REPLACE-controller-baselayer-title" class="fm-controller-box-title">Baselayers</div><div id="REPLACE-controller-baselayer-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-baselayer-content" class="fm-controller-box-content"></div></div>',baselayer:'<div id="REPLACE-controller-box-item" class="fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item-baselayer-content"><div id="REPLACE-controller-item"><div class="fm-controller-box-item-baselayer-image" id="REPLACE-controller-item-baselayer-image"></div><div class="fm-controller-box-item-baselayer-text"><div><label class="fm-controller-box-item-baselayer-text fm-controller-item-title" id="REPLACE-controller-item-title"><input id="REPLACE-controller-item-radio"  class="fm-checkbox-hide" type="radio" name="MAPID" value="REPLACE"><label></div><div style="clear:both"></div><div class="fm-opacity-slider-baselayers" id="REPLACE-controller-item-opacity" style="display:none"></div></div></div></div>',overlayIcon:"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>",overlayBox:'<div class="fm-box-zindex fx-toolbar-map-holder " id="REPLACE-controller-overlay-box"><div id="REPLACE-controller-overlay-title" class="fm-controller-box-title">Selected Layers</div><div id="REPLACE-controller-overlay-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-overlay-content" class="fm-controller-box-content"></div></div>',overlay:'<div id="REPLACE-controller-item-box" class="fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item"><div id="REPLACE-controller-item" class="fm-controller-box-header"><div class="fm-controller-box-header-text"><div class="fm-controller-item-title" id="REPLACE-controller-item-title" ></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-down" id="REPLACE-controller-item-showhide-subicons"></div></div><div style="clear:both"></div><div class="fm-controller-box-icons"><div class="fm-icon-enable" id="REPLACE-controller-item-enabledisable"></div><div class="fm-opacity-slider" style="margin-right:10px;" id="REPLACE-controller-item-opacity"></div></div><div style="clear:both"></div><div class="fm-controller-box-subicons" id="REPLACE-controller-item-subicons" style="display:none;"><div class="fm-icon-layer-subicons-sprite fm-icon-getlegend" id="REPLACE-controller-item-getlegend"></div><div class="fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo" id="REPLACE-controller-item-getfeatureinfo"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-switchjointype" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-zoomto" id="REPLACE-controller-item-zoomtolayer" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-swipe" id="REPLACE-controller-item-swipe"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-joinsettings" style="display:none"></div></div></div></div>',wmsLoaderIcon:"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>",wmsLoaderBox:'<div class="fm-box-zindex fx-toolbar-map-holder " id="REPLACE-controller-wmsLoader-box" style="display:none; min-height:300px;"><div id="REPLACE-controller-wmsLoader-title" class="fm-controller-box-title">WMS Loader</div><div id="REPLACE-controller-wmsLoader-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div class="clear:both"></div><div class="fm-WMSLoaderDropDown" id="REPLACE-controller-wmsLoader-dropdown"></div><div id="REPLACE-controller-wmsLoader-content" class="fm-controller-wmsLoader-content"></div></div>',wmsLoaderLayer:'<div id="REPLACE-WMSLayer-box" class="fm-WMSLayer-box"><div id="REPLACE-WMSLayer-icon" class="fm-controller-box-icon fm-icon-info"></div><div id="REPLACE-WMSLayer-title" class="fm-WMSLayer-title"></div></div>',legend:'<div class="fm-icon-box-background fm-box-legend" id="REPLACE-controller-item-getlegend-holder"><div class="fm-legend-title-content"><div id="REPLACE-controller-item-getlegend-legend-layertitle" class="fm-legend-layertitle"></div><div id="REPLACE-controller-item-getlegend-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-item-getlegend-legendtitle" class="fm-legendtitle"></div><div id="REPLACE-controller-item-getlegend-legendsubtitle" class="fm-legendsubtitle"></div><div id="REPLACE-controller-item-getlegend-content" ></div></div>',popUpJoinPoint:'<div class="fm-box fm-popup-join-point-holder" id="REPLACE-popup-join-point-holder" style="display:none"><div class="fm-popup-join-point-text" id="REPLACE-popup-join-point-text"></div><div class="fm-popup-join-point-value" id="REPLACE-popup-join-point-value"></div></div>'},FM.guiMap={disclaimerfao_en:'<div class="fm-disclaimerfao">The designations employed and the presentation of material in the maps  <br>do not imply the expression of any opinion whatsoever on the part of  <br>FAO concerning the legal or constitutional status of any country, <br>territory or sea area, or concerning the delimitation of frontiers.  <br>South Sudan declared its independence on July 9, 2011. <br>Due to data availability, the assessment presented in the map for Sudan  <br>and South Sudan reflects thesituation up to 2011 for the former Sudan.</div>',disclaimerfao_es:"",disclaimerfao_es_styled:'<div class="fm-disclaimerfao-text"></div>',disclaimerfao_fr:"",disclaimerfao_fr_styled:'<div class="fm-disclaimerfao-text"></div>'},FM.Layer=FM.Class.extend({_fenixmap:"",id:"",layer:{styles:"",srs:"EPSG:3857",visibility:!0,format:"image/png",transparent:"TRUE",opacity:1,name:"",tiitle:"",abstract:"",srs:"",LatLonBoundingBox:"",BoundingBox:"",Style:{name:"",title:"",abstract:"",legendurl:{format:"",onlineresource:""}},KeywordList:[],layertitle:"",enablegfi:!0,layertype:"WMS",openlegend:!1,legendOptions:{forceLabels:"on",forceRule:"true",dx:"0",dy:"0",mx:"0",my:"0",fontAntiAliasing:"true",fontColor:"0x47576F",bgColor:"0xF9F7F3",border:"false",fontSize:"15"},switchjointype:!1,lang:"EN"},leafletLayer:"",initialize:function(e,t){this.layer=$.extend(!0,{},this.layer,e),t&&(this.options=t),this.id=FM.Util.randomID(),e.joindata&&(e.defaultdata=e.joindata)},createLayerWMS:function(){var e=this._getWMSParameters();return this.leafletLayer?"WMS"===this.layertype&&this.leafletLayer.setParams(e):(e=this.options?$.extend(!0,{},this.options,e):e,this.layer.urlWMS&&(this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,e))),this.leafletLayer},createLayerWMSSLD:function(){var e=this._getWMSParameters();return this.leafletLayer?this.leafletLayer.setParams(e):this.layer.urlWMS&&(this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,e)),this.leafletLayer},_getWMSParameters:function(){var e={};return e.id=this.id,e.layers=this.layer.name?this.layer.name:this.layer.layers,e.format=this.layer.format,e.transparent=this.layer.transparent.toUpperCase(),e.visibility=this.layer.visibility,e.opacity=this.layer.opacity,e.styles=this.layer.styles,this.layer.style&&(e.styles=this.layer.style),this.layer.sldurl&&(e.sld=this.layer.sldurl),this.layer.cql_filter&&(e.cql_filter=this.layer.cql_filter),this.layer.sld_body&&(e.sld_body=this.layer.sld_body),this.layer.layers=this.layer.layername?this.layer.layername:this.layer.layers,e},redraw:function(e){var t=this;if(t.layer.layertype)switch(t.layer.layertype){case"JOIN":"SHADED"==t.layer.jointype.toLocaleUpperCase()?e?e.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this):"POINT"==t.layer.jointype.toLocaleUpperCase()&&console.log("TODO: handle redraw point");break;case"WMS":this.createLayerWMS(),this.leafletLayer.redraw();break;default:this.createLayerWMS(),this.leafletLayer.redraw()}},addPointLayer:function(e){e?e.addPointLayer(this):this._fenixmap&&this._fenixmap.addPointLayer(this)},addLayerWMS:function(e){e?e.addLayerWMS(this):this._fenixmap&&this._fenixmap.addLayerWMS(this)},addLayer:function(e){e?e.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this)},removeLayer:function(e){e?e.removeLayer(this):this._fenixmap&&this._fenixmap.removeLayer(this)},addShadedLayer:function(e){e?e.addShadedLayer(this):this._fenixmap&&this._fenixmap.addShadedLayer(this)}}),FM.layer=function(e,t,i){return new FM.Layer(e,t,i)},FM.TileLayer=FM.Layer.extend({createTileLayer:function(){var e=this.layer.layername?FM.TILELAYER[this.layer.layername]:FM.TILELAYER[this.layer.layers];this.layer.layertype="TILE",this.layer.layertitle=e["title_"+this.layer.lang.toLowerCase()];var t=new L.TileLayer(e.url);return t}}),FM.TileLayer.createBaseLayer=function(e,t){var i={};i.layername=e,i.layers=e,i.layertype="TILE",i.lang=t;var a=new FM.TileLayer(i);return a.leafletLayer=a.createTileLayer(i.layername),a},FM}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),!(void 0!==__WEBPACK_AMD_DEFINE_RESULT__&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}).call(exports,__webpack_require__(3))},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_9__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_10__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_11__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_12__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_13__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_14__}])});
//# sourceMappingURL=fenix-ui-map-creator.min.js.map