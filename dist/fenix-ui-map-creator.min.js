define(["jquery","loglevel","underscore","leaflet","hashmap","bootstrap","ion-rangeslider","fenix-ui-pivotator","fenix-ui-pivotator-utils","amplify-pubsub"],function(__WEBPACK_EXTERNAL_MODULE_3__,__WEBPACK_EXTERNAL_MODULE_4__,__WEBPACK_EXTERNAL_MODULE_7__,__WEBPACK_EXTERNAL_MODULE_9__,__WEBPACK_EXTERNAL_MODULE_10__,__WEBPACK_EXTERNAL_MODULE_11__,__WEBPACK_EXTERNAL_MODULE_12__,__WEBPACK_EXTERNAL_MODULE_16__,__WEBPACK_EXTERNAL_MODULE_17__,__WEBPACK_EXTERNAL_MODULE_18__){return function(e){function t(i){if(a[i])return a[i].exports;var o=a[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t,a){e.exports=a(1)},function(e,t,a){var i,o;i=[a(3),a(7),a(4),a(5),a(6),a(2),a(8),a(16),a(17),a(18)],o=function(e,t,a,i,o,n,r,l,s,d){"use strict";function c(e){a.info("FENIX MapCreator"),a.info(e),t.extend(this,n,{initial:e}),this._parseInput(e),this.fenix_ui_mapConfig=e.fenix_ui_map;var i=this._validateInput();return i===!0?(this._initVariables(),this._bindEventListeners(),this._renderMap(),this):(a.error("Impossible to create MapCreator"),void a.error(i))}return c.prototype.on=function(e,t,a){var i=a||this;return this.channels[e]||(this.channels[e]=[]),this.channels[e].push({context:i,callback:t}),this},c.prototype.addBaseLayer=function(e){return this.fenixMap.addTileLayer(e,!0),this},c.prototype.addLayer=function(e){var t;return!!e&&(e instanceof L.TileLayer?this.fenixMap.map.addLayer(e):(!this.errors||e&&e.hasOwnProperty("metadata")||(this.errors.metadata="Model does not contain 'metadata' attribute."),t="string"==typeof e?this.createLayerFenixUid(e):e.hasOwnProperty("data")?this.createLayerFenixJoin(e):this.createLayerFenix(e),t=new r.layer(t),"object"==typeof e&&e.metadata&&e.metadata.title&&e.metadata.title.EN&&(t.layer.layertitle=e.metadata.title.EN),this.initial.legendtitle&&(t.layer.layertitle=this.initial.legendtitle),this.fenixMap.addLayer(t),t))},c.prototype.removeLayer=function(e){if(this.status.ready===!0)return this},c.prototype.invalidateSize=function(){if(this.status.ready===!0)return this.fenixMap.invalidateSize(),this},c.prototype._parseInput=function(){this.id=this.initial.id,this.$el=e(this.initial.el),this.model=this.initial.model;var t={};t.aggregationFn=this.initial.aggregationFn,t.aggregations=this.initial.aggregations||[],t.hidden=this.initial.hidden||[],t.columns=this.initial.x,t.values=this.initial.y||["value"],t.rows=this.initial.series,t.formatter=this.initial.formatter||"value",t.valueOutputType=this.initial.valueOutputType,t.showRowHeaders=this.initial.showRowHeaders||!1,t.decimals=this.initial.decimals||2,t.showCode=this.initial.showCode||!1,t.showFlag=this.initial.showFlag||!1,t.showUnit=this.initial.showUnit||!1,this.pivotatorConfig=t},c.prototype._validateInput=function(){var e=!0,t=[];return this.id||(window.fx_map_id>=0?window.fx_map_id++:window.fx_map_id=0,this.id=String(window.fx_map_id),a.warn("Impossible to find MapCreator id. Set auto id to: "+this.id)),0===this.$el.length&&(t.push({code:i.MISSING_CONTAINER}),a.warn("Impossible to find box container")),t.length>0?t:e},c.prototype._initVariables=function(){this.channels={},this.status={},this.status.ready=!1,this.pivotator=new l,this.fenixTool=new s},c.prototype._bindEventListeners=function(){d.subscribe(this._getEventName(o.WINDOW_RESIZE),this,this.invalidateSize)},c.prototype._renderMap=function(){var e=this;e.fenixMap=new r.Map(e.$el,e.fenix_ui_mapConfig),e.fenixMap.createMap(),e.leafletMap=e.fenixMap.map,e.model?e.addLayer(e.model):this.initial.uid&&e.addLayer(this.initial.uid),e.status.ready=!0,setTimeout(t.bind(function(){e._trigger("ready")},e),0)},c.prototype._trigger=function(e){if(!this.channels[e])return!1;for(var t=Array.prototype.slice.call(arguments,1),a=0,i=this.channels[e].length;a<i;a++){var o=this.channels[e][a];o.callback.apply(o.context,t)}return this},c.prototype._getEventName=function(e){return this.id.concat(e)},c.prototype._unbindEventListeners=function(){d.unsubscribe(this._getEventName(o.WINDOW_RESIZE),this.invalidateSize)},c.prototype.dispose=function(){this._unbindEventListeners(),this.status.ready===!0&&this.fenixMap.destroyMap(),this.$el.empty()},c.prototype.createLayerFenix=function(e,t){var a=e.metadata,i={};if(!a.hasOwnProperty("dsd"))throw this.errors.dsd="Model['metadata'] does not contain 'dsd' attribute.",new Error("FENIX Map creator has not a valid configuration");return i.layers="",a.dsd.hasOwnProperty("workspace")&&(i.layers+=a.dsd.workspace+":"),i.layers+=a.dsd.layerName,i.urlWMS=this.fenix_ui_map.DEFAULT_WMS_SERVER,i.layertitle={en:"Data Layer"},i.opacity="0.9",i},c.prototype.createLayerFenixUid=function(e){var t={urlWMS:this.DEFAULT_WMS_SERVER,layertitle:{en:"Data Layer"},opacity:"0.9",layers:e};return t},c.prototype.createLayerFenixJoin=function(e){if(this._validateJoinInput(e)===!0){var a=this.getJoinLayer(e);t.extend(a,this.join.style);var i="<div class='fm-popup'>{{"+a.joincolumnlabel+"}}<div class='fm-popup-join-content'>{{{"+a.joincolumn+"}}} {{measurementunit}}</div></div>";e.metadata.hasOwnProperty("title")?e.metadata.title[this.lang]&&(a.layertitle=e.metadata.title[this.lang]):a.layertitle=e.metadata.uid,this.hasOwnProperty("layer")&&this.layer.hasOwnProperty("layertitle")&&(a.layertitle=this.layer.layertitle),this.hasOwnProperty("layer")&&this.layer.hasOwnProperty("popupBuilder")&&(a.popupBuilder=this.layer.popupBuilder),a.customgfi={showpopup:!0,content:{EN:t.isFunction(a.popupBuilder)?a.popupBuilder(a.joincolumnlabel,a.joincolumn):i}};var o=[];a.joindata.forEach(function(e){t.keys(e).forEach(function(e){t.isNumber(parseInt(e))&&o.push(e)})});var n=a.layers.split(":");return n=n.length>1?n[1]:n[0],this.fenixMap.zoomTo(n,a.joincolumn,o),this.initial.colorRamp&&(a.colorramp=this.initial.colorRamp),a}},c.prototype.getJoinLayer=function(e){var a=e.metadata,i={},o={},n={};if(a.dsd.columns.forEach(t.bind(function(e,t){e.subject!==this.geoSubject&&e.id!==this.geoSubject||(i=e,i.index=t),e.subject!==this.valueSubject&&e.id!==this.valueSubject||(o=e,o.index=t),e.subject===this.muSubject&&(n=e,n.index=t)},this)),a.dsd.columns.forEach(t.bind(function(e,t){n.id+"_"+this.lang&&(n=e,n.index=t)},this)),this._validateJoinColumnInput(i)){var r=null,l=i.domain.codes[0].idCodeList.toLowerCase();if(this.join.layerMapping[l])r=this.join.layerMapping[l];else{i.domain.codes[0].idCodeList.toLowerCase();var s=a.meContent.seReferencePopulation.referenceArea.codes[0].code.toLowerCase();r=this.join.layerMapping[l+"_"+s]}return r.joindata=this.getJoinData(e.data,i.index,o.index),r.measurementunit=e.data[0][n.index],r.legendtitle=r.measurementunit,r.layertitle="OCD",r}console.error("Error JoinColumnInput not valid")},c.prototype.getJoinData=function(e,a,i){var o=[],n={};return e.forEach(t.bind(function(e){var t={},r=e[a],l=e[i];r&&l&&(t[r]=l,n.hasOwnProperty(r)||(n[r]=!0,o.push(t)))},this)),o},c.prototype._validateJoinInput=function(e){return this.errors={},e.hasOwnProperty("metadata")||(this.errors.metadata="'metadata' attribute not present."),e.hasOwnProperty("data")||(this.errors.data="'data' attribute not present."),0===t.keys(this.errors).length},c.prototype._validateJoinColumnInput=function(e){return this.errors={},e.hasOwnProperty("key")?e.key!==!0&&(this.errors.column="'key' is not true."):this.errors.column="'key' attribute not present.",e.hasOwnProperty("dataType")?"code"!==e.dataType&&(this.errors.column="'dataType' attribute is not a coding system."):this.errors.column="'dataType' attribute not present.",0===Object.keys(this.errors).length},c}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,a){var i;i=function(){"use strict";return{WMS_URL:"http://fenix.fao.org/demo/fenix/geoserver",DEFAULT_WMS_SERVER:"http://fenix.fao.org/demo/fenix/geoserver",url:{wms:"http://fenix.fao.org/demo/fenix/geoserver"},fenix_ui_map:{plugins:{disclaimerfao:!0,geosearch:!0,mouseposition:!1,controlloading:!0,zoomcontrol:"bottomright"},guiController:{overlay:!1,baselayer:!0,wmsLoader:!1},gui:{disclaimerfao:!0}},leaflet:{zoomControl:!1,attributionControl:!1,minZoom:1},layers:{gaul0:{layers:"fenix:gaul0_3857",urlWMS:"http://fenix.fao.org/demo/fenix/geoserver",opacity:"0.9",joincolumn:"adm0_code",joincolumnlabel:"areanamee",layertype:"JOIN",jointype:"shaded",openlegend:!0,defaultgfi:!0,colorramp:"YlGn",lang:"en"}},geoSubject:"geo",colorRamp:"Reds",valueSubject:"value",muSubject:null,join:{style:{layertype:"JOIN",jointype:"shaded",defaultgfi:!0,openlegend:!0,lang:"EN",opacity:"0.7",colorramp:"Greens",decimalvalues:2},layerMapping:{escap_area:{layers:"fenix:gaul0_3857",joincolumn:"adm0_code",joincolumnlabel:"adm0_name"},gaul0:{layers:"fenix:gaul0_3857",joincolumn:"adm0_code",joincolumnlabel:"adm0_name"},gaul1:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},uae_gaul:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},gaul_adm1:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},faostat_countrycodes:{layers:"fenix:gaul0_faostat_3857",joincolumn:"faost_code",joincolumnlabel:"areanamee"},faostat_countries:{layers:"fenix:gaul0_faostat_3857",joincolumn:"faost_code",joincolumnlabel:"areanamee"},gaul:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},uneca_partner:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"},gaul1_afg:{layers:"fenix:gaul1_3857",joincolumn:"adm1_code",joincolumnlabel:"adm1_name"},iso3:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"},uneca_iso3:{layers:"fenix:gaul0_faostat3_3857",joincolumn:"iso3",joincolumnlabel:"areanamee"}}}}}.call(t,a,t,e),!(void 0!==i&&(e.exports=i))},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_3__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_4__},function(e,t,a){var i;i=function(){"use strict";return{MISSING_CONTAINER:"missing_container"}}.call(t,a,t,e),!(void 0!==i&&(e.exports=i))},function(e,t,a){var i;i=function(){"use strict";return{WINDOW_RESIZE:"fs.window.resize.event"}}.call(t,a,t,e),!(void 0!==i&&(e.exports=i))},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_7__},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;(function(jQuery){__WEBPACK_AMD_DEFINE_ARRAY__=[__webpack_require__(3),__webpack_require__(7),__webpack_require__(9),__webpack_require__(10),__webpack_require__(11),__webpack_require__(12),__webpack_require__(13)],__WEBPACK_AMD_DEFINE_RESULT__=function($,_,L,HashMap,Bootstrap,Rangeslider,i18n){var FM={};return FM.CONFIG={MAP_SERVICE_SHADED:"http://fenix.fao.org/test/geo/fenix/mapclassify/join/",DEFAULT_WMS_SERVER:"http://fenix.fao.org/demo/fenix/geoserver",MAP_SERVICE_GFI_STANDARD:"http://fenix.fao.org/test/geo/fenix/mapclassify/request/",ZOOM_TO_BBOX:"http://fenix.fao.org/geo/fenix/spatialquery/db/spatial/bbox/layer/",BASEURL_MAPS:"http://fenixapps2.fao.org/maps-demo",MAP_SERVICE_WMS_GET_CAPABILITIES:"http://fenixapps2.fao.org/maps-demo/rest/service/request",LAYER_BOUNDARIES:"fenix:gaul0_line_3857",LAYER_LABELS:"http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png"},FMCONFIG=FM.CONFIG,FM.Class=function(){},FM.Class.extend=function(e){var t=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},a=function(){};a.prototype=this.prototype;var i=new a;i.constructor=t,t.prototype=i;for(var o in this)this.hasOwnProperty(o)&&"prototype"!==o&&(t[o]=this[o]);e.statics&&(FM.extend(t,e.statics),delete e.statics),e.includes&&(FM.Util.extend.apply(null,[i].concat(e.includes)),delete e.includes),e.options&&i.options&&(e.options=FM.extend({},i.options,e.options)),FM.extend(i,e),i._initHooks=[];var n=this;return i.callInitHooks=function(){if(!this._initHooksCalled){n.prototype.callInitHooks&&n.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var e=0,t=i._initHooks.length;e<t;e++)i._initHooks[e].call(this)}},t},FM.Class.include=function(e){FM.extend(this.prototype,e)},FM.Class.mergeOptions=function(e){FM.extend(this.prototype.options,e)},FM.Class.addInitHook=function(e){var t=Array.prototype.slice.call(arguments,1),a="function"==typeof e?e:function(){this[e].apply(this,t)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(a)},FM.Util={extend:function(e){var t,a,i,o,n=Array.prototype.slice.call(arguments,1);for(a=0,i=n.length;a<i;a++){o=n[a]||{};for(t in o)o.hasOwnProperty(t)&&(e[t]=o[t])}return e},bind:function(e,t){var a=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return e.apply(t,a||arguments)}},stamp:function(){var e=0,t="_leaflet_id";return function(a){return a[t]=a[t]||++e,a[t]}}(),limitExecByInterval:function(e,t,a){var i,o;return function n(){var r=arguments;return i?void(o=!0):(i=!0,setTimeout(function(){i=!1,o&&(n.apply(a,r),o=!1)},t),void e.apply(a,r))}},falseFn:function(){return!1},formatNum:function(e,t){var a=Math.pow(10,t||5);return Math.round(e*a)/a},splitWords:function(e){return e.replace(/^\s+|\s+$/g,"").split(/\s+/)},setOptions:function(e,t){return e.options=L.extend({},e.options,t),e.options},getParamString:function(e,t){var a=[];for(var i in e)e.hasOwnProperty(i)&&a.push(i+"="+e[i]);return(t&&t.indexOf("?")!==-1?"&":"?")+a.join("&")},template:function(e,t){return e.replace(/\{ *([\w_]+) *\}/g,function(e,a){var i=t[a];if(!t.hasOwnProperty(a))throw new Error("No value provided for variable "+e);return i})},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function getPrefixed(e){var t,a,i=["webkit","moz","o","ms"];for(t=0;t<i.length&&!a;t++)a=window[i[t]+e];return a}function timeoutDefer(e){var t=+new Date,a=Math.max(0,16-(t-lastTime));return lastTime=t+a,window.setTimeout(e,a)}var lastTime=0,requestFn=window.requestAnimationFrame||getPrefixed("RequestAnimationFrame")||timeoutDefer,cancelFn=window.cancelAnimationFrame||getPrefixed("CancelAnimationFrame")||getPrefixed("CancelRequestAnimationFrame")||function(e){window.clearTimeout(e)};FM.Util.requestAnimFrame=function(e,t,a,i){return e=L.bind(e,t),a&&requestFn===timeoutDefer?void e():requestFn.call(window,e,i)},FM.Util.cancelAnimFrame=function(e){e&&cancelFn.call(window,e)},FM.Util.replaceAll=function(e,t,a){if(e)return e.replace(new RegExp(t,"g"),a)},FM.Util.parseLayerRequest=function(layer){var layerValues=eval(layer),layerRequest="";return $.each(layerValues,function(e,t){layerRequest+="&"+e+"="+t}),layerRequest},FM.Util.randomID=function(){var e=Math.random().toString(36).substring(7);return(e+Date.now()).toLocaleLowerCase()},FM.Util.fire=function(e,t,a){var i=document.createEvent("CustomEvent");i.initCustomEvent(t,!0,!0,a),e.dispatchEvent(i)},FM.Util.on=function(e,t,a,i){e.addEventListener(t,i,!1)}}(),FM.extend=FM.Util.extend,FM.bind=FM.Util.bind,FM.stamp=FM.Util.stamp,FM.setOptions=FM.Util.setOptions,FM.loadModuleLibs=FM.Util.loadModuleLibs,FM.UIUtils={loadingPanel:function(e,t){var a="25px";t?document.getElementById(e).innerHTML="<div class='fm-loadingPanel' style='height:"+a+"'></div>":document.getElementById(e).innerHTML="<div class='fm-loadingPanel'></div>"}},FM.WMSUtils=FM.Class.extend({_divID:"",_dropdowndID:"",_outputID:"",_fenixMap:"",_wmsServers:"",_mapID:"",_lang:"EN",WMSCapabilities:function(e,t,a,i,o){this._divID=e,this._dropdowndID=e+"-dropdown",this._outputID=t,this._fenixmap=a,this._wmsServers=i,o&&(this._lang=o),this._createWMSDropDown(this._wmsServers,this._divID,this._dropdowndID,this._outputID,a)},_createWMSDropDown:function(e,t,a,i,o){var n='<select id="'+a+'" style="width:200px;" data-placeholder="" class="">';n+='<option value=""></option>';for(var r=0;r<e.length;r++)n+='<option value="'+e[r].url+'">'+e[r].label+"</option>";n+="</select>",$("#"+t).empty(),$("#"+t).append(n);try{$("#"+a).chosen({disable_search_threshold:6,width:"100%"})}catch(e){}var l=this;$("#"+a).change({},function(e){l._createWMSOutputRequest(i,o,$(this).val())})},_createWMSOutputRequest:function(e,t,a){$("#"+e).empty(),FM.UIUtils.loadingPanel(e,"30px");var i=FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;i+=i.indexOf("?")>0?"&":"?",i+="SERVICE=WMS",i+="&VERSION=1.1.1",i+="&request=GetCapabilities",i+="&urlWMS="+a;var o=this;$.ajax({type:"GET",url:i,success:function(i){var n=$.parseXML(i);o._createWMSOutput(e,t,n,a)}})},_createWMSOutput:function(e,t,a,i){$("#"+e).empty(),$(a).find("Layer").each(function(){if($(this).children("Name").text()&&""!=$(this).children("Name").text()){var a={};a.layers=$(this).children("Name").text(),a.layername=$(this).children("Name").text(),a.layertitle=$(this).children("Title").text(),a.layertitle=a.layertitle.replace(/_/g," "),a.layertitle=a.layertitle.replace(/3857/g," "),a.styles=$(this).children("Style").children("Name").text(),a.urlWMS=i,a.srs=t.map.options.crs.code,a.openlegend=!0;var o=FM.Util.randomID(),n=FM.Util.replaceAll(FM.guiController.wmsLoaderLayer,"REPLACE",o);$("#"+e).append(n),$("#"+o+"-WMSLayer-title").append(a.layertitle),$("#"+o+"-WMSLayer-box").on("click",{fenixmap:t,layer:a},function(e){e.data.layer.openlegend=!1;var t=new FM.layer(e.data.layer);e.data.fenixmap.addLayer(t);try{FMPopUp.init({parentID:e.data.fenixmap.id,content:"The Layer <b>"+e.data.layer.layertitle+"</b><br> has been added to the map"})}catch(e){}});var r=t,l=$.extend(!0,{},a),s=new FM.layer(l);try{$("#"+o+"-WMSLayer-box").hoverIntent({over:function(){r.addLayer(s)},out:function(){r.removeLayer(s)},timeout:500})}catch(e){}}})},addWMSServer:function(){},_WMSCapabilities:function(e,t,a){var i=FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;i+=i.indexOf("?")>0?"&":"?",i+="SERVICE=WMS",i+="&VERSION=1.1.1",i+="&request=GetCapabilities",i+="&urlWMS="+a;var o=this;$.ajax({type:"GET",url:i,success:function(i){var n=$.parseXML(i);o._createWMSDropwDown(e,t,n,a)}})},_createWMSDropwDown:function(e,t,a,i){FM.Util.randomID();$(a).find("Layer").each(function(){var a=FM.Util.randomID();if($(this).children("Name").text()){var o={};o.layers=$(this).children("Name").text(),o.layername=$(this).children("Name").text(),o.layertitle=$(this).children("Title").text(),o.styles=$(this).children("Style").children("Name").text(),o.urlWMS=i,o.openlegend=!0,$("#"+e).append("<div id='WMSLayer-"+a+"'>ddd"+o.layertitle+" + "+o.styles+" <div>"),o.srs=t.map.options.crs.code,$("#WMSLayer-"+a).click({fenixmap:t,layer:o},function(e){var t=new FM.layer(e.data.layer);e.data.fenixmap.addLayerWMS(t)})}})},WFSCapabilities:function(e,t,a){var i=FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;i+=i.indexOf("?")>0?"&":"?",i+="SERVICE=WFS",i+="&VERSION=1.0.0",i+="&request=GetCapabilities",i+="&urlWMS="+a;$.ajax({type:"GET",url:i,success:function(i){var o=$.parseXML(i);FM.WMSUtils._createWMSDropwDown(e,t,o,a)}})},_createWFSDropwDown:function(e,t,a,i){$(a).find("Layer").each(function(){var a=FM.Util.randomID();if($(this).children("Name").text()){$("#"+e).append("<div id='WMSLayer-"+a+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var o={};o.layers=$(this).children("Name").text(),o.layername=$(this).children("Name").text(),o.layertitle=$(this).children("Title").text(),o.style=$(this).children("Style").children("Name").text(),o.urlWMS=i,o.openlegend=!0,o.srs=t.map.options.crs.code,$("#WMSLayer-"+a).click({fenixmap:t,layer:o},function(e){var t=new FM.layer(e.data.layer);e.data.fenixmap.addLayerWMS(t)})}})}}),function(){var e={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},t="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.exitFullscreen)e.supportsFullScreen=!0;else for(var a=0,i=t.length;a<i;a++)if(e.prefix=t[a],"undefined"!=typeof document[e.prefix+"CancelFullScreen"]){e.supportsFullScreen=!0;break}e.supportsFullScreen&&(e.fullScreenEventName=e.prefix+"fullscreenchange",e.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},e.requestFullScreen=function(e){return""===this.prefix?e.requestFullscreen():e[this.prefix+"RequestFullScreen"]()},e.cancelFullScreen=function(e){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var t=jQuery(this);e.supportsFullScreen&&e.requestFullScreen(t)})}),window.fullScreenApi=e}(),FMDEFAULTLAYER={getLayer:function(e,t,a){switch(e.toUpperCase()){case"GAUL0":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","adm0_code","the_geom",t,"faost_n",a,"GAUL");case"GAUL0_FAOSTAT":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","faost_code","the_geom",t,"faost_n",a,"FAOSTAT");case"GAUL0_ISO2":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso2_code","the_geom",t,"faost_n",a,"ISO2");case"GAUL0_ISO3":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso3_code","the_geom",t,"faost_n",a,"ISO3");case"GAUL0_BOUNDARIES":return FMDEFAULTLAYER._getWMSLayer("gaul0_line_3857");case"GAUL1":return FMDEFAULTLAYER._getGAUL("gaul1_3857","adm1_code","the_geom",t,"adm1_name",a,null);case"GAUL2":return FMDEFAULTLAYER._getGAUL("gaul2_3857","adm2_code","the_geom",t,"adm2_name",a,null)}},_getGAUL:function(e,t,a,i,o,n,r){var l={};return l.layers=e,l.styles="",l.joincolumn=t?t:null,l.joincolumnlabel=o?o:null,l.measurementunit=n?n:null,l.srs="EPSG:3857",l.geometrycolumn=a?a:"",i&&(FMDEFAULTLAYER.joinDefaultPopUp(l),l.joinboundary=r),l},_getWMSLayer:function(e,t,a,i){var o={};return o.layers=e,o.styles=a?a:"",o.srs=i?i:"EPSG:3857",o.urlWMS=t?t:FMCONFIG.DEFAULT_WMS_SERVER,o},joinDefaultPopUp:function(e){var t=e.measurementunit?" "+e.measurementunit:"",a=e.joincolumnlabel?"<div class='fm-popup-join-title'>{{"+e.joincolumnlabel+"}}</div>":"";e.customgfi={content:{en:"<div class='fm-popup'>"+a+"<div class='fm-popup-join-content'>{{{"+e.joincolumn+"}}} <i>"+t+"</i></div></div>",fr:"<div class='fm-popup'>"+a+"{{{"+e.joincolumn+"}}} <i>"+t+"</i></div>",es:"<div class='fm-popup'>"+a+"{{{"+e.joincolumn+"}}} <i>"+t+"</i></div>"},showpopup:!0,output:{show:!0,id:"gfiid"},callback:function(e,t){$("#"+t.outputid).empty(),$("#"+t.outputid).append(e)}}}},FM.TILELAYER={OSM:{url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",title_en:"OSM - OpenStreetMap"},OSM_GRAYSCALE:{url:"http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",title_en:"OSM - OpenStreetMap grayscale"},MAPQUEST:{url:"http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",title_en:"MapQuest"},MAPQUEST_NASA_AERIAL:{url:"http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",title_en:"MapQuest Aerial"},ESRI_WORLDSTREETMAP:{url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png",title_en:"ESRI - World Street Map"},ESRI_WORLDTERRAINBASE:{url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",title_en:"ESRI - World Terrain Base"},ACETATE_LABELS:{url:"http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png",title_en:"Acetate Labels"},ACETATE_TERRAIN:{url:"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png",title_en:"Acetate Terrain"},STAMEN_TONER_BACKGROUND:{url:"http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",title_en:"Stamen"},ESRI_HISTORICAL_MERCATOR:{url:"http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png",title_en:"ESRI_HISTORICAL_MERCATOR"}},FM.WMSSERVERS={DEFAULT_EXTERNAL_WMS_SERVERS:[{label:"FENIX Crops Area",label_EN:"FENIX",url:"http://fenix.fao.org/demo/fenix/geoserver/earthstat/wms"},{label:"Greenhouse gases Data",label_EN:"FENIX",url:"http://fenix.fao.org/demo/ghg/geoserver/wms"},{label:"DATA.FAO.ORG",label_EN:"data.fao.org WMS Server",url:"http://data.fao.org/maps/wms"},{label:"UNREDD Congo",label_EN:"UNREDD Congo",url:"http://rdc-snsf.org/diss_geoserver/gwc/service/wms"},{label:"Wales OpenData",label_EN:"Wales OpenData",url:"http://inspire.wales.gov.uk/maps/ows"},{label:"Scotland OpenData",label_EN:"Scotland OpenData",url:"http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer"},{label:"Netherlands OpenData",label_EN:"Netherlands OpenData",url:"http://geodata.nationaalgeoregister.nl/ahn2/wcs"},{label:"German OpenData",label_EN:"German OpenData",url:"http://geo.sv.rostock.de/geodienste/verwaltung/wms"},{label:"ENVIRONMENT OpenData",label_EN:"Scotland OpenData",url:"http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer"},{label:"OpenGeo Demo Server",label_EN:"OpenGeo Demo Server",url:"http://demo.opengeo.org/geoserver/ows"},{label:"Alberts Map Service",url:"http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer",urlParameters:"service=WMS"},{label:"Cubert Map Service",label_EN:"Cubert",url:"http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi"},{label:"GP Map Service",label_EN:"gp map service201",url:"http://geoportal.logcluster.org:8081/gp_map_service201/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"}]},FM.Map=FM.Class.extend({id:"",suffix:"",mapContainerID:"",tilePaneID:"",map:"",controller:"",plugins:{},options:{url:{},lang:"EN",guiController:{container:null,overlay:!0,baselayer:!0,wmsLoader:!0,enablegfi:!0,layersthumbs:!1},plugins:{fullscreen:!0,zoomcontrol:!0,scalecontrol:!0,legendcontrol:!0,disclaimerfao:!0},baselayers:null,boundaries:null,labels:null,legendOptions:null,zoomToCountry:null,highlightCountry:null,style:{color:"#337ab7",opacity:.8,weight:2,fillColor:"#337ab7",fillOpacity:.1}},mapOptions:{zoomControl:!1,attributionControl:!1,center:[0,0],lat:0,lng:0,zoom:1},initialize:function(e,t,a){this.options=$.extend(!0,{},this.options,t),this.mapOptions=$.extend(!0,{},this.mapOptions,a),FMCONFIG&&(this.options.url=$.extend(!0,{},FMCONFIG,t&&t.url));var i=FM.Util.randomID(),o=i+"-container-map",n=i+"-map",r="<div class='fm-map-box fm-box' id='"+o+"'><div>";$(e).length>0?$(e).append(r):$("#"+e).append(r),this.id=n,this.$map=$("#"+o),this.$map.append("<div style='width:100%; height: 100%;' id='"+n+"'><div>"),this.map=new L.Map(this.id,this.mapOptions),this.mapContainerID=o,this.suffix=i,this.setTilePaneID(),this.controller=new FM.mapController(i,this,this.map,this.options.guiController),this.controller.initializeGUI(),this.map._fenixMap=this,this.options.guiController.enablegfi&&this.map.on("click",this.getFeatureInfo,this);(function(){var e=new L.Control;return e.onAdd=function(e){return $("<div  class='fm-swipe' id='"+i+"-swipe'><div style='display:none' class='fm-swipe-handle'id='"+i+"-handle'>&nbsp</div></div>")[0]},e})().addTo(this.map);this.$map.append(FM.Util.replaceAll(FM.guiController.popUpJoinPoint,"REPLACE",i))},initStyles:function(){function e(e){for(var t={},a=document.styleSheets.length-1,i=document.styleSheets[a].rules||document.styleSheets[a].cssRules,o=0;o<i.length;o++)console.log(i[o].selectorText),i[o].selectorText.indexOf(e)>-1&&(console.log(i[o].selectorText),t[e]||(t[e]=[]),t[e].push(i[o].cssText?i[o].cssText:i[o].style.cssText));return t}$("<h1>PALETTE<h1>").addClass("color-main-light-10").prependTo(this.$map),this.fenixStyles=e(".color-main"),console.log("FMMAP fenixStyles",fenixStyles)},createMap:function(e,t,a){var i=this;this.mapOptions.lat=e||this.mapOptions.lat,this.mapOptions.lng=t||this.mapOptions.lng,this.mapOptions.zoom=a||this.mapOptions.zoom,this.map.setView(new L.LatLng(this.mapOptions.lat,this.mapOptions.lng),this.mapOptions.zoom),this.initializePlugins(),null===this.options.baselayers&&(this.options.baselayers={OSM:FM.TILELAYER.OSM,OSM_GRAYSCALE:FM.TILELAYER.OSM_GRAYSCALE,ESRI_WORLDSTREETMAP:FM.TILELAYER.ESRI_WORLDSTREETMAP,ESRI_WORLDTERRAINBASE:FM.TILELAYER.ESRI_WORLDTERRAINBASE});for(var o in this.options.baselayers){var n=this.options.baselayers[o],r=new FM.layer({layername:o,layertype:"TILE",layertitle:n["title_"+this.options.lang.toLowerCase()],lang:this.options.lang.toUpperCase()}),l=n.url;delete n.url,r.leafletLayer=new L.TileLayer(l,n),this.addTileLayer(r,!0)}return this.options.url.LAYER_BOUNDARIES&&(this.layerBoundaries=new FM.layer({layers:this.options.url.LAYER_BOUNDARIES,layertitle:"Country Boundaries",urlWMS:this.options.url.DEFAULT_WMS_SERVER,opacity:"0.9",lang:"en",hideLayerInControllerList:!0})),this.options.url.LAYER_LABELS&&(this.layerLabels=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19,opacity:.8})),this.highlightLayer=L.geoJson(null,{style:function(e){return i.options.style}}).addTo(this.map),this.options.zoomToCountry&&this.options.zoomToCountry.length>0&&("string"==typeof this.options.zoomToCountry[0]?this.zoomToCountry("iso3",this.options.zoomToCountry):"number"==typeof this.options.zoomToCountry[0]&&this.zoomToCountry("adm0_code",this.options.zoomToCountry)),this.options.highlightCountry&&this.highlightCountry("iso3_code",this.options.highlightCountry),this.options.boundaries&&this.boundariesShow(),this.options.labels&&this.labelsShow(),this},destroyMap:function(){this.map.remove(),this.$map.empty()},setTilePaneID:function(){this.tilePaneID=this.suffix+"-leaflet-tile-pane";var e=document.getElementById(this.id).childNodes,t=e[1].childNodes;$(t[0]).attr("id",this.tilePaneID)},addTileLayer:function(e,t){return t?this.controller.addBaseLayer(e):(this.controller.layerAdded(e),this.map.addLayer(e.leafletLayer)),this.controller.setZIndex(e),this},addLayer:function(e){if(e._fenixmap=this,this.options.legendOptions&&(e.layer.legendOptions=$.extend(e.layer.legendOptions,this.options.legendOptions)),e.layer.layertype)switch(e.layer.layertype){case"JOIN":"SHADED"==e.layer.jointype.toLocaleUpperCase()?this.addShadedLayer(e):"POINT"==e.layer.jointype.toLocaleUpperCase()&&this.addPointLayer(e);break;case"WMS":this.addLayerWMS(e);break;default:this.addLayerWMS(e)}else this.addLayerWMS(e);return this},removeLayer:function(e){return this.controller.removeLayer(e),this},addLayerWMS:function(e){return this.controller.layerAdded(e),this.map.addLayer(e.createLayerWMS()),this.controller.setZIndex(e),this._openlegend(e,!1),this.controller.showHide(e.id,!1),this},addShadedLayer:function(e){e.layerAdded||this.controller.layerAdded(e),this.createShadeLayerRequest(e,e.isadded)},createShadeLayerRequest:function(e,t){t||($("#"+e.id+"-controller-item-getlegend").css("display","inline-block"),$("#"+e.id+"-controller-item-opacity").css("display","block"));var a=this,i=this.options.url.MAP_SERVICE_SHADED;$.ajax({type:"POST",url:i,data:JSON.stringify(e.layer),contentType:"application/json; charset=utf-8",dataType:"json",success:function(i){a._createShadeLayer(e,i,t)}})},_createShadeLayer:function(e,t,a){"string"==typeof t&&(t=$.parseJSON(t)),e.layer.sldurl=t.url,e.layer.urlWMS=this.options.url.DEFAULT_WMS_SERVER,t.geoserverwms&&(e.layer.urlWMS=t.geoserverwms),e.layer.legendHTML=t.legendHTML,e.createLayerWMSSLD(),this._loadLayer(e,a)},_loadLayer:function(e,t){var t=!(null==t||!t);t?e.leafletLayer.redraw():(this.map.addLayer(e.leafletLayer),this.controller.setZIndex(e),e.isadded=!0),this._openlegend(e,t),this.controller.showHide(e.id,t)},reAddLayer:function(e){this.map.addLayer(e.leafletLayer),this.controller.setZIndex(e)},_openlegend:function(e,t){try{e.layer.openlegend&&FM.Legend.getLegend(e,e.id+"-controller-item-getlegend",t)}catch(e){console.war("_openlegend error:"+e)}},addPointLayer:function(e){this.controller.layerAdded(e),this.createPointLayerRequest(e)},createPointLayerRequest:function(e){$("#"+e.id+"-controller-item-getlegend").css("display","none"),
$("#"+e.id+"-controller-item-getlegend-holder").slideUp("slow"),$("#"+e.id+"-controller-item-opacity").css("display","none");var t=this,a=this.options.url.MAP_SERVICE_SHADED,i=new RequestHandler;i.open("POST",a),i.setContentType("application/x-www-form-urlencoded"),i.request.onload=function(){t._createPointLayer(e,this.responseText)},i.send(FM.Util.parseLayerRequest(e.layer)),i.request.onerror=function(){if(e.layer.pointsLayers)for(var t=0;t<e.layer.pointsLayers.length;t++)this.map.removeLayer(e.layer.pointsLayers[t])}},_createPointLayer:function(e,t){"string"==typeof t&&(t=$.parseJSON(t)),e.layer.sldurl=t.sldurl,e.layer.urlWMS=t.geoserverwms,e.layer.legendHTML=t.legendHTML,e.layer.pointsJSON=t.pointsJSON,this._refreshPointLayer(e)},_refreshPointLayer:function(e){if(e.layer.pointsLayers)for(var t=0;t<e.layer.pointsLayers.length;t++)this.map.removeLayer(e.layer.pointsLayers[t]);"string"==typeof e.layer.pointsJSON&&(e.layer.pointsJSON=$.parseJSON(e.layer.pointsJSON));var a=this;e.layer.pointsLayers=[];for(var t=0;t<e.layer.pointsJSON.length;t++){var i=new L.LatLng(e.layer.pointsJSON[t].lat,e.layer.pointsJSON[t].lon),o=e.layer.pointsJSON[t].properties;e.layer.pointsJSON[t].properties.measurementunit="",null!=e.layer.measurementuni&&(e.layer.pointsJSON[t].properties.measurementunit=e.layer.measurementunit),null!=e.layer.pointColor&&(o.color=e.layer.pointColor),null!=e.layer.pointFillColor&&(o.fillColor=e.layer.pointFillColor),null!=e.layer.pointFillOpacity&&(o.fillOpacity=e.layer.pointFillOpacity);var n=new L.CircleMarker(i,o).addTo(this.map);n.setRadius(e.layer.pointsJSON[t].radius),n.bindPopup(o.title+" - "+o.value),n.on("mouseover",function(){$("#"+a.suffix+"-popup-join-point-holder").show(),$("#"+a.suffix+"-popup-join-point-text").empty(),$("#"+a.suffix+"-popup-join-point-value").empty(),$("#"+a.suffix+"-popup-join-point-text").append(this.options.title),$("#"+a.suffix+"-popup-join-point-value").append(this.options.value+"  <i>"+e.layer.measurementunit+"</i>")}),n.on("mouseout",function(){$("#"+a.suffix+"-popup-join-point-holder").hide()}),e.layer.pointsLayers.push(n)}},syncOnMove:function(e){FM.MapUtils.syncMapsOnMove(this.map,e)},getFeatureInfo:function(e,t){var a=this,t=t?t:a.controller.selectedLayer;t&&(null!=t.layer.layertype&&"JOIN"==t.layer.layertype?FM.SpatialQuery.getFeatureInfoJoin(t,e.layerPoint,e.latlng,a):FM.SpatialQuery.getFeatureInfoStandard(t,e.layerPoint,e.latlng,a))},invalidateSize:function(){this.map.invalidateSize()},initializePlugins:function(){if(null!=this.options.plugins){var e=this;$.each(this.options.plugins,function(t,a){var i=t.toLowerCase(),o="_add"+i;FM.Plugins[o]&&(e.plugins[i]=FM.Plugins[o](e,a))})}},cloneMap:function(e){var t=this.exportMap(),a=(JSON.stringify(t.layers,function(e,t){return"function"==typeof t?t+"":t}),new FM.Map(e,t.map.options,t.map.mapOptions));return a.createMap(),a.createMapFromJSON(t),a},createMapFromJSON:function(e){this.loadOverlays(e.layers.overlays)},exportMap:function(){var e={};return e.map=this._getMapOptions(),e.layers=this._getMapLayers(),e},exportMapToJSONFile:function(){var e=this.exportMap(),t=FM.Util.randomID(),a="data:application/octet-stream;filename=mapview-"+t+".fnx,"+encodeURIComponent(JSON.stringify(e)),i=window.open(a,"mapview-"+t+".fnx");i.focus()},_getMapOptions:function(){return{options:$.extend(!0,{},this.options),plugins:$.extend(!0,{},this.plugins),mapOptions:$.extend(!0,_getCurrentMapOptions,this.mapOptions)}},_getMapLayers:function(){return{overlays:this.controller.exportOverlays()}},loadOverlays:function(e){for(var t=0;t<e.length;t++)this.addLayer(new FM.layer(e[t]))},zoomTo:function(e,t,a){FM.MapUtils.zoomTo(this,e,t,a)},zoomToCountry:function(e,t){FM.MapUtils.zoomToCountry(this,e,t)},labelsShow:function(){this.layerLabels.addTo(this.map).bringToFront()},labelsHide:function(){this.map.removeLayer(this.layerLabels)},boundariesShow:function(){this.addLayer(this.layerBoundaries)},boundariesHide:function(){this.removeLayer(this.layerBoundaries)},highlightCountry:function(e,t){e=e||"iso3_code";var a=this,i=this.options.url.DEFAULT_WMS_SERVER+"/ows";a.highlightLayer.clearLayers();for(var o in t){var n=_.uniqueId("getJson"),r={service:"WFS",version:"1.0.0",request:"GetFeature",typeName:"fenix:gaul0_bounds",maxFeatures:50,outputFormat:"text/javascript",format_options:"callback: "+n,viewparams:e+":"+t[o]},l=L.Util.extend(r),s=i+L.Util.getParamString(l);$.ajax({url:s,dataType:"jsonp",jsonpCallback:n,success:function(e){a.highlightLayer.addData(e),a.highlightLayer.bringToFront()}})}}}),FM.map=function(e,t,a){return new FM.Map(e,t,a)},FM.LayerUtils={setLayerOpacity:function(e,t){e.leafletLayer&&e.leafletLayer.setOpacity(t),e.layer.opacity=t},filterLayerMinEqualThan:function(e,t,a){t=FM.LayerUtils.getValuesMinEqualThan(t,a),t.redraw()},filterLayerGreaterEqualThan:function(e,t,a){t=FM.LayerUtils.getValuesGreaterEqualThan(t,a),t.redraw()},filterLayerInBetweenEqualThan:function(e,t,a,i){t=FM.LayerUtils.getValuesInBetweenEqualThan(t,a,i),t.redraw()},filterLayerOuterEqualThan:function(e,t,a,i){t=FM.LayerUtils.getValuesOuterEqualThan(t,a,i),t.redraw()},getValuesMinEqualThan:function(e,t){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(a,o){o<=t&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e},getValuesGreaterEqualThan:function(e,t){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(a,o){o>=t&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e},getValuesInBetweenEqualThan:function(e,t,a){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(o,n){n>=t&&n<=a&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e},getValuesOuterEqualThan:function(e,t,a){for("string"==typeof e.layer.defaultdata&&(e.layer.defaultdata=$.parseJSON(e.layer.defaultdata)),e.layer.joindata=[],i=0;i<e.layer.defaultdata.length;i++)$.each(e.layer.defaultdata[i],function(o,n){(t&&n<=t||a&&n>=a)&&e.layer.joindata.push(e.layer.defaultdata[i])});return e.layer.joindata=JSON.stringify(e.layer.joindata),e}},FM.Legend={getLegend:function(e,t,a){var i=$.extend({forceLabels:"on",forceRule:"true",dx:"0",dy:"0",mx:"0",my:"0",fontAntiAliasing:"true",fontColor:"0x47576F",bgColor:"0xF9F7F3",border:"false",fontSize:"10"},e.layer.legendOptions);$("#"+t+"-legend-layertitle").empty(),$("#"+t+"-legendtitle").empty(),$("#"+t+"-legendsubtitle").empty(),$("#"+t+"-content").empty(),e.layer.layertitle&&$("#"+t+"-legend-layertitle").append(e.layer.layertitle),e.layer.legendtitle&&$("#"+t+"-legendtitle").append(e.layer.legendtitle),e.layer.legendsubtitle&&$("#"+t+"-legendsubtitle").append(e.layer.legendsubtitle);var o="";if(e.layer.legendHTML)o=e.layer.legendHTML,$("#"+t+"-content").append(o);else{var n=e.layer.urlWMS+"?";n+="&service=WMS&version=1.1.0&REQUEST=GetLegendGraphic&layer="+e.layer.layers+"&Format=image/png",null!=e.layer.style&&""!=e.layer.style&&(n+="&style="+e.layer.style),e.layer.sldurl&&(n+="&sld="+e.layer.sldurl);var r=n;n+="&LEGEND_OPTIONS=";for(var l in i)n+=l+":"+i[l]+";";FM.Legend._loadLegend(n,r,t)}a?$("#"+t+"-holder").is(":visible")&&($("#"+t+"-holder").hide(),$("#"+t+"-holder").slideDown(),e.layer.openlegend=!0):$("#"+t+"-holder").is(":visible")?($("#"+t+"-holder").slideUp(),e.layer.openlegend=!1):($("#"+t+"-holder").slideDown(),e.layer.openlegend=!0),$("#"+t+"-remove").click({id:t+"-holder"},function(t){$("#"+t.data.id).slideUp(),e.layer.openlegend=!1})},_loadLegend:function(e,t,a){var i=new Image;i.name=e,i.src=e;var o='<img id="'+a+'-img" src="'+i.src+'" class="decoded">';i.onload=function(){$("#"+a+"-content").append(o),$("#"+a+"-img").css("width",this.width),$("#"+a+"-img").css("height",this.height)},i.onerror=function(){t?FM.Legend._loadLegend(t,null,a):FM.Legend._nolegend(a)}},_nolegend:function(e){var t='<div class="fm-legend-layertitle">no legend available</div>';$("#"+e+"-content").append(t)}},FM.MapUtils=function(){var e=function(e,t){var a=e.map?e.map:e,i=t.map?t.map:t;a.on("dragend zoomend",function(e){a.getCenter()!=i.getCenter&&a.getZoom()!=i.getZoom&&i.setView(a.getCenter(),a.getZoom())})},t=function(e){},a=function(e,t,a,i){var o=e.options.url.ZOOM_TO_BBOX+t+"/"+a+"/"+i.toString();$.ajax({type:"GET",url:o,success:function(t){e.hasOwnProperty("map")?e.map.fitBounds(t):e.fitBounds(t)}})},i=function(e,t,i){a(e,"country",t,i)},o=function(e,t){var a=L.latLngBounds([[-90,-180],[90,180]]),i=t instanceof L.LatLngBounds?t:a,o=190,n=190,r=i.getSouthWest().lng,l=i.getNorthEast().lng,s=l-r,d=i.getNorthEast().lat,c=i.getSouthWest().lat,p=d-c,u=e.getSize().x,y=e.getSize().y;s<0&&(s+=360),p<0&&(p+=360);var f=Math.round(Math.log(360*u/s/o)/Math.LN2),m=Math.round(Math.log(360*y/p/n)/Math.LN2),h=Math.max(f,m)-1;e.setZoom(h,{animate:!1})};return{syncMapsOnMove:e,exportLayers:t,zoomTo:a,zoomToCountry:i,fitWorldByScreen:o}}(),FM.Plugins={_addzoomcontrol:function(e,t){if(t){var a="string"==typeof e.options.plugins.zoomcontrol?e.options.plugins.zoomcontrol:"bottomright";return new L.Control.Zoom({position:a}).addTo(e.map)}},_addfullscreen:function(e,t){if(t&&window.fullScreenApi&&window.fullScreenApi.supportsFullScreen)return function(){var t="string"==typeof e.options.plugins.zoomcontrol?e.options.plugins.zoomcontrol:"bottomright",a="string"==typeof e.options.plugins.fullscreen?e.options.plugins.fullscreen:t,i=new L.Control({position:a});return i.onAdd=function(t){var a=L.DomUtil.create("div","leaflet-control-fullscreen fm-icon-box-background"),i=L.DomUtil.create("a","fm-icon-sprite fm-btn-icon",a);return L.DomEvent.disableClickPropagation(i).addListener(i,"click",function(){var t=e.options.plugins.fullscreen.id||e.id,a=document.getElementById(t);window.fullScreenApi.isFullScreen(a)?window.fullScreenApi.cancelFullScreen(a):window.fullScreenApi.requestFullScreen(a)},i),a},i}().addTo(e.map)},_addzoomresetcontrol:function(e,t){if(t)return function(){var t="string"==typeof e.options.plugins.zoomcontrol?e.options.plugins.zoomcontrol:"bottomright",a="string"==typeof e.options.plugins.zoomresetcontrol?e.options.plugins.zoomresetcontrol:t,i=new L.Control({position:a}),o=e.plugins.zoomcontrol._container;return i.onAdd=function(e){var t=L.DomUtil.create("div","leaflet-control-zoom-reset",o);t.innerHTML="&nbsp;",t.title="Zoom Reset",L.DomEvent.disableClickPropagation(t).addListener(t,"click",function(){e.setView(e.options.center,e.options.zoom)},t);var a=L.DomUtil.create("span");return a.style.display="none",a},i}().addTo(e.map)},_adddisclaimerfao:function(e,t){if(t)return function(){var t="string"==typeof e.options.plugins.disclaimerfao?e.options.plugins.disclaimerfao:"bottomright",a=new L.Control({position:t}),i=e.options.lang.toLowerCase();return a.onAdd=function(e){var t=L.DomUtil.create("div","leaflet-control-disclaimer fm-icon-box-background"),a=L.DomUtil.create("a","fm-icon-sprite fm-icon-info",t);return a.title=FM.guiMap["disclaimerfao_"+i],$(a).tooltip({placement:"left"}),t},a}().addTo(e.map)},_addlayercontroller:function(e,t){t?$("#"+this.suffix+"-controller").show():$("#"+this.suffix+"-controller").hide()},_addgeosearch:function(e,t){if(t&&L.GeoSearch)return new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap}).addTo(e.map)},_addgeocoder:function(e,t){if(t&&L.Control.OSMGeocoder)return(new L.Conpluginstrol.OSMGeocoder).addTo(e.map)},_addmouseposition:function(e,t){t&&L.control.mousePosition&&L.control.mousePosition().addTo(e.map)},_addexport:function(e,t){t&&L.Control.Export&&e.map.addControl(new L.Control.Export)},_addprintmodule:function(e,t){if(t&&L.print)var a=L.print.provider({method:"GET",url:"http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf",autoLoad:!0,dpi:254});var i=L.control.print({provider:a});e.map.addControl(i)},_adddrawcontrol:function(e,t){if(t&&L.Control.Draw){var a=new L.FeatureGroup;e.map.addLayer(a);var i=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a polygon!",allowIntersection:!1,drawError:{color:"#b00b00",timeout:1e3},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:a}});e.map.addControl(i),e.map.on("draw:created",function(t){var i=t.layerType,o=t.layer;"marker"===i&&o.bindPopup("A popup!"),l=o,l.layerType=i,a.addLayer(o),e.spatialQuery(o)}),e.map.on("draw:edited",function(e){var t=e.layers,a=0;t.eachLayer(function(e){a++})})}},_addcontrolloading:function(e,t){if(t&&L.Control.loading){var a=L.Control.loading({separate:!0,position:"topright"});e.map.addControl(a)}},_addscalecontrol:function(e,t){if(t&&L.Control.Scale){var a="string"==typeof e.options.plugins.scalecontrol?e.options.plugins.scalecontrol:"topleft";L.control.scale({position:a}).addTo(e.map)}},_addlegendcontrol:function(e,t){if(t)return function(){var t="string"==typeof e.options.plugins.legendcontrol?e.options.plugins.legendcontrol:"topright",a=new L.Control({position:t});return a.onAdd=function(e){var t=L.DomUtil.create("div","leaflet-control-legend");return t},a}().addTo(e.map)}},FM.SpatialQuery={getFeatureInfoJoin:function(e,t,a,i){null==e.layer.customgfi&&FMDEFAULTLAYER.joinDefaultPopUp(e.layer),FM.SpatialQuery.getFeatureInfoStandard(e,t,a,i)},getFeatureInfoStandard:function(e,t,a,i){var o=i.map,n=o.getBounds(),r=o.options.crs.project(n.getSouthWest()),l=o.options.crs.project(n.getNorthEast()),s=r.x+","+r.y+","+l.x+","+l.y,d=o.getSize().x,c=o.getSize().y,p=o.layerPointToContainerPoint(t).x,u=o.layerPointToContainerPoint(t).y;p=new Number(p),p=p.toFixed(0),u=new Number(u),u=u.toFixed(0);var y=i.options.url.MAP_SERVICE_GFI_STANDARD;y+="?SERVICE=WMS",y+="&VERSION=1.1.1",y+="&REQUEST=GetFeatureInfo",y+="&BBOX="+s,y+="&HEIGHT="+c,y+="&WIDTH="+d,y+="&X="+p,y+="&Y="+u,y+="&FORMAT=image/png",y+="&INFO_FORMAT=text/html",""!=e&&null!=e&&(y+="&LAYERS="+e.layer.layers,y+="&QUERY_LAYERS="+e.layer.layers,y+="&STYLES=",y+="&SRS=EPSG:3857",y+="&urlWMS="+e.layer.urlWMS,FM.SpatialQuery.getFeatureInfoJoinRequest(y,"GET",a,o,e))},customPopup:function(e,t,a,i,o){var n='<div class="fm-popup">{{'+o.joincolumnlabel+"}} <br /><b>{{{"+o.joincolumn+"}}} </b> "+o.mu+"</div>";t.content&&t.content[a]&&(n=t.content[a]);var r=this._parseHTML(n);if(r.id.length>0||r.joinid.length>0){var l=$("<div></div>").append(e),s=l.find("table");if(s)return FM.SpatialQuery._customizePopUp(n,r,s,i,o)}},getFeatureInfoJoinRequest:function(e,t,a,i,o){var n=null!=o.layer.lang?o.layer.lang:i.options.lang,r=i,l=o;$.ajax({type:"GET",url:e,success:function(e){if(null!=e){var t=$("#"+r._fenixMap.id).width()-15,i=$("#"+r._fenixMap.id).height()-15,s=new L.Popup({maxWidth:t,maxHeight:i}),d=e;if(l.layer.customgfi){var c=null!=l.layer.joindata?l.layer.joindata:l.layer.data,p=FM.SpatialQuery.customPopup(e,l.layer.customgfi,n,c,o.layer);d=null!=p?p[0]:e}else{var p=FM.SpatialQuery.transposeHTMLTable(e,l.layer.layertitle);d=null!=p?p[0]:e}d=FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(d),l.layer.customgfi?(l.layer.customgfi&&l.layer.customgfi.callback&&l.layer.customgfi.callback(d,l.layer),l.layer.customgfi&&l.layer.customgfi.output&&l.layer.customgfi.output.show&&($("#"+l.layer.customgfi.output.id).empty(),d&&$("#"+l.layer.customgfi.output.id).append(d)),l.layer.customgfi&&l.layer.customgfi.showpopup&&d&&(s.setLatLng(a).setContent(d),r.openPopup(s))):d&&(s.setLatLng(a).setContent(d),r.openPopup(s))}}})},_checkGeoserverDefaultEmptyOutput:function(e){return e},_customizePopUp:function(e,t,a,i,o){for(var n=a.find("tr"),r=$(n[0]).find("th"),l=[],s=[],d=0;d<r.length;d++)for(var c=0;c<t.id.length;c++)if(t.id[c].toUpperCase()==r[d].innerHTML.toUpperCase()){s.push(d);break}if(i)for(var p=[],d=0;d<r.length;d++)for(var c=0;c<t.joinid.length;c++)if(t.joinid[c].toUpperCase()==r[d].innerHTML.toUpperCase()){p.push(d);break}for(var d=1;d<n.length;d++)l.push($(n[d]).find("td"));for(var u=[],c=0;c<l.length;c++){for(var y=e,d=0;d<s.length;d++){var f="{{"+r[s[d]].innerHTML+"}}",m=l[c][s[d]].innerHTML;y=FM.Util.replaceAll(y,f,m)}var h=!1;if(i)for(var d=0;d<p.length;d++){var f="{{{"+r[p[d]].innerHTML+"}}}",m=l[c][p[d]].innerHTML,v=FM.SpatialQuery._getJoinValueFromCode(m,i);v="NA"!==v&&o.decimalvalues?v.toFixed(o.decimalvalues):v,y=FM.Util.replaceAll(y,f,v),"NA"!==v&&(h=!0)}u.push(y)}return u[0]=FM.Util.replaceAll(u[0],"{{measurementunit}}",h?o.measurementunit:""),u},_getJoinValueFromCode:function(e,t){for(var a=parseInt(e)?parseInt(e):null,i="string"==typeof t?$.parseJSON(t):t,o=0;o<i.length;o++)if(i[o][e]||i[o][a])return i[o][e]?i[o][e]:i[o][a];return"NA"},_parseHTML:function(e){var t={};t.id=[],t.joinid=[];for(var a=e.match(/\{\{.*?\}\}/g),i=0;i<a.length;i++)a[i]=FM.Util.replaceAll(a[i],"{{",""),a[i]=FM.Util.replaceAll(a[i],"}}",""),a[i].indexOf("{")>=0?(a[i]=FM.Util.replaceAll(a[i],"{",""),a[i]=FM.Util.replaceAll(a[i],"}",""),t.joinid.push(a[i])):t.id.push(a[i]);return t},transposeHTMLTable:function(e,t){var a=$("<div></div>").append(e),i=a.find("table");if(i){var o=FM.SpatialQuery.transposeHTML(i,t);if(null!=o)return o}return null},transposeHTML:function(e,t){var a=$('<div class="fm-transpose-popup"></div>');e.find("caption");try{a.append(t);for(var i=e.find("tr"),o=$(i[0]).find("th"),n=[],r=1;r<i.length;r++)n.push($(i[r]).find("td"));for(var l=$("<table></table>"),s=$("<tbody></tbody>"),r=0;r<o.length;r++){for(var d="<tr>",c="<td>"+o[r].innerHTML+"</td>",p=0;p<n.length;p++)c+="<td>"+n[p][r].innerHTML+"</td>";d+=c,d+="</tr>",s.append(d)}return a.append(l.append(s))}catch(e){return null}},filterLayerMinEqualThan:function(e,t){FM.LayerUtils.filterLayerMinEqualThan(this,e,t)},filterLayerGreaterEqualThan:function(e,t){FM.LayerUtils.filterLayerGreaterEqualThan(this,e,t)},filterLayerInBetweenEqualThan:function(e,t,a){FM.LayerUtils.filterLayerInBetweenEqualThan(this,e,t,a)},filterLayerOuterEqualThan:function(e,t,a){FM.LayerUtils.filterLayerOuterEqualThan(this,e,t,a)}},FM.LayerSwipe={swipeActivate:function(e,t,a,i){function o(e){e=Math.max(0,Math.min(e,i.getSize().x)),r.style.left=e+"px";var t=i.containerPointToLayerPoint(e,0).x;n.style.clip="rect(-99999px "+t+"px 999999px -99999px)"}e.layer.swipeActive=!0;var n=e.leafletLayer._container,r=document.getElementById(t),l=!1;r.onmousedown=function(){return l=!0,!1},document.onmouseup=function(){l=!1},document.onmousemove=function(e){l&&o(e.x)};e.redraw=function(t){n=e.leafletLayer._container,o(parseInt(r.style.left))},e.mousemoveSwipe=function(t){n=e.leafletLayer._container,o(t.containerPoint.x)},i.on("zoomend",e.redraw),i.on("moveend",e.redraw),i.on("drag",e.redraw),i.on("mousemove",e.mousemoveSwipe);var s=$("#"+a).width();o(s/2)},swipeDeactivate:function(e,t){t.off("zoomend",e.redraw),t.off("moveend",e.redraw),t.off("drag",e.redraw),t.off("mousemove",e.mousemoveSwipe),e.layer.swipeActive=!1;var a=e.leafletLayer._container;a.style.clip="auto"}},FM.MAPController=FM.Class.extend({id:"",suffix:"",_map:"",_fenixMap:"",_guiController:{container:null,overlay:!0,baselayer:!0,layersthumbs:!0},baseLayersMap:"",currentBaseLayer:"",layersMap:"",layersMapZIndexes:"",zIndexBaseLayer:10,zIndex:100,selectedLayer:"",$boxIcons:"",$boxMenu:"",$boxMenuContainer:"",$boxMenuSelected:"",getFeautureInfoLayer:[],initialize:function(e,t,a,i){this._map=a,this._fenixMap=t,this.suffix=e,this.id=e+"-controller",this._guiController=$.extend({},this._guiController,i),this.baseLayersMap=new HashMap,this.layersMap=new HashMap,this.layersMapZIndexes=new HashMap},initializeGUI:function(){var e=this;if(e._guiController&&(e._guiController.overlay||e._guiController.baselayer||e._guiController.wmsLoader)){$("#"+e.id);if(e.$boxMenu=$(FM.Util.replaceAll(FM.guiController.boxMenu,"REPLACE",e.suffix)),e.$boxMenuContainer=e.$boxMenu.find("#"+e.suffix+"-controller-box-content"),e.$boxIcons=$(FM.Util.replaceAll(FM.guiController.boxIcons,"REPLACE",e.suffix)),e.visibleBoxMenu,e._guiController.container){var t=$('<div class="fm-controller-external">').append(e.$boxIcons,e.$boxMenu);t.prependTo(e._guiController.container),e.visibleBoxMenu=!0}else{e.visibleBoxMenu=!1;(function(){var t=new L.Control({position:"bottomleft"});return t.onAdd=function(t){var a=$('<div class="leaflet-control-controller">').append(e.$boxIcons,e.$boxMenu);return L.Browser.touch?L.DomEvent.on(a[0],"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(a[0]),L.DomEvent.on(a[0],"mousewheel",L.DomEvent.stopPropagation)),a[0]},t})().addTo(e._map)}if(e._guiController.overlay&&(e.loadIcon("overlay",e.visibleBoxMenu),e.initializeOverlayDragging()),e._guiController.baselayer&&e.loadIcon("baselayer",e.visibleBoxMenu),e._guiController.wmsLoader){e.loadIcon("wmsLoader",e.visibleBoxMenu);var a=new FM.WMSUtils,i=this.suffix+"-controller-wmsLoader-dropdown",o=this.suffix+"-controller-wmsLoader-content",n=FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;a.WMSCapabilities(i,o,this._fenixMap,n)}}},loadIcon:function(e,t){var a=e+"Box",i=e+"Icon";t="undefined"!=typeof t&&t,this.$boxMenuContainer.append(FM.Util.replaceAll(FM.guiController[a],"REPLACE",this.suffix)),t===!1?this.$boxMenu.hide():(this.$boxMenu.show(),this.$boxMenuContainer.find(".fm-box-zindex").show());var o=$(FM.Util.replaceAll(FM.guiController[i],"REPLACE",this.suffix));o.appendTo(this.$boxIcons),t===!0&&this.$boxIcons.hide();var n=this,r=$("#"+n.suffix+"-controller-"+e+"-box");$("#"+this.suffix+"-controller-"+e+"Icon").on("click",{$id:r,suffix:this.suffix},function(e){var t=e.data.$id;n.$boxMenu.is(":visible")?n.$boxMenuSelected==t?(n.$boxMenu.slideUp(),t.hide(),n.$boxMenuSelected=""):(t.slideDown(),n.$boxMenuSelected=t):(n.$boxMenuSelected=t,n.$boxMenu.slideDown())}),$("#"+this.suffix+"-controller-"+e+"-remove").on("click",{$id:r,suffix:this.suffix},function(e){var t=e.data.$id,a=e.data.suffix;$("#"+a+"-controller-box").slideUp(),t.hide()})},initializeOverlayDragging:function(){},layerAdded:function(e){var t=this;if(e.layerAdded=!0,e.layer.zindex||(e.layer.zindex=t.zIndex,e.leafletLayer.setZIndex=e.layer.zindex),t.zIndex=t.zIndex+2,!e.layer.hideLayerInControllerList){var a=$(FM.Util.replaceAll(FM.guiController.legend,"REPLACE",e.id)),i=a[0];L.Browser.touch?L.DomEvent.on(i,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(i),L.DomEvent.on(i,"mousewheel",L.DomEvent.stopPropagation)),t._fenixMap.$map.find(".leaflet-control-legend").append(a);var o="#"+t.suffix+"-controller-overlay-content",n="#"+e.id+"-controller-item",r=e.id+"-controller-item",l=FM.Util.replaceAll(FM.guiController.overlay,"REPLACE",e.id);$(o).prepend(l),$("#"+e.id+"-controller-item-box").data("layer",e);$("#"+e.id+"-controller-item-box").index()+1;t._layerGUIOptions(e),t.layersMap.set(e.id,e),t.layersMapZIndexes.set(e.layer.zindex,e.id),$(n+"-title").append(e.layer.layertitle),$(n+"-enabledisable").on("click",{id:e.id},function(e){t.showHide(e.data.id)});var s=1;null!=e.layer.opacity&&(s=e.layer.opacity),$(n+"-opacity").ionRangeSlider({min:.1,max:1,step:.1,hide_min_max:!0,hide_from_to:!0,from:s,onChange:function(t){FM.LayerUtils.setLayerOpacity(e,t.from)}});var d=$(n+"-getfeatureinfo");e.layer.enablegfi?(d.on("click",{id:e.id},function(e){var a=t.layersMap.get(e.data.id);t.selectedLayer.id==e.data.id?($("#"+t.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),t.selectedLayer="",a.layer.defaultgfi=!1):($("#"+t.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+e.data.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"),t.selectedLayer=a,a.layer.defaultgfi=!0)}),e.layer.defaultgfi&&(t.selectedLayer=e,$("#"+t.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+e.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"))):$(n+"-getfeatureinfo").css("display","none");var c=$(n+"-getlegend");null!=e.layer.showlegend&&0==e.layer.showlegend||c.on("click",{id:e.id,idToRender:r+"-getlegend"},function(e){var a=t.layersMap.get(e.data.id);FM.Legend.getLegend(a,e.data.idToRender)}),c.css("display","inline-block"),e.layer.layertype&&"JOIN"==e.layer.layertype&&(null==e.layer.switchjointype||e.layer.switchjointype)&&$(n+"-switchjointype").css("display","inline-block").on("click",{id:e.id},function(e){t.switchJoinType(e.data.id)});var p=$(n+"-swipe");p.on("click",{id:e.id},function(e){var a=t.layersMap.get(e.data.id);null!=a.layer.swipeActive&&a.layer.swipeActive?(FM.LayerSwipe.swipeDeactivate(a,t._map),p.removeClass("fm-icon-swipe-selected")):(FM.LayerSwipe.swipeActivate(a,t._fenixMap.suffix+"-handle",t._fenixMap.suffix+"-map",t._map),p.addClass("fm-icon-swipe-selected"))});var u=$(n+"-zoomtolayer");e.layer.zoomToBBOX&&(u.css("display","inline-block"),u.on("click",{id:e.id},function(e){var a=t.layersMap.get(e.data.id);FM.LayerUtils.zoomToLayer(t._map,a.layer)})),e.layer.zoomTo&&(u.css("display","inline-block"),u.on("click",{id:e.id},function(e){var a=t.layersMap.get(e.data.id);FM.LayerUtils.zoomToLayer(t._map,a.layer)}));var y=$(n+"-showhide-subicons"),f=$(n+"-subicons");y.on("click",function(e){f.slideToggle("fast"),y.hasClass("fm-icon-up")?(y.removeClass("fm-icon-up"),y.addClass("fm-icon-down")):(y.removeClass("fm-icon-down"),y.addClass("fm-icon-up"))})}},_layerGUIOptions:function(e){e.gui;"JOIN"==e.layer.layertype&&null!=e.layer.gui&&null!=e.layer.gui.nojoinlayerswitch&&e.layer.gui.nojoinlayerswitch&&$("#"+e.id+"-controller-item-switchjointype").css("display","none")},addBaseLayer:function(e){var t=this;e.layer.zindex=this.zIndexBaseLayer,this.zIndexBaseLayer=this.zIndexBaseLayer+2,this.baseLayersMap.set(e.id,e),this.layersMapZIndexes.set(e.layer.zindex,e.id);var a="#"+this.suffix+"-controller-baselayer-content",i="#"+e.id+"-controller-item",o=FM.Util.replaceAll(FM.guiController.baselayer,"REPLACE",e.id);o=FM.Util.replaceAll(o,"MAPID",this._fenixMap.id),$(a).append(o),$(i+"-title").append(e.layer.layertitle),t._guiController.layersthumbs?$("#"+e.id+"-controller-item-baselayer-image").addClass("fm-icon-baselayer-"+e.layer.layername):$("#"+e.id+"-controller-item-baselayer-image").remove(),$(i+"-enabledisable").on("click",{id:e.id},function(e){t.showHide(e.data.id)});var n=1;null!=e.layer.opacity&&(n=e.layer.opacity),$("#"+e.id+"-controller-box-item").on("click",{id:e.id},function(e){var a=e.data.id,i=t.baseLayersMap.get(a);t.removeBaseLayerByID(t.currentBaseLayer.id);var o=t.baseLayersMap.get(t.currentBaseLayer.id);$("#"+o.id+"-controller-box-item").removeClass("fm-controller-box-item-baselayer-content-selected"),$("#"+o.id+"-controller-item-opacity").hide(),$("#"+i.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+i.id+"-controller-item-opacity").show(),t._map.addLayer(i.leafletLayer),t.currentBaseLayer=i,t.setZIndex(i)}),1==this.baseLayersMap.count()&&($(i+"-radio").attr("checked",!0),this._map.addLayer(e.leafletLayer),this.currentBaseLayer=e,$("#"+e.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+e.id+"-controller-item-opacity").show(),t.setZIndex(e))},removeLayer:function(e){null!=e.layer.jointype&&"point"==e.layer.jointype?this.removeLayerPoint(e):this.removeLayerDefault(e)},removeLayerDefault:function(e){this._map.removeLayer(e.leafletLayer),this.layersMap.remove(e.id),this.layersMapZIndexes.remove(e.layer.zindex),$("#"+e.id+"-controller-item-box").remove(),$("#"+e.id+"-controller-item-getlegend-holder").remove()},removeLayerPoint:function(e){for(var t=0;t<e.layer.pointsLayers.length;t++)this._map.removeLayer(e.layer.pointsLayers[t]);this.layersMap.remove(e.id),this.layersMapZIndexes.remove(e.layer.zindex),$("#"+id+"-controller-item-box").remove()},removeBaseLayerByID:function(e){var t=this.baseLayersMap.get(e);this._map.removeLayer(t.leafletLayer)},switchJoinType:function(e){var t=this.layersMap.get(e);"point"==t.layer.jointype.toLowerCase()?this.switchToShaded(e):"shaded"==t.layer.jointype.toLowerCase()&&this.switchToPoint(e)},switchToPointswitchToPoint:function(e){var t=this.layersMap.get(e);t.layer.jointype="point",null!=t.leafletLayer&&this._map.removeLayer(t.leafletLayer),this._fenixMap.createPointLayerRequest(t)},switchToShaded:function(e){var t=this.layersMap.get(e);if(t.layer.jointype="shaded",null!=t.layer.pointsLayers)for(var a=0;a<t.layer.pointsLayers.length;a++)this._map.removeLayer(t.layer.pointsLayers[a]);this._fenixMap.createShadeLayerRequest(t)},showHide:function(e,t){try{var a=this.layersMap.get(e);a&&(a.layer.jointype&&"point"==a.layer.jointype.toLowerCase()?this.showHidePointLayer(e):this.showHideLayer(e,t))}catch(e){}},showHidePointLayer:function(e){for(var t=this.layersMap.get(e),a=0;a<t.layer.pointsLayers.length;a++)if(null==t.layer.visibility||t.layer.visibility){t.layer.visibility=!1,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-disable");for(var a=0;a<t.layer.pointsLayers.length;a++)this._map.removeLayer(t.layer.pointsLayers[a])}else{t.layer.visibility=!0,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-enable");for(var a=0;a<t.layer.pointsLayers.length;a++)this._map.addLayer(t.layer.pointsLayers[a])}},showHideLayer:function(e,t){try{var a=this.layersMap.get(e);null==t||t?null!=t&&t||(null==a.layer.visibility||a.layer.visibility?(a.layer.visibility=!1,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(a.leafletLayer)):(a.layer.visibility=!0,$("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-enable"),this._map.addLayer(a.leafletLayer),this.setZIndex(a))):0==a.layer.visibility&&($("#"+e+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+e+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(a.leafletLayer))}catch(e){}},updateZIndex:function(e,t){var a=this.layersMap.get(e);a.layer.zindex=t,a.leafletLayer.setZindex=t;try{document.getElementById(a.id).style.zIndex=t}catch(e){}},setZIndex:function(e){try{var t=document.getElementById(this._fenixMap.tilePaneID).childNodes;for(i=0,len=t.length;i<len;i++)if(t[i]!==this._container){var a=parseInt(t[i].style.zIndex,10);isNaN(a)&&(t[i].style.zIndex=e.layer.zindex,t[i].id=e.id)}}catch(e){}},selectGetFeatureInfoIcon:function(e){for(var t=0;t<this.layersMap.count();t++)this.layersMap._data[t]==e?$("#"+e+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"):$("#"+e+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected")},exportOverlays:function(){var e=[];this.layersMap.forEach(function(t){e.push(t.layer.zindex)}),e=e.sort();for(var t=[],a=0;a<e.length;a++){var i=!1;i||this.layersMap.forEach(function(o){o.layer.zindex==e[a]&&(t.push(o.layer),i=!0)})}var o=$.map(t,function(e){return $.extend(!0,{},e)});return o},exportBaselayers:function(){return null}}),FM.mapController=function(e,t,a,i){return new FM.MAPController(e,t,a,i)},FM.guiController={boxIcons:'<div id="REPLACE-controller-box-icons-container" class="fm-icon-box-background fm-controller-box-icons-container"></div>',boxMenu:'<div class="fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box" id="REPLACE-controller-box"><div id="REPLACE-controller-box-content" class="clearfix"></div></div>',baselayerIcon:'<div class="fm-box-zindex fx-toolbar-map-holder "><div class="fm-icon-sprite fm-baselayers" id="REPLACE-controller-baselayerIcon"><div></div>',baselayerBox:'<div class="fm-box-zindex fx-toolbar-map-holder " id="REPLACE-controller-baselayer-box"><div id="REPLACE-controller-baselayer-title" class="fm-controller-box-title">Baselayers</div><div id="REPLACE-controller-baselayer-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-baselayer-content" class="fm-controller-box-content"></div></div>',
baselayer:'<div id="REPLACE-controller-box-item" class="fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item-baselayer-content"><div id="REPLACE-controller-item"><div class="fm-controller-box-item-baselayer-image" id="REPLACE-controller-item-baselayer-image"></div><div class="fm-controller-box-item-baselayer-text"><div><label class="fm-controller-box-item-baselayer-text fm-controller-item-title" id="REPLACE-controller-item-title"><input id="REPLACE-controller-item-radio"  class="fm-checkbox-hide" type="radio" name="MAPID" value="REPLACE"><label></div><div style="clear:both"></div><div class="fm-opacity-slider-baselayers" id="REPLACE-controller-item-opacity" style="display:none"></div></div></div></div>',overlayIcon:"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>",overlayBox:'<div class="fm-box-zindex fx-toolbar-map-holder " id="REPLACE-controller-overlay-box"><div id="REPLACE-controller-overlay-title" class="fm-controller-box-title">Selected Layers</div><div id="REPLACE-controller-overlay-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-overlay-content" class="fm-controller-box-content"></div></div>',overlay:'<div id="REPLACE-controller-item-box" class="fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item"><div id="REPLACE-controller-item" class="fm-controller-box-header"><div class="fm-controller-box-header-text"><div class="fm-controller-item-title" id="REPLACE-controller-item-title" ></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-down" id="REPLACE-controller-item-showhide-subicons"></div></div><div style="clear:both"></div><div class="fm-controller-box-icons"><div class="fm-icon-enable" id="REPLACE-controller-item-enabledisable"></div><div class="fm-opacity-slider" style="margin-right:10px;" id="REPLACE-controller-item-opacity"></div></div><div style="clear:both"></div><div class="fm-controller-box-subicons" id="REPLACE-controller-item-subicons" style="display:none;"><div class="fm-icon-layer-subicons-sprite fm-icon-getlegend" id="REPLACE-controller-item-getlegend"></div><div class="fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo" id="REPLACE-controller-item-getfeatureinfo"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-switchjointype" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-zoomto" id="REPLACE-controller-item-zoomtolayer" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-swipe" id="REPLACE-controller-item-swipe"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-joinsettings" style="display:none"></div></div></div></div>',wmsLoaderIcon:"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>",wmsLoaderBox:'<div class="fm-box-zindex fx-toolbar-map-holder " id="REPLACE-controller-wmsLoader-box" style="display:none; min-height:300px;"><div id="REPLACE-controller-wmsLoader-title" class="fm-controller-box-title">WMS Loader</div><div id="REPLACE-controller-wmsLoader-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div class="clear:both"></div><div class="fm-WMSLoaderDropDown" id="REPLACE-controller-wmsLoader-dropdown"></div><div id="REPLACE-controller-wmsLoader-content" class="fm-controller-wmsLoader-content"></div></div>',wmsLoaderLayer:'<div id="REPLACE-WMSLayer-box" class="fm-WMSLayer-box"><div id="REPLACE-WMSLayer-icon" class="fm-controller-box-icon fm-icon-info"></div><div id="REPLACE-WMSLayer-title" class="fm-WMSLayer-title"></div></div>',legend:'<div class="fm-icon-box-background fm-box-legend" id="REPLACE-controller-item-getlegend-holder"><div class="fm-legend-title-content"><div id="REPLACE-controller-item-getlegend-legend-layertitle" class="fm-legend-layertitle"></div><div id="REPLACE-controller-item-getlegend-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-item-getlegend-legendtitle" class="fm-legendtitle"></div><div id="REPLACE-controller-item-getlegend-legendsubtitle" class="fm-legendsubtitle"></div><div id="REPLACE-controller-item-getlegend-content" ></div></div>',popUpJoinPoint:'<div class="fm-box fm-popup-join-point-holder" id="REPLACE-popup-join-point-holder" style="display:none"><div class="fm-popup-join-point-text" id="REPLACE-popup-join-point-text"></div><div class="fm-popup-join-point-value" id="REPLACE-popup-join-point-value"></div></div>'},FM.guiMap={disclaimerfao_en:'<div class="fm-disclaimerfao">The designations employed and the presentation of material in the maps  <br>do not imply the expression of any opinion whatsoever on the part of  <br>FAO concerning the legal or constitutional status of any country, <br>territory or sea area, or concerning the delimitation of frontiers.  <br>South Sudan declared its independence on July 9, 2011. <br>Due to data availability, the assessment presented in the map for Sudan  <br>and South Sudan reflects thesituation up to 2011 for the former Sudan.</div>',disclaimerfao_es:"",disclaimerfao_es_styled:'<div class="fm-disclaimerfao-text"></div>',disclaimerfao_fr:"",disclaimerfao_fr_styled:'<div class="fm-disclaimerfao-text"></div>'},FM.Layer=FM.Class.extend({_fenixmap:"",id:"",layer:{styles:"",srs:"EPSG:3857",visibility:!0,format:"image/png",transparent:"TRUE",opacity:1,name:"",tiitle:"",abstract:"",srs:"",LatLonBoundingBox:"",BoundingBox:"",Style:{name:"",title:"",abstract:"",legendurl:{format:"",onlineresource:""}},KeywordList:[],layertitle:"",enablegfi:!0,layertype:"WMS",openlegend:!1,legendOptions:{forceLabels:"on",forceRule:"true",dx:"0",dy:"0",mx:"0",my:"0",fontAntiAliasing:"true",fontColor:"0x47576F",bgColor:"0xF9F7F3",border:"false",fontSize:"15"},switchjointype:!1,lang:"EN"},leafletLayer:"",initialize:function(e,t){this.layer=$.extend(!0,{},this.layer,e),t&&(this.options=t),this.id=FM.Util.randomID(),e.joindata&&(e.defaultdata=e.joindata)},createLayerWMS:function(){var e=this._getWMSParameters();return this.leafletLayer?"WMS"===this.layertype&&this.leafletLayer.setParams(e):(e=this.options?$.extend(!0,{},this.options,e):e,this.layer.urlWMS&&(this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,e))),this.leafletLayer},createLayerWMSSLD:function(){var e=this._getWMSParameters();return this.leafletLayer?this.leafletLayer.setParams(e):this.layer.urlWMS&&(this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,e)),this.leafletLayer},_getWMSParameters:function(){var e={};return e.id=this.id,e.layers=this.layer.name?this.layer.name:this.layer.layers,e.format=this.layer.format,e.transparent=this.layer.transparent.toUpperCase(),e.visibility=this.layer.visibility,e.opacity=this.layer.opacity,e.styles=this.layer.styles,this.layer.style&&(e.styles=this.layer.style),this.layer.sldurl&&(e.sld=this.layer.sldurl),this.layer.cql_filter&&(e.cql_filter=this.layer.cql_filter),this.layer.sld_body&&(e.sld_body=this.layer.sld_body),this.layer.layers=this.layer.layername?this.layer.layername:this.layer.layers,e},redraw:function(e){var t=this;if(t.layer.layertype)switch(t.layer.layertype){case"JOIN":"SHADED"==t.layer.jointype.toLocaleUpperCase()?e?e.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this):"POINT"==t.layer.jointype.toLocaleUpperCase()&&console.log("TODO: handle redraw point");break;case"WMS":this.createLayerWMS(),this.leafletLayer.redraw();break;default:this.createLayerWMS(),this.leafletLayer.redraw()}},addPointLayer:function(e){e?e.addPointLayer(this):this._fenixmap&&this._fenixmap.addPointLayer(this)},addLayerWMS:function(e){e?e.addLayerWMS(this):this._fenixmap&&this._fenixmap.addLayerWMS(this)},addLayer:function(e){e?e.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this)},removeLayer:function(e){e?e.removeLayer(this):this._fenixmap&&this._fenixmap.removeLayer(this)},addShadedLayer:function(e){e?e.addShadedLayer(this):this._fenixmap&&this._fenixmap.addShadedLayer(this)}}),FM.layer=function(e,t,a){return new FM.Layer(e,t,a)},FM.TileLayer=FM.Layer.extend({createTileLayer:function(){var e=this.layer.layername?FM.TILELAYER[this.layer.layername]:FM.TILELAYER[this.layer.layers];this.layer.layertype="TILE",this.layer.layertitle=e["title_"+this.layer.lang.toLowerCase()];var t=new L.TileLayer(e.url);return t}}),FM.TileLayer.createBaseLayer=function(e,t){var a={};a.layername=e,a.layers=e,a.layertype="TILE",a.lang=t;var i=new FM.TileLayer(a);return i.leafletLayer=i.createTileLayer(a.layername),i},FM}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),!(void 0!==__WEBPACK_AMD_DEFINE_RESULT__&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__))}).call(exports,__webpack_require__(3))},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_9__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_10__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_11__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_12__},function(e,t,a){var i,o;i=[a(14),a(15)],o=function(e,t){"use strict";return{en:e,fr:t}}.apply(t,i),!(void 0!==o&&(e.exports=o))},function(e,t,a){!(e.exports={movelayerup:"Move layer up",movelayerdown:"Move layer down",removelayer:"Remove Layer",enabledisablelayer:"Enable/Disable layer",showhidelegend:"Show/Hide legend",getfeatureinfo:"Inspect layer",layeropacity:"Modify layer opacity",switchtopoint:"Switch to Point layer",switchtoshaded:"Switch to Shaded layer",confirmremovelayer:"Are you sure you want to remove the layer?",dragdroplayer:"Drag and Drop the layer<br>to sort the layer's list",baselayer:"Control BaseLayers",overlay:"Control Overlays",wmsLoader:"Control External WMS Servers",fullscreen:"Fullscreen",layersubicons:"Click to open the layer's menu",selectaWMSServer:"Select a WMS Server",addaWMSServer:"Add a WMS Server",nolegendavailable:"The legend is not available"})},function(e,t,a){!(e.exports={movelayerup:"Monter la couche de données",movelayerdown:"Baisser la couche de données",removelayer:"Effacer la couche de données",enabledisablelayer:"Activer/Désactiver la couche de données",showhidelegend:"Montrer/Cacher la legende",getfeatureinfo:"Inspecter la couche de données",layeropacity:"Modifier l'opacité de la couche",switchtopoint:"Mode couche de points",switchtoshaded:"Mode relief",confirmremovelayer:"Etes vous sur de vouloir éffacer cette couche?",dragdroplayer:"Glissez et déposez la couche<br>pour trier la liste de couches",baselayer:"Controle des couches de bases",overlay:"Controle des autres couches ",wmsLoader:"Controle des serveurs  WMS externes",fullscreen:"Plein ecran",layersubicons:"Cliquez pour ouvrir le menu des couches",selectaWMSServer:"Selectionnez un serveur WMS",addaWMSServer:"Ajoutez un serveur WMS",nolegendavailable:"Legende non disponible"})},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_16__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_17__},function(e,t){e.exports=__WEBPACK_EXTERNAL_MODULE_18__}])});
//# sourceMappingURL=fenix-ui-map-creator.min.js.map