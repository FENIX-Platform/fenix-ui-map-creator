{"version":3,"sources":["webpack:///fenix-ui-map-creator.min.js","webpack:///webpack/bootstrap 3ac9c5885898cd50cda0","webpack:///./src/js/index.js","webpack:///./src/js/fenix-ui-map.src.js","webpack:///external \"jquery\"","webpack:///external \"underscore\"","webpack:///external \"leaflet\"","webpack:///external \"hashmap\"","webpack:///external \"bootstrap\"","webpack:///external \"ion-rangeslider\"","webpack:///./src/nls/labels.js","webpack:///./src/nls/en/labels.js","webpack:///./src/nls/fr/labels.js","webpack:///external \"loglevel\"","webpack:///./src/config/errors.js","webpack:///./src/config/events.js","webpack:///./src/config/config.js","webpack:///external \"fenix-ui-pivotator\"","webpack:///external \"fenix-ui-pivotator-utils\"","webpack:///external \"amplify-pubsub\""],"names":["define","__WEBPACK_EXTERNAL_MODULE_3__","__WEBPACK_EXTERNAL_MODULE_4__","__WEBPACK_EXTERNAL_MODULE_5__","__WEBPACK_EXTERNAL_MODULE_6__","__WEBPACK_EXTERNAL_MODULE_7__","__WEBPACK_EXTERNAL_MODULE_8__","__WEBPACK_EXTERNAL_MODULE_12__","__WEBPACK_EXTERNAL_MODULE_16__","__WEBPACK_EXTERNAL_MODULE_17__","__WEBPACK_EXTERNAL_MODULE_18__","modules","__webpack_require__","moduleId","installedModules","exports","module","id","loaded","call","m","c","p","__WEBPACK_AMD_DEFINE_ARRAY__","__WEBPACK_AMD_DEFINE_RESULT__","$","_","log","ERR","EVT","C","FM","Pivotator","Fenixtool","amplify","MapCreator","o","info","extend","this","initial","_parseInput","fenix_ui_mapConfig","fenix_ui_map","valid","_validateInput","_initVariables","_bindEventListeners","_renderMap","error","prototype","on","channel","fn","context","_context","channels","push","callback","addBaseLayer","layer","fenixMap","addTileLayer","addLayer","model","L","TileLayer","map","errors","hasOwnProperty","metadata","createLayerFenixUid","createLayerFenixJoin","createLayerFenix","layertitle","legendtitle","removeLayer","status","ready","invalidateSize","$el","el","pc","aggregationFn","aggregations","hidden","columns","x","values","y","rows","series","formatter","valueOutputType","showRowHeaders","decimals","showCode","showFlag","showUnit","pivotatorConfig","window","fx_map_id","String","warn","length","code","MISSING_CONTAINER","pivotator","fenixTool","subscribe","_getEventName","WINDOW_RESIZE","self","Map","createMap","leafletMap","uid","setTimeout","bind","_trigger","args","Array","slice","arguments","i","l","subscription","apply","evt","concat","_unbindEventListeners","unsubscribe","dispose","destroyMap","empty","options","Error","layers","dsd","workspace","layerName","urlWMS","DEFAULT_WMS_SERVER","en","opacity","_validateJoinInput","getJoinLayer","join","style","defPopup","joincolumnlabel","joincolumn","lang","popupBuilder","customgfi","showpopup","content","EN","isFunction","codes","joindata","forEach","keys","key","isNumber","parseInt","zoomlayer","split","zoomTo","colorRamp","colorramp","geoColumn","valueColumn","muColumn","col","index","subject","geoSubject","valueSubject","muSubject","column","_validateJoinColumnInput","codelist","toLowerCase","layerMapping","idCodeList","referenceArea","getJoinData","measurementunit","console","data","geoColumnIndex","valueColumnIhdex","cachedValues","row","obj","value","dataType","Object","undefined","jQuery","HashMap","Bootstrap","Rangeslider","i18n","CONFIG","MAP_SERVICE_SHADED","MAP_SERVICE_GFI_STANDARD","ZOOM_TO_BBOX","BASEURL_MAPS","MAP_SERVICE_WMS_GET_CAPABILITIES","LAYER_BOUNDARIES","LAYER_LABELS","FMCONFIG","Class","props","NewClass","initialize","_initHooks","callInitHooks","F","proto","constructor","statics","includes","Util","parent","_initHooksCalled","len","include","mergeOptions","addInitHook","init","dest","j","src","sources","stamp","lastId","limitExecByInterval","time","lock","execOnUnlock","wrapperFn","falseFn","formatNum","num","digits","pow","Math","round","splitWords","str","replace","setOptions","getParamString","existingUrl","params","indexOf","template","isArray","toString","emptyImageUrl","getPrefixed","name","prefixes","timeoutDefer","Date","timeToCall","max","lastTime","requestFn","requestAnimationFrame","cancelFn","cancelAnimationFrame","clearTimeout","requestAnimFrame","immediate","element","cancelAnimFrame","replaceAll","text","stringToFind","stringToReplace","RegExp","parseLayerRequest","layerValues","eval","layerRequest","each","randomID","randLetter","random","substring","now","toLocaleLowerCase","fire","item","type","document","createEvent","initCustomEvent","dispatchEvent","addEventListener","loadModuleLibs","UIUtils","loadingPanel","height","h","getElementById","innerHTML","WMSUtils","_divID","_dropdowndID","_outputID","_fenixMap","_wmsServers","_mapID","_lang","WMSCapabilities","divID","outputID","fenixmap","wmsServers","_fenixmap","_createWMSDropDown","dropdowndID","html","url","label","append","chosen","disable_search_threshold","width","e","_this","change","event","_createWMSOutputRequest","val","wmsServerURL","ajax","success","response","xmlResponse","parseXML","_createWMSOutput","find","children","layername","styles","srs","crs","openlegend","rand","layerPanel","guiController","wmsLoaderLayer","FMPopUp","parentID","_layer","_tmpLayer","hoverIntent","over","out","timeout","addWMSServer","_WMSCapabilities","_createWMSDropwDown","click","addLayerWMS","WFSCapabilities","_createWFSDropwDown","fullScreenApi","supportsFullScreen","isFullScreen","requestFullScreen","cancelFullScreen","fullScreenEventName","prefix","browserPrefixes","exitFullscreen","il","fullScreen","webkitIsFullScreen","requestFullscreen","FMDEFAULTLAYER","getLayer","layertype","isjoin","toUpperCase","_getGAUL","_getWMSLayer","geometrycolumn","joinboundary","joinDefaultPopUp","joinlabel","fr","es","output","show","custompopup","outputid","TILELAYER","OSM","title_en","OSM_GRAYSCALE","MAPQUEST","MAPQUEST_NASA_AERIAL","ESRI_WORLDSTREETMAP","ESRI_WORLDTERRAINBASE","ACETATE_LABELS","ACETATE_TERRAIN","STAMEN_TONER_BACKGROUND","ESRI_HISTORICAL_MERCATOR","WMSSERVERS","DEFAULT_EXTERNAL_WMS_SERVERS","label_EN","urlParameters","suffix","mapContainerID","tilePaneID","controller","plugins","container","overlay","baselayer","wmsLoader","enablegfi","layersthumbs","fullscreen","zoomcontrol","scalecontrol","legendcontrol","disclaimerfao","baselayers","boundaries","labels","legendOptions","zoomToCountry","highlightCountry","color","weight","fillColor","fillOpacity","mapOptions","zoomControl","attributionControl","center","lat","lng","zoom","mapID","mapDIV","$map","setTilePaneID","mapController","initializeGUI","getFeatureInfo","control","Control","onAdd","addTo","popUpJoinPoint","initStyles","getStyle","className","ret","styleSheets","classes","rules","cssRules","selectorText","cssText","addClass","prependTo","fenixStyles","setView","LatLng","initializePlugins","layeropts","lurl","leafletLayer","layerBoundaries","hideLayerInControllerList","layerLabels","tileLayer","attribution","subdomains","maxZoom","highlightLayer","geoJson","feature","boundariesShow","labelsShow","remove","childNodes","childNodes2","attr","isBaseLayer","layerAdded","setZIndex","jointype","toLocaleUpperCase","addShadedLayer","addPointLayer","createLayerWMS","_openlegend","showHide","createShadeLayerRequest","isadded","isReload","css","JSON","stringify","contentType","_createShadeLayer","parseJSON","sldurl","geoserverwms","legendHTML","createLayerWMSSLD","_loadLayer","redraw","reAddLayer","Legend","getLegend","war","createPointLayerRequest","slideUp","r","RequestHandler","open","setContentType","request","onload","_createPointLayer","responseText","send","onerror","pointsLayers","pointsJSON","_refreshPointLayer","latlon","lon","properties","measurementuni","pointColor","pointFillColor","pointFillOpacity","marker","CircleMarker","setRadius","radius","bindPopup","title","hide","syncOnMove","mapToSync","MapUtils","syncMapsOnMove","selectedLayer","SpatialQuery","getFeatureInfoJoin","layerPoint","latlng","getFeatureInfoStandard","pname","invoke","Plugins","cloneMap","exportedMap","exportMap","clonedMap","createMapFromJSON","json","loadOverlays","overlays","_getMapOptions","_getMapLayers","exportMapToJSONFile","uriContent","encodeURIComponent","_window","focus","_getCurrentMapOptions","exportOverlays","bringToFront","labelsHide","boundariesHide","codif","rootUrl","clearLayers","cbName","uniqueId","defaultParameters","service","version","typeName","maxFeatures","outputFormat","format_options","viewparams","parameters","jsonpCallback","addData","LayerUtils","setLayerOpacity","setOpacity","filterLayerMinEqualThan","getValuesMinEqualThan","filterLayerGreaterEqualThan","getValuesGreaterEqualThan","filterLayerInBetweenEqualThan","min","getValuesInBetweenEqualThan","filterLayerOuterEqualThan","getValuesOuterEqualThan","defaultdata","k","v","forceLabels","forceRule","dx","dy","mx","my","fontAntiAliasing","fontColor","bgColor","border","fontSize","legendsubtitle","alternativeUrl","_loadLegend","is","slideDown","img","Image","_nolegend","mToSync","getCenter","getZoom","exportLayers","fitBounds","fitWorldByScreen","bounds","worldBounds","latLngBounds","targetBounds","LatLngBounds","GLOBE_WIDTH","GLOBE_HEIGHT","west","getSouthWest","east","getNorthEast","angleW","north","south","angleH","mapW","getSize","mapH","zoomW","LN2","zoomH","setZoom","animate","_addzoomcontrol","pos","Zoom","position","_addfullscreen","zoompos","div","DomUtil","create","a","DomEvent","disableClickPropagation","addListener","idDiv","mapdiv","_addzoomresetcontrol","zoomresetcontrol","_container","d","display","_adddisclaimerfao","guiMap","tooltip","placement","_addlayercontroller","_addgeosearch","GeoSearch","provider","Provider","OpenStreetMap","_addgeocoder","OSMGeocoder","Conpluginstrol","_addmouseposition","mousePosition","_addexport","Export","addControl","_addprintmodule","print","printProvider","method","autoLoad","dpi","printControl","_adddrawcontrol","Draw","drawnItems","FeatureGroup","drawControl","draw","polygon","allowIntersection","drawError","shapeOptions","circle","edit","featureGroup","layerType","spatialQuery","countOfEditedLayers","eachLayer","_addcontrolloading","loading","loadingControl","separate","_addscalecontrol","Scale","scale","_addlegendcontrol","getBounds","sw","project","ne","BBOX","WIDTH","HEIGHT","X","layerPointToContainerPoint","Y","Number","toFixed","getFeatureInfoJoinRequest","customPopup","mu","_parseHTML","joinid","responsetable","_customizePopUp","requestType","_map","_l","maxWidth","maxHeight","popup","Popup","result","transposeHTMLTable","_checkGeoserverDefaultEmptyOutput","setLatLng","setContent","openPopup","tableHTML","headersHTML","rowsData","headersHTMLIndexs","headersHTMLJOINIndexs","htmlresult","header","checkJoinData","_getJoinValueFromCode","decimalvalues","integerCode","array","match","table","transposeHTML","headers","t","tb","tr","td","LayerSwipe","swipeActivate","handleID","containerID","setDivide","handle","left","layerX","containerPointToLayerPoint","l_parent","clip","swipeActive","dragging","onmousedown","onmouseup","onmousemove","mousemoveSwipe","containerPoint","mydiv","swipeDeactivate","off","MAPController","_guiController","baseLayersMap","currentBaseLayer","layersMap","layersMapZIndexes","zIndexBaseLayer","zIndex","$boxIcons","$boxMenu","$boxMenuContainer","$boxMenuSelected","getFeautureInfoLayer","guiOpts","boxMenu","boxIcons","visibleBoxMenu","$div","Browser","touch","stopPropagation","loadIcon","initializeOverlayDragging","wmsUtils","idDD","idContent","toLoad","visibleBox","guiBox","guiIcon","$boxIcon","appendTo","$id","zindex","$legend","legend","idStructure","idItem","idControllerItem","overlayStructure","prepend","_layerGUIOptions","set","ionRangeSlider","step","hide_min_max","hide_from_to","from","onChange","$layergfi","get","removeClass","defaultgfi","$getlegend","showlegend","idToRender","switchjointype","switchJoinType","$swipelayer","$zoomtolayer","zoomToBBOX","zoomToLayer","$subiconsshowhide","$subiconscontainer","slideToggle","hasClass","gui","nojoinlayerswitch","removeBaseLayerByID","oldBaseLayer","count","removeLayerPoint","removeLayerDefault","switchToShaded","switchToPoint","switchToPointswitchToPoint","showHidePointLayer","showHideLayer","visibility","updateZIndex","layerID","updatedZIndex","setZindex","isNaN","selectGetFeatureInfoIcon","_data","arrayZindex","sort","arrayLayers","found","clonedArray","exportBaselayers","baselayerIcon","baselayerBox","overlayIcon","overlayBox","wmsLoaderIcon","wmsLoaderBox","disclaimerfao_en","disclaimerfao_es","disclaimerfao_es_styled","disclaimerfao_fr","disclaimerfao_fr_styled","Layer","format","transparent","tiitle","abstract","LatLonBoundingBox","BoundingBox","Style","legendurl","onlineresource","KeywordList","wmsParameters","_getWMSParameters","setParams","WMS","sld","cql_filter","sld_body","createTileLayer","createBaseLayer","i18nEn","i18nFr","movelayerup","movelayerdown","removelayer","enabledisablelayer","showhidelegend","getfeatureinfo","layeropacity","switchtopoint","switchtoshaded","confirmremovelayer","dragdroplayer","layersubicons","selectaWMSServer","addaWMSServer","nolegendavailable","WMS_URL","wms","geosearch","mouseposition","controlloading","leaflet","minZoom","gaul0","escap_area","gaul1","uae_gaul","gaul_adm1","faostat_countrycodes","faostat_countries","gaul","uneca_partner","gaul1_afg","iso3","uneca_iso3"],"mappings":"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","file":"fenix-ui-map-creator.min.js","sourcesContent":["define([\"jquery\",\"underscore\",\"leaflet\",\"hashmap\",\"bootstrap\",\"ion-rangeslider\",\"loglevel\",\"fenix-ui-pivotator\",\"fenix-ui-pivotator-utils\",\"amplify-pubsub\"], function(__WEBPACK_EXTERNAL_MODULE_3__, __WEBPACK_EXTERNAL_MODULE_4__, __WEBPACK_EXTERNAL_MODULE_5__, __WEBPACK_EXTERNAL_MODULE_6__, __WEBPACK_EXTERNAL_MODULE_7__, __WEBPACK_EXTERNAL_MODULE_8__, __WEBPACK_EXTERNAL_MODULE_12__, __WEBPACK_EXTERNAL_MODULE_16__, __WEBPACK_EXTERNAL_MODULE_17__, __WEBPACK_EXTERNAL_MODULE_18__) { return /******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId])\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\texports: {},\n/******/ \t\t\tid: moduleId,\n/******/ \t\t\tloaded: false\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.loaded = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(0);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tmodule.exports = __webpack_require__(1);\n\n\n/***/ },\n/* 1 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tvar __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_ARRAY__ = [\n\t    __webpack_require__(3),\n\t    __webpack_require__(4),\n\t    __webpack_require__(12),\n\t    __webpack_require__(13),\n\t    __webpack_require__(14),\n\t    __webpack_require__(15),\n\t    __webpack_require__(2),\n\t    __webpack_require__(16),\n\t    __webpack_require__(17),\n\t    __webpack_require__(18)\n\t], __WEBPACK_AMD_DEFINE_RESULT__ = function ($, _, log, ERR, EVT, C, FM, Pivotator, Fenixtool, amplify) {\n\t\n\t    'use strict';\n\t\n\t    function MapCreator(o) {\n\t\n\t        log.info(\"FENIX MapCreator\");\n\t        log.info(o);\n\t\n\t        _.extend(this, C, {initial: o});\n\t\n\t        __webpack_require__(19);\n\t\n\t        this._parseInput(o);\n\t\n\t        this.fenix_ui_mapConfig = o.fenix_ui_map;\n\t\n\t        var valid = this._validateInput();\n\t\n\t        if (valid === true) {\n\t\n\t            this._initVariables();\n\t\n\t            this._bindEventListeners();\n\t\n\t            this._renderMap();\n\t\n\t            return this;\n\t\n\t        } else {\n\t            log.error(\"Impossible to create MapCreator\");\n\t            log.error(valid)\n\t        }\n\t\n\t    }\n\t\n\t    // API\n\t\n\t    /**\n\t     * pub/sub\n\t     * @return {Object} component instance\n\t     */\n\t    MapCreator.prototype.on = function (channel, fn, context) {\n\t        var _context = context || this;\n\t        if (!this.channels[channel]) {\n\t            this.channels[channel] = [];\n\t        }\n\t        this.channels[channel].push({context: _context, callback: fn});\n\t        return this;\n\t    };\n\t\n\t    /**\n\t     * Add a base layer to map\n\t     */\n\t    MapCreator.prototype.addBaseLayer = function (layer) {\n\t\n\t        this.fenixMap.addTileLayer(layer, true);\n\t\n\t        return this;\n\t    };\n\t    /**\n\t     * Add a layer to map\n\t     */\n\t    MapCreator.prototype.addLayer = function (model) {\n\t\n\t        var layer;\n\t\n\t        if (!model)\n\t            return false;\n\t\n\t        //support simple Leaflet layer\n\t        if (model instanceof L.TileLayer)\n\t            return this.fenixMap.map.addLayer(model);\n\t\n\t        // TODO: switch to check if it's a fenix layer\n\t        if (this.errors && (!model || !model.hasOwnProperty(\"metadata\") ))\n\t            this.errors.metadata = \"Model does not contain 'metadata' attribute.\";\n\t\n\t        if (typeof model === 'string')\n\t            layer = this.createLayerFenixUid(model);\n\t\n\t        else if (model.hasOwnProperty('data'))\n\t            layer = this.createLayerFenixJoin(model);\n\t\n\t        else\n\t            layer = this.createLayerFenix(model);\n\t\n\t        layer = new FM.layer(layer);\n\t\n\t        if (typeof model === 'object' && model['metadata'] && model['metadata']['title'] && model['metadata']['title']['EN'])\n\t            layer.layer.layertitle = model['metadata']['title']['EN'];\n\t\n\t        if (this.initial.legendtitle)\n\t            layer.layer.layertitle = this.initial.legendtitle;\n\t\n\t        this.fenixMap.addLayer(layer);\n\t\n\t        return layer;\n\t    };\n\t\n\t    /**\n\t     * Remove a layer from map\n\t     */\n\t    MapCreator.prototype.removeLayer = function (layer) {\n\t\n\t        if (this.status.ready !== true) {\n\t            return;\n\t        }\n\t\n\t        return this;\n\t    };\n\t\n\t    /**\n\t     * Invalidate map size\n\t     */\n\t    MapCreator.prototype.invalidateSize = function () {\n\t\n\t        if (this.status.ready !== true) {\n\t            return;\n\t        }\n\t\n\t        this.fenixMap.invalidateSize()\n\t\n\t        return this;\n\t    };\n\t\n\t    // end API\n\t\n\t    MapCreator.prototype._parseInput = function () {\n\t\n\t        this.id = this.initial.id;\n\t        this.$el = $(this.initial.el);\n\t        this.model = this.initial.model;\n\t\n\t        //pivotator config\n\t        var pc = {};\n\t\n\t        pc.aggregationFn = this.initial.aggregationFn;\n\t\n\t        pc.aggregations = this.initial.aggregations || [];\n\t        pc.hidden = this.initial.hidden || [];\n\t        pc.columns = this.initial.x;\n\t        pc.values = this.initial.y || [\"value\"];\n\t        pc.rows = this.initial.series;\n\t\n\t        pc.formatter = this.initial.formatter || \"value\";\n\t        pc.valueOutputType = this.initial.valueOutputType;\n\t        pc.showRowHeaders = this.initial.showRowHeaders || false;\n\t        pc.decimals = this.initial.decimals || 2;\n\t\n\t        pc.showCode = this.initial.showCode || false;\n\t        pc.showFlag = this.initial.showFlag || false;\n\t        pc.showUnit = this.initial.showUnit || false;\n\t\n\t        // add more pivotator config\n\t\n\t        this.pivotatorConfig = pc;\n\t\n\t    };\n\t\n\t    MapCreator.prototype._validateInput = function () {\n\t\n\t        var valid = true,\n\t            errors = [];\n\t\n\t        //set MapCreator id\n\t        if (!this.id) {\n\t\n\t            window.fx_map_id >= 0 ? window.fx_map_id++ : window.fx_map_id = 0;\n\t            this.id = String(window.fx_map_id);\n\t            log.warn(\"Impossible to find MapCreator id. Set auto id to: \" + this.id);\n\t        }\n\t\n\t        //Check if $el exist\n\t        if (this.$el.length === 0) {\n\t            errors.push({code: ERR.MISSING_CONTAINER});\n\t            log.warn(\"Impossible to find box container\");\n\t        }\n\t\n\t        return errors.length > 0 ? errors : valid;\n\t\n\t    };\n\t\n\t    MapCreator.prototype._initVariables = function () {\n\t\n\t        //pub/sub\n\t        this.channels = {};\n\t\n\t        this.status = {};\n\t        this.status.ready = false;\n\t\n\t        this.pivotator = new Pivotator();\n\t        this.fenixTool = new Fenixtool();\n\t    };\n\t\n\t    MapCreator.prototype._bindEventListeners = function () {\n\t\n\t        amplify.subscribe(this._getEventName(EVT.WINDOW_RESIZE), this, this.invalidateSize);\n\t    };\n\t\n\t    MapCreator.prototype._renderMap = function () {\n\t\n\t        var self = this;\n\t\n\t        //var myPivotatorConfig=this.fenixTool.parseInut(this.initial.model.metadata.dsd, this.pivotatorConfig);\n\t        //var model = this.pivotator.pivot(this.model, this.pivotatorConfig);\n\t\n\t        self.fenixMap = new FM.Map(self.$el, self.fenix_ui_mapConfig);\n\t        self.fenixMap.createMap();\n\t\n\t        self.leafletMap = self.fenixMap.map;\n\t\n\t        if (self.model) {\n\t            self.addLayer(self.model);\n\t        }\n\t        else if (this.initial.uid) {\n\t            self.addLayer(this.initial.uid);\n\t        }\n\t\n\t\n\t        //TODO bind to Leaflet whenReady\n\t        self.status.ready = true;  //To be set on map ready event\n\t\n\t        setTimeout(_.bind(function () {\n\t            self._trigger('ready');\n\t        }, self), 0);\n\t    };\n\t\n\t    MapCreator.prototype._trigger = function (channel) {\n\t\n\t        if (!this.channels[channel]) {\n\t            return false;\n\t        }\n\t        var args = Array.prototype.slice.call(arguments, 1);\n\t        for (var i = 0, l = this.channels[channel].length; i < l; i++) {\n\t            var subscription = this.channels[channel][i];\n\t            subscription.callback.apply(subscription.context, args);\n\t        }\n\t\n\t        return this;\n\t    };\n\t\n\t    MapCreator.prototype._getEventName = function (evt) {\n\t\n\t        return this.id.concat(evt);\n\t\n\t    };\n\t\n\t    MapCreator.prototype._unbindEventListeners = function () {\n\t\n\t        amplify.unsubscribe(this._getEventName(EVT.WINDOW_RESIZE), this.invalidateSize);\n\t    };\n\t\n\t    MapCreator.prototype.dispose = function () {\n\t\n\t        //unbind event listeners\n\t        this._unbindEventListeners();\n\t\n\t        if (this.status.ready === true) {\n\t            this.fenixMap.destroyMap();\n\t        }\n\t\n\t        this.$el.empty();\n\t\n\t    };\n\t\n\t    MapCreator.prototype.createLayerFenix = function (model, options) {\n\t        var metadata = model.metadata;\n\t        var layer = {};\n\t        // Define the layer\n\t        if (metadata.hasOwnProperty(\"dsd\")) {\n\t            layer.layers = \"\";\n\t            if (metadata.dsd.hasOwnProperty(\"workspace\"))\n\t                layer.layers += metadata.dsd.workspace + \":\";\n\t\n\t            layer.layers += metadata.dsd.layerName;\n\t        }\n\t        else {\n\t            this.errors['dsd'] = \"Model['metadata'] does not contain 'dsd' attribute.\";\n\t            throw new Error(\"FENIX Map creator has not a valid configuration\");\n\t        }\n\t\n\t        //TODO\n\t        //if (model.hasOwnProperty(\"datasource\"))\n\t        //  layer.urlWMS = metadata[\"datasource\"];\n\t\n\t        layer.urlWMS = this.fenix_ui_map.DEFAULT_WMS_SERVER;\n\t        layer.layertitle = {\n\t            en: 'Data Layer'\n\t        };\n\t        layer.opacity = '0.9';\n\t        return layer;\n\t    };\n\t\n\t    MapCreator.prototype.createLayerFenixUid = function (uid) {\n\t        var layer = {\n\t            urlWMS: this.DEFAULT_WMS_SERVER,\n\t            layertitle: {\n\t                en: 'Data Layer'\n\t            },\n\t            opacity: '0.9',\n\t            layers: uid\n\t        };\n\t        return layer;\n\t    };\n\t\n\t    // JOIN\n\t    MapCreator.prototype.createLayerFenixJoin = function (model) {\n\t\n\t        if (this._validateJoinInput(model) === true) {\n\t\n\t            // create the join layer\n\t            var layer = this.getJoinLayer(model);\n\t\n\t            _.extend(layer, this.join.style);\n\t\n\t            var defPopup = \"<div class='fm-popup'>{{\" + layer.joincolumnlabel + \"}}\" +\n\t                \"<div class='fm-popup-join-content'>{{{\" + layer.joincolumn + \"}}} \" +\n\t                \"{{measurementunit}}\" +\n\t                \"</div></div>\";\n\t\n\t\n\t            // Layer title TODO: Add title if exist (check in the validator)\n\t            if (model['metadata'].hasOwnProperty(\"title\")) {\n\t                if (model['metadata']['title'][this.lang]) {\n\t                    layer.layertitle = model['metadata']['title'][this.lang];\n\t                    //console.log('title',this.lang, layer.layertitle)\n\t                }\n\t            }\n\t            else {\n\t                layer.layertitle = model['metadata']['uid'];\n\t            }\n\t\n\t            // getting a title from the options\n\t            if (this.hasOwnProperty('layer') && this.layer.hasOwnProperty('layertitle')) {\n\t                layer.layertitle = this.layer.layertitle;\n\t            }\n\t\n\t            if (this.hasOwnProperty('layer') && this.layer.hasOwnProperty('popupBuilder')) {\n\t                layer.popupBuilder = this.layer.popupBuilder;\n\t            }\n\t\n\t            layer.customgfi = {\n\t                showpopup: true,\n\t                content: {\n\t                    EN: _.isFunction(layer.popupBuilder) ? layer.popupBuilder(layer.joincolumnlabel, layer.joincolumn) : defPopup\n\t                }\n\t            };\n\t\n\t            // TODO: add check on the zoomto data (move it to a function)\n\t            var codes = [];\n\t            layer.joindata.forEach(function (code) {\n\t                _.keys(code).forEach(function (key) {\n\t                    if (_.isNumber(parseInt(key)))\n\t                        codes.push(key);\n\t                });\n\t            });\n\t\n\t            var zoomlayer = layer.layers.split(\":\");\n\t\n\t            zoomlayer = zoomlayer.length > 1 ? zoomlayer[1] : zoomlayer[0];\n\t\n\t            this.fenixMap.zoomTo(zoomlayer, layer.joincolumn, codes);\n\t\n\t            if (this.initial.colorRamp)\n\t                layer.colorramp = this.initial.colorRamp;\n\t\n\t            return layer;\n\t\n\t        } else {\n\t            //console.error(this.errors);\n\t            //throw new Error(\"FENIX Map creator has not a valid JOIN configuration\");\n\t        }\n\t    };\n\t\n\t    MapCreator.prototype.getJoinLayer = function (model) {\n\t\n\t        var metadata = model['metadata'],\n\t            geoColumn = {},\n\t            valueColumn = {},\n\t            muColumn = {};\n\t\n\t        metadata['dsd']['columns'].forEach(_.bind(function (col, index) {\n\t            if (col.subject === this.geoSubject || col.id === this.geoSubject) {\n\t                geoColumn = col;\n\t                geoColumn.index = index;\n\t            }\n\t            if (col.subject === this.valueSubject || col.id === this.valueSubject) {\n\t                valueColumn = col;\n\t                valueColumn.index = index;\n\t            }\n\t            if (col.subject === this.muSubject) {\n\t                muColumn = col;\n\t                muColumn.index = index;\n\t            }\n\t        }, this));\n\t\n\t        // getting the right measurement unit if the new label exists\n\t        metadata['dsd']['columns'].forEach(_.bind(function (column, index) {\n\t            if (muColumn.id + '_' + this.lang) {\n\t                muColumn = column;\n\t                muColumn.index = index;\n\t            }\n\t        }, this));\n\t\n\t\n\t        if (this._validateJoinColumnInput(geoColumn)) {\n\t\n\t\n\t            var layer = null;\n\t            var codelist = geoColumn['domain']['codes'][0]['idCodeList'].toLowerCase();\n\t\n\t            if (this.join.layerMapping[codelist]) {\n\t                layer = this.join.layerMapping[codelist];\n\t            }\n\t            else {\n\t                geoColumn['domain']['codes'][0].idCodeList.toLowerCase();\n\t                // TODO: Handle reference Area\n\t                var referenceArea = metadata[\"meContent\"][\"seReferencePopulation\"][\"referenceArea\"]['codes'][0].code.toLowerCase();\n\t                layer = this.join.layerMapping[codelist + \"_\" + referenceArea];\n\t            }\n\t\n\t            // check measurementunit\n\t            // TODO: Add measurement unit to the layer definition (using label column of the mu)\n\t\n\t            // get joinData\n\t            layer.joindata = this.getJoinData(model['data'], geoColumn.index, valueColumn.index);\n\t\n\t            // TODO: check on the column index\n\t            layer.measurementunit = model['data'][0][muColumn.index];\n\t\n\t            // TODO: check if is the right legendtitle\n\t            layer.legendtitle = layer.measurementunit;\n\t\n\t            layer.layertitle = 'OCD';\n\t            //layer.legendtitle = 'ODA';\n\t\n\t            return layer;\n\t\n\t        } else {\n\t            console.error('Error JoinColumnInput not valid')\n\t        }\n\t    };\n\t\n\t    MapCreator.prototype.getJoinData = function (data, geoColumnIndex, valueColumnIhdex) {\n\t        var joindata = [];\n\t\n\t        // TODO: remove cachedValues on final version. Check on join data consistency?\n\t        var cachedValues = {}\n\t        // TODO: add on check\n\t        data.forEach(_.bind(function (row) {\n\t            var obj = {}\n\t            var code = row[geoColumnIndex];\n\t            var value = row[valueColumnIhdex];\n\t            if (code && value) {\n\t                obj[code] = value;\n\t                if (!cachedValues.hasOwnProperty(code)) {\n\t                    // check null values\n\t                    cachedValues[code] = true;\n\t                    joindata.push(obj);\n\t                }\n\t            }\n\t        }, this));\n\t\n\t        return joindata;\n\t    };\n\t\n\t    MapCreator.prototype._validateJoinInput = function (model) {\n\t        this.errors = {};\n\t\n\t        //Metadata TODO: add all metadata checks\n\t        if (!model.hasOwnProperty(\"metadata\")) {\n\t            this.errors.metadata = \"'metadata' attribute not present.\";\n\t        }\n\t\n\t        //Data\n\t        if (!model.hasOwnProperty(\"data\")) {\n\t            this.errors.data = \"'data' attribute not present.\";\n\t        }\n\t\n\t        return (_.keys(this.errors).length === 0);\n\t    };\n\t\n\t    MapCreator.prototype._validateJoinColumnInput = function (column) {\n\t        this.errors = {};\n\t\n\t        //Metadata TODO: add all metadata checks\n\t        if (!column.hasOwnProperty('key')) {\n\t            this.errors.column = \"'key' attribute not present.\";\n\t        }\n\t        else {\n\t            if (column.key !== true) {\n\t                this.errors.column = \"'key' is not true.\";\n\t            }\n\t        }\n\t\n\t        if (!column.hasOwnProperty('dataType')) {\n\t            this.errors.column = \"'dataType' attribute not present.\";\n\t        }\n\t        else {\n\t            if (column.dataType !== 'code') {\n\t                this.errors.column = \"'dataType' attribute is not a coding system.\";\n\t            }\n\t        }\n\t\n\t        // TODO: check domain and referencearea if needed\n\t\n\t        return (Object.keys(this.errors).length === 0);\n\t    };\n\t\n\t    return MapCreator;\n\t}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));\n\n/***/ },\n/* 2 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tvar __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;/* WEBPACK VAR INJECTION */(function(jQuery) {\n\t!(__WEBPACK_AMD_DEFINE_ARRAY__ = [\n\t    __webpack_require__(3),__webpack_require__(4),__webpack_require__(5),__webpack_require__(6),__webpack_require__(7),__webpack_require__(8),\n\t    __webpack_require__(9)\n\t    ], __WEBPACK_AMD_DEFINE_RESULT__ = function($, _, L, HashMap, Bootstrap, Rangeslider, i18n) {\n\t\n\tvar FM = {};\n\t\n\tFM.CONFIG = {\n\t\n\t\tMAP_SERVICE_SHADED: 'http://fenix.fao.org/test/geo/fenix/mapclassify/join/',\n\t\tDEFAULT_WMS_SERVER: 'http://fenix.fao.org/demo/fenix/geoserver',\n\t\n\t\tMAP_SERVICE_GFI_STANDARD: 'http://fenix.fao.org/test/geo/fenix/mapclassify/request/',\n\t\n\t\tZOOM_TO_BBOX: 'http://fenix.fao.org/geo/fenix/spatialquery/db/spatial/bbox/layer/',\n\t\n\t\tBASEURL_MAPS: 'http://fenixapps2.fao.org/maps-demo',\n\t\n\t\tMAP_SERVICE_WMS_GET_CAPABILITIES: 'http://fenixapps2.fao.org/maps-demo/rest/service/request',\n\t\n\t\tLAYER_BOUNDARIES: 'fenix:gaul0_line_3857',\n\t\tLAYER_LABELS: 'http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png',\n\t};\n\t\n\tFMCONFIG = FM.CONFIG;;\n\tFM.Class = function () {};\n\t\n\tFM.Class.extend = function (props) {\n\t\n\t    // extended class with the new prototype\n\t    var NewClass = function () {\n\t\n\t        // call the constructor\n\t        if (this.initialize) {\n\t            this.initialize.apply(this, arguments);\n\t        }\n\t\n\t        // call all constructor hooks\n\t        if (this._initHooks) {\n\t            this.callInitHooks();\n\t        }\n\t    };\n\t\n\t    // instantiate class without calling constructor\n\t    var F = function () {};\n\t    F.prototype = this.prototype;\n\t\n\t    var proto = new F();\n\t    proto.constructor = NewClass;\n\t\n\t    NewClass.prototype = proto;\n\t\n\t    //inherit parent's statics\n\t    for (var i in this) {\n\t        if (this.hasOwnProperty(i) && i !== 'prototype') {\n\t            NewClass[i] = this[i];\n\t        }\n\t    }\n\t\n\t    // mix static properties into the class\n\t    if (props.statics) {\n\t        FM.extend(NewClass, props.statics);\n\t        delete props.statics;\n\t    }\n\t\n\t    // mix includes into the prototype\n\t    if (props.includes) {\n\t        FM.Util.extend.apply(null, [proto].concat(props.includes));\n\t        delete props.includes;\n\t    }\n\t\n\t    // merge options\n\t    if (props.options && proto.options) {\n\t        props.options = FM.extend({}, proto.options, props.options);\n\t    }\n\t\n\t    // mix given properties into the prototype\n\t    FM.extend(proto, props);\n\t\n\t    proto._initHooks = [];\n\t\n\t    var parent = this;\n\t    // add method for calling all hooks\n\t    proto.callInitHooks = function () {\n\t\n\t        if (this._initHooksCalled) { return; }\n\t\n\t        if (parent.prototype.callInitHooks) {\n\t            parent.prototype.callInitHooks.call(this);\n\t        }\n\t\n\t        this._initHooksCalled = true;\n\t\n\t        for (var i = 0, len = proto._initHooks.length; i < len; i++) {\n\t            proto._initHooks[i].call(this);\n\t        }\n\t    };\n\t\n\t    return NewClass;\n\t};\n\t// method for adding properties to prototype\n\tFM.Class.include = function (props) {\n\t    FM.extend(this.prototype, props);\n\t};\n\t// merge new default options to the Class\n\tFM.Class.mergeOptions = function (options) {\n\t    FM.extend(this.prototype.options, options);\n\t};\n\t// add a constructor hook\n\tFM.Class.addInitHook = function (fn) { // (Function) || (String, args...)\n\t    var args = Array.prototype.slice.call(arguments, 1);\n\t\n\t    var init = typeof fn === 'function' ? fn : function () {\n\t        this[fn].apply(this, args);\n\t    };\n\t\n\t    this.prototype._initHooks = this.prototype._initHooks || [];\n\t    this.prototype._initHooks.push(init);\n\t};\n\tFM.Util = {\n\t\n\t    extend: function (dest) { // (Object[, Object, ...]) ->\n\t        var sources = Array.prototype.slice.call(arguments, 1),\n\t            i, j, len, src;\n\t\n\t        for (j = 0, len = sources.length; j < len; j++) {\n\t            src = sources[j] || {};\n\t            for (i in src) {\n\t                if (src.hasOwnProperty(i)) {\n\t                    dest[i] = src[i];\n\t                }\n\t            }\n\t        }\n\t        return dest;\n\t    },\n\t\n\t    bind: function (fn, obj) { // (Function, Object) -> Function\n\t        var args = arguments.length > 2 ? Array.prototype.slice.call(arguments, 2) : null;\n\t        return function () {\n\t            return fn.apply(obj, args || arguments);\n\t        };\n\t    },\n\t\n\t    stamp: (function () {\n\t        var lastId = 0, key = '_leaflet_id';\n\t        return function (/*Object*/ obj) {\n\t            obj[key] = obj[key] || ++lastId;\n\t            return obj[key];\n\t        };\n\t    }()),\n\t\n\t    limitExecByInterval: function (fn, time, context) {\n\t        var lock, execOnUnlock;\n\t\n\t        return function wrapperFn() {\n\t            var args = arguments;\n\t\n\t            if (lock) {\n\t                execOnUnlock = true;\n\t                return;\n\t            }\n\t\n\t            lock = true;\n\t\n\t            setTimeout(function () {\n\t                lock = false;\n\t\n\t                if (execOnUnlock) {\n\t                    wrapperFn.apply(context, args);\n\t                    execOnUnlock = false;\n\t                }\n\t            }, time);\n\t\n\t            fn.apply(context, args);\n\t        };\n\t    },\n\t\n\t    falseFn: function () {\n\t        return false;\n\t    },\n\t\n\t    formatNum: function (num, digits) {\n\t        var pow = Math.pow(10, digits || 5);\n\t        return Math.round(num * pow) / pow;\n\t    },\n\t\n\t    splitWords: function (str) {\n\t        return str.replace(/^\\s+|\\s+$/g, '').split(/\\s+/);\n\t    },\n\t\n\t    setOptions: function (obj, options) {\n\t        obj.options = L.extend({}, obj.options, options);\n\t        return obj.options;\n\t    },\n\t\n\t    getParamString: function (obj, existingUrl) {\n\t        var params = [];\n\t        for (var i in obj) {\n\t            if (obj.hasOwnProperty(i)) {\n\t                params.push(i + '=' + obj[i]);\n\t            }\n\t        }\n\t        return ((!existingUrl || existingUrl.indexOf('?') === -1) ? '?' : '&') + params.join('&');\n\t    },\n\t\n\t    template: function (str, data) {\n\t        return str.replace(/\\{ *([\\w_]+) *\\}/g, function (str, key) {\n\t            var value = data[key];\n\t            if (!data.hasOwnProperty(key)) {\n\t                throw new Error('No value provided for variable ' + str);\n\t            }\n\t            return value;\n\t        });\n\t    },\n\t\n\t    isArray: function (obj) {\n\t        return (Object.prototype.toString.call(obj) === '[object Array]');\n\t    },\n\t\n\t    emptyImageUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='\n\t};\n\t\n\t(function () {\n\t\n\t    function getPrefixed(name) {\n\t        var i, fn,\n\t            prefixes = ['webkit', 'moz', 'o', 'ms'];\n\t\n\t        for (i = 0; i < prefixes.length && !fn; i++) {\n\t            fn = window[prefixes[i] + name];\n\t        }\n\t\n\t        return fn;\n\t    }\n\t\n\t    var lastTime = 0;\n\t\n\t    function timeoutDefer(fn) {\n\t        var time = +new Date(),\n\t            timeToCall = Math.max(0, 16 - (time - lastTime));\n\t\n\t        lastTime = time + timeToCall;\n\t        return window.setTimeout(fn, timeToCall);\n\t    }\n\t\n\t    var requestFn = window.requestAnimationFrame ||\n\t        getPrefixed('RequestAnimationFrame') || timeoutDefer;\n\t\n\t    var cancelFn = window.cancelAnimationFrame ||\n\t        getPrefixed('CancelAnimationFrame') ||\n\t        getPrefixed('CancelRequestAnimationFrame') ||\n\t        function (id) { window.clearTimeout(id); };\n\t\n\t\n\t    FM.Util.requestAnimFrame = function (fn, context, immediate, element) {\n\t        fn = L.bind(fn, context);\n\t\n\t        if (immediate && requestFn === timeoutDefer) {\n\t            fn();\n\t        } else {\n\t            return requestFn.call(window, fn, element);\n\t        }\n\t    };\n\t\n\t    FM.Util.cancelAnimFrame = function (id) {\n\t        if (id) {\n\t            cancelFn.call(window, id);\n\t        }\n\t    };\n\t\n\t    FM.Util.replaceAll = function(text, stringToFind, stringToReplace) {\n\t        if(text)\n\t            return text.replace(new RegExp(stringToFind, 'g'), stringToReplace);\n\t    },\n\t\n\t    FM.Util.parseLayerRequest = function(layer) {\n\t        var layerValues = eval(layer);\n\t        var layerRequest = '';\n\t        $.each(layerValues, function(key, value) {\n\t            layerRequest += '&' + key + '=' + value;\n\t        });\n\t        return layerRequest;\n\t    },\n\t\n\t    FM.Util.randomID = function() {\n\t        var randLetter = Math.random().toString(36).substring(7);\n\t        return (randLetter + Date.now()).toLocaleLowerCase();\n\t    },\n\t\n\t    FM.Util.fire = function(item , type, data){\n\t        var evt = document.createEvent('CustomEvent');\n\t        evt.initCustomEvent(type, true, true, data);\n\t        item.dispatchEvent(evt);\n\t    }\n\t\n\t    FM.Util.on = function(item , type, data, callback){\n\t        item.addEventListener(type, callback, false);\n\t    }\n\t\n\t}());\n\t\n\t// shortcuts for most used utility functions\n\tFM.extend = FM.Util.extend;\n\tFM.bind = FM.Util.bind;\n\tFM.stamp = FM.Util.stamp;\n\tFM.setOptions = FM.Util.setOptions;\n\tFM.loadModuleLibs = FM.Util.loadModuleLibs;\n\t\n\tFM.UIUtils = {\n\t    loadingPanel: function (id, height) {\n\t        var h = '25px';\n\t        if (height)\n\t            document.getElementById(id).innerHTML = \"<div class='fm-loadingPanel' style='height:\"+ h +\"'></div>\";\n\t        else\n\t            document.getElementById(id).innerHTML = \"<div class='fm-loadingPanel'></div>\";\n\t    }\n\t};\n\t\n\tFM.WMSUtils = FM.Class.extend({\n\t\n\t    _divID:'',\n\t    _dropdowndID: '',\n\t    _outputID: '',\n\t    _fenixMap: '',\n\t    _wmsServers: '',\n\t    _mapID: '',\n\t    _lang: 'EN',\n\t\n\t    // JSON\n\t    WMSCapabilities: function(divID, outputID, fenixmap, wmsServers, lang) {\n\t        this._divID = divID;\n\t        this._dropdowndID = divID + '-dropdown';\n\t        this._outputID = outputID;\n\t        this._fenixmap = fenixmap;\n\t        this._wmsServers = wmsServers;\n\t        if ( lang ) this._lang = lang;\n\t\n\t        this._createWMSDropDown(this._wmsServers, this._divID, this._dropdowndID, this._outputID, fenixmap);\n\t    },\n\t\n\t    _createWMSDropDown: function(wmsServers, divID, dropdowndID, outputID, fenixmap) {\n\t        // TODO: dynamic width\n\t        var html = '<select id=\"'+ dropdowndID+'\" style=\"width:200px;\" data-placeholder=\"\" class=\"\">';\n\t        html += '<option value=\"\"></option>';\n\t        for(var i=0; i < wmsServers.length; i++)\n\t            html += '<option value=\"'+ wmsServers[i].url + '\">'+wmsServers[i].label +'</option>';\n\t        html += '</select>';\n\t\n\t        $('#' + divID).empty();\n\t        $('#' + divID).append(html);\n\t\n\t        try {\n\t            $('#' + dropdowndID).chosen({disable_search_threshold:6, width: '100%'});\n\t        }  catch (e) {}\n\t\n\t        // enable on click\n\t        var _this = this;\n\t        $( \"#\" + dropdowndID ).change({},  function (event) {\n\t            _this._createWMSOutputRequest(outputID, fenixmap, $( this ).val());\n\t        });\n\t    },\n\t\n\t    _createWMSOutputRequest: function(id, fenixmap, wmsServerURL) {\n\t        $(\"#\" + id).empty();\n\t        FM.UIUtils.loadingPanel(id, '30px');\n\t\n\t        var url = FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;\n\t        url += (url.indexOf('?') > 0)? \"&\": \"?\";\n\t        url += 'SERVICE=WMS';\n\t        url += '&VERSION=1.1.1';\n\t        url += '&request=GetCapabilities';\n\t        url += '&urlWMS=' + wmsServerURL;\n\t\n\t         var _this = this;\n\t         $.ajax({\n\t             type: \"GET\",\n\t             url: url,\n\t             success: function(response) {\n\t                 var xmlResponse = $.parseXML( response );\n\t                 _this._createWMSOutput(id, fenixmap, xmlResponse, wmsServerURL)\n\t             }\n\t         });\n\t    },\n\t\n\t    _createWMSOutput: function(id, fenixmap, xmlResponse, wmsServerURL ) {\n\t\n\t        $(\"#\" + id).empty();\n\t        $(xmlResponse).find('Layer').each(function() {\n\t\n\t            if ($(this).children(\"Name\").text() && $(this).children(\"Name\").text() != '') {\n\t\n\t                var layer = {};\n\t                layer.layers= $(this).children(\"Name\").text();\n\t                layer.layername= $(this).children(\"Name\").text();\n\t                layer.layertitle=$(this).children(\"Title\").text();\n\t\n\t                //TODO: dirty quick TITLE fix for DEMO\n\t                layer.layertitle = layer.layertitle.replace(/_/g,' ');\n\t                layer.layertitle = layer.layertitle.replace(/3857/g,' ');\n\t\n\t                layer.styles = $(this).children(\"Style\").children(\"Name\").text();\n\t                layer.urlWMS = wmsServerURL;\n\t                // setting the default CRS of the map\n\t                layer.srs = fenixmap.map.options.crs.code;\n\t                layer.openlegend = true; //this will open the legend by on preview (choose on add if we want to leave it open **/\n\t\n\t\n\t                var rand = FM.Util.randomID();\n\t                var layerPanel = FM.Util.replaceAll(FM.guiController.wmsLoaderLayer, 'REPLACE', rand);\n\t\n\t                $(\"#\" + id).append(layerPanel);\n\t                $('#' + rand + '-WMSLayer-title').append(layer.layertitle);\n\t\n\t\n\t                // TODO: get bounding box with the current CRS\n\t                $(\"#\" + rand + \"-WMSLayer-box\").on('click',\n\t                    {\n\t                        fenixmap: fenixmap,\n\t                        layer: layer\n\t                    }, function(e) {\n\t\n\t                    e.data.layer.openlegend = false; // if on add we want to close the legend\n\t                    \n\t                    var layer = new FM.layer(e.data.layer);\n\t\n\t                    e.data.fenixmap.addLayer(layer);\n\t\n\t                    try {\n\t                        FMPopUp.init({\n\t                            parentID: e.data.fenixmap.id,\n\t                            content: 'The Layer <b>' + e.data.layer.layertitle + '</b><br> has been added to the map'\n\t                        })\n\t                    }catch(e) {}\n\t\n\t                });\n\t\n\t                // add on hoverIntent the layer\n\t                var _fenixMap = fenixmap;\n\t                var _layer =  $.extend(true, {}, layer);\n\t                //_layer.hideLayerInControllerList = true;\n\t                var _tmpLayer = new FM.layer(_layer);\n\t                try {\n\t                    $(\"#\" + rand + \"-WMSLayer-box\").hoverIntent({\n\t                        over: function () { _fenixMap.addLayer(_tmpLayer);},\n\t                        out:  function () { _fenixMap.removeLayer(_tmpLayer);},\n\t                        timeout: 500\n\t                    });\n\t                }catch(e) {\n\t                    // try catch in case the jquery.hoverIntent plugin is not been imported\n\t                }\n\t            }\n\t        });\n\t    },\n\t\n\t    // add a new Server to the servers list\n\t    addWMSServer: function() {\n\t\n\t    },\n\t\n\t\n\t    _WMSCapabilities: function(id, fenixmap, wmsServerURL) {\n\t        // TODO: check it because in theory it shouldn't be needed\n\t        var url = FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;\n\t        url += (url.indexOf('?') > 0)? \"&\": \"?\";\n\t        url += 'SERVICE=WMS';\n\t        url += '&VERSION=1.1.1';\n\t        url += '&request=GetCapabilities';\n\t        url += '&urlWMS=' + wmsServerURL;\n\t\n\t        var _this = this;\n\t        $.ajax({\n\t            type: \"GET\",\n\t            url: url,\n\t            success: function(response) {\n\t                var xmlResponse = $.parseXML(response);\n\t                _this._createWMSDropwDown(id, fenixmap, xmlResponse, wmsServerURL)\n\t            }\n\t        });\n\t    },\n\t\n\t    _createWMSDropwDown: function(id, fenixmap, xmlResponse, wmsServerURL ) {\n\t        var rand = FM.Util.randomID();\n\t        $(xmlResponse).find('Layer').each(function() {\n\t            var rand = FM.Util.randomID();\n\t            if ($(this).children(\"Name\").text()) {\n\t\n\t                var layer = {};\n\t                layer.layers = $(this).children(\"Name\").text();\n\t                layer.layername = $(this).children(\"Name\").text();\n\t                layer.layertitle =$(this).children(\"Title\").text();\n\t                layer.styles = $(this).children(\"Style\").children(\"Name\").text();\n\t                layer.urlWMS = wmsServerURL;\n\t                layer.openlegend = true;\n\t\n\t                $(\"#\" + id).append(\"<div id='WMSLayer-\"+ rand +\"'>ddd\" + layer.layertitle + \" + \" +  layer.styles + \" <div>\");\n\t\n\t                // setting the default CRS of the map\n\t                layer.srs = fenixmap.map.options.crs.code;\n\t\n\t                $(\"#WMSLayer-\" + rand).click({fenixmap:fenixmap, layer: layer}, function(event) {\n\t                    var layer = new FM.layer(event.data.layer);\n\t                    event.data.fenixmap.addLayerWMS(layer);\n\t                });\n\t            }\n\t        });\n\t    },\n\t\n\t\n\t    WFSCapabilities: function(id, fenixmap, wmsServerURL) {\n\t        var url = FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;\n\t        url += (url.indexOf('?') > 0)? \"&\": \"?\";\n\t        url += 'SERVICE=WFS';\n\t        url += '&VERSION=1.0.0';\n\t        url += '&request=GetCapabilities';\n\t        url += '&urlWMS=' + wmsServerURL;\n\t\n\t        var _this = this;\n\t        $.ajax({\n\t            type: \"GET\",\n\t            url: url,\n\t            success: function(response) {\n\t                var xmlResponse = $.parseXML(response);\n\t                FM.WMSUtils._createWMSDropwDown(id, fenixmap, xmlResponse, wmsServerURL)\n\t            }\n\t        });\n\t    },\n\t\n\t    _createWFSDropwDown: function(id, fenixmap, xmlResponse, wmsServerURL ) {\n\t        $(xmlResponse).find('Layer').each(function() {\n\t            /** TODO: optimize ramdon function **/\n\t            var rand = FM.Util.randomID();\n\t            if ($(this).children(\"Name\").text()) {\n\t\n\t                //console.log($(this).children(\"Name\").text() + ' | ' +  $(this).children(\"Title\").text());\n\t                $(\"#\" + id).append(\"<div id='WMSLayer-\"+ rand +\"'>\" + $(this).children(\"Title\").text() + \" + \" +  $(this).children(\"Style\").children(\"Name\").text() + \" <div>\");\n\t                //$(\"#\" + id).append(\"<li> <a href='#'>\" + $(this).children(\"Title\").text() + \" + \" +  $(this).children(\"Style\").children(\"Name\").text() + \"</a><li>\");\n\t\n\t                var layer = {};\n\t                layer.layers= $(this).children(\"Name\").text();\n\t                layer.layername= $(this).children(\"Name\").text();\n\t                layer.layertitle=$(this).children(\"Title\").text();\n\t                layer.style = $(this).children(\"Style\").children(\"Name\").text();\n\t                layer.urlWMS = wmsServerURL;\n\t                layer.openlegend = true;\n\t\n\t                // setting the default CRS of the map\n\t                layer.srs = fenixmap.map.options.crs.code;\n\t\n\t                $(\"#WMSLayer-\" + rand).click({fenixmap:fenixmap, layer: layer}, function(event) {\n\t                    var layer = new FM.layer(event.data.layer);\n\t                    event.data.fenixmap.addLayerWMS(layer);\n\t                });\n\t            }\n\t        });\n\t    }\n\t});;\n\t\n\t(function() {\n\t    var\n\t        fullScreenApi = {\n\t            supportsFullScreen: false,\n\t            isFullScreen: function() { return false; },\n\t            requestFullScreen: function() {},\n\t            cancelFullScreen: function() {},\n\t            fullScreenEventName: '',\n\t            prefix: ''\n\t        },\n\t        browserPrefixes = 'webkit moz o ms khtml'.split(' ');\n\t\n\t    // check for native support\n\t    if (typeof document.exitFullscreen != 'undefined') {\n\t        //console.log('fullScreenApi if');\n\t        fullScreenApi.supportsFullScreen = true;\n\t    } else {\n\t       // console.log('fullScreenApi else');\n\t        // check for fullscreen support by vendor prefix\n\t        for (var i = 0, il = browserPrefixes.length; i < il; i++ ) {\n\t            fullScreenApi.prefix = browserPrefixes[i];\n\t\n\t            if (typeof document[fullScreenApi.prefix + 'CancelFullScreen' ] != 'undefined' ) {\n\t                //console.log('fullScreenApi.CancelFullScreen');\n\t                fullScreenApi.supportsFullScreen = true;\n\t                break;\n\t            }\n\t        }\n\t    }\n\t\n\t    // update methods to do something useful\n\t    if (fullScreenApi.supportsFullScreen) {\n\t        //console.log('fullScreenApi.qua');\n\t        fullScreenApi.fullScreenEventName = fullScreenApi.prefix + 'fullscreenchange';\n\t\n\t        fullScreenApi.isFullScreen = function() {\n\t            //console.log('fullScreenApi.isFullScreen');\n\t            switch (this.prefix) {\n\t                case '':\n\t                    return document.fullScreen;\n\t                case 'webkit':\n\t                    return document.webkitIsFullScreen;\n\t                default:\n\t                    return document[this.prefix + 'FullScreen'];\n\t            }\n\t        }\n\t        fullScreenApi.requestFullScreen = function(el) {\n\t            //console.log('fullScreenApi.requestFullScreen');\n\t            return (this.prefix === '') ? el.requestFullscreen() : el[this.prefix + 'RequestFullScreen']();\n\t        }\n\t        fullScreenApi.cancelFullScreen = function(el) {\n\t           // console.log('fullScreenApi.cancelFullScreen');\n\t                return (this.prefix === '') ?\n\t                document.exitFullscreen() :\n\t                document[this.prefix + 'CancelFullScreen']();\n\t        }\n\t    }\n\t\n\t    // jQuery plugin\n\t    if (typeof jQuery != 'undefined') {\n\t        jQuery.fn.requestFullScreen = function() {\n\t\n\t            return this.each(function() {\n\t                var el = jQuery(this);\n\t                if (fullScreenApi.supportsFullScreen) {\n\t                    fullScreenApi.requestFullScreen(el);\n\t                }\n\t            });\n\t        };\n\t    }\n\t\n\t    // export api\n\t    window.fullScreenApi = fullScreenApi;\n\t})();;\n\t\n\tFMDEFAULTLAYER = {\n\t\n\t    getLayer: function(layertype, isjoin, measurementunit) {\n\t        switch(layertype.toUpperCase()) {\n\t            case \"GAUL0\"                : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857_2', 'adm0_code', 'the_geom', isjoin, 'faost_n', measurementunit, 'GAUL'); break;\n\t            case \"GAUL0_FAOSTAT\"        : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857', 'faost_code','the_geom', isjoin, 'faost_n', measurementunit, 'FAOSTAT'); break;\n\t            case \"GAUL0_ISO2\"           : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857_2', 'iso2_code', 'the_geom', isjoin, 'faost_n', measurementunit, 'ISO2'); break;\n\t            case \"GAUL0_ISO3\"           : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857_2', 'iso3_code', 'the_geom', isjoin, 'faost_n', measurementunit, 'ISO3'); break;\n\t            case \"GAUL0_BOUNDARIES\"     : return FMDEFAULTLAYER._getWMSLayer('gaul0_line_3857'); break;\n\t            case \"GAUL1\"                : return FMDEFAULTLAYER._getGAUL('gaul1_3857', 'adm1_code', 'the_geom', isjoin, 'adm1_name', measurementunit, null); break;\n\t//            case \"GAUL1\"                : return FMDEFAULTLAYER._getGAUL('gaul1_3857', 'adm1_code', 'the_geom', isjoin, 'adm1_name', measurementunit, null); break;\n\t//            case \"GAUL2\"                : return FMDEFAULTLAYER._getGAUL('gaul2_3857', 'adm2_code', 'the_geom', isjoin, 'adm2_name', measurementunit, null); break;\n\t            // TODO: change to a standard GAUL2 layer. 'gaul2_3857_2'is another GAUL2 used with the new popup (the old gaul2 as content.ftl used by countrystat)\n\t            case \"GAUL2\"                : return FMDEFAULTLAYER._getGAUL('gaul2_3857', 'adm2_code', 'the_geom', isjoin, 'adm2_name', measurementunit, null); break;\n\t        }\n\t    },\n\t\n\t    _getGAUL: function(layername, joincolumn, geometrycolumn, isjoin, joincolumnlabel, measurementunit, joinboundary) {\n\t        var layer = {};\n\t        layer.layers=layername ;\n\t        layer.styles='';\n\t        layer.joincolumn=(joincolumn )? joincolumn: null;\n\t        layer.joincolumnlabel=(joincolumnlabel )? joincolumnlabel: null;\n\t        layer.measurementunit=(measurementunit )? measurementunit: null;\n\t        layer.srs = 'EPSG:3857';\n\t        layer.geometrycolumn =(geometrycolumn )? geometrycolumn: '';\n\t        if (isjoin) {\n\t            FMDEFAULTLAYER.joinDefaultPopUp(layer);\n\t            layer.joinboundary = joinboundary;\n\t        }\n\t        return layer;\n\t    },\n\t\n\t    _getWMSLayer:function(layername, urlWMS, styles, srs) {\n\t        // TODO: remove FMCONFIG from here!\n\t        var layer = {};\n\t        layer.layers = layername;\n\t        layer.styles = (styles)?styles:'';\n\t        layer.srs = (srs)?srs:'EPSG:3857';\n\t        layer.urlWMS = (urlWMS)?urlWMS: FMCONFIG.DEFAULT_WMS_SERVER;\n\t        return layer;\n\t    },\n\t\n\t    /** TODO: handle multilanguage **/\n\t    joinDefaultPopUp: function( layer ) {\n\t        //console.log(layer);\n\t        var measurementunit  = (layer.measurementunit)? \" \" + layer.measurementunit +\"\": \"\";\n\t        var joinlabel  = (layer.joincolumnlabel)? \"<div class='fm-popup-join-title'>{{\" + layer.joincolumnlabel +\"}}</div>\": \"\";\n\t        layer.customgfi = {\n\t            content : {\n\t                en: \"<div class='fm-popup'>\" + joinlabel + \"<div class='fm-popup-join-content'>{{{\" + layer.joincolumn +\"}}} <i>\" + measurementunit +\"</i></div></div>\",\n\t                fr: \"<div class='fm-popup'>\" + joinlabel + \"{{{\" + layer.joincolumn +\"}}} <i>\" + measurementunit +\"</i></div>\",\n\t                es: \"<div class='fm-popup'>\" + joinlabel + \"{{{\" + layer.joincolumn +\"}}} <i>\" + measurementunit +\"</i></div>\"\n\t            }\n\t            ,showpopup: true\n\t            ,output: {\n\t                show: true,\n\t                id: 'gfiid'\n\t            }\n\t            ,callback : function(response, custompopup) {\n\t                $('#' + custompopup.outputid ).empty();\n\t                $('#' + custompopup.outputid ).append(response);\n\t            }\n\t        }\n\t    }\n\t\n\t};\n\t;\n\tFM.TILELAYER = {\n\t\n\t    // OpenStreetMap\n\t    OSM: {\n\t        url: 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n\t        title_en: 'OSM - OpenStreetMap'\n\t    },\n\t\n\t    OSM_GRAYSCALE: {\n\t        url : 'http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png',\n\t        title_en: 'OSM - OpenStreetMap grayscale'\n\t    },\n\t\n\t    MAPQUEST: {\n\t        url : 'http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',\n\t        title_en: 'MapQuest'\n\t    },\n\t\n\t    MAPQUEST_NASA_AERIAL : {\n\t        url: 'http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png',\n\t        title_en: 'MapQuest Aerial'\n\t    },\n\t\n\t    ESRI_WORLDSTREETMAP : {\n\t        url: 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png',\n\t        title_en: 'ESRI - World Street Map'\n\t    },\n\t\n\t    ESRI_WORLDTERRAINBASE : {\n\t        url: 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',\n\t        title_en: 'ESRI - World Terrain Base'\n\t    },\n\t\n\t    ACETATE_LABELS : {\n\t        url : 'http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png',\n\t        title_en : 'Acetate Labels'\n\t    },\n\t\n\t    ACETATE_TERRAIN : {\n\t        url : 'http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png',\n\t        title_en: 'Acetate Terrain'\n\t    },\n\t\n\t    STAMEN_TONER_BACKGROUND : {\n\t        url : 'http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png',\n\t        title_en: 'Stamen'\n\t    },\n\t\n\t    ESRI_HISTORICAL_MERCATOR: {\n\t        url : 'http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png',\n\t        title_en: 'ESRI_HISTORICAL_MERCATOR'\n\t    }\n\t};\n\t;\n\tFM.WMSSERVERS = {\n\t\n\t    DEFAULT_EXTERNAL_WMS_SERVERS: [\n\t        {\n\t            label: 'FENIX Crops Area',\n\t            label_EN: 'FENIX', // not currently used for the multilingual, it is needed?\n\t            url: 'http://fenix.fao.org/demo/fenix/geoserver/earthstat/wms'\n\t        },\n\t        {\n\t            label: 'Greenhouse gases Data',\n\t            label_EN: 'FENIX',\n\t            url: 'http://fenix.fao.org/demo/ghg/geoserver/wms'\n\t        },\n\t        {\n\t            label: 'DATA.FAO.ORG',\n\t            label_EN: 'data.fao.org WMS Server',\n\t            url: 'http://data.fao.org/maps/wms'\n\t        },\n\t        {\n\t            label: 'UNREDD Congo',\n\t            label_EN: 'UNREDD Congo',\n\t            url: 'http://rdc-snsf.org/diss_geoserver/gwc/service/wms'\n\t        },\n\t        {\n\t            label: 'Wales OpenData',\n\t            label_EN:  'Wales OpenData',\n\t            url: 'http://inspire.wales.gov.uk/maps/ows'\n\t        },\n\t        {\n\t            label: 'Scotland OpenData',\n\t            label_EN:  'Scotland OpenData',\n\t            url: 'http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer'\n\t        },\n\t        {\n\t            label: 'Netherlands OpenData',\n\t            label_EN:  'Netherlands OpenData',\n\t            url: 'http://geodata.nationaalgeoregister.nl/ahn2/wcs'\n\t        },\n\t        {\n\t            label: 'German OpenData',\n\t            label_EN:  'German OpenData',\n\t            url: 'http://geo.sv.rostock.de/geodienste/verwaltung/wms'\n\t        },\n\t        {\n\t            label: 'ENVIRONMENT OpenData',\n\t            label_EN:  'Scotland OpenData',\n\t            url: 'http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer'\n\t        },\n\t        {\n\t            label: 'OpenGeo Demo Server',\n\t            label_EN: 'OpenGeo Demo Server',\n\t            url: 'http://demo.opengeo.org/geoserver/ows'\n\t        },\n\t        {\n\t            label: 'Alberts Map Service',\n\t            url: 'http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer',\n\t            urlParameters: 'service=WMS'\n\t        },\n\t        {\n\t            label: 'Cubert Map Service',\n\t            label_EN: 'Cubert',\n\t            url: 'http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi'\n\t        },\n\t        {\n\t            label: 'GP Map Service',\n\t            label_EN: 'gp map service201',\n\t            url: 'http://geoportal.logcluster.org:8081/gp_map_service201/wms'\n\t        },\n\t        {\n\t            label: 'Vienna OpenData',\n\t            label_EN:  'Vienna OpenData',\n\t            url: 'http://data.wien.gv.at/daten/wms'\n\t        },\n\t        {\n\t            label: 'Vienna OpenData',\n\t            label_EN:  'Vienna OpenData',\n\t            url: 'http://data.wien.gv.at/daten/wms'\n\t        }\n\t    ]\n\t}\n\t\n\t;\n\tFM.Map = FM.Class.extend({\n\t\n\t    id: '',\n\t    suffix: '',\n\t    mapContainerID: '',\n\t    tilePaneID: '',\n\t\n\t    map: '',        //this is the map obj of Leaflet/Openlayers\n\t    controller: '', //controller of the map\n\t    plugins: {},    //indexed plugins istances\n\t\n\t    options: {\n\t        url: {},    \t\n\t        lang: 'EN',\n\t        guiController : {\n\t            container: null,\n\t            overlay: true,\n\t            baselayer: true,\n\t            wmsLoader: true,\n\t            enablegfi: true, //this is used to switch off events like on drawing (when is need to stop the events on GFI)\n\t            layersthumbs: false\n\t        },\n\t        plugins: {\n\t\t\t\tfullscreen: true,  //true or {id: 'divID'} or false\n\t        \tzoomcontrol: true,\n\t            scalecontrol: true,\n\t            legendcontrol: true,\n\t        \tdisclaimerfao: true\n\t        },\n\t        baselayers: null,\n\t        boundaries: null,\n\t        labels: null,\n\t        //http://goo.gl/MUIt8Z\n\t        legendOptions: null,\n\t        zoomToCountry: null,\n\t        highlightCountry: null,\n\t        style: {\n\t            color: '#337ab7',\n\t            opacity: 0.8,\n\t            weight: 2,\n\t            fillColor: '#337ab7',\n\t            fillOpacity: 0.1\n\t        }\n\t    },\n\t    mapOptions: {\n\t\t\tzoomControl: false,\n\t\t\tattributionControl: false,\n\t        center: [0, 0],\n\t        lat: 0,\n\t        lng: 0,\n\t        zoom: 1\n\t    },\n\t\n\t    initialize: function(id, options, mapOptions) { // (HTMLElement or String, Object)\n\t\n\t        var self = this;\n\t\n\t        // merging object with a deep copy\n\t        this.options =  $.extend(true, {}, this.options, options);\n\t        this.mapOptions = $.extend(true, {}, this.mapOptions, mapOptions);\n\t\n\t        // extent if exist FM.CONFIG\n\t        if (FMCONFIG)\n\t            this.options.url = $.extend(true, {}, FMCONFIG, options && options.url );\n\t\n\t        var suffix = FM.Util.randomID();\n\t        var mapContainerID =  suffix + '-container-map';\n\t        var mapID =  suffix + '-map';\n\t\n\t        var mapDIV = \"<div class='fm-map-box fm-box' id='\"+ mapContainerID +\"'><div>\";\n\t        \n\t        $(id).length > 0? $(id).append(mapDIV): $(\"#\" + id).append(mapDIV);\n\t\n\t        this.id = mapID;\n\t\n\t        this.$map = $(\"#\" + mapContainerID);\n\t\n\t        this.$map.append(\"<div style='width:100%; height: 100%;' id='\"+ mapID +\"'><div>\");\n\t\n\t        this.map = new L.Map(this.id, this.mapOptions);\n\t\n\t        this.mapContainerID = mapContainerID;\n\t        this.suffix = suffix;\n\t\n\t        // setting the TilePaneID   TODO: set IDs to all the DIVs?\n\t        this.setTilePaneID();\n\t   \n\t        this.controller = new FM.mapController(suffix, this, this.map,  this.options.guiController);\n\t\n\t        this.controller.initializeGUI();\n\t\n\t        this.map._fenixMap = this;\n\t\n\t        if(this.options.guiController.enablegfi)\n\t            this.map.on('click', this.getFeatureInfo, this);\n\t\n\t        var swipeControl = (function() {\n\t            var control = new L.Control();\n\t            control.onAdd = function(map) {\n\t                return $(\"<div  class='fm-swipe' id='\"+ suffix +\"-swipe'><div style='display:none' class='fm-swipe-handle'id='\"+ suffix +\"-handle'>&nbsp</div></div>\")[0];\n\t            };\n\t            return control;\n\t        }()).addTo(this.map);\n\t\n\t        // join popup holder\n\t        this.$map.append(FM.Util.replaceAll(FM.guiController.popUpJoinPoint, 'REPLACE', suffix));\n\t     \n\t    },\n\t\n\t//TODO\n\t    initStyles: function() {\n\t\n\t        $('<h1>PALETTE<h1>').addClass('color-main-light-10').prependTo(this.$map);\n\t\n\t        function getStyle(className) {\n\t            var ret = {},\n\t                len = document.styleSheets.length-1,\n\t                classes = document.styleSheets[len].rules || document.styleSheets[len].cssRules;\n\t            \n\t            for (var x = 0; x < classes.length; x++) {\n\t                \n\t                console.log(classes[x].selectorText)\n\t\n\t                if (classes[x].selectorText.indexOf(className)>-1 ) {\n\t\n\t                    console.log(classes[x].selectorText)\n\t\n\t                    if(!ret[className])\n\t                        ret[className]=[];\n\t                    \n\t                    ret[className].push(classes[x].cssText ? classes[x].cssText : classes[x].style.cssText);\n\t                }\n\t            }\n\t            return ret;\n\t        }\n\t\n\t        this.fenixStyles = getStyle('.color-main');\n\t\n\t        console.log('FMMAP fenixStyles',fenixStyles);//*/\n\t    },\n\t    \n\t    createMap: function(lat, lng, zoom) {\n\t\n\t        var self = this;\n\t        \n\t        this.mapOptions.lat = lat || this.mapOptions.lat;\n\t        this.mapOptions.lng = lng || this.mapOptions.lng;\n\t        this.mapOptions.zoom = zoom || this.mapOptions.zoom;\n\t        this.map.setView(new L.LatLng(this.mapOptions.lat, this.mapOptions.lng), this.mapOptions.zoom);\n\t        \n\t        this.initializePlugins();\n\t\n\t        if(this.options.baselayers === null) {\n\t            this.options.baselayers = {\n\t                'OSM': FM.TILELAYER['OSM'],\n\t                'OSM_GRAYSCALE': FM.TILELAYER['OSM_GRAYSCALE'],\n\t                'ESRI_WORLDSTREETMAP': FM.TILELAYER['ESRI_WORLDSTREETMAP'],\n\t                'ESRI_WORLDTERRAINBASE': FM.TILELAYER['ESRI_WORLDTERRAINBASE']\n\t            }\n\t        }\n\t\n\t        for(var i in this.options.baselayers) {\n\t            //this.addTileLayer(FM.TileLayer.createBaseLayer('OSM', 'EN'), true);\n\t            var layeropts = this.options.baselayers[i];\n\t            // this is replicated because in wms it's used \"layers\" instead of layername\n\t            \n\t            var l = new FM.layer({\n\t                layername: i,\n\t                layertype: 'TILE',\n\t                layertitle: layeropts['title_'+ this.options.lang.toLowerCase()],\n\t                lang: this.options.lang.toUpperCase()\n\t            });\n\t            var lurl = layeropts.url;\n\t            delete layeropts.url;\n\t            l.leafletLayer = new L.TileLayer(lurl, layeropts);\n\t\n\t            this.addTileLayer(l, true);\n\t        }\n\t\n\t        if(this.options.url.LAYER_BOUNDARIES) {\n\t            this.layerBoundaries = new FM.layer({\n\t                layers: this.options.url.LAYER_BOUNDARIES,\n\t                layertitle: 'Country Boundaries',\n\t                urlWMS: this.options.url.DEFAULT_WMS_SERVER,\n\t                opacity: '0.9',\n\t                lang: 'en',\n\t                hideLayerInControllerList: true\n\t            });\n\t            //this.addLayer(this.layerBoundaries)\n\t        }\n\t\n\t        if(this.options.url.LAYER_LABELS) {        \n\t            this.layerLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {\n\t                attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>',\n\t                subdomains: 'abcd',\n\t                maxZoom: 19,\n\t                opacity: 0.8\n\t            });\n\t        }\n\t\n\t        this.highlightLayer = L.geoJson(null, {\n\t            style: function(feature) {\n\t                return self.options.style;\n\t            }\n\t        }).addTo(this.map);\n\t\n\t        if(this.options.zoomToCountry && this.options.zoomToCountry.length > 0)\n\t        {\n\t            if(typeof this.options.zoomToCountry[0] === 'string') {\n\t                this.zoomToCountry('iso3', this.options.zoomToCountry);\n\t            }\n\t\n\t            else if(typeof this.options.zoomToCountry[0] === 'number') {\n\t                this.zoomToCountry('adm0_code', this.options.zoomToCountry);\n\t            }\n\t        }\n\t\n\t        if(this.options.highlightCountry) {\n\t            this.highlightCountry('iso3_code', this.options.highlightCountry);\n\t        }\n\t\n\t\n\t        if(this.options.boundaries) {\n\t            this.boundariesShow();\n\t        }\n\t        \n\t        if(this.options.labels) {\n\t            this.labelsShow();  \n\t        }\n\t\n\t        return this;\n\t    },\n\t\n\t    destroyMap: function() {\n\t        //TODO unbind events\n\t        this.map.remove();\n\t        this.$map.empty();\n\t    },\n\t\n\t    /** TODO: make it nicer **/\n\t    setTilePaneID: function() {\n\t        this.tilePaneID = this.suffix + '-leaflet-tile-pane';\n\t        var childNodes = document.getElementById(this.id).childNodes;\n\t        var childNodes2 = childNodes[1].childNodes;\n\t        $(childNodes2[0]).attr(\"id\", this.tilePaneID);\n\t    },\n\t\n\t    addTileLayer: function(l, isBaseLayer) {\n\t        if ( isBaseLayer )\n\t            this.controller.addBaseLayer(l);\n\t        else  {\n\t           this.controller.layerAdded(l);\n\t           this.map.addLayer(l.leafletLayer);\n\t        }\n\t        this.controller.setZIndex(l);\n\t        return this;\n\t    },\n\t\n\t    /** TODO: make it nicer **/\n\t    addLayer:function (l) {\n\t        l._fenixmap = this;\n\t\n\t        if(this.options.legendOptions)\n\t            l.layer.legendOptions = $.extend(l.layer.legendOptions, this.options.legendOptions);\n\t        \n\t        if (l.layer.layertype ) {\n\t            switch(l.layer.layertype ) {\n\t                case 'JOIN':\n\t                    if (l.layer.jointype.toLocaleUpperCase() == 'SHADED')\n\t                        this.addShadedLayer(l);\n\t                    else if (l.layer.jointype.toLocaleUpperCase() == 'POINT')\n\t                        this.addPointLayer(l);\n\t                break;\n\t                case 'WMS': this.addLayerWMS(l); break;\n\t                default: this.addLayerWMS(l); break;\n\t            }\n\t        }\n\t        else\n\t           this.addLayerWMS(l);\n\t        return this;\n\t    },\n\t\n\t    removeLayer:function(l) {\n\t        this.controller.removeLayer(l);\n\t        return this;\n\t    },\n\t\n\t    addLayerWMS: function(l) {\n\t        this.controller.layerAdded(l);\n\t        this.map.addLayer(l.createLayerWMS());\n\t        this.controller.setZIndex(l);\n\t\n\t        this._openlegend(l, false);\n\t\n\t        // check layer visibility\n\t        this.controller.showHide(l.id, false);\n\t        return this;\n\t    },\n\t\n\t    addShadedLayer: function(l) {\n\t        // adding the layer to the controller\n\t        if ( !l.layerAdded) this.controller.layerAdded(l);\n\t        this.createShadeLayerRequest(l, l.isadded);\n\t    },\n\t\n\t    createShadeLayerRequest: function(l, isReload) {\n\t        // hiding the legend TODO: make a test if controller is currently used?\n\t        if ( !isReload ) {\n\t            $('#'+ l.id + '-controller-item-getlegend').css('display', 'inline-block');\n\t            $('#'+ l.id + '-controller-item-opacity').css('display', 'block');\n\t        }\n\t        var _this = this;\n\t        var url = this.options.url.MAP_SERVICE_SHADED;\n\t        $.ajax({\n\t            type: \"POST\",\n\t            url: url,\n\t            data: JSON.stringify(l.layer),\n\t            contentType: \"application/json; charset=utf-8\",\n\t            dataType: 'json',\n\t            success: function(response) {\n\t                _this._createShadeLayer(l, response, isReload);\n\t            }\n\t        });\n\t    },\n\t\n\t    _createShadeLayer: function(l, response, isReload){\n\t        if (typeof response == 'string')\n\t            response = $.parseJSON(response);\n\t        //l.layer.sldurl = response.sldurl;\n\t        //l.layer.urlWMS = response.geoserverwms;\n\t        l.layer.sldurl = response.url;\n\t        // TODO: check urlWMS how to set it\n\t        l.layer.urlWMS = this.options.url.DEFAULT_WMS_SERVER;\n\t        if (response.geoserverwms)\n\t            l.layer.urlWMS = response.geoserverwms\n\t\n\t        //l.layer.urlWMS = \"http://localhost:9090/geoserver/wms/\";\n\t        l.layer.legendHTML = response.legendHTML;\n\t        l.createLayerWMSSLD();\n\t\n\t        this._loadLayer(l, isReload)\n\t    },\n\t\n\t    _loadLayer:function(l, isReload) {\n\t        var isReload = ( isReload == null || !isReload )? false: true;\n\t        // TODO: if ( this.map.hasLayer(l.leafletLayer)) could be an alternative to the isReloaded check?\n\t        if ( !isReload ) {\n\t            this.map.addLayer(l.leafletLayer);\n\t            this.controller.setZIndex(l);\n\t            // this is a flag specifically for the JOIN Layers (they need to be registered as added once they are loaded )\n\t            l.isadded = true;\n\t        }\n\t        else l.leafletLayer.redraw();\n\t\n\t        // open legend\n\t        this._openlegend(l, isReload);\n\t\n\t        // check layer visibility\n\t        this.controller.showHide(l.id, isReload)\n\t    },\n\t\n\t    reAddLayer:function(l) {\n\t        this.map.addLayer(l.leafletLayer);\n\t        this.controller.setZIndex(l);\n\t        // check layer visibility\n\t        //this.controller.showHide(l.id)\n\t    },\n\t\n\t    _openlegend: function(l, isReload) {\n\t        try {\n\t            if (l.layer.openlegend) {\n\t                FM.Legend.getLegend(l, l.id + '-controller-item-getlegend', isReload);\n\t            }\n\t        }catch (e) {\n\t            console.war(\"_openlegend error:\" + e);\n\t        }\n\t    },\n\t\n\t    addPointLayer: function(l) {\n\t        // adding the layer to the controller\n\t        this.controller.layerAdded(l);\n\t        this.createPointLayerRequest(l);\n\t    },\n\t\n\t    createPointLayerRequest: function(l) {\n\t        // hiding the legend\n\t        $('#'+ l.id + '-controller-item-getlegend').css('display', 'none');\n\t        $('#'+ l.id + '-controller-item-getlegend-holder').slideUp(\"slow\");\n\t        $('#'+ l.id + '-controller-item-opacity').css('display', 'none');\n\t        var _this = this;\n\t        var url = this.options.url.MAP_SERVICE_SHADED;\n\t        var r = new RequestHandler();\n\t        r.open('POST', url);\n\t        r.setContentType('application/x-www-form-urlencoded');\n\t        r.request.onload= function () {\n\t            // TODO: make a specific function to clear the old layer\n\t            // cleaning the pointLayers (if they were created)\n\t            _this._createPointLayer(l, this.responseText );\n\t        };\n\t        r.send(FM.Util.parseLayerRequest(l.layer));\n\t        r.request.onerror = function () {\n\t            // TODO: make a specific function to clear the old layer\n\t            // cleaning the pointLayers (if they were created)\n\t            if ( l.layer.pointsLayers ) {\n\t                for(var i=0; i < l.layer.pointsLayers.length; i++) {\n\t                    this.map.removeLayer(l.layer.pointsLayers[i]);\n\t                }\n\t            }\n\t        };\n\t    },\n\t\n\t    _createPointLayer: function(l, response) {\n\t        if (typeof response == 'string') response = $.parseJSON(response);\n\t        l.layer.sldurl = response.sldurl;\n\t        l.layer.urlWMS = response.geoserverwms;\n\t        l.layer.legendHTML = response.legendHTML;\n\t        l.layer.pointsJSON = response.pointsJSON;\n\t        this._refreshPointLayer(l);\n\t    },\n\t\n\t    _refreshPointLayer:function (l) {\n\t        // cleaning the pointLayers (if they were created)\n\t        if ( l.layer.pointsLayers ) {\n\t            for(var i=0; i < l.layer.pointsLayers.length; i++) {\n\t                this.map.removeLayer(l.layer.pointsLayers[i]);\n\t            }\n\t        }\n\t        if (typeof l.layer.pointsJSON == 'string') l.layer.pointsJSON = $.parseJSON(l.layer.pointsJSON);\n\t\n\t        var _this = this;\n\t        l.layer.pointsLayers = [];\n\t        for(var i=0; i < l.layer.pointsJSON.length; i++) {\n\t            var latlon = new L.LatLng(l.layer.pointsJSON[i].lat, l.layer.pointsJSON[i].lon);\n\t            // var latlon = new L.LatLng(7.09, -67.58);\n\t           // var properties =  { color: 'red', fillColor: '#f03', fillOpacity: 0.4, html: '<b>Venezuela (Bolivarian Republic of)</b><br>15,364,178.947 (Head)' };\n\t            var properties =  l.layer.pointsJSON[i].properties;\n\t\n\t            // setting the measurement unit\n\t            l.layer.pointsJSON[i].properties.measurementunit = '';\n\t            if ( l.layer.measurementuni != null )\n\t                l.layer.pointsJSON[i].properties.measurementunit = l.layer.measurementunit;\n\t\n\t            if (l.layer.pointColor != null) properties.color = l.layer.pointColor;\n\t            if (l.layer.pointFillColor != null) properties.fillColor = l.layer.pointFillColor;\n\t            if (l.layer.pointFillOpacity != null) properties.fillOpacity = l.layer.pointFillOpacity;\n\t\n\t            var marker = new L.CircleMarker(latlon, properties).addTo(this.map);\n\t\n\t            marker.setRadius(l.layer.pointsJSON[i].radius);\n\t            marker.bindPopup(properties.title + ' - ' + properties.value );\n\t            marker.on('mouseover', function () {\n\t                $(\"#\" + _this.suffix +\"-popup-join-point-holder\").show();\n\t                $(\"#\" + _this.suffix +\"-popup-join-point-text\").empty();\n\t                $(\"#\" + _this.suffix +\"-popup-join-point-value\").empty();\n\t                $(\"#\" + _this.suffix +\"-popup-join-point-text\").append( this.options.title );\n\t                // TODO: N.B. l.layer.measurementunit is used **/\n\t                $(\"#\" + _this.suffix +\"-popup-join-point-value\").append(this.options.value + '  <i>' + l.layer.measurementunit + '</i>');\n\t            });\n\t            marker.on('mouseout', function () {\n\t                $(\"#\" + _this.suffix +\"-popup-join-point-holder\").hide();\n\t            });\n\t            l.layer.pointsLayers.push(marker);\n\t        }\n\t    },\n\t\n\t    // syncronize the maps on movement\n\t    syncOnMove: function (mapToSync) {\n\t        FM.MapUtils.syncMapsOnMove(this.map, mapToSync);\n\t    },\n\t\n\t    // TODO: add other parameters in the request: I.E.\n\t    getFeatureInfo: function(e, l) {\n\t\n\t        // var fenixMap = e.target._fenixMap;\n\t        var fenixMap = this;\n\t        // get the layer that is been passed or the one that is selected in the Controller\n\t        var l = (l) ? l: fenixMap.controller.selectedLayer;\n\t        if ( l ) {\n\t            if (l.layer.layertype != null && l.layer.layertype == 'JOIN') {\n\t                FM.SpatialQuery.getFeatureInfoJoin(l, e.layerPoint, e.latlng, fenixMap);\n\t            }\n\t            else {\n\t                FM.SpatialQuery.getFeatureInfoStandard(l, e.layerPoint, e.latlng, fenixMap);\n\t            }\n\t        }\n\t    },\n\t\n\t    invalidateSize: function() {\n\t      this.map.invalidateSize();\n\t    },\n\t\n\t    // interface plugins\n\t    initializePlugins: function() {\n\t        if ( this.options.plugins != null ) {\n\t            var _this = this;\n\t            $.each(this.options.plugins, function(key, value) {\n\t                var pname = key.toLowerCase(),\n\t                \tinvoke = '_add' + pname;\n\t\n\t                if (FM.Plugins[invoke])\n\t                \t_this.plugins[pname] = FM.Plugins[invoke](_this, value);\n\t            });\n\t        }\n\t    },\n\t\n\t    /** Fenix Map  Exporting/Importing functionalities **/\n\t    cloneMap: function(id) {\n\t        var exportedMap = this.exportMap();\n\t        //JSON.stringify(exportedMap.layers, null, '\\t');\n\t        var v = JSON.stringify(exportedMap.layers, function(key, val) {\n\t            if (typeof val === 'function') {\n\t                return val + ''; // implicitly `toString` it\n\t            }\n\t            return val;\n\t        });\n\t        var clonedMap = new FM.Map(id, exportedMap.map.options, exportedMap.map.mapOptions);\n\t        clonedMap.createMap();\n\t        clonedMap.createMapFromJSON(exportedMap);\n\t        return clonedMap;\n\t    },\n\t\n\t    createMapFromJSON:function(json) {\n\t        /** TODO: add baselayers handling **/\n\t        this.loadOverlays(json.layers.overlays);\n\t    },\n\t\n\t    /** functionality to export the map definition **/\n\t    exportMap:function() {\n\t       var o = {};\n\t       o.map   = this._getMapOptions();\n\t       o.layers = this._getMapLayers();\n\t       return o;\n\t    },\n\t\n\t    exportMapToJSONFile:function() {\n\t        var json = this.exportMap();\n\t        var id = FM.Util.randomID();\n\t        var uriContent = \"data:application/octet-stream;filename=mapview-\"+ id +\".fnx,\" + encodeURIComponent(JSON.stringify(json));\n\t        var _window = window.open(uriContent, \"mapview-\"+ id +\".fnx\");\n\t        _window.focus();\n\t    },\n\t\n\t    _getMapOptions:function() {\n\t        return {\n\t            options: $.extend(true, {}, this.options),\n\t            plugins: $.extend(true, {}, this.plugins),\n\t            mapOptions: $.extend(true, _getCurrentMapOptions, this.mapOptions)            \n\t        };\n\t    },\n\t\n\t    _getMapLayers:function() {\n\t        return {\n\t            overlays: this.controller.exportOverlays()\n\t        };\n\t    },\n\t\n\t    loadOverlays: function(overlays) {\n\t        for(var i =0; i < overlays.length; i++) {\n\t            this.addLayer( new FM.layer(overlays[i]) );\n\t        }\n\t    },\n\t\n\t    zoomTo: function(layer, column, codes) {\n\t        FM.MapUtils.zoomTo(this, layer, column, codes)\n\t    },\n\t\n\t    zoomToCountry: function(column, codes) {\n\t        FM.MapUtils.zoomToCountry(this, column, codes)\n\t    },\n\t\n\t    labelsShow: function() {\n\t        this.layerLabels.addTo(this.map).bringToFront();\n\t    },\n\t\n\t    labelsHide: function() {\n\t        this.map.removeLayer(this.layerLabels);\n\t    },\n\t\n\t    boundariesShow: function() {\n\t        this.addLayer( this.layerBoundaries );\n\t        //TODO .bringToFront()\n\t    },\n\t\n\t    boundariesHide: function() {\n\t        this.removeLayer( this.layerBoundaries );\n\t    },\n\t\n\t    highlightCountry: function(codif, codes) {\n\t\n\t        codif = codif || 'iso3_code';\n\t        //codif = codif || 'adm0_code';\n\t\n\t        var self = this;\n\t\n\t        var rootUrl = this.options.url.DEFAULT_WMS_SERVER+\"/ows\";\n\t\n\t        self.highlightLayer.clearLayers();\n\t\n\t        for(var c in codes) {\n\t\n\t            var cbName = _.uniqueId('getJson');\n\t\n\t            var defaultParameters = {\n\t                service: 'WFS',\n\t                version: '1.0.0',\n\t                request: 'GetFeature',\n\t                typeName: 'fenix:gaul0_bounds',\n\t                maxFeatures: 50,\n\t                outputFormat: 'text/javascript',\n\t                format_options: 'callback: '+cbName,\n\t                viewparams: codif+':'+codes[c]\n\t            };\n\t\n\t            var parameters = L.Util.extend(defaultParameters),\n\t                url = rootUrl + L.Util.getParamString(parameters);\n\t\n\t            $.ajax({\n\t                url: url,\n\t                dataType: 'jsonp',\n\t                jsonpCallback: cbName,\n\t                success: function(json) {\n\t                    //console.log('JSONP',url, json)\n\t                    self.highlightLayer.addData(json);\n\t                    self.highlightLayer.bringToFront();\n\t                }\n\t            });\n\t        }\n\t    }\n\t});\n\t\n\tFM.map = function (id, options, mapOptions) {\n\t    return new FM.Map(id, options, mapOptions);\n\t};\n\t\n\tFM.LayerUtils = {\n\t\n\t    setLayerOpacity: function(l, opacity) {\n\t        if (l.leafletLayer) l.leafletLayer.setOpacity(opacity)\n\t        l.layer.opacity = opacity;\n\t    },\n\t\n\t    filterLayerMinEqualThan:function(fenixMap, l, value) {\n\t        l = FM.LayerUtils.getValuesMinEqualThan(l, value);\n\t        l.redraw();\n\t    },\n\t\n\t    filterLayerGreaterEqualThan:function(fenixMap, l, value) {\n\t        l = FM.LayerUtils.getValuesGreaterEqualThan(l, value);\n\t        l.redraw();\n\t    },\n\t\n\t    filterLayerInBetweenEqualThan:function(fenixMap, l, min, max) {\n\t        l = FM.LayerUtils.getValuesInBetweenEqualThan(l, min, max);\n\t        l.redraw();\n\t    },\n\t\n\t    filterLayerOuterEqualThan:function(fenixMap, l, min, max) {\n\t        l = FM.LayerUtils.getValuesOuterEqualThan(l, min, max);\n\t        l.redraw();\n\t    },\n\t\n\t    getValuesMinEqualThan:function(l, value) {\n\t        if (typeof l.layer.defaultdata == 'string')\n\t            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n\t        l.layer.joindata = [];\n\t        for(i=0; i < l.layer.defaultdata.length; i++) {\n\t            $.each(l.layer.defaultdata[i], function(k, v) {\n\t                if ( v <= value)  {\n\t                    // TODO: optimize it\n\t                    l.layer.joindata.push(l.layer.defaultdata[i]);\n\t                }\n\t            });\n\t        }\n\t        l.layer.joindata = JSON.stringify(l.layer.joindata);\n\t        return l;\n\t    },\n\t    getValuesGreaterEqualThan:function(l, value) {\n\t        if (typeof l.layer.defaultdata == 'string')\n\t            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n\t        l.layer.joindata = [];\n\t        for(i=0; i < l.layer.defaultdata.length; i++) {\n\t            $.each(l.layer.defaultdata[i], function(k, v) {\n\t                if ( v >= value)  {\n\t                    // TODO: optimize it\n\t                    l.layer.joindata.push(l.layer.defaultdata[i]);\n\t                }\n\t            });\n\t        }\n\t        l.layer.joindata = JSON.stringify(l.layer.joindata);\n\t        return l;\n\t    },\n\t\n\t    getValuesInBetweenEqualThan:function(l, min, max) {\n\t        if (typeof l.layer.defaultdata == 'string')\n\t            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n\t        l.layer.joindata = [];\n\t        for(i=0; i < l.layer.defaultdata.length; i++) {\n\t            $.each(l.layer.defaultdata[i], function(k, v) {\n\t                if ( v >= min && v <= max)  {\n\t                    // TODO: optimize it\n\t                    l.layer.joindata.push(l.layer.defaultdata[i]);\n\t                }\n\t            });\n\t        }\n\t        l.layer.joindata = JSON.stringify(l.layer.joindata);\n\t        return l;\n\t    },\n\t\n\t    getValuesOuterEqualThan:function(l, min, max) {\n\t        if (typeof l.layer.defaultdata == 'string')\n\t            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n\t        l.layer.joindata = [];\n\t        for(i=0; i < l.layer.defaultdata.length; i++) {\n\t            $.each(l.layer.defaultdata[i], function(k, v) {\n\t                if ( (min &&  v <= min) || (max &&  v >= max)) {\n\t                    // TODO: optimize it\n\t                    l.layer.joindata.push(l.layer.defaultdata[i]);\n\t                }\n\t            });\n\t        }\n\t        l.layer.joindata = JSON.stringify(l.layer.joindata);\n\t        return l;\n\t    }\n\t}\n\t;\n\t\n\tFM.Legend = {\n\t\n\t    getLegend: function(l, id, isReload) {\n\t\n\t        var legendOptions = $.extend({\n\t            forceLabels: 'on',\n\t            forceRule: 'true',\n\t            dx: '0',\n\t            dy: '0',\n\t            mx: '0',\n\t            my: '0',\n\t            fontAntiAliasing: 'true',\n\t            fontColor: '0x47576F',\n\t            bgColor: '0xF9F7F3',\n\t            border: 'false',\n\t            fontSize: '10'\n\t        }, l.layer.legendOptions);\n\t\n\t        // based on the layer type get the legendURL or Request\n\t        $('#'+id+'-legend-layertitle').empty();\n\t        $('#'+id+'-legendtitle').empty();\n\t        $('#'+id+'-legendsubtitle').empty();\n\t        $('#'+id+'-content').empty();\n\t\n\t        if (l.layer.layertitle) {\n\t            $('#'+id+'-legend-layertitle').append(l.layer.layertitle);\n\t        }\n\t        if (l.layer.legendtitle) {\n\t            $('#'+id+'-legendtitle').append(l.layer.legendtitle);\n\t        }\n\t        if (l.layer.legendsubtitle) {\n\t            $('#'+id+'-legendsubtitle').append(l.layer.legendsubtitle);\n\t        }\n\t\n\t        /* TODO: handle better, especially the l.layer.openlegend value*/\n\t        var html = '';\n\t        if (l.layer.legendHTML) {\n\t            html = l.layer.legendHTML;\n\t            $('#'+id+'-content').append(html);\n\t        }\n\t        else {\n\t            var url = l.layer.urlWMS  + '?';\n\t            url += '&service=WMS' +\n\t                '&version=1.1.0' +\n\t                '&REQUEST=GetLegendGraphic' +\n\t                '&layer=' + l.layer.layers +\n\t                '&Format=image/png';\n\t                //'&LEGEND_OPTIONS=forceRule:True;dx:0.1;dy:0.1;mx:0.1;my:0.1;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3';\n\t            if (l.layer.style != null && l.layer.style != '' )\n\t                url +=  '&style=' + l.layer.style;\n\t            if (l.layer.sldurl )\n\t                 url +=  '&sld=' + l.layer.sldurl;\n\t\n\t            //LEGEND STYLE DOCS\n\t            //http://goo.gl/MUIt8Z\n\t            var alternativeUrl = url;\n\t\n\t            url += '&LEGEND_OPTIONS=';\n\t            for(var k in legendOptions) {\n\t                url += k+':'+legendOptions[k]+';'\n\t            }\n\t\n\t            FM.Legend._loadLegend(url, alternativeUrl, id)\n\t        }\n\t\n\t        if ( isReload ) {\n\t            if(($('#'+id+'-holder').is(\":visible\"))) {\n\t                $('#'+id+'-holder').hide();\n\t                $('#'+id+'-holder').slideDown();\n\t                l.layer.openlegend = true;\n\t            }\n\t            else {\n\t            }\n\t        }\n\t        else{\n\t            if(!($('#'+id+'-holder').is(\":visible\"))) {\n\t                $('#'+id+'-holder').slideDown();\n\t                l.layer.openlegend = true;\n\t            } else {\n\t                $('#'+id+'-holder').slideUp();\n\t                l.layer.openlegend = false;\n\t            }\n\t        }\n\t\n\t        //$('#'+id+'-holder').draggable();\n\t        $('#' + id+ '-remove').click({id:id + '-holder'}, function(event) {\n\t            $('#' + event.data.id).slideUp();\n\t            l.layer.openlegend = false;\n\t        });\n\t    },\n\t\n\t    _loadLegend: function(url, alternativeUrl, id) {\n\t        var img = new Image();\n\t        img.name = url;\n\t        img.src = url;\n\t\n\t        var html = '<img id=\"'+id + '-img\" src=\"'+ img.src +'\" class=\"decoded\">';\n\t        img.onload = function() {\n\t            $('#'+id+'-content').append(html);\n\t            $('#'+id+'-img').css('width', this.width);\n\t            $('#'+id+'-img').css('height', this.height);\n\t        }\n\t        img.onerror = function() {\n\t            if ( alternativeUrl )\n\t                FM.Legend._loadLegend(alternativeUrl, null, id)\n\t            else\n\t                FM.Legend._nolegend(id);\n\t            // reload the image with different parameters (without legend_options)\n\t            // if returns again error, then le legend is not available\n\t            // '&LEGEND_OPTIONS=forceRule:True;dx:0.1;dy:0.1;mx:0.1;my:0.1;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3'+\n\t        }\n\t    },\n\t\n\t    _nolegend: function(id) {\n\t        /** TODO: getLegendURl http://gis.stackexchange.com/questions/21912/how-to-get-wms-legendgraphics-using-geoserver-and-geowebcache **/\n\t        var html = '<div class=\"fm-legend-layertitle\">no legend available</div>';\n\t        $('#'+id+'-content').append(html);\n\t    }\n\t    \n\t}\n\t;\n\tFM.MapUtils = function() {\n\t\n\t    var syncMapsOnMove = function (map, mapToSync) {\n\t        // this let you pass the FenixMap or the LeafletMap\n\t        var m = ( map.map ? map.map: map);\n\t        var mToSync = ( mapToSync.map ? mapToSync.map: mapToSync);\n\t        m.on('dragend zoomend', function(e) {\n\t            if ( m.getCenter() != mToSync.getCenter && m.getZoom() != mToSync.getZoom) {\n\t                mToSync.setView(m.getCenter(), m.getZoom());\n\t            }\n\t        });\n\t    };\n\t\n\t    var exportLayers = function(fenixmap) {\n\t        //console.log(fenixmap);\n\t    };\n\t\n\t    var zoomTo = function(m, layer, column, codes) {\n\t\n\t        var url = m.options.url.ZOOM_TO_BBOX + layer +'/'+ column+'/'+ codes.toString();\n\t\n\t        $.ajax({\n\t            type: \"GET\",\n\t            url: url,\n\t            success: function(response) {\n\t                if (m.hasOwnProperty(\"map\"))\n\t                    m.map.fitBounds(response);\n\t                else\n\t                    m.fitBounds(response);\n\t            }\n\t        });\n\t    };\n\t\n\t    var zoomToCountry = function(m, column, codes) {\n\t        zoomTo(m, \"country\", column, codes);\n\t    };\n\t\n\t    var fitWorldByScreen = function(m, bounds) {\n\t    \t//http://stackoverflow.com/questions/6048975/google-maps-v3-how-to-calculate-the-zoom-level-for-a-given-bounds\n\t\n\t\t\tvar worldBounds = L.latLngBounds([[-90, -180], [90, 180]]),\n\t\t\t\ttargetBounds = bounds instanceof L.LatLngBounds ? bounds : worldBounds,\n\t\n\t\t\t\tGLOBE_WIDTH = 190, // a constant in Google's map projection\n\t\t\t\tGLOBE_HEIGHT = 190, // a constant in Google's map projection\n\t\n\t\t\t\twest = targetBounds.getSouthWest().lng,\n\t\t\t\teast = targetBounds.getNorthEast().lng,\n\t\t\t\tangleW = east - west,\n\t\n\t\t\t\tnorth = targetBounds.getNorthEast().lat,\n\t\t\t\tsouth = targetBounds.getSouthWest().lat,\n\t\t\t\tangleH = north - south,\n\t\n\t\t\t\tmapW = m.getSize().x,\n\t\t\t\tmapH = m.getSize().y;\n\t\n\t\t\tif (angleW < 0)\n\t\t\t\tangleW += 360;\n\t\t\tif (angleH < 0)\n\t\t\t\tangleH += 360;\t\t\t\n\t\n\t\t\tvar zoomW = Math.round(Math.log(mapW * 360 / angleW / GLOBE_WIDTH) / Math.LN2),\n\t\t\t\tzoomH = Math.round(Math.log(mapH * 360 / angleH / GLOBE_HEIGHT) / Math.LN2),\n\t\t\t\tzoom = Math.max(zoomW, zoomH) - 1;\n\t\n\t\t\tm.setZoom(zoom, { animate: false });\n\t    };\n\t\n\t    return {\n\t        syncMapsOnMove: syncMapsOnMove,\n\t        exportLayers: exportLayers,\n\t        zoomTo: zoomTo,\n\t        zoomToCountry: zoomToCountry,\n\t        fitWorldByScreen: fitWorldByScreen\n\t    }\n\t\n\t}();;\n\tFM.Plugins = {\n\t    /*\n\t    //geocoder\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.js\"\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.css\"\n\t    //geosearch\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geosearch/1.0/l.control.geosearch.js\",\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.provider.openstreetmap.js\"\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.css\"\n\t    //mouseposition\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.js\"\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.css\"\n\t    //drawcontrol\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.js\"\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.css\"\n\t    //controlloading\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.js\"\n\t    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.css\"\n\t    */\n\t    _addzoomcontrol: function(_fenixmap, show) {\n\t    \tif( show ) {\n\t\t    \tvar pos = typeof _fenixmap.options.plugins.zoomcontrol === 'string' ? \n\t\t\t\t\t\t\t\t_fenixmap.options.plugins.zoomcontrol : 'bottomright';\n\t\t        return new L.Control.Zoom({position: pos}).addTo(_fenixmap.map);\n\t       \t}\n\t    },\n\t\n\t    _addfullscreen: function(_fenixmap, show) {\n\t        if ( show && window.fullScreenApi && window.fullScreenApi.supportsFullScreen) {\n\t\t\t\treturn (function() {\n\t\n\t                //TODO second click on button exit from fullscreen\n\t\n\t\t\t\t\tvar zoompos = typeof _fenixmap.options.plugins.zoomcontrol === 'string' ? \n\t\t\t\t\t\t\t_fenixmap.options.plugins.zoomcontrol : 'bottomright',\n\t\t\t\t\t\tpos = typeof _fenixmap.options.plugins.fullscreen === 'string' ? \n\t\t\t\t\t\t\t_fenixmap.options.plugins.fullscreen : zoompos,\n\t\t\t\t\t\tcontrol = new L.Control({position: pos});\n\t\n\t\t\t\t\tcontrol.onAdd = function(map) {\n\t\t\t\t\t\tvar div = L.DomUtil.create('div','leaflet-control-fullscreen fm-icon-box-background'),\n\t\t\t\t\t\t\ta = L.DomUtil.create('a','fm-icon-sprite fm-btn-icon', div);\n\t\t\t\t\t\tL.DomEvent\n\t\t\t\t\t\t\t.disableClickPropagation(a)\n\t\t\t\t\t\t\t.addListener(a, 'click', function() {\n\t\n\t\t\t\t\t\t\t\tvar idDiv = _fenixmap.options.plugins.fullscreen.id || _fenixmap.id,\n\t                                mapdiv = document.getElementById(idDiv);\n\t\n\t                            if( window.fullScreenApi.isFullScreen(mapdiv) )\n\t                                window.fullScreenApi.cancelFullScreen(mapdiv);\n\t                            else\n\t                                window.fullScreenApi.requestFullScreen(mapdiv);\n\t\t\t\t\t\t\t}, a);\n\t\t\t\t\t\treturn div;\n\t\t\t\t\t};\n\t\t\t\t\treturn control;\n\t\t\t\t}())\n\t\t\t\t.addTo(_fenixmap.map);\n\t        }\n\t    },\n\t\n\t    _addzoomresetcontrol: function( _fenixmap, show) {\n\t    \tif( show ) {\n\t\t\t\treturn (function() {\n\t\t\t\t\tvar zoompos = typeof _fenixmap.options.plugins.zoomcontrol === 'string' ? \n\t\t\t\t\t\t\t_fenixmap.options.plugins.zoomcontrol : 'bottomright',\n\t\t\t\t\t\tpos = typeof _fenixmap.options.plugins.zoomresetcontrol === 'string' ? \n\t\t\t\t\t\t\t_fenixmap.options.plugins.zoomresetcontrol : zoompos,\n\t\t\t\t\t\tcontrol = new L.Control({position: pos}),\n\t\t\t\t\t\tcontainer = _fenixmap.plugins.zoomcontrol._container;\n\t\n\t\t\t\t\tcontrol.onAdd = function(map) {\n\t\t\t\t\t\t\tvar a = L.DomUtil.create('div','leaflet-control-zoom-reset',container);\n\t\t\t\t\t\t\ta.innerHTML = \"&nbsp;\";\n\t\t\t\t\t\t\ta.title = \"Zoom Reset\";\n\t\t\t\t\t\t\tL.DomEvent\n\t\t\t\t\t\t\t\t.disableClickPropagation(a)\n\t\t\t\t\t\t\t\t.addListener(a, 'click', function() {\n\t\t\t\t\t\t\t\t\tmap.setView(map.options.center, map.options.zoom);\n\t\t\t\t\t\t\t\t},a);\n\t\t\t\t\t\t\tvar d = L.DomUtil.create('span');\n\t\t\t\t\t\t\td.style.display = 'none';\n\t\t\t\t\t\t\treturn d;\n\t\t\t\t\t\t};\n\t\t\t\t\treturn control;\n\t\t\t\t}())\n\t\t\t\t.addTo(_fenixmap.map);\n\t\t\t}    \t\n\t    },\n\t\n\t    _adddisclaimerfao: function(_fenixmap, show) {\n\t        if ( show ) {\n\t\t\t\treturn (function() {\n\t\t\t\t\tvar pos = typeof _fenixmap.options.plugins.disclaimerfao === 'string' ? \n\t                        _fenixmap.options.plugins.disclaimerfao : 'bottomright',\n\t\t\t\t\t\tcontrol = new L.Control({position: pos}),\n\t\t\t\t\t\tlang = _fenixmap.options.lang.toLowerCase();\n\t\n\t\t\t\t\tcontrol.onAdd = function(map) {\n\t\t\t\t\t\t\tvar div = L.DomUtil.create('div','leaflet-control-disclaimer fm-icon-box-background'),\t\t\t\t\t\n\t\t\t\t\t\t\t\ta = L.DomUtil.create('a','fm-icon-sprite fm-icon-info', div);\n\t\n\t\t\t\t\t\t\ta.title = FM.guiMap['disclaimerfao_'+lang];\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t$(a).tooltip({placement:'left'});\n\t\n\t\t\t\t\t\t\treturn div;\n\t\t\t\t\t\t};\n\t\t\t\t\treturn control;\n\t\t\t\t}())\n\t\t\t\t.addTo(_fenixmap.map);\n\t        }\n\t    },\n\t\n\t    _addlayercontroller: function(_fenixmap, show){\n\t        if ( show )\n\t            $(\"#\" + this.suffix +\"-controller\").show();\n\t        else\n\t            $(\"#\" + this.suffix +\"-controller\").hide();\n\t    },\n\t\n\t    _addgeosearch: function(_fenixmap, show) {\n\t        if ( show && L.GeoSearch) {\n\t            return new L.Control.GeoSearch({\n\t                provider: new L.GeoSearch.Provider.OpenStreetMap()\n\t            }).addTo(_fenixmap.map);\n\t        }\n\t    },\n\t\n\t    _addgeocoder: function(_fenixmap, show) {\n\t        // TODO: should be load here dinamically the requires JS\n\t        if ( show && L.Control.OSMGeocoder) {\n\t            return new L.Conpluginstrol.OSMGeocoder().addTo(_fenixmap.map);\n\t        }\n\t    },\n\t\n\t    _addmouseposition: function(_fenixmap, show) {\n\t        if ( show && L.control.mousePosition) {\n\t        \tL.control.mousePosition().addTo(_fenixmap.map);\n\t        }\n\t    },\n\t\n\t    _addexport: function(_fenixmap, show) {\n\t        if ( show && L.Control.Export) {\n\t        \t_fenixmap.map.addControl(new L.Control.Export())\n\t        }\n\t    },\n\t\n\t    _addprintmodule: function(_fenixmap, show) {\n\t        if ( show && L.print)\n\t            /** TODO: install print module **/\n\t            var printProvider = L.print.provider({\n\t                method: 'GET',\n\t                url: 'http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf',\n\t                autoLoad: true,\n\t                dpi: 254\n\t            });\n\t        var printControl = L.control.print({ provider: printProvider });\n\t        _fenixmap.map.addControl(printControl);\n\t    },\n\t\n\t    /**\n\t     *\n\t     *\n\t     * TODO: handle the layer control on layer selection to make spatial query\n\t     *\n\t     * (i.e. if a layer has certain properties add the draw control and remove it when is deselected )\n\t     *\n\t     *\n\t     **/\n\t    _adddrawcontrol: function(_fenixmap, show) {\n\t        if ( show && L.Control.Draw) {\n\t\n\t            var drawnItems = new L.FeatureGroup();\n\t            _fenixmap.map.addLayer(drawnItems);\n\t\n\t            var drawControl = new L.Control.Draw({\n\t                draw: {\n\t                    position: 'topleft',\n\t                    polygon: {\n\t                        title: 'Draw a polygon!',\n\t                        allowIntersection: false,\n\t                        drawError: {\n\t                            color: '#b00b00',\n\t                            timeout: 1000\n\t                        },\n\t                        shapeOptions: {\n\t                            color: '#bada55'\n\t                        }\n\t                    },\n\t                    circle: {\n\t                        shapeOptions: {\n\t                            color: '#662d91'\n\t                        }\n\t                    }\n\t                },\n\t                edit: {\n\t                    featureGroup: drawnItems\n\t                }\n\t            });\n\t            _fenixmap.map.addControl(drawControl);\n\t\n\t            _fenixmap.map.on('draw:created', function (e) {\n\t                var type = e.layerType,\n\t                    layer = e.layer;\n\t\n\t                if (type === 'marker') {\n\t\n\t                    layer.bindPopup('A popup!');\n\t                    //console.log(layer.getLatLng());\n\t                    //console.log(_fenixmap.map.options.crs.project(layer.getLatLng()));\n\t                }\n\t                //console.log(\"created \" + e.layerType);\n\t                l = layer;\n\t                l.layerType = type;\n\t                drawnItems.addLayer(layer);\n\t\n\t                _fenixmap.spatialQuery(layer)\n\t\n\t            });\n\t\n\t            _fenixmap.map.on('draw:edited', function (e) {\n\t                var layers = e.layers;\n\t                var countOfEditedLayers = 0;\n\t                layers.eachLayer(function(layer) {\n\t                    countOfEditedLayers++;\n\t                });\n\t            });\n\t        }\n\t    },\n\t\n\t    _addcontrolloading: function( _fenixmap, show) {\n\t        if ( show && L.Control.loading) {\n\t            var loadingControl = L.Control.loading({\n\t                separate: true,\n\t                position: 'topright'\n\t            });\n\t            _fenixmap.map.addControl(loadingControl)\n\t        }\n\t    },\n\t\n\t    _addscalecontrol: function( _fenixmap, show) {\n\t        if( show && L.Control.Scale) {\n\t            var pos = typeof _fenixmap.options.plugins.scalecontrol === 'string' ? \n\t                    _fenixmap.options.plugins.scalecontrol : 'topleft';\n\t            \n\t            L.control.scale({position: pos}).addTo(_fenixmap.map);\n\t        }\n\t    },\n\t\n\t    _addlegendcontrol: function( _fenixmap, show) {\n\t        if( show ) {\n\t            return (function() {\n\t                var pos = typeof _fenixmap.options.plugins.legendcontrol === 'string' ? \n\t                        _fenixmap.options.plugins.legendcontrol : 'topright',\n\t                    control = new L.Control({position: pos});\n\t\n\t                control.onAdd = function(map) {\n\t                    var div = L.DomUtil.create('div','leaflet-control-legend');\n\t                    //FILLED BY JQUERY\n\t                    return div;\n\t                };\n\t                return control;\n\t            }())\n\t            .addTo(_fenixmap.map);\n\t        }\n\t    }\n\t}\n\t;\n\tFM.SpatialQuery = {\n\t\n\t    /**\n\t     *\n\t     * Perform a GetFeautreInfo with a Joined Layer\n\t     *\n\t     * @param l\n\t     * @param layerPoint\n\t     * @param latlng\n\t     * @param map\n\t     */\n\t    getFeatureInfoJoin: function(l, layerPoint, latlng, fenixmap) {\n\t        // setting a custom popup if it's not available\n\t        if (l.layer.customgfi == null )\n\t            FMDEFAULTLAYER.joinDefaultPopUp(l.layer)\n\t\n\t        FM.SpatialQuery.getFeatureInfoStandard(l, layerPoint, latlng, fenixmap);\n\t    },\n\t\n\t\n\t    /**\n\t     *\n\t     * GetFeatureInfo standard (used to WMS GetFeatureInfoRequests)\n\t     *\n\t     * @param l\n\t     * @param layerPoint\n\t     * @param latlng\n\t     * @param map\n\t     */\n\t    getFeatureInfoStandard: function(l, layerPoint, latlng, fenixmap) {\n\t\n\t        // bind to leaflet map\n\t        var map = fenixmap.map;\n\t\n\t        // query parameters for the GFI\n\t        var bounds = map.getBounds();\n\t        var sw = map.options.crs.project(bounds.getSouthWest());\n\t        var ne = map.options.crs.project(bounds.getNorthEast());\n\t        var BBOX = (sw.x ) + ',' + (sw.y) +',' + (ne.x) + ',' + (ne.y);\n\t        var WIDTH = map.getSize().x;\n\t        var HEIGHT = map.getSize().y;\n\t        var X = map.layerPointToContainerPoint(layerPoint).x;\n\t        var Y = map.layerPointToContainerPoint(layerPoint).y;\n\t        // TODO: check it because in theory it shouldn't be needed\n\t        X = new Number(X);\n\t        X = X.toFixed(0) //13.3714\n\t        Y = new Number(Y);\n\t        Y = Y.toFixed(0) //13.3714\n\t        var url = fenixmap.options.url.MAP_SERVICE_GFI_STANDARD;\n\t        url += '?SERVICE=WMS';\n\t        url += '&VERSION=1.1.1';\n\t        url += '&REQUEST=GetFeatureInfo';\n\t        url += '&BBOX='+BBOX;\n\t        url += '&HEIGHT='+HEIGHT;\n\t        url += '&WIDTH='+WIDTH;\n\t        url += '&X='+X;\n\t        url += '&Y='+Y;\n\t        url += '&FORMAT=image/png';\n\t        url += '&INFO_FORMAT=text/html';\n\t\n\t        // get the selected layer and layer values\n\t        if ( l != '' && l != null ) {\n\t            url += '&LAYERS=' + l.layer.layers;\n\t            url += '&QUERY_LAYERS=' + l.layer.layers;\n\t            url += '&STYLES=';\n\t            // TODO: this should be loaded at runtime based on the projection used on the map?\n\t            url += '&SRS=EPSG:3857';\n\t            //l.layer.srs; //EPSG:3857\n\t            url += '&urlWMS=' + l.layer.urlWMS;\n\t            FM.SpatialQuery.getFeatureInfoJoinRequest(url, 'GET', latlng, map, l);\n\t        }\n\t        else {\n\t            // alert('no layer selected')\n\t        }\n\t    },\n\t\n\t    customPopup: function(response, custompopup, lang, joindata, layer) {\n\t\n\t        var html = '<div class=\"fm-popup\">'+\n\t                '{{' + layer.joincolumnlabel + '}} <br />'+\n\t                '<b>{{{' + layer.joincolumn + '}}} </b> '+ layer.mu +\n\t            '</div>';\n\t\n\t        if(custompopup.content && custompopup.content[lang])\n\t            html = custompopup.content[lang];\n\t\n\t        var values = this._parseHTML(html);\n\t        if ( values.id.length > 0 || values.joinid.length > 0) {\n\t            var h = $('<div></div>').append(response);\n\t            var responsetable = h.find('table');\n\t            if ( responsetable) {\n\t                return FM.SpatialQuery._customizePopUp(html, values, responsetable, joindata, layer );\n\t            }\n\t        }\n\t\n\t    },\n\t\n\t    // TODO: use an isOnHover flag?\n\t    getFeatureInfoJoinRequest: function(url, requestType, latlon, map, l) {\n\t        var lang = l.layer.lang != null? l.layer.lang : map.options.lang;\n\t        var _map = map;\n\t        var _l = l;\n\t        $.ajax({\n\t            type: \"GET\",\n\t            url: url,\n\t            success: function(response) {\n\t                // do something to response\n\t                if ( response != null ) {\n\t                    // rendering the output\n\t                    var maxWidth = $('#' + _map._fenixMap.id).width() - 15;\n\t                    var maxHeight = $('#' + _map._fenixMap.id).height() - 15;\n\t                    var popup = new L.Popup({maxWidth: maxWidth, maxHeight: maxHeight});\n\t\n\t                    /** TODO: do it MUCH nicer **/\n\t                    var r = response;\n\t                    if (_l.layer.customgfi) {\n\t                        var joindata = _l.layer.joindata != null? _l.layer.joindata : _l.layer.data;\n\t                        var result = FM.SpatialQuery.customPopup(response, _l.layer.customgfi, lang, joindata, l.layer);\n\t                        // TODO: handle multiple outputs\n\t                        r = (result != null) ? result[0] : response;\n\t                    }\n\t                    else {\n\t                        var result = FM.SpatialQuery.transposeHTMLTable(response, _l.layer.layertitle);\n\t                        r = (result != null) ? result[0] : response;\n\t                    }\n\t\n\t                    // check if the output is an empty (geoserver) output\n\t                    r = FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(r);\n\t\n\t                    // how to handle custom callback\n\t                    if (_l.layer.customgfi) {\n\t                        if (_l.layer.customgfi && _l.layer.customgfi.callback) ( _l.layer.customgfi.callback(r, _l.layer) )\n\t                        if (_l.layer.customgfi && _l.layer.customgfi.output && _l.layer.customgfi.output.show) {\n\t                            $('#' + _l.layer.customgfi.output.id).empty();\n\t                            if (r) {\n\t                                $('#' + _l.layer.customgfi.output.id).append(r);\n\t                            }\n\t                        }\n\t                        if (_l.layer.customgfi && _l.layer.customgfi.showpopup) {\n\t                            if (r) {\n\t                                popup.setLatLng(latlon).setContent(r);\n\t                                _map.openPopup(popup);\n\t                            }\n\t                        }\n\t                    }\n\t                    else {\n\t                        if (r) {\n\t                            popup.setLatLng(latlon).setContent(r);\n\t                            _map.openPopup(popup);\n\t                        }\n\t                    }\n\t                }\n\t            }\n\t        });\n\t    },\n\t\n\t    /** TODO: how to check it?  **/\n\t    _checkGeoserverDefaultEmptyOutput: function(response) {\n\t        return response;\n\t    },\n\t\n\t    _customizePopUp:function(content, values, responsetable, joindata, layer) {\n\t\n\t        var tableHTML = responsetable.find('tr');\n\t        var headersHTML = $(tableHTML[0]).find('th');\n\t        var rowsData = [];\n\t\n\t        // get only useful headers\n\t        var headersHTMLIndexs = [];\n\t        for ( var i=0;  i < headersHTML.length; i ++) {\n\t            for (var j=0; j< values.id.length; j++) {\n\t                if (values.id[j].toUpperCase() == headersHTML[i].innerHTML.toUpperCase()) {\n\t                    headersHTMLIndexs.push(i);\n\t                    break;\n\t                }\n\t            }\n\t        }\n\t\n\t        // this is in case the joinid is not empty TODO: split the code\n\t        if ( joindata ) {\n\t            var headersHTMLJOINIndexs = [];\n\t            for ( var i=0;  i < headersHTML.length; i ++) {\n\t                for (var j=0; j< values.joinid.length; j++) {\n\t                    if ( values.joinid[j].toUpperCase() == headersHTML[i].innerHTML.toUpperCase()) {\n\t                        headersHTMLJOINIndexs.push(i); break;\n\t                    }\n\t                }\n\t            }\n\t        }\n\t\n\t        // get rows data\n\t        for(var i=1; i<tableHTML.length; i ++) {\n\t            rowsData.push($(tableHTML[i]).find('td'))\n\t        }\n\t\n\t        // create the response results\n\t        var htmlresult = [];\n\t        for( var j=0; j < rowsData.length; j++) {\n\t\n\t            // this is done for each row of result (They could be many rows)\n\t            var c = content;\n\t\n\t            // Replace IDs\n\t            for(var i=0; i<headersHTMLIndexs.length; i ++) {\n\t                var header = '{{' + headersHTML[headersHTMLIndexs[i]].innerHTML + '}}';\n\t                var d = rowsData[j][headersHTMLIndexs[i]].innerHTML;\n\t                c = FM.Util.replaceAll(c, header, d);\n\t            }\n\t\n\t            // Replace joindata (if needed)\n\t            // used to add dynamically the measurementunit\n\t            var checkJoinData = false;\n\t            if ( joindata ) {\n\t                for(var i=0; i<headersHTMLJOINIndexs.length; i ++) {\n\t                    var header = '{{{' + headersHTML[headersHTMLJOINIndexs[i]].innerHTML + '}}}';\n\t                    var d = rowsData[j][headersHTMLJOINIndexs[i]].innerHTML;\n\t                    var v = FM.SpatialQuery._getJoinValueFromCode(d, joindata);\n\t                    v = (v !== 'NA' && layer.decimalvalues)? v.toFixed(layer.decimalvalues): v;\n\t                    c = FM.Util.replaceAll(c, header, v);\n\t                    if (v !== 'NA') {\n\t                        checkJoinData = true;\n\t                    }\n\t                }\n\t            }\n\t\n\t            // adding the row result to the outputcontent\n\t            htmlresult.push(c)\n\t        }\n\t\n\t        // \"dynamic\" measurementunit change\n\t        htmlresult[0] = FM.Util.replaceAll(htmlresult[0], \"{{measurementunit}}\", (checkJoinData)? layer.measurementunit: '');\n\t\n\t        return htmlresult;\n\t    },\n\t\n\t\n\t    _getJoinValueFromCode: function(code, joindata) {\n\t        //TODO: do it nicer: the problem on the gaul is that the code is a DOUBLE and in most cases it uses an INTEGER\n\t        var integerCode = ( parseInt(code) )? parseInt(code): null\n\t        //console.log(integerCode);\n\t        var json = ( typeof joindata == 'string' )? $.parseJSON(joindata) : joindata;\n\t        for(var i=0; i< json.length; i++) {\n\t            if ( json[i][code] || json[i][integerCode] ) {\n\t                if ( json[i][code] ) {\n\t                    //console.log( json[i][code]);\n\t                    return json[i][code];\n\t                }\n\t                else {\n\t                    //console.log( json[i][integerCode]);\n\t                    return json[i][integerCode];\n\t                }\n\t            }\n\t        }\n\t        return 'NA';\n\t        //return 'No data available for this point';\n\t    },\n\t\n\t    /**\n\t     *\n\t     * Get all {{value}}\n\t     * @private\n\t     */\n\t    _parseHTML: function(content) {\n\t        var values = {};\n\t        values.id = [];\n\t        values.joinid = [];\n\t\n\t        //console.log(content);\n\t        var array = content.match(/\\{\\{.*?\\}\\}/g);\n\t        for (var i=0; i < array.length; i++) {\n\t            array[i] = FM.Util.replaceAll(array[i], \"{{\", \"\");\n\t            array[i] = FM.Util.replaceAll(array[i], \"}}\", \"\");\n\t\n\t            // if it contains $ (this means that is a joinid\n\t            if ( array[i].indexOf('{') >= 0 ) {\n\t                array[i] = FM.Util.replaceAll(array[i], \"{\", \"\");\n\t                array[i] = FM.Util.replaceAll(array[i], \"}\", \"\");\n\t                values.joinid.push(array[i]);\n\t            }\n\t            else {\n\t                values.id.push(array[i]);\n\t            }\n\t        }\n\t        return values;\n\t    },\n\t\n\t    transposeHTMLTable: function(response, layertitle){\n\t        /** TODO: make it nicer **/\n\t        var h = $('<div></div>').append(response);\n\t        var table = h.find('table');\n\t        var result = [];\n\t        if ( table ) {\n\t            var r = FM.SpatialQuery.transposeHTML(table, layertitle);\n\t            if ( r != null ) return r;\n\t        }\n\t        return null;\n\t    },\n\t\n\t    transposeHTML:function(table, layertitle) {\n\t        var div = $('<div class=\"fm-transpose-popup\"></div>');\n\t        var titleHTML = table.find('caption');\n\t        try {\n\t            div.append(layertitle)\n\t\n\t            var tableHTML = table.find('tr');\n\t\n\t            var headers = $(tableHTML[0]).find('th');\n\t            var rowsData = [];\n\t            for ( var i =1;  i < tableHTML.length; i ++) {\n\t                rowsData.push($(tableHTML[i]).find('td'))\n\t            }\n\t\n\t            var t = $('<table></table>');\n\t            var tb = $('<tbody></tbody>');\n\t            for( var i =0; i < headers.length; i++) {\n\t                var tr = '<tr>';\n\t                var td = '<td>' + headers[i].innerHTML + '</td>';\n\t                for(var j = 0; j < rowsData.length; j++) {\n\t                    td += '<td>' +rowsData[j][i].innerHTML + '</td>';\n\t                }\n\t                tr += td;\n\t                tr += '</tr>';\n\t                tb.append(tr);\n\t            }\n\t            return div.append(t.append(tb));\n\t        } catch (e) {\n\t            return null;\n\t        }\n\t    },\n\t\n\t    filterLayerMinEqualThan: function(l, value) {\n\t        FM.LayerUtils.filterLayerMinEqualThan(this, l, value);\n\t    },\n\t\n\t    filterLayerGreaterEqualThan:function(l, value) {\n\t        FM.LayerUtils.filterLayerGreaterEqualThan(this, l, value);\n\t    },\n\t\n\t    filterLayerInBetweenEqualThan:function(l, min, max) {\n\t        FM.LayerUtils.filterLayerInBetweenEqualThan(this, l, min, max);\n\t    },\n\t\n\t    filterLayerOuterEqualThan:function(l, min, max) {\n\t        FM.LayerUtils.filterLayerOuterEqualThan(this, l, min, max);\n\t    }\n\t\n\t}\n\t;\n\tFM.LayerSwipe = {\n\t\n\t    swipeActivate: function(l, handleID, containerID, map) {\n\t        l.layer.swipeActive = true;\n\t        var l_parent = l.leafletLayer._container,\n\t           // handle = document.getElementById(fenixMap.suffix +  '-handle'),\n\t            handle = document.getElementById(handleID),\n\t            dragging = false;\n\t/*        console.log('L_parent');\n\t        console.log(l_parent);*/\n\t        handle.onmousedown = function() { dragging = true; return false;}\n\t        document.onmouseup = function() { dragging = false; }\n\t        document.onmousemove = function(e) {\n\t            if (!dragging) return;\n\t            setDivide(e.x);\n\t        }\n\t\n\t        var _this = this;\n\t\n\t        l.redraw = function( e ) {\n\t            l_parent = l.leafletLayer._container;\n\t            setDivide(parseInt(handle.style.left));\n\t        };\n\t\n\t        l.mousemoveSwipe = function( e ) {\n\t            l_parent = l.leafletLayer._container;\n\t            setDivide(e.containerPoint.x);\n\t        };\n\t\n\t        map.on( \"zoomend\", l.redraw);\n\t        map.on( \"moveend\", l.redraw);\n\t        map.on( \"drag\", l.redraw);\n\t        map.on( \"mousemove\", l.mousemoveSwipe );\n\t\n\t        function setDivide(x) {\n\t            x = Math.max(0, Math.min(x, map.getSize()['x']));\n\t            handle.style.left = (x) + 'px';\n\t            var layerX = map.containerPointToLayerPoint(x,0).x\n\t            l_parent.style.clip = 'rect(-99999px ' + layerX + 'px 999999px -99999px)';\n\t        }\n\t\n\t        // set 50% of the width, maybe start with 0?\n\t       // var mydiv =  $('#' + fenixMap.suffix + '-map').width();\n\t        var mydiv =  $('#' + containerID).width();\n\t       // console.log(mydiv);\n\t        setDivide(mydiv / 2);\n\t    },\n\t\n\t    swipeDeactivate: function(l, map) {\n\t        map.off( \"zoomend\", l.redraw);\n\t        map.off( \"moveend\", l.redraw);\n\t        map.off( \"drag\", l.redraw);\n\t        map.off( \"mousemove\", l.mousemoveSwipe );\n\t        l.layer.swipeActive = false;\n\t\n\t        var l_parent = l.leafletLayer._container;\n\t        l_parent.style.clip = 'auto';\n\t    }\n\t\n\t}\n\t;\n\t\n\tFM.MAPController = FM.Class.extend({\n\t\n\t    id: '',\n\t\n\t    suffix: '',\n\t\n\t    _map: '',\n\t\n\t    _fenixMap: '',\n\t\n\t    _guiController:  {\n\t        container: null,\n\t        overlay : true,\n\t        baselayer: true,\n\t        layersthumbs: true\n\t    },\n\t\n\t    /** Used by the controller **/\n\t    baseLayersMap:    '',    // should be an hashmap (id, layer)\n\t    currentBaseLayer: '', // this is the layer that is currently the baselayer\n\t\n\t    layersMap: '',  // HashMap(l.id, l)\n\t\n\t    layersMapZIndexes: '', // HashMap(l.zindex, l.id)\n\t\n\t    zIndexBaseLayer: 10, // TODO: modify it automatically on every update/adding of the layer checking the higher\n\t\n\t    zIndex: 100, // TODO: modify it automatically on every update/adding of the layer checking the higher\n\t\n\t    // used for the GFI\n\t    selectedLayer: '',\n\t\n\t    // GUI\n\t    // left controller\n\t    $boxIcons: '',\n\t    $boxMenu: '',\n\t    $boxMenuContainer: '',\n\t    $boxMenuSelected: '', // i.e. SelectedLayers, BaseLayers WMS Layers\n\t\n\t    getFeautureInfoLayer: [],\n\t    // TODO: this is the list of the layers selected for the GFI\n\t\n\t    initialize: function(suffix, fenixMap, map, guiOpts) { // (HTMLElement or String, Object)\n\t        this._map = map;\n\t        this._fenixMap = fenixMap;\n\t        this.suffix = suffix;\n\t        this.id = suffix + '-controller';\n\t        this._guiController = $.extend({}, this._guiController, guiOpts);\n\t\n\t        // initialize HashMaps\n\t        this.baseLayersMap = new HashMap();\n\t        this.layersMap = new HashMap();\n\t        this.layersMapZIndexes = new HashMap();\n\t    },\n\t\n\t    /**\n\t     *\n\t     * initialize the Layer Controller GUI\n\t     *\n\t     */\n\t    initializeGUI:function() {\n\t\n\t        var self = this;\n\t\n\t        if ( self._guiController &&\n\t                (self._guiController.overlay ||\n\t                 self._guiController.baselayer ||\n\t                 self._guiController.wmsLoader)\n\t            ) {\n\t\n\t            var mapDiv$ = $('#' + self.id);\n\t\n\t            self.$boxMenu = $(FM.Util.replaceAll(FM.guiController.boxMenu, 'REPLACE', self.suffix));\n\t\n\t            self.$boxMenuContainer = self.$boxMenu.find('#' + self.suffix + '-controller-box-content');\n\t            \n\t            self.$boxIcons = $(FM.Util.replaceAll(FM.guiController.boxIcons, 'REPLACE', self.suffix));\n\t\n\t            self.visibleBoxMenu;\n\t\n\t            if( self._guiController.container ) {\n\t\n\t                var $div = $('<div class=\"fm-controller-external\">')\n\t                    .append(self.$boxIcons, self.$boxMenu);\n\t\n\t                $div.prependTo(self._guiController.container);\n\t\n\t                self.visibleBoxMenu = true;\n\t            }\n\t            else\n\t            {\n\t                self.visibleBoxMenu = false;\n\t\n\t                var guiControl = (function() {\n\t                    var control = new L.Control({position: 'bottomleft'});\n\t\n\t                    control.onAdd = function(map) {\n\t\n\t                        var $div = $('<div class=\"leaflet-control-controller\">')\n\t                            .append(self.$boxIcons, self.$boxMenu);\n\t\n\t                        if (!L.Browser.touch) {\n\t                            L.DomEvent.disableClickPropagation($div[0]);\n\t                            L.DomEvent.on($div[0], 'mousewheel', L.DomEvent.stopPropagation);\n\t                        }\n\t                        else\n\t                            L.DomEvent.on($div[0], 'click', L.DomEvent.stopPropagation);\n\t\n\t                        return $div[0];\n\t                    };\n\t                    return control;\n\t                }()).addTo(self._map);\n\t            }\n\t\n\t            /** TODO: make it nicer and more dynamic, with a more consistent name **/\n\t            if ( self._guiController.overlay) {\n\t                self.loadIcon('overlay', self.visibleBoxMenu);\n\t                self.initializeOverlayDragging();\n\t            }\n\t            if ( self._guiController.baselayer) {\n\t                self.loadIcon('baselayer', self.visibleBoxMenu);\n\t            }\n\t\n\t            if ( self._guiController.wmsLoader) {\n\t                self.loadIcon('wmsLoader', self.visibleBoxMenu);\n\t                var wmsUtils = new FM.WMSUtils(),\n\t                    idDD = this.suffix + '-controller-wmsLoader-dropdown',\n\t                    idContent = this.suffix + '-controller-wmsLoader-content',\n\t                    wmsServers = FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;\n\t                    \n\t                wmsUtils.WMSCapabilities(idDD, idContent, this._fenixMap, wmsServers);\n\t            }\n\t        }\n\t    },\n\t\n\t    /**\n\t     *\n\t     * Inizialize an Icon to load\n\t     *\n\t     * @param toLoad\n\t     */\n\t    loadIcon: function(toLoad, visibleBox) {\n\t        var guiBox = toLoad + 'Box';\n\t        var guiIcon = toLoad + 'Icon';\n\t\n\t        visibleBox = typeof visibleBox !== 'undefined' ? visibleBox : false;\n\t\n\t        this.$boxMenuContainer.append(\n\t            FM.Util.replaceAll(FM.guiController[guiBox], 'REPLACE', this.suffix)\n\t        );\n\t\n\t        if(visibleBox===false) {\n\t            this.$boxMenu.hide();\n\t            //this.$boxMenuContainer.find('.fm-box-zindex').hide();\n\t        }else {\n\t            this.$boxMenu.show();\n\t            this.$boxMenuContainer.find('.fm-box-zindex').show();\n\t        }\n\t        \n\t        var $boxIcon = $(FM.Util.replaceAll(FM.guiController[guiIcon], 'REPLACE', this.suffix));\n\t\n\t        $boxIcon.appendTo(this.$boxIcons);\n\t\n\t        if(visibleBox===true)\n\t            this.$boxIcons.hide();\n\t\n\t        \n\t\n\t        var _this = this,\n\t            $id =  $('#' + _this.suffix + '-controller-' + toLoad + '-box');\n\t\n\t        $('#' + this.suffix + '-controller-' + toLoad + 'Icon')\n\t        .on('click', {\n\t                $id: $id,\n\t                suffix: this.suffix\n\t            }, function(e) {\n\t                \n\t                var $id = e.data.$id;\n\t\n\t                if (_this.$boxMenu.is(':visible'))\n\t                {\n\t                    if ( _this.$boxMenuSelected == $id ) {\n\t                        _this.$boxMenu.slideUp()\n\t                        $id.hide();\n\t                        _this.$boxMenuSelected = '';\n\t                    }\n\t                    else {\n\t                        $id.slideDown();\n\t                        _this.$boxMenuSelected = $id;\n\t                    }\n\t                }\n\t                else {\n\t                    _this.$boxMenuSelected = $id;\n\t                    _this.$boxMenu.slideDown();\n\t                }\n\t        });\n\t\n\t        // close panel\n\t        $('#' + this.suffix + '-controller-' + toLoad + '-remove')\n\t        .on('click', {\n\t            $id: $id,\n\t            suffix: this.suffix\n\t        }, function(e) {\n\t            var $id = e.data.$id,\n\t                suffix =  e.data.suffix;\n\t\n\t            $('#' + suffix + '-controller-box').slideUp();\n\t            $id.hide();\n\t        });//*/\n\t    },\n\t\n\t    /**\n\t     * Initialize the Drag and Drop of the Overlays\n\t     */\n\t    initializeOverlayDragging: function() {\n\t        var _this = this;\n\t\n\t//TODO replace with https://github.com/RubaXa/Sortable\n\t\n\t/*        $('#'+ this.suffix + '-controller-overlay-content').sortable({\n\t            cursor: 'move',\n\t            opacity:'0.5',\n\t            stop: function (event, ui) {\n\t                // getting layers order\n\t                var children = $(ui.item).parent().children();\n\t                var layerIDs = [];\n\t                var zIndexBase = 0;\n\t                for(var i=children.length-1; i >= 0; i-- ) {\n\t                    var id = $(children[i]).data(\"layer\").id;\n\t                    var layertitle = $(children[i]).data(\"layer\").layer.layertitle;\n\t                    var zIndex =  zIndexBase + 100\n\t                    layerIDs.push($(children[i]).data(\"layer\").id)\n\t                    _this.updateZIndex(id, zIndex);\n\t                    zIndexBase++;\n\t                }\n\t                // setting the z-indexes based on the layers order list\n\t                // N.B. they are set from the bottom to the top\n\t            }\n\t        });*/\n\t    },\n\t\n\t    /**\n\t     *\n\t     * Add a Layer Overlay to the Layer Controller\n\t     *\n\t     * @param l\n\t     */\n\t    layerAdded: function(l) {\n\t\n\t        var self = this;\n\t\n\t        l.layerAdded = true;\n\t        /** TODO: check if works always this solution **/\n\t        if ( !l.layer.zindex ) {\n\t            l.layer.zindex = self.zIndex;\n\t            l.leafletLayer.setZIndex = l.layer.zindex;\n\t        }\n\t        self.zIndex = self.zIndex + 2;\n\t\n\t        if ( !l.layer.hideLayerInControllerList ) {\n\t            // add legend to the mapDIV\n\t            var $legend = $(FM.Util.replaceAll(FM.guiController.legend, 'REPLACE', l.id)),\n\t                div = $legend[0];\n\t           \n\t            if (!L.Browser.touch) {\n\t                L.DomEvent.disableClickPropagation(div);\n\t                L.DomEvent.on(div, 'mousewheel', L.DomEvent.stopPropagation);\n\t            }\n\t            else\n\t                L.DomEvent.on(div, 'click', L.DomEvent.stopPropagation);\n\t\n\t            self._fenixMap.$map.find('.leaflet-control-legend').append($legend);\n\t            \n\t\n\t            // creating the HTML controller-overlay-item structure\n\t            var idStructure =  '#'+ self.suffix + '-controller-overlay-content';\n\t            var idItem = '#'+ l.id + '-controller-item';\n\t            var idControllerItem = l.id + '-controller-item';\n\t            var overlayStructure = FM.Util.replaceAll(FM.guiController.overlay, 'REPLACE', l.id);\n\t\n\t            // TODO: a way to get the layer back by the ID\n\t\n\t            $(idStructure).prepend(overlayStructure);\n\t\n\t            // saving the layer information (it's too many information TODO: please set only ID and needed infos\n\t            $( '#'+ l.id  + '-controller-item-box' ).data( \"layer\", l );\n\t\n\t            var index = $('#'+l.id+'-controller-item-box').index() + 1;\n\t\n\t            // setting up the layer GUI options\n\t            self._layerGUIOptions(l);\n\t\n\t            // setting the layer to the HashMap to handle the ID and ZIndex\n\t            self.layersMap.set(l.id, l);\n\t            self.layersMapZIndexes.set(l.layer.zindex, l.id)\n\t\n\t            $(idItem+'-title').append(l.layer.layertitle);\n\t\n\t            // Enable/Disable layer\n\t            $(idItem+ '-enabledisable')\n\t                .on('click', {id:l.id}, function(event) {\n\t                    self.showHide(event.data.id)\n\t                });\n\t\n\t            // Layer Opacity\n\t            var opacity = 1;\n\t            if ( l.layer.opacity != null )\n\t                opacity = l.layer.opacity;\n\t\n\t            $(idItem+ '-opacity').ionRangeSlider({\n\t                min: 0.1, max: 1, step: 0.1,\n\t                hide_min_max: true, hide_from_to: true,\n\t                from: opacity,\n\t                onChange: function (o) {\n\t                    //item.layer.setOpacity(o.from);\n\t                    FM.LayerUtils.setLayerOpacity(l, o.from);\n\t                }\n\t            });\n\t/*                .slider({\n\t                    orientation: \"horizontal\",\n\t                    range: \"min\",\n\t                    min: 0, max: 1, step: 0.1,\n\t                    value: opacity,\n\t                    slide: function( event, ui ) {\n\t                        FM.LayerUtils.setLayerOpacity(l, ui.value);\n\t                    }\n\t                });\n\t*/\n\t            // Layer GetFeatureInfo\n\t            var $layergfi = $(idItem+ '-getfeatureinfo');\n\t\n\t            if ( !l.layer.enablegfi ) {\n\t                $(idItem+ '-getfeatureinfo').css(\"display\",\"none\");\n\t            }\n\t            else\n\t            {\n\t                $layergfi.on('click', {id:l.id}, function(event) {\n\t                    var l = self.layersMap.get(event.data.id);\n\t                    if ( self.selectedLayer.id == event.data.id) {\n\t                        // the layer select is equal to the new one, so deselect it\n\t                        $('#' + self.selectedLayer.id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n\t                        self.selectedLayer = '';\n\t                        l.layer.defaultgfi = false;\n\t                    }\n\t                    else {\n\t                        // unselect old layer icon\n\t                        $('#' + self.selectedLayer.id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n\t                        // select new layer icon\n\t                        $('#' + event.data.id + '-controller-item-getfeatureinfo').addClass('fm-icon-getfeatureinfo-selected');\n\t                        self.selectedLayer = l;\n\t                        l.layer.defaultgfi = true;\n\t                    }\n\t                });\n\t\n\t                if ( l.layer.defaultgfi ) {\n\t                    // TODO: set default gfi style on the layer\n\t                    self.selectedLayer = l;\n\t                    $('#' + self.selectedLayer.id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n\t                    // select new layer icon\n\t                    $('#' + l.id + '-controller-item-getfeatureinfo').addClass('fm-icon-getfeatureinfo-selected');\n\t                }\n\t            }\n\t\n\t\n\t\n\t            // Show/Hide Legend\n\t            var $getlegend = $(idItem+ '-getlegend');\n\t            if (l.layer.showlegend == null || l.layer.showlegend != false) {\n\t                $getlegend.on('click', {id:l.id, idToRender: idControllerItem + '-getlegend'}, function(event) {\n\t                    var l = self.layersMap.get( event.data.id);\n\t                    FM.Legend.getLegend(l, event.data.idToRender)\n\t                });\n\t            }\n\t            \n\t            $getlegend.css(\"display\",\"inline-block\");\n\t\n\t            // Switch JoinType (From shaded to Point Layer)\n\t            if (l.layer.layertype ) {\n\t                if (l.layer.layertype == 'JOIN' ) {\n\t                    if (l.layer.switchjointype == null || l.layer.switchjointype ) {\n\t                        $(idItem+ '-switchjointype').css(\"display\",\"inline-block\")\n\t                        .on('click', {id:l.id}, function(event) {\n\t                            self.switchJoinType(event.data.id);\n\t                        })\n\t                    }\n\t                }\n\t            }\n\t\n\t            // Enable/Disable Swipe\n\t            var $swipelayer = $(idItem+ '-swipe');\n\t            $swipelayer.on('click', {id:l.id}, function(event) {\n\t                var l = self.layersMap.get( event.data.id);\n\t                if (l.layer.swipeActive == null || !l.layer.swipeActive) {\n\t                    FM.LayerSwipe.swipeActivate(l, self._fenixMap.suffix + '-handle', self._fenixMap.suffix + '-map', self._map);\n\t                    // select icon\n\t                    $swipelayer.addClass('fm-icon-swipe-selected')\n\t                }\n\t                else {\n\t                    FM.LayerSwipe.swipeDeactivate(l, self._map);\n\t                    // deselect icon\n\t                    $swipelayer.removeClass('fm-icon-swipe-selected')\n\t                }\n\t            });\n\t\n\t            // ZoomToLayer or BBOX\n\t            var $zoomtolayer = $(idItem+ '-zoomtolayer');\n\t            if ( l.layer.zoomToBBOX ) {\n\t                $zoomtolayer.css(\"display\",\"inline-block\");\n\t                $zoomtolayer.on('click', {id:l.id}, function(event) {\n\t                    var l = self.layersMap.get( event.data.id);\n\t                    FM.LayerUtils.zoomToLayer(self._map, l.layer)\n\t                });\n\t            }\n\t            if (l.layer.zoomTo ) {\n\t                $zoomtolayer.css(\"display\",\"inline-block\");\n\t                $zoomtolayer.on('click', {id:l.id}, function(event) {\n\t                    var l = self.layersMap.get( event.data.id);\n\t                    FM.LayerUtils.zoomToLayer(self._map, l.layer)\n\t                });\n\t            }\n\t\n\t            // Show/Hide SubIcons\n\t            var $subiconsshowhide  = $(idItem+ '-showhide-subicons');\n\t            var $subiconscontainer = $(idItem+ '-subicons');\n\t            \n\t            $subiconsshowhide\n\t                .on('click', function(event) {\n\t\n\t                    $subiconscontainer.slideToggle('fast');\n\t\n\t                    if ( $subiconsshowhide.hasClass(\"fm-icon-up\")) {\n\t                        $subiconsshowhide.removeClass(\"fm-icon-up\")\n\t                        $subiconsshowhide.addClass(\"fm-icon-down\")\n\t                    }\n\t                    else {\n\t                        $subiconsshowhide.removeClass(\"fm-icon-down\")\n\t                        $subiconsshowhide.addClass(\"fm-icon-up\")\n\t                    }\n\t                });\n\t        }\n\t    },\n\t\n\t    _layerGUIOptions:function(l) {\n\t        var gui = l.gui;\n\t        // at Gaul Level 1 remove the point layer option\n\t        if (l.layer.layertype == 'JOIN') {\n\t            if ( l.layer.gui !=null )\n\t                if (l.layer.gui.nojoinlayerswitch != null && l.layer.gui.nojoinlayerswitch) {\n\t                    // TODO: hide pointlayer option\n\t                    // hiding the legend\n\t                    $('#'+ l.id + '-controller-item-switchjointype').css('display', 'none');\n\t                }\n\t        }\n\t    },\n\t\n\t    /**\n\t     *\n\t     * Add a Base Layer to the Layer Controller\n\t     *\n\t     * @param l\n\t     */\n\t    addBaseLayer: function(l) {\n\t\n\t        var self = this;\n\t\n\t        // setting the zIndex and updating it\n\t        //console.log(this.zIndexBaseLayer);\n\t        l.layer.zindex = this.zIndexBaseLayer;\n\t        this.zIndexBaseLayer = this.zIndexBaseLayer + 2;\n\t\n\t        // setting the layer to the HashMap to handle the ID and ZIndex\n\t        this.baseLayersMap.set(l.id, l);\n\t        this.layersMapZIndexes.set(l.layer.zindex, l.id);\n\t\n\t        // creating the HTML controller-overlay-item structure\n\t        var idStructure =  '#'+ this.suffix + '-controller-baselayer-content',\n\t            idItem = '#'+ l.id + '-controller-item',\n\t            overlayStructure = FM.Util.replaceAll(FM.guiController.baselayer, 'REPLACE', l.id);\n\t\n\t        overlayStructure = FM.Util.replaceAll(overlayStructure, 'MAPID', this._fenixMap.id);\n\t\n\t        $(idStructure).append(overlayStructure);\n\t\n\t        // listeners\n\t        $(idItem + '-title').append(l.layer.layertitle);\n\t\n\t        if(self._guiController.layersthumbs)\n\t            $('#' + l.id + '-controller-item-baselayer-image').addClass(\"fm-icon-baselayer-\" + l.layer.layername);\n\t        else\n\t            $('#' + l.id + '-controller-item-baselayer-image').remove();\n\t\n\t        $(idItem+ '-enabledisable').on('click', {id:l.id}, function(e) {\n\t            self.showHide(e.data.id)\n\t        });\n\t\n\t        var opacity = 1;\n\t        if ( l.layer.opacity != null )\n\t            opacity = l.layer.opacity;\n\t        /*try {\n\t            $(idItem+ '-opacity').slider({\n\t                orientation: \"horizontal\",\n\t                range: \"min\",\n\t                min: 0,\n\t                max: 1,\n\t                step: 0.1,\n\t                value: opacity,\n\t                slide: function(e, ui) {\n\t                    FM.LayerUtils.setLayerOpacity(l, ui.value);\n\t                }\n\t            });\n\t        }catch(e) { }//*/\n\t\n\t        $('#' + l.id + '-controller-box-item')\n\t        .on('click', {\n\t            id:l.id\n\t        }, function(e) {\n\t            var id = e.data.id;\n\t            var l = self.baseLayersMap.get(id);\n\t\n\t            // removing the old baselayer\n\t            self.removeBaseLayerByID(self.currentBaseLayer.id);\n\t            var oldBaseLayer = self.baseLayersMap.get(self.currentBaseLayer.id);\n\t            $('#' + oldBaseLayer.id + \"-controller-box-item\").removeClass('fm-controller-box-item-baselayer-content-selected')\n\t            $('#' + oldBaseLayer.id + \"-controller-item-opacity\").hide();\n\t\n\t            // add the new baselayer to the map and setting as default one\n\t            $('#' + l.id + \"-controller-box-item\").addClass('fm-controller-box-item-baselayer-content-selected')\n\t            $('#' + l.id + \"-controller-item-opacity\").show();\n\t            self._map.addLayer(l.leafletLayer);\n\t            self.currentBaseLayer = l;\n\t            self.setZIndex(l)\n\t\n\t        });\n\t\n\t        // select baselayer item\n\t        if ( this.baseLayersMap.count() == 1 ){\n\t            $(idItem + '-radio').attr('checked', true);\n\t            // add the layer just if it's the first one\n\t            this._map.addLayer(l.leafletLayer);\n\t            this.currentBaseLayer = l;\n\t            $('#' + l.id + \"-controller-box-item\").addClass('fm-controller-box-item-baselayer-content-selected')\n\t            $('#' + l.id + \"-controller-item-opacity\").show();\n\t            self.setZIndex(l)\n\t        }\n\t\n\t    },\n\t\n\t    /*\n\t     * Remove a layer from the Map and from the HashMap\n\t     *\n\t     * @param l\n\t     */\n\t    removeLayer:function(l) {\n\t        if ( l.layer.jointype !=null && l.layer.jointype == 'point')\n\t            this.removeLayerPoint(l);\n\t        else\n\t            this.removeLayerDefault(l);\n\t    },\n\t\n\t\n\t    removeLayerDefault:function(l) {\n\t        // remove layer from the map\n\t        this._map.removeLayer(l.leafletLayer);\n\t        // remove layer from the hashmaps\n\t        this.layersMap.remove(l.id);\n\t        this.layersMapZIndexes.remove(l.layer.zindex);\n\t        $('#' + l.id + '-controller-item-box').remove();\n\t        $('#' + l.id + '-controller-item-getlegend-holder').remove();\n\t    },\n\t\n\t    /*\n\t     * Remove the layer Point from the Map and from the HashMap\n\t     *\n\t     * @param id\n\t     */\n\t    removeLayerPoint: function(l) {\n\t        for(var i=0; i < l.layer.pointsLayers.length; i++)\n\t            this._map.removeLayer(l.layer.pointsLayers[i]);\n\t\n\t        this.layersMap.remove(l.id);\n\t        this.layersMapZIndexes.remove(l.layer.zindex);\n\t        $('#' + id + '-controller-item-box').remove();\n\t    },\n\t\n\t    /*\n\t     * Remove the layer from the Map and from the HashMap\n\t     *\n\t     * @param id\n\t     */\n\t    removeBaseLayerByID: function(id) {\n\t        var l = this.baseLayersMap.get(id);\n\t        // remove layer from the map\n\t        this._map.removeLayer(l.leafletLayer);\n\t    },\n\t\n\t    /*\n\t     * Switch a jointype (from Point to Shaded and from Shaded to Point)\n\t     *\n\t     * @param id\n\t     */\n\t    switchJoinType: function(id) {\n\t        var l = this.layersMap.get(id);\n\t\n\t        if (  l.layer.jointype.toLowerCase() == 'point') {\n\t            // alert('point')\n\t            this.switchToShaded(id);\n\t        }\n\t        else if ( l.layer.jointype.toLowerCase() == 'shaded') {\n\t            // alert('shaded')\n\t            this.switchToPoint(id);\n\t        }\n\t    },\n\t\n\t    /*\n\t     * Switch a Shaded joined layer to a Point one\n\t     *\n\t     * TODO: da vedere\n\t     *\n\t     * @param id\n\t     */\n\t    switchToPointswitchToPoint: function(id) {\n\t        var l = this.layersMap.get(id);\n\t        l.layer.jointype = 'point';\n\t\n\t        if ( l.leafletLayer != null )\n\t            this._map.removeLayer(l.leafletLayer);\n\t\n\t        this._fenixMap.createPointLayerRequest(l);\n\t    },\n\t\n\t    /*\n\t     * Switch a Point joined layer to a Shaded one\n\t     *\n\t     * TODO: da vedere\n\t     *\n\t     * @param id\n\t     */\n\t    switchToShaded: function(id) {\n\t        var l = this.layersMap.get(id);\n\t        l.layer.jointype = 'shaded';\n\t\n\t        // cleaning the pointLayers\n\t        if ( l.layer.pointsLayers != null ) {\n\t            for(var i=0; i < l.layer.pointsLayers.length; i++) {\n\t                this._map.removeLayer(l.layer.pointsLayers[i]);\n\t            }\n\t        }\n\t        this._fenixMap.createShadeLayerRequest(l);\n\t    },\n\t\n\t    /**\n\t     *  Show/Hide the layer from the map\n\t     *\n\t     * @param id\n\t     */\n\t    showHide: function(id, isReload) {\n\t        try {\n\t            var l = this.layersMap.get(id);\n\t            if (l) {\n\t                if (l.layer.jointype && l.layer.jointype.toLowerCase() == 'point')\n\t                    this.showHidePointLayer(id);\n\t                else\n\t                    this.showHideLayer(id, isReload);\n\t            }\n\t        }catch (e) {\n\t           // console.warn(\"showHide warn:\" + e);\n\t        }\n\t    },\n\t\n\t    /***\n\t     *\n\t     * Show/Hide a Point Layer\n\t     *\n\t     * @param id\n\t     */\n\t    showHidePointLayer: function(id) {\n\t        var l = this.layersMap.get(id);\n\t        for(var i=0; i < l.layer.pointsLayers.length; i++) {\n\t            if (l.layer.visibility == null || l.layer.visibility) {\n\t                l.layer.visibility = false;\n\t                $('#'+ id+ '-controller-item-enabledisable').removeClass('fm-icon-enable');\n\t                $('#'+ id+ '-controller-item-enabledisable').addClass('fm-icon-disable');\n\t                for(var i=0; i < l.layer.pointsLayers.length; i++)\n\t                    this._map.removeLayer(l.layer.pointsLayers[i]);\n\t            }\n\t            else {\n\t                l.layer.visibility = true;\n\t                $('#'+ id+ '-controller-item-enabledisable').removeClass('fm-icon-disable');\n\t                $('#'+ id+ '-controller-item-enabledisable').addClass('fm-icon-enable');\n\t                for(var i=0; i < l.layer.pointsLayers.length; i++)\n\t                    this._map.addLayer(l.layer.pointsLayers[i]);\n\t            }\n\t        }\n\t    },\n\t\n\t    /**\n\t     * Show/Hide the layer  removing it and readding ti to leaflet for performance issues\n\t     *\n\t     * @param id\n\t     */\n\t    showHideLayer:function(id, isReload) {\n\t        try {\n\t            var l = this.layersMap.get(id);\n\t            if (isReload != null && !isReload) {\n\t                if (l.layer.visibility == false) {\n\t                    $('#' + id + '-controller-item-enabledisable').removeClass('fm-icon-enable');\n\t                    $('#' + id + '-controller-item-enabledisable').addClass('fm-icon-disable');\n\t                    this._map.removeLayer(l.leafletLayer)\n\t                }\n\t            }\n\t            else if (isReload != null && isReload) {\n\t                // do nothing (this will maintain the old status\n\t            }\n\t            else {\n\t                if (l.layer.visibility == null || l.layer.visibility) {\n\t                    l.layer.visibility = false;\n\t                    ;\n\t                    $('#' + id + '-controller-item-enabledisable').removeClass('fm-icon-enable');\n\t                    $('#' + id + '-controller-item-enabledisable').addClass('fm-icon-disable');\n\t                    //document.getElementById(id).style.display = 'none';\n\t                    this._map.removeLayer(l.leafletLayer)\n\t                }\n\t                else {\n\t                    l.layer.visibility = true;\n\t                    $('#' + id + '-controller-item-enabledisable').removeClass('fm-icon-disable');\n\t                    $('#' + id + '-controller-item-enabledisable').addClass('fm-icon-enable');\n\t                    //document.getElementById(id).style.display = 'block';\n\t                    this._map.addLayer(l.leafletLayer);\n\t                    this.setZIndex(l) // this method assigns the Z-Index and the ID to the layer\n\t                }\n\t            }\n\t        }catch (e) {\n\t           // console.warn(\"showHideLayer error:\"  + e);\n\t        }\n\t    },\n\t\n\t    /**\n\t     * Update the Z-Index of a layer retrieving it by ID\n\t     *\n\t     * @param layerID\n\t     * @param updatedZIndex\n\t     */\n\t    updateZIndex: function(layerID, updatedZIndex) {\n\t        var l = this.layersMap.get(layerID);\n\t        l.layer.zindex = updatedZIndex;\n\t        l.leafletLayer.setZindex = updatedZIndex;\n\t        try {\n\t            document.getElementById(l.id).style.zIndex=updatedZIndex;\n\t        }catch (e) {\n\t           // console.log('error updateZIndex: ' + l.id + ' doesnt exists');\n\t        }\n\t\n\t    },\n\t\n\t    /**\n\t     * This method search for the new layer added (a new layer or a layer that was hidden\n\t     * and set the index and the id of the layer that is missing the ID/Z-Index\n\t     *\n\t     * @param l\n\t     */\n\t    setZIndex: function (l) {\n\t        try {\n\t            var layers = document.getElementById(this._fenixMap.tilePaneID).childNodes;\n\t            for (i = 0, len = layers.length; i < len; i++) {\n\t                if (layers[i] !== this._container) {\n\t                    var zIndex = parseInt(layers[i].style.zIndex, 10);\n\t                    if ( isNaN(zIndex))  {\n\t                        layers[i].style.zIndex = l.layer.zindex;\n\t                        layers[i].id = l.id;\n\t                    }\n\t                }\n\t            }\n\t        } catch (e) {\n\t           // console.warn(\"setZIndex error:\"  + e);\n\t        }\n\t    },\n\t\n\t    selectGetFeatureInfoIcon:function (id) {\n\t        for(var i=0; i < this.layersMap.count(); i++) {\n\t            if ( this.layersMap._data[i] == id )\n\t                $('#' + id + '-controller-item-getfeatureinfo').addClass('fm-icon-getfeatureinfo-selected');\n\t            else\n\t                $('#' + id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n\t        }\n\t\n\t    },\n\t\n\t    exportOverlays:function() {\n\t        //console.log('exportOverlays');\n\t\n\t        /* TODO: make it simpler **/\n\t        var arrayZindex = [];\n\t        this.layersMap.forEach(function(l) {\n\t            arrayZindex.push(l.layer.zindex)\n\t        });\n\t        arrayZindex = arrayZindex.sort()\n\t\n\t        //console.log(arrayZindex);\n\t\n\t        /** get the id based on the zIndex **/\n\t        var arrayLayers = [];\n\t        for (var i = 0; i < arrayZindex.length; i++ ) {\n\t            var found = false;\n\t            if ( !found)\n\t                this.layersMap.forEach(function(l) {\n\t                    //console.log(e);\n\t                    if (l.layer.zindex == arrayZindex[i]) {\n\t                        arrayLayers.push(l.layer);\n\t                        found = true;\n\t                    }\n\t                });\n\t        }\n\t        var clonedArray = $.map(arrayLayers, function (obj) {\n\t            return $.extend(true, {}, obj);\n\t        });\n\t        return clonedArray;\n\t    },\n\t\n\t    exportBaselayers:function() {\n\t        /* TODO: make it easier the load of the baselayers\n\t        *  add a value to set the current selected one (also on startup)\n\t        * **/\n\t\n\t        return null;\n\t    }\n\t\n\t});\n\t\n\tFM.mapController = function (suffix, fenixMap, map, guiController) {\n\t    return new FM.MAPController(suffix, fenixMap, map, guiController);\n\t};;\n\tFM.guiController = {\n\t\n\t    boxIcons: '<div id=\"REPLACE-controller-box-icons-container\" class=\"fm-icon-box-background fm-controller-box-icons-container\"></div>',\n\t\n\t    boxMenu: '<div class=\"fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box\" id=\"REPLACE-controller-box\">' +\n\t                '<div id=\"REPLACE-controller-box-content\" class=\"clearfix\"></div>' +\n\t            '</div>',\n\t\n\t    baselayerIcon:\n\t    '<div class=\"fm-box-zindex fx-toolbar-map-holder \">'+\n\t        '<div class=\"fm-icon-sprite fm-baselayers\" id=\"REPLACE-controller-baselayerIcon\"><div>'+\n\t    '</div>',\n\t\n\t    baselayerBox:\n\t    '<div class=\"fm-box-zindex fx-toolbar-map-holder \" id=\"REPLACE-controller-baselayer-box\">' +\n\t        '<div id=\"REPLACE-controller-baselayer-title\" class=\"fm-controller-box-title\">Baselayers</div>' +\n\t        '<div id=\"REPLACE-controller-baselayer-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n\t        '<div class=\"fm-standard-hr\"></div>' +\n\t        '<div id=\"REPLACE-controller-baselayer-content\" class=\"fm-controller-box-content\"></div>' +\n\t    '</div>',\n\t\n\t    baselayer:\n\t    '<div id=\"REPLACE-controller-box-item\" class=\"fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item-baselayer-content\">' +\n\t    '<div id=\"REPLACE-controller-item\">' +\n\t        '<div class=\"fm-controller-box-item-baselayer-image\" id=\"REPLACE-controller-item-baselayer-image\"></div>' +\n\t        '<div class=\"fm-controller-box-item-baselayer-text\">' +\n\t            '<div>' +\n\t                '<label class=\"fm-controller-box-item-baselayer-text fm-controller-item-title\" id=\"REPLACE-controller-item-title\">'+\n\t                    '<input id=\"REPLACE-controller-item-radio\"  class=\"fm-checkbox-hide\" type=\"radio\" name=\"MAPID\" value=\"REPLACE\">'+\n\t                '<label>' +\n\t            '</div>' +\n\t            '<div style=\"clear:both\"></div>' +\n\t            '<div class=\"fm-opacity-slider-baselayers\" id=\"REPLACE-controller-item-opacity\" style=\"display:none\"></div>' +\n\t        '</div>' +\n\t    '</div>' +\n\t    '</div>',\n\t\n\t    overlayIcon:\n\t    \"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>\",\n\t\n\t    overlayBox:\n\t    '<div class=\"fm-box-zindex fx-toolbar-map-holder \" id=\"REPLACE-controller-overlay-box\">' +\n\t        '<div id=\"REPLACE-controller-overlay-title\" class=\"fm-controller-box-title\">Selected Layers</div>' +\n\t        '<div id=\"REPLACE-controller-overlay-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n\t        '<div class=\"fm-standard-hr\"></div>' +\n\t        '<div id=\"REPLACE-controller-overlay-content\" class=\"fm-controller-box-content\"></div>'+\n\t    '</div>',\n\t\n\t    overlay:\n\t    '<div id=\"REPLACE-controller-item-box\" class=\"fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item\">' +\n\t        '<div id=\"REPLACE-controller-item\" class=\"fm-controller-box-header\">' +\n\t            '<div class=\"fm-controller-box-header-text\">' +\n\t                '<div class=\"fm-controller-item-title\" id=\"REPLACE-controller-item-title\" ></div>' +\n\t                '<div class=\"fm-icon-right fm-icon-layer-panel-sprite fm-icon-down\" id=\"REPLACE-controller-item-showhide-subicons\"></div>' +\n\t            '</div>' +\n\t            '<div style=\"clear:both\"></div>' +\n\t            '<div class=\"fm-controller-box-icons\">' +\n\t                '<div class=\"fm-icon-enable\" id=\"REPLACE-controller-item-enabledisable\"></div>' +\n\t                '<div class=\"fm-opacity-slider\" style=\"margin-right:10px;\" id=\"REPLACE-controller-item-opacity\"></div>' +\n\t            '</div>' +\n\t            '<div style=\"clear:both\"></div>' +\n\t            '<div class=\"fm-controller-box-subicons\" id=\"REPLACE-controller-item-subicons\" style=\"display:none;\">' +\n\t                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-getlegend\" id=\"REPLACE-controller-item-getlegend\"></div>' +\n\t                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo\" id=\"REPLACE-controller-item-getfeatureinfo\"></div>' +\n\t                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-switchJoinType\" id=\"REPLACE-controller-item-switchjointype\" style=\"display:none\"></div>' +\n\t                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-zoomto\" id=\"REPLACE-controller-item-zoomtolayer\" style=\"display:none\"></div>' +\n\t                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-swipe\" id=\"REPLACE-controller-item-swipe\"></div>' +\n\t                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-switchJoinType\" id=\"REPLACE-controller-item-joinsettings\" style=\"display:none\"></div>' +\n\t            '</div>' +\n\t            /*    '</div>' +\n\t            '</div>' +*/\n\t        '</div>' +\n\t    '</div>',\n\t\n\t    wmsLoaderIcon:\n\t    \"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>\",\n\t    \n\t    wmsLoaderBox:\n\t    '<div class=\"fm-box-zindex fx-toolbar-map-holder \" id=\"REPLACE-controller-wmsLoader-box\" style=\"display:none; min-height:300px;\">' +\n\t        '<div id=\"REPLACE-controller-wmsLoader-title\" class=\"fm-controller-box-title\">WMS Loader</div>' +\n\t        '<div id=\"REPLACE-controller-wmsLoader-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n\t        '<div class=\"fm-standard-hr\"></div>' +\n\t        '<div class=\"clear:both\"></div>' +\n\t        '<div class=\"fm-WMSLoaderDropDown\" id=\"REPLACE-controller-wmsLoader-dropdown\"></div>' +\n\t        '<div id=\"REPLACE-controller-wmsLoader-content\" class=\"fm-controller-wmsLoader-content\"></div>' +\n\t     '</div>',\n\t\n\t    wmsLoaderLayer: '<div id=\"REPLACE-WMSLayer-box\" class=\"fm-WMSLayer-box\">' +\n\t                        '<div id=\"REPLACE-WMSLayer-icon\" class=\"fm-controller-box-icon fm-icon-info\"></div>' +\n\t                        '<div id=\"REPLACE-WMSLayer-title\" class=\"fm-WMSLayer-title\"></div>' +\n\t                    '</div>',\n\t\n\t    legend: '<div class=\"fm-icon-box-background fm-box-legend\" id=\"REPLACE-controller-item-getlegend-holder\">' +\n\t            '<div class=\"fm-legend-title-content\">' +\n\t                '<div id=\"REPLACE-controller-item-getlegend-legend-layertitle\" class=\"fm-legend-layertitle\"></div>' +\n\t                '<div id=\"REPLACE-controller-item-getlegend-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n\t            '</div>' +\n\t            '<div class=\"fm-standard-hr\"></div>' +\n\t\n\t            '<div id=\"REPLACE-controller-item-getlegend-legendtitle\" class=\"fm-legendtitle\"></div>' +\n\t            '<div id=\"REPLACE-controller-item-getlegend-legendsubtitle\" class=\"fm-legendsubtitle\"></div>' +\n\t                '<div id=\"REPLACE-controller-item-getlegend-content\" ></div>' +\n\t            '</div>',\n\t\n\t    popUpJoinPoint: '<div class=\"fm-box fm-popup-join-point-holder\" id=\"REPLACE-popup-join-point-holder\" style=\"display:none\">' +\n\t                        '<div class=\"fm-popup-join-point-text\" id=\"REPLACE-popup-join-point-text\"></div>'+\n\t                        '<div class=\"fm-popup-join-point-value\" id=\"REPLACE-popup-join-point-value\"></div>'+\n\t                    '</div>'\n\t};;\n\tFM.guiMap = {\n\t    disclaimerfao_en:\n\t            'The designations employed and the presentation of material in the maps ' +\n\t            'do not imply the expression of any opinion whatsoever on the part of ' +\n\t            'FAO concerning the legal or constitutional status of any country,' +\n\t            'territory or sea area, or concerning the delimitation of frontiers. ' +\n\t            'South Sudan declared its independence on July 9, 2011.' +\n\t            'Due to data availability, the assessment presented in the map for Sudan ' +\n\t            'and South Sudan reflects thesituation up to 2011 for the former Sudan.',\n\t    disclaimerfao_es: '',\n\t    disclaimerfao_es_styled: '<div class=\"fm-disclaimerfao-text\"></div>',\n\t    disclaimerfao_fr: '',\n\t    disclaimerfao_fr_styled: '<div class=\"fm-disclaimerfao-text\"></div>'\n\t};\n\t;\n\t\n\tFM.Layer = FM.Class.extend({\n\t\n\t    _fenixmap: '',\n\t\n\t    id : '',\n\t\n\t    //layer: '',\n\t\n\t    layer: {\n\t        // WMS default parameters\n\t        styles:'', // could be better 'styles' to be passed directory to the WMS parameters\n\t        srs : 'EPSG:3857',\n\t        visibility: true, //enabled/disabled layer and also to the wms request\n\t        format: \"image/png\", // [\"image/png\", \"image/gif\"]\n\t        transparent: 'TRUE', //[TRUE, FALSE]\n\t        opacity: 1,\n\t        // Other Options\n\t        name: '',\n\t        tiitle: '',\n\t        abstract: '',\n\t        srs: '',\n\t        LatLonBoundingBox: '',\n\t        BoundingBox: '',\n\t        Style: {\n\t            name: '',\n\t            title: '',\n\t            abstract: '',\n\t            legendurl: {\n\t                format: '',\n\t                onlineresource: '' //differenct xml attributes (how to store it?\n\t            }\n\t        },\n\t        KeywordList: [],\n\t\n\t        layertitle: '',\n\t        enablegfi: true,\n\t        layertype: 'WMS', //['WMS', 'JOIN', 'TILE']\n\t        openlegend: false,\n\t        legendOptions: {\n\t            forceLabels: 'on',\n\t            forceRule: 'true',\n\t            dx: '0',\n\t            dy: '0',\n\t            mx: '0',\n\t            my: '0',\n\t            fontAntiAliasing: 'true',\n\t            fontColor: '0x47576F',\n\t            bgColor: '0xF9F7F3',\n\t            border: 'false',            \n\t            fontSize: '15'            \n\t        },\n\t        // JOIN default options\n\t        switchjointype: false,\n\t\n\t        // language\n\t        lang: 'EN' //ISO2\n\t\n\t    },\n\t\n\t    leafletLayer: '',\n\t\n\t    initialize: function(layer, options) { // (HTMLElement or String, Object)\n\t        this.layer = $.extend(true, {}, this.layer, layer);\n\t\n\t        if (options)\n\t            this.options = options;\n\t\n\t        this.id = FM.Util.randomID();\n\t\n\t        if (layer.joindata)\n\t            layer.defaultdata = layer.joindata;\n\t    },\n\t\n\t    createLayerWMS: function() {\n\t\n\t        var wmsParameters = this._getWMSParameters();\n\t\n\t        if ( this.leafletLayer ) {\n\t            if(this.layertype === 'WMS')\n\t                this.leafletLayer.setParams(wmsParameters);\n\t        }\n\t        else {\n\t            wmsParameters = (this.options)? $.extend(true, {}, this.options, wmsParameters): wmsParameters;\n\t            if(this.layer.urlWMS)\n\t                this.leafletLayer = new L.TileLayer.WMS( this.layer.urlWMS, wmsParameters );\n\t        }\n\t        return this.leafletLayer;\n\t    },\n\t\n\t    createLayerWMSSLD: function() {\n\t        var wmsParameters = this._getWMSParameters();\n\t        if ( this.leafletLayer ) {\n\t            this.leafletLayer.setParams(wmsParameters);\n\t        }\n\t        else {\n\t            if(this.layer.urlWMS)\n\t                this.leafletLayer = new L.TileLayer.WMS( this.layer.urlWMS, wmsParameters );\n\t        }\n\t        return this.leafletLayer;\n\t    },\n\t\n\t    /** TODO: make also the other parameters dynamic **/\n\t    _getWMSParameters:function() {\n\t        var options = {};\n\t\n\t        options.id = this.id;\n\t\n\t        // can be used layers (default WMS parameter or layername)\n\t        options.layers = ( this.layer.name )?  this.layer.name: this.layer.layers;\n\t        options.format= this.layer.format;\n\t        options.transparent = this.layer.transparent.toUpperCase();\n\t        options.visibility = this.layer.visibility;\n\t        options.opacity = this.layer.opacity;\n\t\n\t        /** TODO: handle additional parameters that are not default ones **/\n\t        /** i.e. http://nyc.freemap.in/cgi-bin/mapserv?MAP=/www/freemap.in/nyc/map/basemap.map **/\n\t\n\t        // check whether styles or style is set (styles is the default URL parameter)\n\t        options.styles=this.layer.styles;\n\t        if ( this.layer.style ) options.styles = this.layer.style;\n\t        if ( this.layer.sldurl ) options.sld = this.layer.sldurl;\n\t        if ( this.layer.cql_filter ) options.cql_filter = this.layer.cql_filter;\n\t        if ( this.layer.sld_body ) options.sld_body = this.layer.sld_body;\n\t        this.layer.layers = ( this.layer.layername )?  this.layer.layername: this.layer.layers;\n\t\n\t        return options;\n\t    },\n\t\n\t    // this is just to use with the WMS Layers // check layer type\n\t    redraw: function(fenixmap) {\n\t        var l = this;\n\t        if (l.layer.layertype ) {\n\t            switch(l.layer.layertype ) {\n\t                case 'JOIN':\n\t                    if (l.layer.jointype.toLocaleUpperCase() == 'SHADED') {\n\t                        if ( fenixmap ) fenixmap.addLayer(this);\n\t                        else if ( this._fenixmap ) this._fenixmap.addLayer(this);\n\t                    }\n\t                    else if (l.layer.jointype.toLocaleUpperCase() == 'POINT')\n\t                        console.log('TODO: handle redraw point');\n\t                    break;\n\t                case 'WMS':\n\t                    this.createLayerWMS();\n\t                    this.leafletLayer.redraw();\n\t                    break;\n\t                default:\n\t                    this.createLayerWMS();\n\t                    this.leafletLayer.redraw();\n\t                    break;\n\t            }\n\t        }\n\t    },\n\t\n\t    /** shortcut **/\n\t    addPointLayer: function(fenixmap) {\n\t        if ( fenixmap )\n\t            fenixmap.addPointLayer(this);\n\t        else if ( this._fenixmap)\n\t            this._fenixmap.addPointLayer(this);\n\t    },\n\t\n\t    addLayerWMS: function(fenixmap) {\n\t        if ( fenixmap )\n\t            fenixmap.addLayerWMS(this);\n\t        else if ( this._fenixmap)\n\t            this._fenixmap.addLayerWMS(this);\n\t    },\n\t\n\t    addLayer: function(fenixmap) {\n\t        if ( fenixmap )\n\t            fenixmap.addLayer(this);\n\t        else if ( this._fenixmap)\n\t            this._fenixmap.addLayer(this);\n\t    },\n\t    \n\t    /** TOODO: remove layer also from the layers list **/\n\t    removeLayer: function(fenixmap) {\n\t        /** TODO: remove it from the list **/\n\t        if ( fenixmap )\n\t            fenixmap.removeLayer(this);\n\t        else if ( this._fenixmap)\n\t            this._fenixmap.removeLayer(this);\n\t    },\n\t\n\t    addShadedLayer: function(fenixmap) {\n\t        if ( fenixmap )\n\t            fenixmap.addShadedLayer(this);\n\t        else if ( this._fenixmap)\n\t            this._fenixmap.addShadedLayer(this);\n\t    }\n\t\n\t});\n\t\n\tFM.layer = function (layer, map, options) {\n\t    return new FM.Layer(layer, map, options);\n\t};\n\t\n\t\n\t;\n\t\n\tFM.TileLayer = FM.Layer.extend({\n\t\n\t  createTileLayer: function() {\n\t    var info = this.layer.layername ? FM.TILELAYER[this.layer.layername] : FM.TILELAYER[this.layer.layers];\n\t\n\t    this.layer.layertype = 'TILE';\n\t    this.layer.layertitle = info[ 'title_' + this.layer.lang.toLowerCase() ];\n\t    var leafletLayer = new L.TileLayer( info.url );\n\t    return leafletLayer;\n\t  }\n\t\n\t});\n\t\n\tFM.TileLayer.createBaseLayer = function (layername, lang) {\n\t    var layer = {};\n\t    // this is replicated because in wms it's used \"layers\" instead of layername\n\t    layer.layername = layername;\n\t    layer.layers = layername;\n\t    layer.layertype = 'TILE';\n\t    layer.lang = lang;\n\t    var l = new FM.TileLayer(layer);\n\t    l.leafletLayer = l.createTileLayer(layer.layername);\n\t    return l;\n\t};\n\t return FM;\n\t\n\t}.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));\n\t/* WEBPACK VAR INJECTION */}.call(exports, __webpack_require__(3)))\n\n/***/ },\n/* 3 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_3__;\n\n/***/ },\n/* 4 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_4__;\n\n/***/ },\n/* 5 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_5__;\n\n/***/ },\n/* 6 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_6__;\n\n/***/ },\n/* 7 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_7__;\n\n/***/ },\n/* 8 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_8__;\n\n/***/ },\n/* 9 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tvar __WEBPACK_AMD_DEFINE_ARRAY__, __WEBPACK_AMD_DEFINE_RESULT__;/*global define*/\n\t!(__WEBPACK_AMD_DEFINE_ARRAY__ = [\n\t        __webpack_require__(10),\n\t        __webpack_require__(11)\n\t    ], __WEBPACK_AMD_DEFINE_RESULT__ = function (i18nEn, i18nFr) {\n\t\n\t        'use strict';\n\t\n\t        return {\n\t\n\t            en: i18nEn,\n\t            fr: i18nFr\n\t        }\n\t    }.apply(exports, __WEBPACK_AMD_DEFINE_ARRAY__), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));\n\n/***/ },\n/* 10 */\n/***/ function(module, exports, __webpack_require__) {\n\n\t!(module.exports = {\n\t    \"movelayerup\": \"Move layer up\",\n\t    \"movelayerdown\": \"Move layer down\",\n\t    \"removelayer\": \"Remove Layer\",\n\t    \"enabledisablelayer\": \"Enable/Disable layer\",\n\t    \"showhidelegend\": \"Show/Hide legend\",\n\t    \"getfeatureinfo\": \"Inspect layer\",\n\t    \"layeropacity\": \"Modify layer opacity\",\n\t    \"switchtopoint\": \"Switch to Point layer\",\n\t    \"switchtoshaded\": \"Switch to Shaded layer\",\n\t    \"confirmremovelayer\": \"Are you sure you want to remove the layer?\",\n\t    \"dragdroplayer\": \"Drag and Drop the layer<br>to sort the layer's list\",\n\t    \"baselayer\": \"Control BaseLayers\",\n\t    \"overlay\": \"Control Overlays\",\n\t    \"wmsLoader\": \"Control External WMS Servers\",\n\t    \"fullscreen\": \"Fullscreen\",\n\t    \"layersubicons\": \"Click to open the layer's menu\",\n\t    \"selectaWMSServer\": \"Select a WMS Server\",\n\t    \"addaWMSServer\": \"Add a WMS Server\",\n\t    \"nolegendavailable\": \"The legend is not available\"\n\t});\n\n/***/ },\n/* 11 */\n/***/ function(module, exports, __webpack_require__) {\n\n\t!(module.exports = {\n\t    \"movelayerup\": \"Monter la couche de donnes\",\n\t    \"movelayerdown\": \"Baisser la couche de donnes\",\n\t    \"removelayer\": \"Effacer la couche de donnes\",\n\t    \"enabledisablelayer\": \"Activer/Dsactiver la couche de donnes\",\n\t    \"showhidelegend\": \"Montrer/Cacher la legende\",\n\t    \"getfeatureinfo\": \"Inspecter la couche de donnes\",\n\t    \"layeropacity\": \"Modifier l'opacit de la couche\",\n\t    \"switchtopoint\": \"Mode couche de points\",\n\t    \"switchtoshaded\": \"Mode relief\",\n\t    \"confirmremovelayer\": \"Etes vous sur de vouloir ffacer cette couche?\",\n\t    \"dragdroplayer\": \"Glissez et dposez la couche<br>pour trier la liste de couches\",\n\t    \"baselayer\": \"Controle des couches de bases\",\n\t    \"overlay\": \"Controle des autres couches \",\n\t    \"wmsLoader\": \"Controle des serveurs  WMS externes\",\n\t    \"fullscreen\": \"Plein ecran\",\n\t    \"layersubicons\": \"Cliquez pour ouvrir le menu des couches\",\n\t    \"selectaWMSServer\": \"Selectionnez un serveur WMS\",\n\t    \"addaWMSServer\": \"Ajoutez un serveur WMS\",\n\t    \"nolegendavailable\": \"Legende non disponible\"\n\t});\n\n/***/ },\n/* 12 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_12__;\n\n/***/ },\n/* 13 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tvar __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_RESULT__ = function () {\n\t\n\t    'use strict';\n\t\n\t    return {\n\t\n\t        MISSING_CONTAINER: 'missing_container'\n\t\n\t    };\n\t}.call(exports, __webpack_require__, exports, module), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));\n\n/***/ },\n/* 14 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tvar __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_RESULT__ = function () {\n\t\n\t    'use strict';\n\t\n\t    return {\n\t\n\t        WINDOW_RESIZE: 'fs.window.resize.event'\n\t\n\t    };\n\t}.call(exports, __webpack_require__, exports, module), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));\n\n/***/ },\n/* 15 */\n/***/ function(module, exports, __webpack_require__) {\n\n\tvar __WEBPACK_AMD_DEFINE_RESULT__;!(__WEBPACK_AMD_DEFINE_RESULT__ = function () {\n\t\n\t    'use strict';\n\t\n\t    return {\n\t        WMS_URL: \"http://fenix.fao.org/demo/fenix/geoserver\",\n\t        DEFAULT_WMS_SERVER: \"http://fenix.fao.org/demo/fenix/geoserver\",\n\t        url: {\n\t            wms: \"http://fenix.fao.org/demo/fenix/geoserver\"\n\t        },        \n\t        fenix_ui_map: {\n\t            plugins: {\n\t                disclaimerfao: true,\n\t                geosearch: true,\n\t                mouseposition: false,\n\t                controlloading : true,\n\t                zoomcontrol: 'bottomright'\n\t            },\n\t            guiController: {\n\t                overlay: false,\n\t                baselayer: true,\n\t                wmsLoader: false\n\t            },\n\t            gui: {\n\t                disclaimerfao: true\n\t            }\n\t        },\n\t        leaflet: {\n\t            zoomControl: false,\n\t            attributionControl: false,\n\t            minZoom: 1\n\t        },\n\t        layers: {\n\t            gaul0: {\n\t                layers: 'fenix:gaul0_3857',\n\t                urlWMS: 'http://fenix.fao.org/demo/fenix/geoserver',\n\t                opacity: '0.9',\n\t                joincolumn: 'adm0_code',\n\t                joincolumnlabel: 'areanamee',\n\t                layertype: 'JOIN',\n\t                jointype: 'shaded',\n\t                openlegend: true,\n\t                defaultgfi: true,\n\t                colorramp: 'YlGn',\n\t                lang: 'en'\n\t            }\n\t        },\n\t        geoSubject: 'geo',\n\t        colorRamp: 'Reds',  //Blues, Greens,\n\t        //colorRamp values: http://fenixrepo.fao.org/cdn/fenix/fenix-ui-map-datasets/colorramp.png        \n\t\n\t        valueSubject: 'value',\n\t        // measurement unit\n\t        muSubject: null,\n\t\n\t        // Mapping with the\n\t        join: {\n\t            style: {\n\t                layertype: 'JOIN',\n\t                jointype: 'shaded',\n\t                defaultgfi: true,\n\t                openlegend: true,\n\t                lang: 'EN',\n\t                opacity: '0.7',\n\t                colorramp: 'Greens',\n\t                decimalvalues: 2\n\t            },\n\t            layerMapping: {\n\t                escap_area: {\n\t                    layers: 'fenix:gaul0_3857',\n\t                    joincolumn: 'adm0_code',\n\t                    joincolumnlabel: 'adm0_name'\n\t                },\n\t                gaul0: {\n\t                    layers: 'fenix:gaul0_3857',\n\t                    joincolumn: 'adm0_code',\n\t                    joincolumnlabel: 'adm0_name'\n\t                },\n\t                gaul1: {\n\t                    layers: 'fenix:gaul1_3857',\n\t                    joincolumn: 'adm1_code',\n\t                    joincolumnlabel: 'adm1_name'\n\t                },\n\t                uae_gaul: {\n\t                    layers: 'fenix:gaul1_3857',\n\t                    joincolumn: 'adm1_code',\n\t                    joincolumnlabel: 'adm1_name'\n\t                },\n\t\n\t                gaul_adm1: {\n\t                    layers: 'fenix:gaul1_3857',\n\t                    joincolumn: 'adm1_code',\n\t                    joincolumnlabel: 'adm1_name'\n\t                },\n\t\n\t                faostat_countrycodes: {\n\t                    layers: 'fenix:gaul0_faostat_3857',\n\t                    joincolumn: 'faost_code',\n\t                    joincolumnlabel: 'areanamee',\n\t                },\n\t                faostat_countries: {\n\t                    layers: 'fenix:gaul0_faostat_3857',\n\t                    joincolumn: 'faost_code',\n\t                    joincolumnlabel: 'areanamee',\n\t                },\n\t                gaul: {\n\t                    layers: 'fenix:gaul1_3857',\n\t                    joincolumn: 'adm1_code',\n\t                    joincolumnlabel: 'adm1_name'\n\t                },\n\t                uneca_partner: {\n\t                    layers: 'fenix:gaul0_faostat3_3857',\n\t                    joincolumn: 'iso3',\n\t                    joincolumnlabel: 'areanamee'\n\t                },\n\t                gaul1_afg: {\n\t                    layers: 'fenix:gaul1_3857',\n\t                    joincolumn: 'adm1_code',\n\t                    joincolumnlabel: 'adm1_name'\n\t                },\n\t                iso3: {\n\t                    layers: 'fenix:gaul0_faostat3_3857',\n\t                    joincolumn: 'iso3',\n\t                    joincolumnlabel: 'areanamee'\n\t                },\n\t                uneca_iso3: {\n\t                    layers: 'fenix:gaul0_faostat3_3857',\n\t                    joincolumn: 'iso3',\n\t                    joincolumnlabel: 'areanamee'\n\t                }\n\t            }\n\t        }\n\t        // TODO: add boundaries option\n\t    };\n\t}.call(exports, __webpack_require__, exports, module), __WEBPACK_AMD_DEFINE_RESULT__ !== undefined && (module.exports = __WEBPACK_AMD_DEFINE_RESULT__));\n\n\n/***/ },\n/* 16 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_16__;\n\n/***/ },\n/* 17 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_17__;\n\n/***/ },\n/* 18 */\n/***/ function(module, exports) {\n\n\tmodule.exports = __WEBPACK_EXTERNAL_MODULE_18__;\n\n/***/ },\n/* 19 */\n/***/ function(module, exports) {\n\n\t// removed by extract-text-webpack-plugin\n\n/***/ }\n/******/ ])});;\n\n\n// WEBPACK FOOTER //\n// fenix-ui-map-creator.min.js"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId])\n \t\t\treturn installedModules[moduleId].exports;\n\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\texports: {},\n \t\t\tid: moduleId,\n \t\t\tloaded: false\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.loaded = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 3ac9c5885898cd50cda0","define([\n    'jquery',\n    'underscore',\n    'loglevel',\n    '../config/errors',\n    '../config/events',\n    '../config/config',\n    './fenix-ui-map.src',\n    'fenix-ui-pivotator',\n    'fenix-ui-pivotator-utils',\n    'amplify-pubsub'\n], function ($, _, log, ERR, EVT, C, FM, Pivotator, Fenixtool, amplify) {\n\n    'use strict';\n\n    function MapCreator(o) {\n\n        log.info(\"FENIX MapCreator\");\n        log.info(o);\n\n        _.extend(this, C, {initial: o});\n\n        require(\"../css/fenix-ui-map-creator.css\");\n\n        this._parseInput(o);\n\n        this.fenix_ui_mapConfig = o.fenix_ui_map;\n\n        var valid = this._validateInput();\n\n        if (valid === true) {\n\n            this._initVariables();\n\n            this._bindEventListeners();\n\n            this._renderMap();\n\n            return this;\n\n        } else {\n            log.error(\"Impossible to create MapCreator\");\n            log.error(valid)\n        }\n\n    }\n\n    // API\n\n    /**\n     * pub/sub\n     * @return {Object} component instance\n     */\n    MapCreator.prototype.on = function (channel, fn, context) {\n        var _context = context || this;\n        if (!this.channels[channel]) {\n            this.channels[channel] = [];\n        }\n        this.channels[channel].push({context: _context, callback: fn});\n        return this;\n    };\n\n    /**\n     * Add a base layer to map\n     */\n    MapCreator.prototype.addBaseLayer = function (layer) {\n\n        this.fenixMap.addTileLayer(layer, true);\n\n        return this;\n    };\n    /**\n     * Add a layer to map\n     */\n    MapCreator.prototype.addLayer = function (model) {\n\n        var layer;\n\n        if (!model)\n            return false;\n\n        //support simple Leaflet layer\n        if (model instanceof L.TileLayer)\n            return this.fenixMap.map.addLayer(model);\n\n        // TODO: switch to check if it's a fenix layer\n        if (this.errors && (!model || !model.hasOwnProperty(\"metadata\") ))\n            this.errors.metadata = \"Model does not contain 'metadata' attribute.\";\n\n        if (typeof model === 'string')\n            layer = this.createLayerFenixUid(model);\n\n        else if (model.hasOwnProperty('data'))\n            layer = this.createLayerFenixJoin(model);\n\n        else\n            layer = this.createLayerFenix(model);\n\n        layer = new FM.layer(layer);\n\n        if (typeof model === 'object' && model['metadata'] && model['metadata']['title'] && model['metadata']['title']['EN'])\n            layer.layer.layertitle = model['metadata']['title']['EN'];\n\n        if (this.initial.legendtitle)\n            layer.layer.layertitle = this.initial.legendtitle;\n\n        this.fenixMap.addLayer(layer);\n\n        return layer;\n    };\n\n    /**\n     * Remove a layer from map\n     */\n    MapCreator.prototype.removeLayer = function (layer) {\n\n        if (this.status.ready !== true) {\n            return;\n        }\n\n        return this;\n    };\n\n    /**\n     * Invalidate map size\n     */\n    MapCreator.prototype.invalidateSize = function () {\n\n        if (this.status.ready !== true) {\n            return;\n        }\n\n        this.fenixMap.invalidateSize()\n\n        return this;\n    };\n\n    // end API\n\n    MapCreator.prototype._parseInput = function () {\n\n        this.id = this.initial.id;\n        this.$el = $(this.initial.el);\n        this.model = this.initial.model;\n\n        //pivotator config\n        var pc = {};\n\n        pc.aggregationFn = this.initial.aggregationFn;\n\n        pc.aggregations = this.initial.aggregations || [];\n        pc.hidden = this.initial.hidden || [];\n        pc.columns = this.initial.x;\n        pc.values = this.initial.y || [\"value\"];\n        pc.rows = this.initial.series;\n\n        pc.formatter = this.initial.formatter || \"value\";\n        pc.valueOutputType = this.initial.valueOutputType;\n        pc.showRowHeaders = this.initial.showRowHeaders || false;\n        pc.decimals = this.initial.decimals || 2;\n\n        pc.showCode = this.initial.showCode || false;\n        pc.showFlag = this.initial.showFlag || false;\n        pc.showUnit = this.initial.showUnit || false;\n\n        // add more pivotator config\n\n        this.pivotatorConfig = pc;\n\n    };\n\n    MapCreator.prototype._validateInput = function () {\n\n        var valid = true,\n            errors = [];\n\n        //set MapCreator id\n        if (!this.id) {\n\n            window.fx_map_id >= 0 ? window.fx_map_id++ : window.fx_map_id = 0;\n            this.id = String(window.fx_map_id);\n            log.warn(\"Impossible to find MapCreator id. Set auto id to: \" + this.id);\n        }\n\n        //Check if $el exist\n        if (this.$el.length === 0) {\n            errors.push({code: ERR.MISSING_CONTAINER});\n            log.warn(\"Impossible to find box container\");\n        }\n\n        return errors.length > 0 ? errors : valid;\n\n    };\n\n    MapCreator.prototype._initVariables = function () {\n\n        //pub/sub\n        this.channels = {};\n\n        this.status = {};\n        this.status.ready = false;\n\n        this.pivotator = new Pivotator();\n        this.fenixTool = new Fenixtool();\n    };\n\n    MapCreator.prototype._bindEventListeners = function () {\n\n        amplify.subscribe(this._getEventName(EVT.WINDOW_RESIZE), this, this.invalidateSize);\n    };\n\n    MapCreator.prototype._renderMap = function () {\n\n        var self = this;\n\n        //var myPivotatorConfig=this.fenixTool.parseInut(this.initial.model.metadata.dsd, this.pivotatorConfig);\n        //var model = this.pivotator.pivot(this.model, this.pivotatorConfig);\n\n        self.fenixMap = new FM.Map(self.$el, self.fenix_ui_mapConfig);\n        self.fenixMap.createMap();\n\n        self.leafletMap = self.fenixMap.map;\n\n        if (self.model) {\n            self.addLayer(self.model);\n        }\n        else if (this.initial.uid) {\n            self.addLayer(this.initial.uid);\n        }\n\n\n        //TODO bind to Leaflet whenReady\n        self.status.ready = true;  //To be set on map ready event\n\n        setTimeout(_.bind(function () {\n            self._trigger('ready');\n        }, self), 0);\n    };\n\n    MapCreator.prototype._trigger = function (channel) {\n\n        if (!this.channels[channel]) {\n            return false;\n        }\n        var args = Array.prototype.slice.call(arguments, 1);\n        for (var i = 0, l = this.channels[channel].length; i < l; i++) {\n            var subscription = this.channels[channel][i];\n            subscription.callback.apply(subscription.context, args);\n        }\n\n        return this;\n    };\n\n    MapCreator.prototype._getEventName = function (evt) {\n\n        return this.id.concat(evt);\n\n    };\n\n    MapCreator.prototype._unbindEventListeners = function () {\n\n        amplify.unsubscribe(this._getEventName(EVT.WINDOW_RESIZE), this.invalidateSize);\n    };\n\n    MapCreator.prototype.dispose = function () {\n\n        //unbind event listeners\n        this._unbindEventListeners();\n\n        if (this.status.ready === true) {\n            this.fenixMap.destroyMap();\n        }\n\n        this.$el.empty();\n\n    };\n\n    MapCreator.prototype.createLayerFenix = function (model, options) {\n        var metadata = model.metadata;\n        var layer = {};\n        // Define the layer\n        if (metadata.hasOwnProperty(\"dsd\")) {\n            layer.layers = \"\";\n            if (metadata.dsd.hasOwnProperty(\"workspace\"))\n                layer.layers += metadata.dsd.workspace + \":\";\n\n            layer.layers += metadata.dsd.layerName;\n        }\n        else {\n            this.errors['dsd'] = \"Model['metadata'] does not contain 'dsd' attribute.\";\n            throw new Error(\"FENIX Map creator has not a valid configuration\");\n        }\n\n        //TODO\n        //if (model.hasOwnProperty(\"datasource\"))\n        //  layer.urlWMS = metadata[\"datasource\"];\n\n        layer.urlWMS = this.fenix_ui_map.DEFAULT_WMS_SERVER;\n        layer.layertitle = {\n            en: 'Data Layer'\n        };\n        layer.opacity = '0.9';\n        return layer;\n    };\n\n    MapCreator.prototype.createLayerFenixUid = function (uid) {\n        var layer = {\n            urlWMS: this.DEFAULT_WMS_SERVER,\n            layertitle: {\n                en: 'Data Layer'\n            },\n            opacity: '0.9',\n            layers: uid\n        };\n        return layer;\n    };\n\n    // JOIN\n    MapCreator.prototype.createLayerFenixJoin = function (model) {\n\n        if (this._validateJoinInput(model) === true) {\n\n            // create the join layer\n            var layer = this.getJoinLayer(model);\n\n            _.extend(layer, this.join.style);\n\n            var defPopup = \"<div class='fm-popup'>{{\" + layer.joincolumnlabel + \"}}\" +\n                \"<div class='fm-popup-join-content'>{{{\" + layer.joincolumn + \"}}} \" +\n                \"{{measurementunit}}\" +\n                \"</div></div>\";\n\n\n            // Layer title TODO: Add title if exist (check in the validator)\n            if (model['metadata'].hasOwnProperty(\"title\")) {\n                if (model['metadata']['title'][this.lang]) {\n                    layer.layertitle = model['metadata']['title'][this.lang];\n                    //console.log('title',this.lang, layer.layertitle)\n                }\n            }\n            else {\n                layer.layertitle = model['metadata']['uid'];\n            }\n\n            // getting a title from the options\n            if (this.hasOwnProperty('layer') && this.layer.hasOwnProperty('layertitle')) {\n                layer.layertitle = this.layer.layertitle;\n            }\n\n            if (this.hasOwnProperty('layer') && this.layer.hasOwnProperty('popupBuilder')) {\n                layer.popupBuilder = this.layer.popupBuilder;\n            }\n\n            layer.customgfi = {\n                showpopup: true,\n                content: {\n                    EN: _.isFunction(layer.popupBuilder) ? layer.popupBuilder(layer.joincolumnlabel, layer.joincolumn) : defPopup\n                }\n            };\n\n            // TODO: add check on the zoomto data (move it to a function)\n            var codes = [];\n            layer.joindata.forEach(function (code) {\n                _.keys(code).forEach(function (key) {\n                    if (_.isNumber(parseInt(key)))\n                        codes.push(key);\n                });\n            });\n\n            var zoomlayer = layer.layers.split(\":\");\n\n            zoomlayer = zoomlayer.length > 1 ? zoomlayer[1] : zoomlayer[0];\n\n            this.fenixMap.zoomTo(zoomlayer, layer.joincolumn, codes);\n\n            if (this.initial.colorRamp)\n                layer.colorramp = this.initial.colorRamp;\n\n            return layer;\n\n        } else {\n            //console.error(this.errors);\n            //throw new Error(\"FENIX Map creator has not a valid JOIN configuration\");\n        }\n    };\n\n    MapCreator.prototype.getJoinLayer = function (model) {\n\n        var metadata = model['metadata'],\n            geoColumn = {},\n            valueColumn = {},\n            muColumn = {};\n\n        metadata['dsd']['columns'].forEach(_.bind(function (col, index) {\n            if (col.subject === this.geoSubject || col.id === this.geoSubject) {\n                geoColumn = col;\n                geoColumn.index = index;\n            }\n            if (col.subject === this.valueSubject || col.id === this.valueSubject) {\n                valueColumn = col;\n                valueColumn.index = index;\n            }\n            if (col.subject === this.muSubject) {\n                muColumn = col;\n                muColumn.index = index;\n            }\n        }, this));\n\n        // getting the right measurement unit if the new label exists\n        metadata['dsd']['columns'].forEach(_.bind(function (column, index) {\n            if (muColumn.id + '_' + this.lang) {\n                muColumn = column;\n                muColumn.index = index;\n            }\n        }, this));\n\n\n        if (this._validateJoinColumnInput(geoColumn)) {\n\n\n            var layer = null;\n            var codelist = geoColumn['domain']['codes'][0]['idCodeList'].toLowerCase();\n\n            if (this.join.layerMapping[codelist]) {\n                layer = this.join.layerMapping[codelist];\n            }\n            else {\n                geoColumn['domain']['codes'][0].idCodeList.toLowerCase();\n                // TODO: Handle reference Area\n                var referenceArea = metadata[\"meContent\"][\"seReferencePopulation\"][\"referenceArea\"]['codes'][0].code.toLowerCase();\n                layer = this.join.layerMapping[codelist + \"_\" + referenceArea];\n            }\n\n            // check measurementunit\n            // TODO: Add measurement unit to the layer definition (using label column of the mu)\n\n            // get joinData\n            layer.joindata = this.getJoinData(model['data'], geoColumn.index, valueColumn.index);\n\n            // TODO: check on the column index\n            layer.measurementunit = model['data'][0][muColumn.index];\n\n            // TODO: check if is the right legendtitle\n            layer.legendtitle = layer.measurementunit;\n\n            layer.layertitle = 'OCD';\n            //layer.legendtitle = 'ODA';\n\n            return layer;\n\n        } else {\n            console.error('Error JoinColumnInput not valid')\n        }\n    };\n\n    MapCreator.prototype.getJoinData = function (data, geoColumnIndex, valueColumnIhdex) {\n        var joindata = [];\n\n        // TODO: remove cachedValues on final version. Check on join data consistency?\n        var cachedValues = {}\n        // TODO: add on check\n        data.forEach(_.bind(function (row) {\n            var obj = {}\n            var code = row[geoColumnIndex];\n            var value = row[valueColumnIhdex];\n            if (code && value) {\n                obj[code] = value;\n                if (!cachedValues.hasOwnProperty(code)) {\n                    // check null values\n                    cachedValues[code] = true;\n                    joindata.push(obj);\n                }\n            }\n        }, this));\n\n        return joindata;\n    };\n\n    MapCreator.prototype._validateJoinInput = function (model) {\n        this.errors = {};\n\n        //Metadata TODO: add all metadata checks\n        if (!model.hasOwnProperty(\"metadata\")) {\n            this.errors.metadata = \"'metadata' attribute not present.\";\n        }\n\n        //Data\n        if (!model.hasOwnProperty(\"data\")) {\n            this.errors.data = \"'data' attribute not present.\";\n        }\n\n        return (_.keys(this.errors).length === 0);\n    };\n\n    MapCreator.prototype._validateJoinColumnInput = function (column) {\n        this.errors = {};\n\n        //Metadata TODO: add all metadata checks\n        if (!column.hasOwnProperty('key')) {\n            this.errors.column = \"'key' attribute not present.\";\n        }\n        else {\n            if (column.key !== true) {\n                this.errors.column = \"'key' is not true.\";\n            }\n        }\n\n        if (!column.hasOwnProperty('dataType')) {\n            this.errors.column = \"'dataType' attribute not present.\";\n        }\n        else {\n            if (column.dataType !== 'code') {\n                this.errors.column = \"'dataType' attribute is not a coding system.\";\n            }\n        }\n\n        // TODO: check domain and referencearea if needed\n\n        return (Object.keys(this.errors).length === 0);\n    };\n\n    return MapCreator;\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/js/index.js\n// module id = 1\n// module chunks = 0","\ndefine([\n    'jquery','underscore','leaflet','hashmap','bootstrap','ion-rangeslider',\n    '../nls/labels'\n    ],\n\nfunction($, _, L, HashMap, Bootstrap, Rangeslider, i18n) {\n\nvar FM = {};\n\nFM.CONFIG = {\n\n\tMAP_SERVICE_SHADED: 'http://fenix.fao.org/test/geo/fenix/mapclassify/join/',\n\tDEFAULT_WMS_SERVER: 'http://fenix.fao.org/demo/fenix/geoserver',\n\n\tMAP_SERVICE_GFI_STANDARD: 'http://fenix.fao.org/test/geo/fenix/mapclassify/request/',\n\n\tZOOM_TO_BBOX: 'http://fenix.fao.org/geo/fenix/spatialquery/db/spatial/bbox/layer/',\n\n\tBASEURL_MAPS: 'http://fenixapps2.fao.org/maps-demo',\n\n\tMAP_SERVICE_WMS_GET_CAPABILITIES: 'http://fenixapps2.fao.org/maps-demo/rest/service/request',\n\n\tLAYER_BOUNDARIES: 'fenix:gaul0_line_3857',\n\tLAYER_LABELS: 'http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png',\n};\n\nFMCONFIG = FM.CONFIG;;\nFM.Class = function () {};\n\nFM.Class.extend = function (props) {\n\n    // extended class with the new prototype\n    var NewClass = function () {\n\n        // call the constructor\n        if (this.initialize) {\n            this.initialize.apply(this, arguments);\n        }\n\n        // call all constructor hooks\n        if (this._initHooks) {\n            this.callInitHooks();\n        }\n    };\n\n    // instantiate class without calling constructor\n    var F = function () {};\n    F.prototype = this.prototype;\n\n    var proto = new F();\n    proto.constructor = NewClass;\n\n    NewClass.prototype = proto;\n\n    //inherit parent's statics\n    for (var i in this) {\n        if (this.hasOwnProperty(i) && i !== 'prototype') {\n            NewClass[i] = this[i];\n        }\n    }\n\n    // mix static properties into the class\n    if (props.statics) {\n        FM.extend(NewClass, props.statics);\n        delete props.statics;\n    }\n\n    // mix includes into the prototype\n    if (props.includes) {\n        FM.Util.extend.apply(null, [proto].concat(props.includes));\n        delete props.includes;\n    }\n\n    // merge options\n    if (props.options && proto.options) {\n        props.options = FM.extend({}, proto.options, props.options);\n    }\n\n    // mix given properties into the prototype\n    FM.extend(proto, props);\n\n    proto._initHooks = [];\n\n    var parent = this;\n    // add method for calling all hooks\n    proto.callInitHooks = function () {\n\n        if (this._initHooksCalled) { return; }\n\n        if (parent.prototype.callInitHooks) {\n            parent.prototype.callInitHooks.call(this);\n        }\n\n        this._initHooksCalled = true;\n\n        for (var i = 0, len = proto._initHooks.length; i < len; i++) {\n            proto._initHooks[i].call(this);\n        }\n    };\n\n    return NewClass;\n};\n// method for adding properties to prototype\nFM.Class.include = function (props) {\n    FM.extend(this.prototype, props);\n};\n// merge new default options to the Class\nFM.Class.mergeOptions = function (options) {\n    FM.extend(this.prototype.options, options);\n};\n// add a constructor hook\nFM.Class.addInitHook = function (fn) { // (Function) || (String, args...)\n    var args = Array.prototype.slice.call(arguments, 1);\n\n    var init = typeof fn === 'function' ? fn : function () {\n        this[fn].apply(this, args);\n    };\n\n    this.prototype._initHooks = this.prototype._initHooks || [];\n    this.prototype._initHooks.push(init);\n};\nFM.Util = {\n\n    extend: function (dest) { // (Object[, Object, ...]) ->\n        var sources = Array.prototype.slice.call(arguments, 1),\n            i, j, len, src;\n\n        for (j = 0, len = sources.length; j < len; j++) {\n            src = sources[j] || {};\n            for (i in src) {\n                if (src.hasOwnProperty(i)) {\n                    dest[i] = src[i];\n                }\n            }\n        }\n        return dest;\n    },\n\n    bind: function (fn, obj) { // (Function, Object) -> Function\n        var args = arguments.length > 2 ? Array.prototype.slice.call(arguments, 2) : null;\n        return function () {\n            return fn.apply(obj, args || arguments);\n        };\n    },\n\n    stamp: (function () {\n        var lastId = 0, key = '_leaflet_id';\n        return function (/*Object*/ obj) {\n            obj[key] = obj[key] || ++lastId;\n            return obj[key];\n        };\n    }()),\n\n    limitExecByInterval: function (fn, time, context) {\n        var lock, execOnUnlock;\n\n        return function wrapperFn() {\n            var args = arguments;\n\n            if (lock) {\n                execOnUnlock = true;\n                return;\n            }\n\n            lock = true;\n\n            setTimeout(function () {\n                lock = false;\n\n                if (execOnUnlock) {\n                    wrapperFn.apply(context, args);\n                    execOnUnlock = false;\n                }\n            }, time);\n\n            fn.apply(context, args);\n        };\n    },\n\n    falseFn: function () {\n        return false;\n    },\n\n    formatNum: function (num, digits) {\n        var pow = Math.pow(10, digits || 5);\n        return Math.round(num * pow) / pow;\n    },\n\n    splitWords: function (str) {\n        return str.replace(/^\\s+|\\s+$/g, '').split(/\\s+/);\n    },\n\n    setOptions: function (obj, options) {\n        obj.options = L.extend({}, obj.options, options);\n        return obj.options;\n    },\n\n    getParamString: function (obj, existingUrl) {\n        var params = [];\n        for (var i in obj) {\n            if (obj.hasOwnProperty(i)) {\n                params.push(i + '=' + obj[i]);\n            }\n        }\n        return ((!existingUrl || existingUrl.indexOf('?') === -1) ? '?' : '&') + params.join('&');\n    },\n\n    template: function (str, data) {\n        return str.replace(/\\{ *([\\w_]+) *\\}/g, function (str, key) {\n            var value = data[key];\n            if (!data.hasOwnProperty(key)) {\n                throw new Error('No value provided for variable ' + str);\n            }\n            return value;\n        });\n    },\n\n    isArray: function (obj) {\n        return (Object.prototype.toString.call(obj) === '[object Array]');\n    },\n\n    emptyImageUrl: 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='\n};\n\n(function () {\n\n    function getPrefixed(name) {\n        var i, fn,\n            prefixes = ['webkit', 'moz', 'o', 'ms'];\n\n        for (i = 0; i < prefixes.length && !fn; i++) {\n            fn = window[prefixes[i] + name];\n        }\n\n        return fn;\n    }\n\n    var lastTime = 0;\n\n    function timeoutDefer(fn) {\n        var time = +new Date(),\n            timeToCall = Math.max(0, 16 - (time - lastTime));\n\n        lastTime = time + timeToCall;\n        return window.setTimeout(fn, timeToCall);\n    }\n\n    var requestFn = window.requestAnimationFrame ||\n        getPrefixed('RequestAnimationFrame') || timeoutDefer;\n\n    var cancelFn = window.cancelAnimationFrame ||\n        getPrefixed('CancelAnimationFrame') ||\n        getPrefixed('CancelRequestAnimationFrame') ||\n        function (id) { window.clearTimeout(id); };\n\n\n    FM.Util.requestAnimFrame = function (fn, context, immediate, element) {\n        fn = L.bind(fn, context);\n\n        if (immediate && requestFn === timeoutDefer) {\n            fn();\n        } else {\n            return requestFn.call(window, fn, element);\n        }\n    };\n\n    FM.Util.cancelAnimFrame = function (id) {\n        if (id) {\n            cancelFn.call(window, id);\n        }\n    };\n\n    FM.Util.replaceAll = function(text, stringToFind, stringToReplace) {\n        if(text)\n            return text.replace(new RegExp(stringToFind, 'g'), stringToReplace);\n    },\n\n    FM.Util.parseLayerRequest = function(layer) {\n        var layerValues = eval(layer);\n        var layerRequest = '';\n        $.each(layerValues, function(key, value) {\n            layerRequest += '&' + key + '=' + value;\n        });\n        return layerRequest;\n    },\n\n    FM.Util.randomID = function() {\n        var randLetter = Math.random().toString(36).substring(7);\n        return (randLetter + Date.now()).toLocaleLowerCase();\n    },\n\n    FM.Util.fire = function(item , type, data){\n        var evt = document.createEvent('CustomEvent');\n        evt.initCustomEvent(type, true, true, data);\n        item.dispatchEvent(evt);\n    }\n\n    FM.Util.on = function(item , type, data, callback){\n        item.addEventListener(type, callback, false);\n    }\n\n}());\n\n// shortcuts for most used utility functions\nFM.extend = FM.Util.extend;\nFM.bind = FM.Util.bind;\nFM.stamp = FM.Util.stamp;\nFM.setOptions = FM.Util.setOptions;\nFM.loadModuleLibs = FM.Util.loadModuleLibs;\n\nFM.UIUtils = {\n    loadingPanel: function (id, height) {\n        var h = '25px';\n        if (height)\n            document.getElementById(id).innerHTML = \"<div class='fm-loadingPanel' style='height:\"+ h +\"'></div>\";\n        else\n            document.getElementById(id).innerHTML = \"<div class='fm-loadingPanel'></div>\";\n    }\n};\n\nFM.WMSUtils = FM.Class.extend({\n\n    _divID:'',\n    _dropdowndID: '',\n    _outputID: '',\n    _fenixMap: '',\n    _wmsServers: '',\n    _mapID: '',\n    _lang: 'EN',\n\n    // JSON\n    WMSCapabilities: function(divID, outputID, fenixmap, wmsServers, lang) {\n        this._divID = divID;\n        this._dropdowndID = divID + '-dropdown';\n        this._outputID = outputID;\n        this._fenixmap = fenixmap;\n        this._wmsServers = wmsServers;\n        if ( lang ) this._lang = lang;\n\n        this._createWMSDropDown(this._wmsServers, this._divID, this._dropdowndID, this._outputID, fenixmap);\n    },\n\n    _createWMSDropDown: function(wmsServers, divID, dropdowndID, outputID, fenixmap) {\n        // TODO: dynamic width\n        var html = '<select id=\"'+ dropdowndID+'\" style=\"width:200px;\" data-placeholder=\"\" class=\"\">';\n        html += '<option value=\"\"></option>';\n        for(var i=0; i < wmsServers.length; i++)\n            html += '<option value=\"'+ wmsServers[i].url + '\">'+wmsServers[i].label +'</option>';\n        html += '</select>';\n\n        $('#' + divID).empty();\n        $('#' + divID).append(html);\n\n        try {\n            $('#' + dropdowndID).chosen({disable_search_threshold:6, width: '100%'});\n        }  catch (e) {}\n\n        // enable on click\n        var _this = this;\n        $( \"#\" + dropdowndID ).change({},  function (event) {\n            _this._createWMSOutputRequest(outputID, fenixmap, $( this ).val());\n        });\n    },\n\n    _createWMSOutputRequest: function(id, fenixmap, wmsServerURL) {\n        $(\"#\" + id).empty();\n        FM.UIUtils.loadingPanel(id, '30px');\n\n        var url = FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;\n        url += (url.indexOf('?') > 0)? \"&\": \"?\";\n        url += 'SERVICE=WMS';\n        url += '&VERSION=1.1.1';\n        url += '&request=GetCapabilities';\n        url += '&urlWMS=' + wmsServerURL;\n\n         var _this = this;\n         $.ajax({\n             type: \"GET\",\n             url: url,\n             success: function(response) {\n                 var xmlResponse = $.parseXML( response );\n                 _this._createWMSOutput(id, fenixmap, xmlResponse, wmsServerURL)\n             }\n         });\n    },\n\n    _createWMSOutput: function(id, fenixmap, xmlResponse, wmsServerURL ) {\n\n        $(\"#\" + id).empty();\n        $(xmlResponse).find('Layer').each(function() {\n\n            if ($(this).children(\"Name\").text() && $(this).children(\"Name\").text() != '') {\n\n                var layer = {};\n                layer.layers= $(this).children(\"Name\").text();\n                layer.layername= $(this).children(\"Name\").text();\n                layer.layertitle=$(this).children(\"Title\").text();\n\n                //TODO: dirty quick TITLE fix for DEMO\n                layer.layertitle = layer.layertitle.replace(/_/g,' ');\n                layer.layertitle = layer.layertitle.replace(/3857/g,' ');\n\n                layer.styles = $(this).children(\"Style\").children(\"Name\").text();\n                layer.urlWMS = wmsServerURL;\n                // setting the default CRS of the map\n                layer.srs = fenixmap.map.options.crs.code;\n                layer.openlegend = true; //this will open the legend by on preview (choose on add if we want to leave it open **/\n\n\n                var rand = FM.Util.randomID();\n                var layerPanel = FM.Util.replaceAll(FM.guiController.wmsLoaderLayer, 'REPLACE', rand);\n\n                $(\"#\" + id).append(layerPanel);\n                $('#' + rand + '-WMSLayer-title').append(layer.layertitle);\n\n\n                // TODO: get bounding box with the current CRS\n                $(\"#\" + rand + \"-WMSLayer-box\").on('click',\n                    {\n                        fenixmap: fenixmap,\n                        layer: layer\n                    }, function(e) {\n\n                    e.data.layer.openlegend = false; // if on add we want to close the legend\n                    \n                    var layer = new FM.layer(e.data.layer);\n\n                    e.data.fenixmap.addLayer(layer);\n\n                    try {\n                        FMPopUp.init({\n                            parentID: e.data.fenixmap.id,\n                            content: 'The Layer <b>' + e.data.layer.layertitle + '</b><br> has been added to the map'\n                        })\n                    }catch(e) {}\n\n                });\n\n                // add on hoverIntent the layer\n                var _fenixMap = fenixmap;\n                var _layer =  $.extend(true, {}, layer);\n                //_layer.hideLayerInControllerList = true;\n                var _tmpLayer = new FM.layer(_layer);\n                try {\n                    $(\"#\" + rand + \"-WMSLayer-box\").hoverIntent({\n                        over: function () { _fenixMap.addLayer(_tmpLayer);},\n                        out:  function () { _fenixMap.removeLayer(_tmpLayer);},\n                        timeout: 500\n                    });\n                }catch(e) {\n                    // try catch in case the jquery.hoverIntent plugin is not been imported\n                }\n            }\n        });\n    },\n\n    // add a new Server to the servers list\n    addWMSServer: function() {\n\n    },\n\n\n    _WMSCapabilities: function(id, fenixmap, wmsServerURL) {\n        // TODO: check it because in theory it shouldn't be needed\n        var url = FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;\n        url += (url.indexOf('?') > 0)? \"&\": \"?\";\n        url += 'SERVICE=WMS';\n        url += '&VERSION=1.1.1';\n        url += '&request=GetCapabilities';\n        url += '&urlWMS=' + wmsServerURL;\n\n        var _this = this;\n        $.ajax({\n            type: \"GET\",\n            url: url,\n            success: function(response) {\n                var xmlResponse = $.parseXML(response);\n                _this._createWMSDropwDown(id, fenixmap, xmlResponse, wmsServerURL)\n            }\n        });\n    },\n\n    _createWMSDropwDown: function(id, fenixmap, xmlResponse, wmsServerURL ) {\n        var rand = FM.Util.randomID();\n        $(xmlResponse).find('Layer').each(function() {\n            var rand = FM.Util.randomID();\n            if ($(this).children(\"Name\").text()) {\n\n                var layer = {};\n                layer.layers = $(this).children(\"Name\").text();\n                layer.layername = $(this).children(\"Name\").text();\n                layer.layertitle =$(this).children(\"Title\").text();\n                layer.styles = $(this).children(\"Style\").children(\"Name\").text();\n                layer.urlWMS = wmsServerURL;\n                layer.openlegend = true;\n\n                $(\"#\" + id).append(\"<div id='WMSLayer-\"+ rand +\"'>ddd\" + layer.layertitle + \" + \" +  layer.styles + \" <div>\");\n\n                // setting the default CRS of the map\n                layer.srs = fenixmap.map.options.crs.code;\n\n                $(\"#WMSLayer-\" + rand).click({fenixmap:fenixmap, layer: layer}, function(event) {\n                    var layer = new FM.layer(event.data.layer);\n                    event.data.fenixmap.addLayerWMS(layer);\n                });\n            }\n        });\n    },\n\n\n    WFSCapabilities: function(id, fenixmap, wmsServerURL) {\n        var url = FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;\n        url += (url.indexOf('?') > 0)? \"&\": \"?\";\n        url += 'SERVICE=WFS';\n        url += '&VERSION=1.0.0';\n        url += '&request=GetCapabilities';\n        url += '&urlWMS=' + wmsServerURL;\n\n        var _this = this;\n        $.ajax({\n            type: \"GET\",\n            url: url,\n            success: function(response) {\n                var xmlResponse = $.parseXML(response);\n                FM.WMSUtils._createWMSDropwDown(id, fenixmap, xmlResponse, wmsServerURL)\n            }\n        });\n    },\n\n    _createWFSDropwDown: function(id, fenixmap, xmlResponse, wmsServerURL ) {\n        $(xmlResponse).find('Layer').each(function() {\n            /** TODO: optimize ramdon function **/\n            var rand = FM.Util.randomID();\n            if ($(this).children(\"Name\").text()) {\n\n                //console.log($(this).children(\"Name\").text() + ' | ' +  $(this).children(\"Title\").text());\n                $(\"#\" + id).append(\"<div id='WMSLayer-\"+ rand +\"'>\" + $(this).children(\"Title\").text() + \" + \" +  $(this).children(\"Style\").children(\"Name\").text() + \" <div>\");\n                //$(\"#\" + id).append(\"<li> <a href='#'>\" + $(this).children(\"Title\").text() + \" + \" +  $(this).children(\"Style\").children(\"Name\").text() + \"</a><li>\");\n\n                var layer = {};\n                layer.layers= $(this).children(\"Name\").text();\n                layer.layername= $(this).children(\"Name\").text();\n                layer.layertitle=$(this).children(\"Title\").text();\n                layer.style = $(this).children(\"Style\").children(\"Name\").text();\n                layer.urlWMS = wmsServerURL;\n                layer.openlegend = true;\n\n                // setting the default CRS of the map\n                layer.srs = fenixmap.map.options.crs.code;\n\n                $(\"#WMSLayer-\" + rand).click({fenixmap:fenixmap, layer: layer}, function(event) {\n                    var layer = new FM.layer(event.data.layer);\n                    event.data.fenixmap.addLayerWMS(layer);\n                });\n            }\n        });\n    }\n});;\n\n(function() {\n    var\n        fullScreenApi = {\n            supportsFullScreen: false,\n            isFullScreen: function() { return false; },\n            requestFullScreen: function() {},\n            cancelFullScreen: function() {},\n            fullScreenEventName: '',\n            prefix: ''\n        },\n        browserPrefixes = 'webkit moz o ms khtml'.split(' ');\n\n    // check for native support\n    if (typeof document.exitFullscreen != 'undefined') {\n        //console.log('fullScreenApi if');\n        fullScreenApi.supportsFullScreen = true;\n    } else {\n       // console.log('fullScreenApi else');\n        // check for fullscreen support by vendor prefix\n        for (var i = 0, il = browserPrefixes.length; i < il; i++ ) {\n            fullScreenApi.prefix = browserPrefixes[i];\n\n            if (typeof document[fullScreenApi.prefix + 'CancelFullScreen' ] != 'undefined' ) {\n                //console.log('fullScreenApi.CancelFullScreen');\n                fullScreenApi.supportsFullScreen = true;\n                break;\n            }\n        }\n    }\n\n    // update methods to do something useful\n    if (fullScreenApi.supportsFullScreen) {\n        //console.log('fullScreenApi.qua');\n        fullScreenApi.fullScreenEventName = fullScreenApi.prefix + 'fullscreenchange';\n\n        fullScreenApi.isFullScreen = function() {\n            //console.log('fullScreenApi.isFullScreen');\n            switch (this.prefix) {\n                case '':\n                    return document.fullScreen;\n                case 'webkit':\n                    return document.webkitIsFullScreen;\n                default:\n                    return document[this.prefix + 'FullScreen'];\n            }\n        }\n        fullScreenApi.requestFullScreen = function(el) {\n            //console.log('fullScreenApi.requestFullScreen');\n            return (this.prefix === '') ? el.requestFullscreen() : el[this.prefix + 'RequestFullScreen']();\n        }\n        fullScreenApi.cancelFullScreen = function(el) {\n           // console.log('fullScreenApi.cancelFullScreen');\n                return (this.prefix === '') ?\n                document.exitFullscreen() :\n                document[this.prefix + 'CancelFullScreen']();\n        }\n    }\n\n    // jQuery plugin\n    if (typeof jQuery != 'undefined') {\n        jQuery.fn.requestFullScreen = function() {\n\n            return this.each(function() {\n                var el = jQuery(this);\n                if (fullScreenApi.supportsFullScreen) {\n                    fullScreenApi.requestFullScreen(el);\n                }\n            });\n        };\n    }\n\n    // export api\n    window.fullScreenApi = fullScreenApi;\n})();;\n\nFMDEFAULTLAYER = {\n\n    getLayer: function(layertype, isjoin, measurementunit) {\n        switch(layertype.toUpperCase()) {\n            case \"GAUL0\"                : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857_2', 'adm0_code', 'the_geom', isjoin, 'faost_n', measurementunit, 'GAUL'); break;\n            case \"GAUL0_FAOSTAT\"        : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857', 'faost_code','the_geom', isjoin, 'faost_n', measurementunit, 'FAOSTAT'); break;\n            case \"GAUL0_ISO2\"           : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857_2', 'iso2_code', 'the_geom', isjoin, 'faost_n', measurementunit, 'ISO2'); break;\n            case \"GAUL0_ISO3\"           : return FMDEFAULTLAYER._getGAUL('gaul0_faostat_3857_2', 'iso3_code', 'the_geom', isjoin, 'faost_n', measurementunit, 'ISO3'); break;\n            case \"GAUL0_BOUNDARIES\"     : return FMDEFAULTLAYER._getWMSLayer('gaul0_line_3857'); break;\n            case \"GAUL1\"                : return FMDEFAULTLAYER._getGAUL('gaul1_3857', 'adm1_code', 'the_geom', isjoin, 'adm1_name', measurementunit, null); break;\n//            case \"GAUL1\"                : return FMDEFAULTLAYER._getGAUL('gaul1_3857', 'adm1_code', 'the_geom', isjoin, 'adm1_name', measurementunit, null); break;\n//            case \"GAUL2\"                : return FMDEFAULTLAYER._getGAUL('gaul2_3857', 'adm2_code', 'the_geom', isjoin, 'adm2_name', measurementunit, null); break;\n            // TODO: change to a standard GAUL2 layer. 'gaul2_3857_2'is another GAUL2 used with the new popup (the old gaul2 as content.ftl used by countrystat)\n            case \"GAUL2\"                : return FMDEFAULTLAYER._getGAUL('gaul2_3857', 'adm2_code', 'the_geom', isjoin, 'adm2_name', measurementunit, null); break;\n        }\n    },\n\n    _getGAUL: function(layername, joincolumn, geometrycolumn, isjoin, joincolumnlabel, measurementunit, joinboundary) {\n        var layer = {};\n        layer.layers=layername ;\n        layer.styles='';\n        layer.joincolumn=(joincolumn )? joincolumn: null;\n        layer.joincolumnlabel=(joincolumnlabel )? joincolumnlabel: null;\n        layer.measurementunit=(measurementunit )? measurementunit: null;\n        layer.srs = 'EPSG:3857';\n        layer.geometrycolumn =(geometrycolumn )? geometrycolumn: '';\n        if (isjoin) {\n            FMDEFAULTLAYER.joinDefaultPopUp(layer);\n            layer.joinboundary = joinboundary;\n        }\n        return layer;\n    },\n\n    _getWMSLayer:function(layername, urlWMS, styles, srs) {\n        // TODO: remove FMCONFIG from here!\n        var layer = {};\n        layer.layers = layername;\n        layer.styles = (styles)?styles:'';\n        layer.srs = (srs)?srs:'EPSG:3857';\n        layer.urlWMS = (urlWMS)?urlWMS: FMCONFIG.DEFAULT_WMS_SERVER;\n        return layer;\n    },\n\n    /** TODO: handle multilanguage **/\n    joinDefaultPopUp: function( layer ) {\n        //console.log(layer);\n        var measurementunit  = (layer.measurementunit)? \" \" + layer.measurementunit +\"\": \"\";\n        var joinlabel  = (layer.joincolumnlabel)? \"<div class='fm-popup-join-title'>{{\" + layer.joincolumnlabel +\"}}</div>\": \"\";\n        layer.customgfi = {\n            content : {\n                en: \"<div class='fm-popup'>\" + joinlabel + \"<div class='fm-popup-join-content'>{{{\" + layer.joincolumn +\"}}} <i>\" + measurementunit +\"</i></div></div>\",\n                fr: \"<div class='fm-popup'>\" + joinlabel + \"{{{\" + layer.joincolumn +\"}}} <i>\" + measurementunit +\"</i></div>\",\n                es: \"<div class='fm-popup'>\" + joinlabel + \"{{{\" + layer.joincolumn +\"}}} <i>\" + measurementunit +\"</i></div>\"\n            }\n            ,showpopup: true\n            ,output: {\n                show: true,\n                id: 'gfiid'\n            }\n            ,callback : function(response, custompopup) {\n                $('#' + custompopup.outputid ).empty();\n                $('#' + custompopup.outputid ).append(response);\n            }\n        }\n    }\n\n};\n;\nFM.TILELAYER = {\n\n    // OpenStreetMap\n    OSM: {\n        url: 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',\n        title_en: 'OSM - OpenStreetMap'\n    },\n\n    OSM_GRAYSCALE: {\n        url : 'http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png',\n        title_en: 'OSM - OpenStreetMap grayscale'\n    },\n\n    MAPQUEST: {\n        url : 'http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',\n        title_en: 'MapQuest'\n    },\n\n    MAPQUEST_NASA_AERIAL : {\n        url: 'http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png',\n        title_en: 'MapQuest Aerial'\n    },\n\n    ESRI_WORLDSTREETMAP : {\n        url: 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png',\n        title_en: 'ESRI - World Street Map'\n    },\n\n    ESRI_WORLDTERRAINBASE : {\n        url: 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',\n        title_en: 'ESRI - World Terrain Base'\n    },\n\n    ACETATE_LABELS : {\n        url : 'http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png',\n        title_en : 'Acetate Labels'\n    },\n\n    ACETATE_TERRAIN : {\n        url : 'http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png',\n        title_en: 'Acetate Terrain'\n    },\n\n    STAMEN_TONER_BACKGROUND : {\n        url : 'http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png',\n        title_en: 'Stamen'\n    },\n\n    ESRI_HISTORICAL_MERCATOR: {\n        url : 'http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png',\n        title_en: 'ESRI_HISTORICAL_MERCATOR'\n    }\n};\n;\nFM.WMSSERVERS = {\n\n    DEFAULT_EXTERNAL_WMS_SERVERS: [\n        {\n            label: 'FENIX Crops Area',\n            label_EN: 'FENIX', // not currently used for the multilingual, it is needed?\n            url: 'http://fenix.fao.org/demo/fenix/geoserver/earthstat/wms'\n        },\n        {\n            label: 'Greenhouse gases Data',\n            label_EN: 'FENIX',\n            url: 'http://fenix.fao.org/demo/ghg/geoserver/wms'\n        },\n        {\n            label: 'DATA.FAO.ORG',\n            label_EN: 'data.fao.org WMS Server',\n            url: 'http://data.fao.org/maps/wms'\n        },\n        {\n            label: 'UNREDD Congo',\n            label_EN: 'UNREDD Congo',\n            url: 'http://rdc-snsf.org/diss_geoserver/gwc/service/wms'\n        },\n        {\n            label: 'Wales OpenData',\n            label_EN:  'Wales OpenData',\n            url: 'http://inspire.wales.gov.uk/maps/ows'\n        },\n        {\n            label: 'Scotland OpenData',\n            label_EN:  'Scotland OpenData',\n            url: 'http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer'\n        },\n        {\n            label: 'Netherlands OpenData',\n            label_EN:  'Netherlands OpenData',\n            url: 'http://geodata.nationaalgeoregister.nl/ahn2/wcs'\n        },\n        {\n            label: 'German OpenData',\n            label_EN:  'German OpenData',\n            url: 'http://geo.sv.rostock.de/geodienste/verwaltung/wms'\n        },\n        {\n            label: 'ENVIRONMENT OpenData',\n            label_EN:  'Scotland OpenData',\n            url: 'http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer'\n        },\n        {\n            label: 'OpenGeo Demo Server',\n            label_EN: 'OpenGeo Demo Server',\n            url: 'http://demo.opengeo.org/geoserver/ows'\n        },\n        {\n            label: 'Alberts Map Service',\n            url: 'http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer',\n            urlParameters: 'service=WMS'\n        },\n        {\n            label: 'Cubert Map Service',\n            label_EN: 'Cubert',\n            url: 'http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi'\n        },\n        {\n            label: 'GP Map Service',\n            label_EN: 'gp map service201',\n            url: 'http://geoportal.logcluster.org:8081/gp_map_service201/wms'\n        },\n        {\n            label: 'Vienna OpenData',\n            label_EN:  'Vienna OpenData',\n            url: 'http://data.wien.gv.at/daten/wms'\n        },\n        {\n            label: 'Vienna OpenData',\n            label_EN:  'Vienna OpenData',\n            url: 'http://data.wien.gv.at/daten/wms'\n        }\n    ]\n}\n\n;\nFM.Map = FM.Class.extend({\n\n    id: '',\n    suffix: '',\n    mapContainerID: '',\n    tilePaneID: '',\n\n    map: '',        //this is the map obj of Leaflet/Openlayers\n    controller: '', //controller of the map\n    plugins: {},    //indexed plugins istances\n\n    options: {\n        url: {},    \t\n        lang: 'EN',\n        guiController : {\n            container: null,\n            overlay: true,\n            baselayer: true,\n            wmsLoader: true,\n            enablegfi: true, //this is used to switch off events like on drawing (when is need to stop the events on GFI)\n            layersthumbs: false\n        },\n        plugins: {\n\t\t\tfullscreen: true,  //true or {id: 'divID'} or false\n        \tzoomcontrol: true,\n            scalecontrol: true,\n            legendcontrol: true,\n        \tdisclaimerfao: true\n        },\n        baselayers: null,\n        boundaries: null,\n        labels: null,\n        //http://goo.gl/MUIt8Z\n        legendOptions: null,\n        zoomToCountry: null,\n        highlightCountry: null,\n        style: {\n            color: '#337ab7',\n            opacity: 0.8,\n            weight: 2,\n            fillColor: '#337ab7',\n            fillOpacity: 0.1\n        }\n    },\n    mapOptions: {\n\t\tzoomControl: false,\n\t\tattributionControl: false,\n        center: [0, 0],\n        lat: 0,\n        lng: 0,\n        zoom: 1\n    },\n\n    initialize: function(id, options, mapOptions) { // (HTMLElement or String, Object)\n\n        var self = this;\n\n        // merging object with a deep copy\n        this.options =  $.extend(true, {}, this.options, options);\n        this.mapOptions = $.extend(true, {}, this.mapOptions, mapOptions);\n\n        // extent if exist FM.CONFIG\n        if (FMCONFIG)\n            this.options.url = $.extend(true, {}, FMCONFIG, options && options.url );\n\n        var suffix = FM.Util.randomID();\n        var mapContainerID =  suffix + '-container-map';\n        var mapID =  suffix + '-map';\n\n        var mapDIV = \"<div class='fm-map-box fm-box' id='\"+ mapContainerID +\"'><div>\";\n        \n        $(id).length > 0? $(id).append(mapDIV): $(\"#\" + id).append(mapDIV);\n\n        this.id = mapID;\n\n        this.$map = $(\"#\" + mapContainerID);\n\n        this.$map.append(\"<div style='width:100%; height: 100%;' id='\"+ mapID +\"'><div>\");\n\n        this.map = new L.Map(this.id, this.mapOptions);\n\n        this.mapContainerID = mapContainerID;\n        this.suffix = suffix;\n\n        // setting the TilePaneID   TODO: set IDs to all the DIVs?\n        this.setTilePaneID();\n   \n        this.controller = new FM.mapController(suffix, this, this.map,  this.options.guiController);\n\n        this.controller.initializeGUI();\n\n        this.map._fenixMap = this;\n\n        if(this.options.guiController.enablegfi)\n            this.map.on('click', this.getFeatureInfo, this);\n\n        var swipeControl = (function() {\n            var control = new L.Control();\n            control.onAdd = function(map) {\n                return $(\"<div  class='fm-swipe' id='\"+ suffix +\"-swipe'><div style='display:none' class='fm-swipe-handle'id='\"+ suffix +\"-handle'>&nbsp</div></div>\")[0];\n            };\n            return control;\n        }()).addTo(this.map);\n\n        // join popup holder\n        this.$map.append(FM.Util.replaceAll(FM.guiController.popUpJoinPoint, 'REPLACE', suffix));\n     \n    },\n\n//TODO\n    initStyles: function() {\n\n        $('<h1>PALETTE<h1>').addClass('color-main-light-10').prependTo(this.$map);\n\n        function getStyle(className) {\n            var ret = {},\n                len = document.styleSheets.length-1,\n                classes = document.styleSheets[len].rules || document.styleSheets[len].cssRules;\n            \n            for (var x = 0; x < classes.length; x++) {\n                \n                console.log(classes[x].selectorText)\n\n                if (classes[x].selectorText.indexOf(className)>-1 ) {\n\n                    console.log(classes[x].selectorText)\n\n                    if(!ret[className])\n                        ret[className]=[];\n                    \n                    ret[className].push(classes[x].cssText ? classes[x].cssText : classes[x].style.cssText);\n                }\n            }\n            return ret;\n        }\n\n        this.fenixStyles = getStyle('.color-main');\n\n        console.log('FMMAP fenixStyles',fenixStyles);//*/\n    },\n    \n    createMap: function(lat, lng, zoom) {\n\n        var self = this;\n        \n        this.mapOptions.lat = lat || this.mapOptions.lat;\n        this.mapOptions.lng = lng || this.mapOptions.lng;\n        this.mapOptions.zoom = zoom || this.mapOptions.zoom;\n        this.map.setView(new L.LatLng(this.mapOptions.lat, this.mapOptions.lng), this.mapOptions.zoom);\n        \n        this.initializePlugins();\n\n        if(this.options.baselayers === null) {\n            this.options.baselayers = {\n                'OSM': FM.TILELAYER['OSM'],\n                'OSM_GRAYSCALE': FM.TILELAYER['OSM_GRAYSCALE'],\n                'ESRI_WORLDSTREETMAP': FM.TILELAYER['ESRI_WORLDSTREETMAP'],\n                'ESRI_WORLDTERRAINBASE': FM.TILELAYER['ESRI_WORLDTERRAINBASE']\n            }\n        }\n\n        for(var i in this.options.baselayers) {\n            //this.addTileLayer(FM.TileLayer.createBaseLayer('OSM', 'EN'), true);\n            var layeropts = this.options.baselayers[i];\n            // this is replicated because in wms it's used \"layers\" instead of layername\n            \n            var l = new FM.layer({\n                layername: i,\n                layertype: 'TILE',\n                layertitle: layeropts['title_'+ this.options.lang.toLowerCase()],\n                lang: this.options.lang.toUpperCase()\n            });\n            var lurl = layeropts.url;\n            delete layeropts.url;\n            l.leafletLayer = new L.TileLayer(lurl, layeropts);\n\n            this.addTileLayer(l, true);\n        }\n\n        if(this.options.url.LAYER_BOUNDARIES) {\n            this.layerBoundaries = new FM.layer({\n                layers: this.options.url.LAYER_BOUNDARIES,\n                layertitle: 'Country Boundaries',\n                urlWMS: this.options.url.DEFAULT_WMS_SERVER,\n                opacity: '0.9',\n                lang: 'en',\n                hideLayerInControllerList: true\n            });\n            //this.addLayer(this.layerBoundaries)\n        }\n\n        if(this.options.url.LAYER_LABELS) {        \n            this.layerLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {\n                attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>',\n                subdomains: 'abcd',\n                maxZoom: 19,\n                opacity: 0.8\n            });\n        }\n\n        this.highlightLayer = L.geoJson(null, {\n            style: function(feature) {\n                return self.options.style;\n            }\n        }).addTo(this.map);\n\n        if(this.options.zoomToCountry && this.options.zoomToCountry.length > 0)\n        {\n            if(typeof this.options.zoomToCountry[0] === 'string') {\n                this.zoomToCountry('iso3', this.options.zoomToCountry);\n            }\n\n            else if(typeof this.options.zoomToCountry[0] === 'number') {\n                this.zoomToCountry('adm0_code', this.options.zoomToCountry);\n            }\n        }\n\n        if(this.options.highlightCountry) {\n            this.highlightCountry('iso3_code', this.options.highlightCountry);\n        }\n\n\n        if(this.options.boundaries) {\n            this.boundariesShow();\n        }\n        \n        if(this.options.labels) {\n            this.labelsShow();  \n        }\n\n        return this;\n    },\n\n    destroyMap: function() {\n        //TODO unbind events\n        this.map.remove();\n        this.$map.empty();\n    },\n\n    /** TODO: make it nicer **/\n    setTilePaneID: function() {\n        this.tilePaneID = this.suffix + '-leaflet-tile-pane';\n        var childNodes = document.getElementById(this.id).childNodes;\n        var childNodes2 = childNodes[1].childNodes;\n        $(childNodes2[0]).attr(\"id\", this.tilePaneID);\n    },\n\n    addTileLayer: function(l, isBaseLayer) {\n        if ( isBaseLayer )\n            this.controller.addBaseLayer(l);\n        else  {\n           this.controller.layerAdded(l);\n           this.map.addLayer(l.leafletLayer);\n        }\n        this.controller.setZIndex(l);\n        return this;\n    },\n\n    /** TODO: make it nicer **/\n    addLayer:function (l) {\n        l._fenixmap = this;\n\n        if(this.options.legendOptions)\n            l.layer.legendOptions = $.extend(l.layer.legendOptions, this.options.legendOptions);\n        \n        if (l.layer.layertype ) {\n            switch(l.layer.layertype ) {\n                case 'JOIN':\n                    if (l.layer.jointype.toLocaleUpperCase() == 'SHADED')\n                        this.addShadedLayer(l);\n                    else if (l.layer.jointype.toLocaleUpperCase() == 'POINT')\n                        this.addPointLayer(l);\n                break;\n                case 'WMS': this.addLayerWMS(l); break;\n                default: this.addLayerWMS(l); break;\n            }\n        }\n        else\n           this.addLayerWMS(l);\n        return this;\n    },\n\n    removeLayer:function(l) {\n        this.controller.removeLayer(l);\n        return this;\n    },\n\n    addLayerWMS: function(l) {\n        this.controller.layerAdded(l);\n        this.map.addLayer(l.createLayerWMS());\n        this.controller.setZIndex(l);\n\n        this._openlegend(l, false);\n\n        // check layer visibility\n        this.controller.showHide(l.id, false);\n        return this;\n    },\n\n    addShadedLayer: function(l) {\n        // adding the layer to the controller\n        if ( !l.layerAdded) this.controller.layerAdded(l);\n        this.createShadeLayerRequest(l, l.isadded);\n    },\n\n    createShadeLayerRequest: function(l, isReload) {\n        // hiding the legend TODO: make a test if controller is currently used?\n        if ( !isReload ) {\n            $('#'+ l.id + '-controller-item-getlegend').css('display', 'inline-block');\n            $('#'+ l.id + '-controller-item-opacity').css('display', 'block');\n        }\n        var _this = this;\n        var url = this.options.url.MAP_SERVICE_SHADED;\n        $.ajax({\n            type: \"POST\",\n            url: url,\n            data: JSON.stringify(l.layer),\n            contentType: \"application/json; charset=utf-8\",\n            dataType: 'json',\n            success: function(response) {\n                _this._createShadeLayer(l, response, isReload);\n            }\n        });\n    },\n\n    _createShadeLayer: function(l, response, isReload){\n        if (typeof response == 'string')\n            response = $.parseJSON(response);\n        //l.layer.sldurl = response.sldurl;\n        //l.layer.urlWMS = response.geoserverwms;\n        l.layer.sldurl = response.url;\n        // TODO: check urlWMS how to set it\n        l.layer.urlWMS = this.options.url.DEFAULT_WMS_SERVER;\n        if (response.geoserverwms)\n            l.layer.urlWMS = response.geoserverwms\n\n        //l.layer.urlWMS = \"http://localhost:9090/geoserver/wms/\";\n        l.layer.legendHTML = response.legendHTML;\n        l.createLayerWMSSLD();\n\n        this._loadLayer(l, isReload)\n    },\n\n    _loadLayer:function(l, isReload) {\n        var isReload = ( isReload == null || !isReload )? false: true;\n        // TODO: if ( this.map.hasLayer(l.leafletLayer)) could be an alternative to the isReloaded check?\n        if ( !isReload ) {\n            this.map.addLayer(l.leafletLayer);\n            this.controller.setZIndex(l);\n            // this is a flag specifically for the JOIN Layers (they need to be registered as added once they are loaded )\n            l.isadded = true;\n        }\n        else l.leafletLayer.redraw();\n\n        // open legend\n        this._openlegend(l, isReload);\n\n        // check layer visibility\n        this.controller.showHide(l.id, isReload)\n    },\n\n    reAddLayer:function(l) {\n        this.map.addLayer(l.leafletLayer);\n        this.controller.setZIndex(l);\n        // check layer visibility\n        //this.controller.showHide(l.id)\n    },\n\n    _openlegend: function(l, isReload) {\n        try {\n            if (l.layer.openlegend) {\n                FM.Legend.getLegend(l, l.id + '-controller-item-getlegend', isReload);\n            }\n        }catch (e) {\n            console.war(\"_openlegend error:\" + e);\n        }\n    },\n\n    addPointLayer: function(l) {\n        // adding the layer to the controller\n        this.controller.layerAdded(l);\n        this.createPointLayerRequest(l);\n    },\n\n    createPointLayerRequest: function(l) {\n        // hiding the legend\n        $('#'+ l.id + '-controller-item-getlegend').css('display', 'none');\n        $('#'+ l.id + '-controller-item-getlegend-holder').slideUp(\"slow\");\n        $('#'+ l.id + '-controller-item-opacity').css('display', 'none');\n        var _this = this;\n        var url = this.options.url.MAP_SERVICE_SHADED;\n        var r = new RequestHandler();\n        r.open('POST', url);\n        r.setContentType('application/x-www-form-urlencoded');\n        r.request.onload= function () {\n            // TODO: make a specific function to clear the old layer\n            // cleaning the pointLayers (if they were created)\n            _this._createPointLayer(l, this.responseText );\n        };\n        r.send(FM.Util.parseLayerRequest(l.layer));\n        r.request.onerror = function () {\n            // TODO: make a specific function to clear the old layer\n            // cleaning the pointLayers (if they were created)\n            if ( l.layer.pointsLayers ) {\n                for(var i=0; i < l.layer.pointsLayers.length; i++) {\n                    this.map.removeLayer(l.layer.pointsLayers[i]);\n                }\n            }\n        };\n    },\n\n    _createPointLayer: function(l, response) {\n        if (typeof response == 'string') response = $.parseJSON(response);\n        l.layer.sldurl = response.sldurl;\n        l.layer.urlWMS = response.geoserverwms;\n        l.layer.legendHTML = response.legendHTML;\n        l.layer.pointsJSON = response.pointsJSON;\n        this._refreshPointLayer(l);\n    },\n\n    _refreshPointLayer:function (l) {\n        // cleaning the pointLayers (if they were created)\n        if ( l.layer.pointsLayers ) {\n            for(var i=0; i < l.layer.pointsLayers.length; i++) {\n                this.map.removeLayer(l.layer.pointsLayers[i]);\n            }\n        }\n        if (typeof l.layer.pointsJSON == 'string') l.layer.pointsJSON = $.parseJSON(l.layer.pointsJSON);\n\n        var _this = this;\n        l.layer.pointsLayers = [];\n        for(var i=0; i < l.layer.pointsJSON.length; i++) {\n            var latlon = new L.LatLng(l.layer.pointsJSON[i].lat, l.layer.pointsJSON[i].lon);\n            // var latlon = new L.LatLng(7.09, -67.58);\n           // var properties =  { color: 'red', fillColor: '#f03', fillOpacity: 0.4, html: '<b>Venezuela (Bolivarian Republic of)</b><br>15,364,178.947 (Head)' };\n            var properties =  l.layer.pointsJSON[i].properties;\n\n            // setting the measurement unit\n            l.layer.pointsJSON[i].properties.measurementunit = '';\n            if ( l.layer.measurementuni != null )\n                l.layer.pointsJSON[i].properties.measurementunit = l.layer.measurementunit;\n\n            if (l.layer.pointColor != null) properties.color = l.layer.pointColor;\n            if (l.layer.pointFillColor != null) properties.fillColor = l.layer.pointFillColor;\n            if (l.layer.pointFillOpacity != null) properties.fillOpacity = l.layer.pointFillOpacity;\n\n            var marker = new L.CircleMarker(latlon, properties).addTo(this.map);\n\n            marker.setRadius(l.layer.pointsJSON[i].radius);\n            marker.bindPopup(properties.title + ' - ' + properties.value );\n            marker.on('mouseover', function () {\n                $(\"#\" + _this.suffix +\"-popup-join-point-holder\").show();\n                $(\"#\" + _this.suffix +\"-popup-join-point-text\").empty();\n                $(\"#\" + _this.suffix +\"-popup-join-point-value\").empty();\n                $(\"#\" + _this.suffix +\"-popup-join-point-text\").append( this.options.title );\n                // TODO: N.B. l.layer.measurementunit is used **/\n                $(\"#\" + _this.suffix +\"-popup-join-point-value\").append(this.options.value + '  <i>' + l.layer.measurementunit + '</i>');\n            });\n            marker.on('mouseout', function () {\n                $(\"#\" + _this.suffix +\"-popup-join-point-holder\").hide();\n            });\n            l.layer.pointsLayers.push(marker);\n        }\n    },\n\n    // syncronize the maps on movement\n    syncOnMove: function (mapToSync) {\n        FM.MapUtils.syncMapsOnMove(this.map, mapToSync);\n    },\n\n    // TODO: add other parameters in the request: I.E.\n    getFeatureInfo: function(e, l) {\n\n        // var fenixMap = e.target._fenixMap;\n        var fenixMap = this;\n        // get the layer that is been passed or the one that is selected in the Controller\n        var l = (l) ? l: fenixMap.controller.selectedLayer;\n        if ( l ) {\n            if (l.layer.layertype != null && l.layer.layertype == 'JOIN') {\n                FM.SpatialQuery.getFeatureInfoJoin(l, e.layerPoint, e.latlng, fenixMap);\n            }\n            else {\n                FM.SpatialQuery.getFeatureInfoStandard(l, e.layerPoint, e.latlng, fenixMap);\n            }\n        }\n    },\n\n    invalidateSize: function() {\n      this.map.invalidateSize();\n    },\n\n    // interface plugins\n    initializePlugins: function() {\n        if ( this.options.plugins != null ) {\n            var _this = this;\n            $.each(this.options.plugins, function(key, value) {\n                var pname = key.toLowerCase(),\n                \tinvoke = '_add' + pname;\n\n                if (FM.Plugins[invoke])\n                \t_this.plugins[pname] = FM.Plugins[invoke](_this, value);\n            });\n        }\n    },\n\n    /** Fenix Map  Exporting/Importing functionalities **/\n    cloneMap: function(id) {\n        var exportedMap = this.exportMap();\n        //JSON.stringify(exportedMap.layers, null, '\\t');\n        var v = JSON.stringify(exportedMap.layers, function(key, val) {\n            if (typeof val === 'function') {\n                return val + ''; // implicitly `toString` it\n            }\n            return val;\n        });\n        var clonedMap = new FM.Map(id, exportedMap.map.options, exportedMap.map.mapOptions);\n        clonedMap.createMap();\n        clonedMap.createMapFromJSON(exportedMap);\n        return clonedMap;\n    },\n\n    createMapFromJSON:function(json) {\n        /** TODO: add baselayers handling **/\n        this.loadOverlays(json.layers.overlays);\n    },\n\n    /** functionality to export the map definition **/\n    exportMap:function() {\n       var o = {};\n       o.map   = this._getMapOptions();\n       o.layers = this._getMapLayers();\n       return o;\n    },\n\n    exportMapToJSONFile:function() {\n        var json = this.exportMap();\n        var id = FM.Util.randomID();\n        var uriContent = \"data:application/octet-stream;filename=mapview-\"+ id +\".fnx,\" + encodeURIComponent(JSON.stringify(json));\n        var _window = window.open(uriContent, \"mapview-\"+ id +\".fnx\");\n        _window.focus();\n    },\n\n    _getMapOptions:function() {\n        return {\n            options: $.extend(true, {}, this.options),\n            plugins: $.extend(true, {}, this.plugins),\n            mapOptions: $.extend(true, _getCurrentMapOptions, this.mapOptions)            \n        };\n    },\n\n    _getMapLayers:function() {\n        return {\n            overlays: this.controller.exportOverlays()\n        };\n    },\n\n    loadOverlays: function(overlays) {\n        for(var i =0; i < overlays.length; i++) {\n            this.addLayer( new FM.layer(overlays[i]) );\n        }\n    },\n\n    zoomTo: function(layer, column, codes) {\n        FM.MapUtils.zoomTo(this, layer, column, codes)\n    },\n\n    zoomToCountry: function(column, codes) {\n        FM.MapUtils.zoomToCountry(this, column, codes)\n    },\n\n    labelsShow: function() {\n        this.layerLabels.addTo(this.map).bringToFront();\n    },\n\n    labelsHide: function() {\n        this.map.removeLayer(this.layerLabels);\n    },\n\n    boundariesShow: function() {\n        this.addLayer( this.layerBoundaries );\n        //TODO .bringToFront()\n    },\n\n    boundariesHide: function() {\n        this.removeLayer( this.layerBoundaries );\n    },\n\n    highlightCountry: function(codif, codes) {\n\n        codif = codif || 'iso3_code';\n        //codif = codif || 'adm0_code';\n\n        var self = this;\n\n        var rootUrl = this.options.url.DEFAULT_WMS_SERVER+\"/ows\";\n\n        self.highlightLayer.clearLayers();\n\n        for(var c in codes) {\n\n            var cbName = _.uniqueId('getJson');\n\n            var defaultParameters = {\n                service: 'WFS',\n                version: '1.0.0',\n                request: 'GetFeature',\n                typeName: 'fenix:gaul0_bounds',\n                maxFeatures: 50,\n                outputFormat: 'text/javascript',\n                format_options: 'callback: '+cbName,\n                viewparams: codif+':'+codes[c]\n            };\n\n            var parameters = L.Util.extend(defaultParameters),\n                url = rootUrl + L.Util.getParamString(parameters);\n\n            $.ajax({\n                url: url,\n                dataType: 'jsonp',\n                jsonpCallback: cbName,\n                success: function(json) {\n                    //console.log('JSONP',url, json)\n                    self.highlightLayer.addData(json);\n                    self.highlightLayer.bringToFront();\n                }\n            });\n        }\n    }\n});\n\nFM.map = function (id, options, mapOptions) {\n    return new FM.Map(id, options, mapOptions);\n};\n\nFM.LayerUtils = {\n\n    setLayerOpacity: function(l, opacity) {\n        if (l.leafletLayer) l.leafletLayer.setOpacity(opacity)\n        l.layer.opacity = opacity;\n    },\n\n    filterLayerMinEqualThan:function(fenixMap, l, value) {\n        l = FM.LayerUtils.getValuesMinEqualThan(l, value);\n        l.redraw();\n    },\n\n    filterLayerGreaterEqualThan:function(fenixMap, l, value) {\n        l = FM.LayerUtils.getValuesGreaterEqualThan(l, value);\n        l.redraw();\n    },\n\n    filterLayerInBetweenEqualThan:function(fenixMap, l, min, max) {\n        l = FM.LayerUtils.getValuesInBetweenEqualThan(l, min, max);\n        l.redraw();\n    },\n\n    filterLayerOuterEqualThan:function(fenixMap, l, min, max) {\n        l = FM.LayerUtils.getValuesOuterEqualThan(l, min, max);\n        l.redraw();\n    },\n\n    getValuesMinEqualThan:function(l, value) {\n        if (typeof l.layer.defaultdata == 'string')\n            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n        l.layer.joindata = [];\n        for(i=0; i < l.layer.defaultdata.length; i++) {\n            $.each(l.layer.defaultdata[i], function(k, v) {\n                if ( v <= value)  {\n                    // TODO: optimize it\n                    l.layer.joindata.push(l.layer.defaultdata[i]);\n                }\n            });\n        }\n        l.layer.joindata = JSON.stringify(l.layer.joindata);\n        return l;\n    },\n    getValuesGreaterEqualThan:function(l, value) {\n        if (typeof l.layer.defaultdata == 'string')\n            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n        l.layer.joindata = [];\n        for(i=0; i < l.layer.defaultdata.length; i++) {\n            $.each(l.layer.defaultdata[i], function(k, v) {\n                if ( v >= value)  {\n                    // TODO: optimize it\n                    l.layer.joindata.push(l.layer.defaultdata[i]);\n                }\n            });\n        }\n        l.layer.joindata = JSON.stringify(l.layer.joindata);\n        return l;\n    },\n\n    getValuesInBetweenEqualThan:function(l, min, max) {\n        if (typeof l.layer.defaultdata == 'string')\n            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n        l.layer.joindata = [];\n        for(i=0; i < l.layer.defaultdata.length; i++) {\n            $.each(l.layer.defaultdata[i], function(k, v) {\n                if ( v >= min && v <= max)  {\n                    // TODO: optimize it\n                    l.layer.joindata.push(l.layer.defaultdata[i]);\n                }\n            });\n        }\n        l.layer.joindata = JSON.stringify(l.layer.joindata);\n        return l;\n    },\n\n    getValuesOuterEqualThan:function(l, min, max) {\n        if (typeof l.layer.defaultdata == 'string')\n            l.layer.defaultdata = $.parseJSON(l.layer.defaultdata);\n        l.layer.joindata = [];\n        for(i=0; i < l.layer.defaultdata.length; i++) {\n            $.each(l.layer.defaultdata[i], function(k, v) {\n                if ( (min &&  v <= min) || (max &&  v >= max)) {\n                    // TODO: optimize it\n                    l.layer.joindata.push(l.layer.defaultdata[i]);\n                }\n            });\n        }\n        l.layer.joindata = JSON.stringify(l.layer.joindata);\n        return l;\n    }\n}\n;\n\nFM.Legend = {\n\n    getLegend: function(l, id, isReload) {\n\n        var legendOptions = $.extend({\n            forceLabels: 'on',\n            forceRule: 'true',\n            dx: '0',\n            dy: '0',\n            mx: '0',\n            my: '0',\n            fontAntiAliasing: 'true',\n            fontColor: '0x47576F',\n            bgColor: '0xF9F7F3',\n            border: 'false',\n            fontSize: '10'\n        }, l.layer.legendOptions);\n\n        // based on the layer type get the legendURL or Request\n        $('#'+id+'-legend-layertitle').empty();\n        $('#'+id+'-legendtitle').empty();\n        $('#'+id+'-legendsubtitle').empty();\n        $('#'+id+'-content').empty();\n\n        if (l.layer.layertitle) {\n            $('#'+id+'-legend-layertitle').append(l.layer.layertitle);\n        }\n        if (l.layer.legendtitle) {\n            $('#'+id+'-legendtitle').append(l.layer.legendtitle);\n        }\n        if (l.layer.legendsubtitle) {\n            $('#'+id+'-legendsubtitle').append(l.layer.legendsubtitle);\n        }\n\n        /* TODO: handle better, especially the l.layer.openlegend value*/\n        var html = '';\n        if (l.layer.legendHTML) {\n            html = l.layer.legendHTML;\n            $('#'+id+'-content').append(html);\n        }\n        else {\n            var url = l.layer.urlWMS  + '?';\n            url += '&service=WMS' +\n                '&version=1.1.0' +\n                '&REQUEST=GetLegendGraphic' +\n                '&layer=' + l.layer.layers +\n                '&Format=image/png';\n                //'&LEGEND_OPTIONS=forceRule:True;dx:0.1;dy:0.1;mx:0.1;my:0.1;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3';\n            if (l.layer.style != null && l.layer.style != '' )\n                url +=  '&style=' + l.layer.style;\n            if (l.layer.sldurl )\n                 url +=  '&sld=' + l.layer.sldurl;\n\n            //LEGEND STYLE DOCS\n            //http://goo.gl/MUIt8Z\n            var alternativeUrl = url;\n\n            url += '&LEGEND_OPTIONS=';\n            for(var k in legendOptions) {\n                url += k+':'+legendOptions[k]+';'\n            }\n\n            FM.Legend._loadLegend(url, alternativeUrl, id)\n        }\n\n        if ( isReload ) {\n            if(($('#'+id+'-holder').is(\":visible\"))) {\n                $('#'+id+'-holder').hide();\n                $('#'+id+'-holder').slideDown();\n                l.layer.openlegend = true;\n            }\n            else {\n            }\n        }\n        else{\n            if(!($('#'+id+'-holder').is(\":visible\"))) {\n                $('#'+id+'-holder').slideDown();\n                l.layer.openlegend = true;\n            } else {\n                $('#'+id+'-holder').slideUp();\n                l.layer.openlegend = false;\n            }\n        }\n\n        //$('#'+id+'-holder').draggable();\n        $('#' + id+ '-remove').click({id:id + '-holder'}, function(event) {\n            $('#' + event.data.id).slideUp();\n            l.layer.openlegend = false;\n        });\n    },\n\n    _loadLegend: function(url, alternativeUrl, id) {\n        var img = new Image();\n        img.name = url;\n        img.src = url;\n\n        var html = '<img id=\"'+id + '-img\" src=\"'+ img.src +'\" class=\"decoded\">';\n        img.onload = function() {\n            $('#'+id+'-content').append(html);\n            $('#'+id+'-img').css('width', this.width);\n            $('#'+id+'-img').css('height', this.height);\n        }\n        img.onerror = function() {\n            if ( alternativeUrl )\n                FM.Legend._loadLegend(alternativeUrl, null, id)\n            else\n                FM.Legend._nolegend(id);\n            // reload the image with different parameters (without legend_options)\n            // if returns again error, then le legend is not available\n            // '&LEGEND_OPTIONS=forceRule:True;dx:0.1;dy:0.1;mx:0.1;my:0.1;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3'+\n        }\n    },\n\n    _nolegend: function(id) {\n        /** TODO: getLegendURl http://gis.stackexchange.com/questions/21912/how-to-get-wms-legendgraphics-using-geoserver-and-geowebcache **/\n        var html = '<div class=\"fm-legend-layertitle\">no legend available</div>';\n        $('#'+id+'-content').append(html);\n    }\n    \n}\n;\nFM.MapUtils = function() {\n\n    var syncMapsOnMove = function (map, mapToSync) {\n        // this let you pass the FenixMap or the LeafletMap\n        var m = ( map.map ? map.map: map);\n        var mToSync = ( mapToSync.map ? mapToSync.map: mapToSync);\n        m.on('dragend zoomend', function(e) {\n            if ( m.getCenter() != mToSync.getCenter && m.getZoom() != mToSync.getZoom) {\n                mToSync.setView(m.getCenter(), m.getZoom());\n            }\n        });\n    };\n\n    var exportLayers = function(fenixmap) {\n        //console.log(fenixmap);\n    };\n\n    var zoomTo = function(m, layer, column, codes) {\n\n        var url = m.options.url.ZOOM_TO_BBOX + layer +'/'+ column+'/'+ codes.toString();\n\n        $.ajax({\n            type: \"GET\",\n            url: url,\n            success: function(response) {\n                if (m.hasOwnProperty(\"map\"))\n                    m.map.fitBounds(response);\n                else\n                    m.fitBounds(response);\n            }\n        });\n    };\n\n    var zoomToCountry = function(m, column, codes) {\n        zoomTo(m, \"country\", column, codes);\n    };\n\n    var fitWorldByScreen = function(m, bounds) {\n    \t//http://stackoverflow.com/questions/6048975/google-maps-v3-how-to-calculate-the-zoom-level-for-a-given-bounds\n\n\t\tvar worldBounds = L.latLngBounds([[-90, -180], [90, 180]]),\n\t\t\ttargetBounds = bounds instanceof L.LatLngBounds ? bounds : worldBounds,\n\n\t\t\tGLOBE_WIDTH = 190, // a constant in Google's map projection\n\t\t\tGLOBE_HEIGHT = 190, // a constant in Google's map projection\n\n\t\t\twest = targetBounds.getSouthWest().lng,\n\t\t\teast = targetBounds.getNorthEast().lng,\n\t\t\tangleW = east - west,\n\n\t\t\tnorth = targetBounds.getNorthEast().lat,\n\t\t\tsouth = targetBounds.getSouthWest().lat,\n\t\t\tangleH = north - south,\n\n\t\t\tmapW = m.getSize().x,\n\t\t\tmapH = m.getSize().y;\n\n\t\tif (angleW < 0)\n\t\t\tangleW += 360;\n\t\tif (angleH < 0)\n\t\t\tangleH += 360;\t\t\t\n\n\t\tvar zoomW = Math.round(Math.log(mapW * 360 / angleW / GLOBE_WIDTH) / Math.LN2),\n\t\t\tzoomH = Math.round(Math.log(mapH * 360 / angleH / GLOBE_HEIGHT) / Math.LN2),\n\t\t\tzoom = Math.max(zoomW, zoomH) - 1;\n\n\t\tm.setZoom(zoom, { animate: false });\n    };\n\n    return {\n        syncMapsOnMove: syncMapsOnMove,\n        exportLayers: exportLayers,\n        zoomTo: zoomTo,\n        zoomToCountry: zoomToCountry,\n        fitWorldByScreen: fitWorldByScreen\n    }\n\n}();;\nFM.Plugins = {\n    /*\n    //geocoder\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.js\"\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.css\"\n    //geosearch\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geosearch/1.0/l.control.geosearch.js\",\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.provider.openstreetmap.js\"\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.css\"\n    //mouseposition\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.js\"\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.css\"\n    //drawcontrol\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.js\"\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.css\"\n    //controlloading\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.js\"\n    \"http://fenixrepo.fao.org/cdn/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.css\"\n    */\n    _addzoomcontrol: function(_fenixmap, show) {\n    \tif( show ) {\n\t    \tvar pos = typeof _fenixmap.options.plugins.zoomcontrol === 'string' ? \n\t\t\t\t\t\t\t_fenixmap.options.plugins.zoomcontrol : 'bottomright';\n\t        return new L.Control.Zoom({position: pos}).addTo(_fenixmap.map);\n       \t}\n    },\n\n    _addfullscreen: function(_fenixmap, show) {\n        if ( show && window.fullScreenApi && window.fullScreenApi.supportsFullScreen) {\n\t\t\treturn (function() {\n\n                //TODO second click on button exit from fullscreen\n\n\t\t\t\tvar zoompos = typeof _fenixmap.options.plugins.zoomcontrol === 'string' ? \n\t\t\t\t\t\t_fenixmap.options.plugins.zoomcontrol : 'bottomright',\n\t\t\t\t\tpos = typeof _fenixmap.options.plugins.fullscreen === 'string' ? \n\t\t\t\t\t\t_fenixmap.options.plugins.fullscreen : zoompos,\n\t\t\t\t\tcontrol = new L.Control({position: pos});\n\n\t\t\t\tcontrol.onAdd = function(map) {\n\t\t\t\t\tvar div = L.DomUtil.create('div','leaflet-control-fullscreen fm-icon-box-background'),\n\t\t\t\t\t\ta = L.DomUtil.create('a','fm-icon-sprite fm-btn-icon', div);\n\t\t\t\t\tL.DomEvent\n\t\t\t\t\t\t.disableClickPropagation(a)\n\t\t\t\t\t\t.addListener(a, 'click', function() {\n\n\t\t\t\t\t\t\tvar idDiv = _fenixmap.options.plugins.fullscreen.id || _fenixmap.id,\n                                mapdiv = document.getElementById(idDiv);\n\n                            if( window.fullScreenApi.isFullScreen(mapdiv) )\n                                window.fullScreenApi.cancelFullScreen(mapdiv);\n                            else\n                                window.fullScreenApi.requestFullScreen(mapdiv);\n\t\t\t\t\t\t}, a);\n\t\t\t\t\treturn div;\n\t\t\t\t};\n\t\t\t\treturn control;\n\t\t\t}())\n\t\t\t.addTo(_fenixmap.map);\n        }\n    },\n\n    _addzoomresetcontrol: function( _fenixmap, show) {\n    \tif( show ) {\n\t\t\treturn (function() {\n\t\t\t\tvar zoompos = typeof _fenixmap.options.plugins.zoomcontrol === 'string' ? \n\t\t\t\t\t\t_fenixmap.options.plugins.zoomcontrol : 'bottomright',\n\t\t\t\t\tpos = typeof _fenixmap.options.plugins.zoomresetcontrol === 'string' ? \n\t\t\t\t\t\t_fenixmap.options.plugins.zoomresetcontrol : zoompos,\n\t\t\t\t\tcontrol = new L.Control({position: pos}),\n\t\t\t\t\tcontainer = _fenixmap.plugins.zoomcontrol._container;\n\n\t\t\t\tcontrol.onAdd = function(map) {\n\t\t\t\t\t\tvar a = L.DomUtil.create('div','leaflet-control-zoom-reset',container);\n\t\t\t\t\t\ta.innerHTML = \"&nbsp;\";\n\t\t\t\t\t\ta.title = \"Zoom Reset\";\n\t\t\t\t\t\tL.DomEvent\n\t\t\t\t\t\t\t.disableClickPropagation(a)\n\t\t\t\t\t\t\t.addListener(a, 'click', function() {\n\t\t\t\t\t\t\t\tmap.setView(map.options.center, map.options.zoom);\n\t\t\t\t\t\t\t},a);\n\t\t\t\t\t\tvar d = L.DomUtil.create('span');\n\t\t\t\t\t\td.style.display = 'none';\n\t\t\t\t\t\treturn d;\n\t\t\t\t\t};\n\t\t\t\treturn control;\n\t\t\t}())\n\t\t\t.addTo(_fenixmap.map);\n\t\t}    \t\n    },\n\n    _adddisclaimerfao: function(_fenixmap, show) {\n        if ( show ) {\n\t\t\treturn (function() {\n\t\t\t\tvar pos = typeof _fenixmap.options.plugins.disclaimerfao === 'string' ? \n                        _fenixmap.options.plugins.disclaimerfao : 'bottomright',\n\t\t\t\t\tcontrol = new L.Control({position: pos}),\n\t\t\t\t\tlang = _fenixmap.options.lang.toLowerCase();\n\n\t\t\t\tcontrol.onAdd = function(map) {\n\t\t\t\t\t\tvar div = L.DomUtil.create('div','leaflet-control-disclaimer fm-icon-box-background'),\t\t\t\t\t\n\t\t\t\t\t\t\ta = L.DomUtil.create('a','fm-icon-sprite fm-icon-info', div);\n\n\t\t\t\t\t\ta.title = FM.guiMap['disclaimerfao_'+lang];\n\t\t\t\t\t\t\n\t\t\t\t\t\t$(a).tooltip({placement:'left'});\n\n\t\t\t\t\t\treturn div;\n\t\t\t\t\t};\n\t\t\t\treturn control;\n\t\t\t}())\n\t\t\t.addTo(_fenixmap.map);\n        }\n    },\n\n    _addlayercontroller: function(_fenixmap, show){\n        if ( show )\n            $(\"#\" + this.suffix +\"-controller\").show();\n        else\n            $(\"#\" + this.suffix +\"-controller\").hide();\n    },\n\n    _addgeosearch: function(_fenixmap, show) {\n        if ( show && L.GeoSearch) {\n            return new L.Control.GeoSearch({\n                provider: new L.GeoSearch.Provider.OpenStreetMap()\n            }).addTo(_fenixmap.map);\n        }\n    },\n\n    _addgeocoder: function(_fenixmap, show) {\n        // TODO: should be load here dinamically the requires JS\n        if ( show && L.Control.OSMGeocoder) {\n            return new L.Conpluginstrol.OSMGeocoder().addTo(_fenixmap.map);\n        }\n    },\n\n    _addmouseposition: function(_fenixmap, show) {\n        if ( show && L.control.mousePosition) {\n        \tL.control.mousePosition().addTo(_fenixmap.map);\n        }\n    },\n\n    _addexport: function(_fenixmap, show) {\n        if ( show && L.Control.Export) {\n        \t_fenixmap.map.addControl(new L.Control.Export())\n        }\n    },\n\n    _addprintmodule: function(_fenixmap, show) {\n        if ( show && L.print)\n            /** TODO: install print module **/\n            var printProvider = L.print.provider({\n                method: 'GET',\n                url: 'http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf',\n                autoLoad: true,\n                dpi: 254\n            });\n        var printControl = L.control.print({ provider: printProvider });\n        _fenixmap.map.addControl(printControl);\n    },\n\n    /**\n     *\n     *\n     * TODO: handle the layer control on layer selection to make spatial query\n     *\n     * (i.e. if a layer has certain properties add the draw control and remove it when is deselected )\n     *\n     *\n     **/\n    _adddrawcontrol: function(_fenixmap, show) {\n        if ( show && L.Control.Draw) {\n\n            var drawnItems = new L.FeatureGroup();\n            _fenixmap.map.addLayer(drawnItems);\n\n            var drawControl = new L.Control.Draw({\n                draw: {\n                    position: 'topleft',\n                    polygon: {\n                        title: 'Draw a polygon!',\n                        allowIntersection: false,\n                        drawError: {\n                            color: '#b00b00',\n                            timeout: 1000\n                        },\n                        shapeOptions: {\n                            color: '#bada55'\n                        }\n                    },\n                    circle: {\n                        shapeOptions: {\n                            color: '#662d91'\n                        }\n                    }\n                },\n                edit: {\n                    featureGroup: drawnItems\n                }\n            });\n            _fenixmap.map.addControl(drawControl);\n\n            _fenixmap.map.on('draw:created', function (e) {\n                var type = e.layerType,\n                    layer = e.layer;\n\n                if (type === 'marker') {\n\n                    layer.bindPopup('A popup!');\n                    //console.log(layer.getLatLng());\n                    //console.log(_fenixmap.map.options.crs.project(layer.getLatLng()));\n                }\n                //console.log(\"created \" + e.layerType);\n                l = layer;\n                l.layerType = type;\n                drawnItems.addLayer(layer);\n\n                _fenixmap.spatialQuery(layer)\n\n            });\n\n            _fenixmap.map.on('draw:edited', function (e) {\n                var layers = e.layers;\n                var countOfEditedLayers = 0;\n                layers.eachLayer(function(layer) {\n                    countOfEditedLayers++;\n                });\n            });\n        }\n    },\n\n    _addcontrolloading: function( _fenixmap, show) {\n        if ( show && L.Control.loading) {\n            var loadingControl = L.Control.loading({\n                separate: true,\n                position: 'topright'\n            });\n            _fenixmap.map.addControl(loadingControl)\n        }\n    },\n\n    _addscalecontrol: function( _fenixmap, show) {\n        if( show && L.Control.Scale) {\n            var pos = typeof _fenixmap.options.plugins.scalecontrol === 'string' ? \n                    _fenixmap.options.plugins.scalecontrol : 'topleft';\n            \n            L.control.scale({position: pos}).addTo(_fenixmap.map);\n        }\n    },\n\n    _addlegendcontrol: function( _fenixmap, show) {\n        if( show ) {\n            return (function() {\n                var pos = typeof _fenixmap.options.plugins.legendcontrol === 'string' ? \n                        _fenixmap.options.plugins.legendcontrol : 'topright',\n                    control = new L.Control({position: pos});\n\n                control.onAdd = function(map) {\n                    var div = L.DomUtil.create('div','leaflet-control-legend');\n                    //FILLED BY JQUERY\n                    return div;\n                };\n                return control;\n            }())\n            .addTo(_fenixmap.map);\n        }\n    }\n}\n;\nFM.SpatialQuery = {\n\n    /**\n     *\n     * Perform a GetFeautreInfo with a Joined Layer\n     *\n     * @param l\n     * @param layerPoint\n     * @param latlng\n     * @param map\n     */\n    getFeatureInfoJoin: function(l, layerPoint, latlng, fenixmap) {\n        // setting a custom popup if it's not available\n        if (l.layer.customgfi == null )\n            FMDEFAULTLAYER.joinDefaultPopUp(l.layer)\n\n        FM.SpatialQuery.getFeatureInfoStandard(l, layerPoint, latlng, fenixmap);\n    },\n\n\n    /**\n     *\n     * GetFeatureInfo standard (used to WMS GetFeatureInfoRequests)\n     *\n     * @param l\n     * @param layerPoint\n     * @param latlng\n     * @param map\n     */\n    getFeatureInfoStandard: function(l, layerPoint, latlng, fenixmap) {\n\n        // bind to leaflet map\n        var map = fenixmap.map;\n\n        // query parameters for the GFI\n        var bounds = map.getBounds();\n        var sw = map.options.crs.project(bounds.getSouthWest());\n        var ne = map.options.crs.project(bounds.getNorthEast());\n        var BBOX = (sw.x ) + ',' + (sw.y) +',' + (ne.x) + ',' + (ne.y);\n        var WIDTH = map.getSize().x;\n        var HEIGHT = map.getSize().y;\n        var X = map.layerPointToContainerPoint(layerPoint).x;\n        var Y = map.layerPointToContainerPoint(layerPoint).y;\n        // TODO: check it because in theory it shouldn't be needed\n        X = new Number(X);\n        X = X.toFixed(0) //13.3714\n        Y = new Number(Y);\n        Y = Y.toFixed(0) //13.3714\n        var url = fenixmap.options.url.MAP_SERVICE_GFI_STANDARD;\n        url += '?SERVICE=WMS';\n        url += '&VERSION=1.1.1';\n        url += '&REQUEST=GetFeatureInfo';\n        url += '&BBOX='+BBOX;\n        url += '&HEIGHT='+HEIGHT;\n        url += '&WIDTH='+WIDTH;\n        url += '&X='+X;\n        url += '&Y='+Y;\n        url += '&FORMAT=image/png';\n        url += '&INFO_FORMAT=text/html';\n\n        // get the selected layer and layer values\n        if ( l != '' && l != null ) {\n            url += '&LAYERS=' + l.layer.layers;\n            url += '&QUERY_LAYERS=' + l.layer.layers;\n            url += '&STYLES=';\n            // TODO: this should be loaded at runtime based on the projection used on the map?\n            url += '&SRS=EPSG:3857';\n            //l.layer.srs; //EPSG:3857\n            url += '&urlWMS=' + l.layer.urlWMS;\n            FM.SpatialQuery.getFeatureInfoJoinRequest(url, 'GET', latlng, map, l);\n        }\n        else {\n            // alert('no layer selected')\n        }\n    },\n\n    customPopup: function(response, custompopup, lang, joindata, layer) {\n\n        var html = '<div class=\"fm-popup\">'+\n                '{{' + layer.joincolumnlabel + '}} <br />'+\n                '<b>{{{' + layer.joincolumn + '}}} </b> '+ layer.mu +\n            '</div>';\n\n        if(custompopup.content && custompopup.content[lang])\n            html = custompopup.content[lang];\n\n        var values = this._parseHTML(html);\n        if ( values.id.length > 0 || values.joinid.length > 0) {\n            var h = $('<div></div>').append(response);\n            var responsetable = h.find('table');\n            if ( responsetable) {\n                return FM.SpatialQuery._customizePopUp(html, values, responsetable, joindata, layer );\n            }\n        }\n\n    },\n\n    // TODO: use an isOnHover flag?\n    getFeatureInfoJoinRequest: function(url, requestType, latlon, map, l) {\n        var lang = l.layer.lang != null? l.layer.lang : map.options.lang;\n        var _map = map;\n        var _l = l;\n        $.ajax({\n            type: \"GET\",\n            url: url,\n            success: function(response) {\n                // do something to response\n                if ( response != null ) {\n                    // rendering the output\n                    var maxWidth = $('#' + _map._fenixMap.id).width() - 15;\n                    var maxHeight = $('#' + _map._fenixMap.id).height() - 15;\n                    var popup = new L.Popup({maxWidth: maxWidth, maxHeight: maxHeight});\n\n                    /** TODO: do it MUCH nicer **/\n                    var r = response;\n                    if (_l.layer.customgfi) {\n                        var joindata = _l.layer.joindata != null? _l.layer.joindata : _l.layer.data;\n                        var result = FM.SpatialQuery.customPopup(response, _l.layer.customgfi, lang, joindata, l.layer);\n                        // TODO: handle multiple outputs\n                        r = (result != null) ? result[0] : response;\n                    }\n                    else {\n                        var result = FM.SpatialQuery.transposeHTMLTable(response, _l.layer.layertitle);\n                        r = (result != null) ? result[0] : response;\n                    }\n\n                    // check if the output is an empty (geoserver) output\n                    r = FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(r);\n\n                    // how to handle custom callback\n                    if (_l.layer.customgfi) {\n                        if (_l.layer.customgfi && _l.layer.customgfi.callback) ( _l.layer.customgfi.callback(r, _l.layer) )\n                        if (_l.layer.customgfi && _l.layer.customgfi.output && _l.layer.customgfi.output.show) {\n                            $('#' + _l.layer.customgfi.output.id).empty();\n                            if (r) {\n                                $('#' + _l.layer.customgfi.output.id).append(r);\n                            }\n                        }\n                        if (_l.layer.customgfi && _l.layer.customgfi.showpopup) {\n                            if (r) {\n                                popup.setLatLng(latlon).setContent(r);\n                                _map.openPopup(popup);\n                            }\n                        }\n                    }\n                    else {\n                        if (r) {\n                            popup.setLatLng(latlon).setContent(r);\n                            _map.openPopup(popup);\n                        }\n                    }\n                }\n            }\n        });\n    },\n\n    /** TODO: how to check it?  **/\n    _checkGeoserverDefaultEmptyOutput: function(response) {\n        return response;\n    },\n\n    _customizePopUp:function(content, values, responsetable, joindata, layer) {\n\n        var tableHTML = responsetable.find('tr');\n        var headersHTML = $(tableHTML[0]).find('th');\n        var rowsData = [];\n\n        // get only useful headers\n        var headersHTMLIndexs = [];\n        for ( var i=0;  i < headersHTML.length; i ++) {\n            for (var j=0; j< values.id.length; j++) {\n                if (values.id[j].toUpperCase() == headersHTML[i].innerHTML.toUpperCase()) {\n                    headersHTMLIndexs.push(i);\n                    break;\n                }\n            }\n        }\n\n        // this is in case the joinid is not empty TODO: split the code\n        if ( joindata ) {\n            var headersHTMLJOINIndexs = [];\n            for ( var i=0;  i < headersHTML.length; i ++) {\n                for (var j=0; j< values.joinid.length; j++) {\n                    if ( values.joinid[j].toUpperCase() == headersHTML[i].innerHTML.toUpperCase()) {\n                        headersHTMLJOINIndexs.push(i); break;\n                    }\n                }\n            }\n        }\n\n        // get rows data\n        for(var i=1; i<tableHTML.length; i ++) {\n            rowsData.push($(tableHTML[i]).find('td'))\n        }\n\n        // create the response results\n        var htmlresult = [];\n        for( var j=0; j < rowsData.length; j++) {\n\n            // this is done for each row of result (They could be many rows)\n            var c = content;\n\n            // Replace IDs\n            for(var i=0; i<headersHTMLIndexs.length; i ++) {\n                var header = '{{' + headersHTML[headersHTMLIndexs[i]].innerHTML + '}}';\n                var d = rowsData[j][headersHTMLIndexs[i]].innerHTML;\n                c = FM.Util.replaceAll(c, header, d);\n            }\n\n            // Replace joindata (if needed)\n            // used to add dynamically the measurementunit\n            var checkJoinData = false;\n            if ( joindata ) {\n                for(var i=0; i<headersHTMLJOINIndexs.length; i ++) {\n                    var header = '{{{' + headersHTML[headersHTMLJOINIndexs[i]].innerHTML + '}}}';\n                    var d = rowsData[j][headersHTMLJOINIndexs[i]].innerHTML;\n                    var v = FM.SpatialQuery._getJoinValueFromCode(d, joindata);\n                    v = (v !== 'NA' && layer.decimalvalues)? v.toFixed(layer.decimalvalues): v;\n                    c = FM.Util.replaceAll(c, header, v);\n                    if (v !== 'NA') {\n                        checkJoinData = true;\n                    }\n                }\n            }\n\n            // adding the row result to the outputcontent\n            htmlresult.push(c)\n        }\n\n        // \"dynamic\" measurementunit change\n        htmlresult[0] = FM.Util.replaceAll(htmlresult[0], \"{{measurementunit}}\", (checkJoinData)? layer.measurementunit: '');\n\n        return htmlresult;\n    },\n\n\n    _getJoinValueFromCode: function(code, joindata) {\n        //TODO: do it nicer: the problem on the gaul is that the code is a DOUBLE and in most cases it uses an INTEGER\n        var integerCode = ( parseInt(code) )? parseInt(code): null\n        //console.log(integerCode);\n        var json = ( typeof joindata == 'string' )? $.parseJSON(joindata) : joindata;\n        for(var i=0; i< json.length; i++) {\n            if ( json[i][code] || json[i][integerCode] ) {\n                if ( json[i][code] ) {\n                    //console.log( json[i][code]);\n                    return json[i][code];\n                }\n                else {\n                    //console.log( json[i][integerCode]);\n                    return json[i][integerCode];\n                }\n            }\n        }\n        return 'NA';\n        //return 'No data available for this point';\n    },\n\n    /**\n     *\n     * Get all {{value}}\n     * @private\n     */\n    _parseHTML: function(content) {\n        var values = {};\n        values.id = [];\n        values.joinid = [];\n\n        //console.log(content);\n        var array = content.match(/\\{\\{.*?\\}\\}/g);\n        for (var i=0; i < array.length; i++) {\n            array[i] = FM.Util.replaceAll(array[i], \"{{\", \"\");\n            array[i] = FM.Util.replaceAll(array[i], \"}}\", \"\");\n\n            // if it contains $ (this means that is a joinid\n            if ( array[i].indexOf('{') >= 0 ) {\n                array[i] = FM.Util.replaceAll(array[i], \"{\", \"\");\n                array[i] = FM.Util.replaceAll(array[i], \"}\", \"\");\n                values.joinid.push(array[i]);\n            }\n            else {\n                values.id.push(array[i]);\n            }\n        }\n        return values;\n    },\n\n    transposeHTMLTable: function(response, layertitle){\n        /** TODO: make it nicer **/\n        var h = $('<div></div>').append(response);\n        var table = h.find('table');\n        var result = [];\n        if ( table ) {\n            var r = FM.SpatialQuery.transposeHTML(table, layertitle);\n            if ( r != null ) return r;\n        }\n        return null;\n    },\n\n    transposeHTML:function(table, layertitle) {\n        var div = $('<div class=\"fm-transpose-popup\"></div>');\n        var titleHTML = table.find('caption');\n        try {\n            div.append(layertitle)\n\n            var tableHTML = table.find('tr');\n\n            var headers = $(tableHTML[0]).find('th');\n            var rowsData = [];\n            for ( var i =1;  i < tableHTML.length; i ++) {\n                rowsData.push($(tableHTML[i]).find('td'))\n            }\n\n            var t = $('<table></table>');\n            var tb = $('<tbody></tbody>');\n            for( var i =0; i < headers.length; i++) {\n                var tr = '<tr>';\n                var td = '<td>' + headers[i].innerHTML + '</td>';\n                for(var j = 0; j < rowsData.length; j++) {\n                    td += '<td>' +rowsData[j][i].innerHTML + '</td>';\n                }\n                tr += td;\n                tr += '</tr>';\n                tb.append(tr);\n            }\n            return div.append(t.append(tb));\n        } catch (e) {\n            return null;\n        }\n    },\n\n    filterLayerMinEqualThan: function(l, value) {\n        FM.LayerUtils.filterLayerMinEqualThan(this, l, value);\n    },\n\n    filterLayerGreaterEqualThan:function(l, value) {\n        FM.LayerUtils.filterLayerGreaterEqualThan(this, l, value);\n    },\n\n    filterLayerInBetweenEqualThan:function(l, min, max) {\n        FM.LayerUtils.filterLayerInBetweenEqualThan(this, l, min, max);\n    },\n\n    filterLayerOuterEqualThan:function(l, min, max) {\n        FM.LayerUtils.filterLayerOuterEqualThan(this, l, min, max);\n    }\n\n}\n;\nFM.LayerSwipe = {\n\n    swipeActivate: function(l, handleID, containerID, map) {\n        l.layer.swipeActive = true;\n        var l_parent = l.leafletLayer._container,\n           // handle = document.getElementById(fenixMap.suffix +  '-handle'),\n            handle = document.getElementById(handleID),\n            dragging = false;\n/*        console.log('L_parent');\n        console.log(l_parent);*/\n        handle.onmousedown = function() { dragging = true; return false;}\n        document.onmouseup = function() { dragging = false; }\n        document.onmousemove = function(e) {\n            if (!dragging) return;\n            setDivide(e.x);\n        }\n\n        var _this = this;\n\n        l.redraw = function( e ) {\n            l_parent = l.leafletLayer._container;\n            setDivide(parseInt(handle.style.left));\n        };\n\n        l.mousemoveSwipe = function( e ) {\n            l_parent = l.leafletLayer._container;\n            setDivide(e.containerPoint.x);\n        };\n\n        map.on( \"zoomend\", l.redraw);\n        map.on( \"moveend\", l.redraw);\n        map.on( \"drag\", l.redraw);\n        map.on( \"mousemove\", l.mousemoveSwipe );\n\n        function setDivide(x) {\n            x = Math.max(0, Math.min(x, map.getSize()['x']));\n            handle.style.left = (x) + 'px';\n            var layerX = map.containerPointToLayerPoint(x,0).x\n            l_parent.style.clip = 'rect(-99999px ' + layerX + 'px 999999px -99999px)';\n        }\n\n        // set 50% of the width, maybe start with 0?\n       // var mydiv =  $('#' + fenixMap.suffix + '-map').width();\n        var mydiv =  $('#' + containerID).width();\n       // console.log(mydiv);\n        setDivide(mydiv / 2);\n    },\n\n    swipeDeactivate: function(l, map) {\n        map.off( \"zoomend\", l.redraw);\n        map.off( \"moveend\", l.redraw);\n        map.off( \"drag\", l.redraw);\n        map.off( \"mousemove\", l.mousemoveSwipe );\n        l.layer.swipeActive = false;\n\n        var l_parent = l.leafletLayer._container;\n        l_parent.style.clip = 'auto';\n    }\n\n}\n;\n\nFM.MAPController = FM.Class.extend({\n\n    id: '',\n\n    suffix: '',\n\n    _map: '',\n\n    _fenixMap: '',\n\n    _guiController:  {\n        container: null,\n        overlay : true,\n        baselayer: true,\n        layersthumbs: true\n    },\n\n    /** Used by the controller **/\n    baseLayersMap:    '',    // should be an hashmap (id, layer)\n    currentBaseLayer: '', // this is the layer that is currently the baselayer\n\n    layersMap: '',  // HashMap(l.id, l)\n\n    layersMapZIndexes: '', // HashMap(l.zindex, l.id)\n\n    zIndexBaseLayer: 10, // TODO: modify it automatically on every update/adding of the layer checking the higher\n\n    zIndex: 100, // TODO: modify it automatically on every update/adding of the layer checking the higher\n\n    // used for the GFI\n    selectedLayer: '',\n\n    // GUI\n    // left controller\n    $boxIcons: '',\n    $boxMenu: '',\n    $boxMenuContainer: '',\n    $boxMenuSelected: '', // i.e. SelectedLayers, BaseLayers WMS Layers\n\n    getFeautureInfoLayer: [],\n    // TODO: this is the list of the layers selected for the GFI\n\n    initialize: function(suffix, fenixMap, map, guiOpts) { // (HTMLElement or String, Object)\n        this._map = map;\n        this._fenixMap = fenixMap;\n        this.suffix = suffix;\n        this.id = suffix + '-controller';\n        this._guiController = $.extend({}, this._guiController, guiOpts);\n\n        // initialize HashMaps\n        this.baseLayersMap = new HashMap();\n        this.layersMap = new HashMap();\n        this.layersMapZIndexes = new HashMap();\n    },\n\n    /**\n     *\n     * initialize the Layer Controller GUI\n     *\n     */\n    initializeGUI:function() {\n\n        var self = this;\n\n        if ( self._guiController &&\n                (self._guiController.overlay ||\n                 self._guiController.baselayer ||\n                 self._guiController.wmsLoader)\n            ) {\n\n            var mapDiv$ = $('#' + self.id);\n\n            self.$boxMenu = $(FM.Util.replaceAll(FM.guiController.boxMenu, 'REPLACE', self.suffix));\n\n            self.$boxMenuContainer = self.$boxMenu.find('#' + self.suffix + '-controller-box-content');\n            \n            self.$boxIcons = $(FM.Util.replaceAll(FM.guiController.boxIcons, 'REPLACE', self.suffix));\n\n            self.visibleBoxMenu;\n\n            if( self._guiController.container ) {\n\n                var $div = $('<div class=\"fm-controller-external\">')\n                    .append(self.$boxIcons, self.$boxMenu);\n\n                $div.prependTo(self._guiController.container);\n\n                self.visibleBoxMenu = true;\n            }\n            else\n            {\n                self.visibleBoxMenu = false;\n\n                var guiControl = (function() {\n                    var control = new L.Control({position: 'bottomleft'});\n\n                    control.onAdd = function(map) {\n\n                        var $div = $('<div class=\"leaflet-control-controller\">')\n                            .append(self.$boxIcons, self.$boxMenu);\n\n                        if (!L.Browser.touch) {\n                            L.DomEvent.disableClickPropagation($div[0]);\n                            L.DomEvent.on($div[0], 'mousewheel', L.DomEvent.stopPropagation);\n                        }\n                        else\n                            L.DomEvent.on($div[0], 'click', L.DomEvent.stopPropagation);\n\n                        return $div[0];\n                    };\n                    return control;\n                }()).addTo(self._map);\n            }\n\n            /** TODO: make it nicer and more dynamic, with a more consistent name **/\n            if ( self._guiController.overlay) {\n                self.loadIcon('overlay', self.visibleBoxMenu);\n                self.initializeOverlayDragging();\n            }\n            if ( self._guiController.baselayer) {\n                self.loadIcon('baselayer', self.visibleBoxMenu);\n            }\n\n            if ( self._guiController.wmsLoader) {\n                self.loadIcon('wmsLoader', self.visibleBoxMenu);\n                var wmsUtils = new FM.WMSUtils(),\n                    idDD = this.suffix + '-controller-wmsLoader-dropdown',\n                    idContent = this.suffix + '-controller-wmsLoader-content',\n                    wmsServers = FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;\n                    \n                wmsUtils.WMSCapabilities(idDD, idContent, this._fenixMap, wmsServers);\n            }\n        }\n    },\n\n    /**\n     *\n     * Inizialize an Icon to load\n     *\n     * @param toLoad\n     */\n    loadIcon: function(toLoad, visibleBox) {\n        var guiBox = toLoad + 'Box';\n        var guiIcon = toLoad + 'Icon';\n\n        visibleBox = typeof visibleBox !== 'undefined' ? visibleBox : false;\n\n        this.$boxMenuContainer.append(\n            FM.Util.replaceAll(FM.guiController[guiBox], 'REPLACE', this.suffix)\n        );\n\n        if(visibleBox===false) {\n            this.$boxMenu.hide();\n            //this.$boxMenuContainer.find('.fm-box-zindex').hide();\n        }else {\n            this.$boxMenu.show();\n            this.$boxMenuContainer.find('.fm-box-zindex').show();\n        }\n        \n        var $boxIcon = $(FM.Util.replaceAll(FM.guiController[guiIcon], 'REPLACE', this.suffix));\n\n        $boxIcon.appendTo(this.$boxIcons);\n\n        if(visibleBox===true)\n            this.$boxIcons.hide();\n\n        \n\n        var _this = this,\n            $id =  $('#' + _this.suffix + '-controller-' + toLoad + '-box');\n\n        $('#' + this.suffix + '-controller-' + toLoad + 'Icon')\n        .on('click', {\n                $id: $id,\n                suffix: this.suffix\n            }, function(e) {\n                \n                var $id = e.data.$id;\n\n                if (_this.$boxMenu.is(':visible'))\n                {\n                    if ( _this.$boxMenuSelected == $id ) {\n                        _this.$boxMenu.slideUp()\n                        $id.hide();\n                        _this.$boxMenuSelected = '';\n                    }\n                    else {\n                        $id.slideDown();\n                        _this.$boxMenuSelected = $id;\n                    }\n                }\n                else {\n                    _this.$boxMenuSelected = $id;\n                    _this.$boxMenu.slideDown();\n                }\n        });\n\n        // close panel\n        $('#' + this.suffix + '-controller-' + toLoad + '-remove')\n        .on('click', {\n            $id: $id,\n            suffix: this.suffix\n        }, function(e) {\n            var $id = e.data.$id,\n                suffix =  e.data.suffix;\n\n            $('#' + suffix + '-controller-box').slideUp();\n            $id.hide();\n        });//*/\n    },\n\n    /**\n     * Initialize the Drag and Drop of the Overlays\n     */\n    initializeOverlayDragging: function() {\n        var _this = this;\n\n//TODO replace with https://github.com/RubaXa/Sortable\n\n/*        $('#'+ this.suffix + '-controller-overlay-content').sortable({\n            cursor: 'move',\n            opacity:'0.5',\n            stop: function (event, ui) {\n                // getting layers order\n                var children = $(ui.item).parent().children();\n                var layerIDs = [];\n                var zIndexBase = 0;\n                for(var i=children.length-1; i >= 0; i-- ) {\n                    var id = $(children[i]).data(\"layer\").id;\n                    var layertitle = $(children[i]).data(\"layer\").layer.layertitle;\n                    var zIndex =  zIndexBase + 100\n                    layerIDs.push($(children[i]).data(\"layer\").id)\n                    _this.updateZIndex(id, zIndex);\n                    zIndexBase++;\n                }\n                // setting the z-indexes based on the layers order list\n                // N.B. they are set from the bottom to the top\n            }\n        });*/\n    },\n\n    /**\n     *\n     * Add a Layer Overlay to the Layer Controller\n     *\n     * @param l\n     */\n    layerAdded: function(l) {\n\n        var self = this;\n\n        l.layerAdded = true;\n        /** TODO: check if works always this solution **/\n        if ( !l.layer.zindex ) {\n            l.layer.zindex = self.zIndex;\n            l.leafletLayer.setZIndex = l.layer.zindex;\n        }\n        self.zIndex = self.zIndex + 2;\n\n        if ( !l.layer.hideLayerInControllerList ) {\n            // add legend to the mapDIV\n            var $legend = $(FM.Util.replaceAll(FM.guiController.legend, 'REPLACE', l.id)),\n                div = $legend[0];\n           \n            if (!L.Browser.touch) {\n                L.DomEvent.disableClickPropagation(div);\n                L.DomEvent.on(div, 'mousewheel', L.DomEvent.stopPropagation);\n            }\n            else\n                L.DomEvent.on(div, 'click', L.DomEvent.stopPropagation);\n\n            self._fenixMap.$map.find('.leaflet-control-legend').append($legend);\n            \n\n            // creating the HTML controller-overlay-item structure\n            var idStructure =  '#'+ self.suffix + '-controller-overlay-content';\n            var idItem = '#'+ l.id + '-controller-item';\n            var idControllerItem = l.id + '-controller-item';\n            var overlayStructure = FM.Util.replaceAll(FM.guiController.overlay, 'REPLACE', l.id);\n\n            // TODO: a way to get the layer back by the ID\n\n            $(idStructure).prepend(overlayStructure);\n\n            // saving the layer information (it's too many information TODO: please set only ID and needed infos\n            $( '#'+ l.id  + '-controller-item-box' ).data( \"layer\", l );\n\n            var index = $('#'+l.id+'-controller-item-box').index() + 1;\n\n            // setting up the layer GUI options\n            self._layerGUIOptions(l);\n\n            // setting the layer to the HashMap to handle the ID and ZIndex\n            self.layersMap.set(l.id, l);\n            self.layersMapZIndexes.set(l.layer.zindex, l.id)\n\n            $(idItem+'-title').append(l.layer.layertitle);\n\n            // Enable/Disable layer\n            $(idItem+ '-enabledisable')\n                .on('click', {id:l.id}, function(event) {\n                    self.showHide(event.data.id)\n                });\n\n            // Layer Opacity\n            var opacity = 1;\n            if ( l.layer.opacity != null )\n                opacity = l.layer.opacity;\n\n            $(idItem+ '-opacity').ionRangeSlider({\n                min: 0.1, max: 1, step: 0.1,\n                hide_min_max: true, hide_from_to: true,\n                from: opacity,\n                onChange: function (o) {\n                    //item.layer.setOpacity(o.from);\n                    FM.LayerUtils.setLayerOpacity(l, o.from);\n                }\n            });\n/*                .slider({\n                    orientation: \"horizontal\",\n                    range: \"min\",\n                    min: 0, max: 1, step: 0.1,\n                    value: opacity,\n                    slide: function( event, ui ) {\n                        FM.LayerUtils.setLayerOpacity(l, ui.value);\n                    }\n                });\n*/\n            // Layer GetFeatureInfo\n            var $layergfi = $(idItem+ '-getfeatureinfo');\n\n            if ( !l.layer.enablegfi ) {\n                $(idItem+ '-getfeatureinfo').css(\"display\",\"none\");\n            }\n            else\n            {\n                $layergfi.on('click', {id:l.id}, function(event) {\n                    var l = self.layersMap.get(event.data.id);\n                    if ( self.selectedLayer.id == event.data.id) {\n                        // the layer select is equal to the new one, so deselect it\n                        $('#' + self.selectedLayer.id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n                        self.selectedLayer = '';\n                        l.layer.defaultgfi = false;\n                    }\n                    else {\n                        // unselect old layer icon\n                        $('#' + self.selectedLayer.id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n                        // select new layer icon\n                        $('#' + event.data.id + '-controller-item-getfeatureinfo').addClass('fm-icon-getfeatureinfo-selected');\n                        self.selectedLayer = l;\n                        l.layer.defaultgfi = true;\n                    }\n                });\n\n                if ( l.layer.defaultgfi ) {\n                    // TODO: set default gfi style on the layer\n                    self.selectedLayer = l;\n                    $('#' + self.selectedLayer.id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n                    // select new layer icon\n                    $('#' + l.id + '-controller-item-getfeatureinfo').addClass('fm-icon-getfeatureinfo-selected');\n                }\n            }\n\n\n\n            // Show/Hide Legend\n            var $getlegend = $(idItem+ '-getlegend');\n            if (l.layer.showlegend == null || l.layer.showlegend != false) {\n                $getlegend.on('click', {id:l.id, idToRender: idControllerItem + '-getlegend'}, function(event) {\n                    var l = self.layersMap.get( event.data.id);\n                    FM.Legend.getLegend(l, event.data.idToRender)\n                });\n            }\n            \n            $getlegend.css(\"display\",\"inline-block\");\n\n            // Switch JoinType (From shaded to Point Layer)\n            if (l.layer.layertype ) {\n                if (l.layer.layertype == 'JOIN' ) {\n                    if (l.layer.switchjointype == null || l.layer.switchjointype ) {\n                        $(idItem+ '-switchjointype').css(\"display\",\"inline-block\")\n                        .on('click', {id:l.id}, function(event) {\n                            self.switchJoinType(event.data.id);\n                        })\n                    }\n                }\n            }\n\n            // Enable/Disable Swipe\n            var $swipelayer = $(idItem+ '-swipe');\n            $swipelayer.on('click', {id:l.id}, function(event) {\n                var l = self.layersMap.get( event.data.id);\n                if (l.layer.swipeActive == null || !l.layer.swipeActive) {\n                    FM.LayerSwipe.swipeActivate(l, self._fenixMap.suffix + '-handle', self._fenixMap.suffix + '-map', self._map);\n                    // select icon\n                    $swipelayer.addClass('fm-icon-swipe-selected')\n                }\n                else {\n                    FM.LayerSwipe.swipeDeactivate(l, self._map);\n                    // deselect icon\n                    $swipelayer.removeClass('fm-icon-swipe-selected')\n                }\n            });\n\n            // ZoomToLayer or BBOX\n            var $zoomtolayer = $(idItem+ '-zoomtolayer');\n            if ( l.layer.zoomToBBOX ) {\n                $zoomtolayer.css(\"display\",\"inline-block\");\n                $zoomtolayer.on('click', {id:l.id}, function(event) {\n                    var l = self.layersMap.get( event.data.id);\n                    FM.LayerUtils.zoomToLayer(self._map, l.layer)\n                });\n            }\n            if (l.layer.zoomTo ) {\n                $zoomtolayer.css(\"display\",\"inline-block\");\n                $zoomtolayer.on('click', {id:l.id}, function(event) {\n                    var l = self.layersMap.get( event.data.id);\n                    FM.LayerUtils.zoomToLayer(self._map, l.layer)\n                });\n            }\n\n            // Show/Hide SubIcons\n            var $subiconsshowhide  = $(idItem+ '-showhide-subicons');\n            var $subiconscontainer = $(idItem+ '-subicons');\n            \n            $subiconsshowhide\n                .on('click', function(event) {\n\n                    $subiconscontainer.slideToggle('fast');\n\n                    if ( $subiconsshowhide.hasClass(\"fm-icon-up\")) {\n                        $subiconsshowhide.removeClass(\"fm-icon-up\")\n                        $subiconsshowhide.addClass(\"fm-icon-down\")\n                    }\n                    else {\n                        $subiconsshowhide.removeClass(\"fm-icon-down\")\n                        $subiconsshowhide.addClass(\"fm-icon-up\")\n                    }\n                });\n        }\n    },\n\n    _layerGUIOptions:function(l) {\n        var gui = l.gui;\n        // at Gaul Level 1 remove the point layer option\n        if (l.layer.layertype == 'JOIN') {\n            if ( l.layer.gui !=null )\n                if (l.layer.gui.nojoinlayerswitch != null && l.layer.gui.nojoinlayerswitch) {\n                    // TODO: hide pointlayer option\n                    // hiding the legend\n                    $('#'+ l.id + '-controller-item-switchjointype').css('display', 'none');\n                }\n        }\n    },\n\n    /**\n     *\n     * Add a Base Layer to the Layer Controller\n     *\n     * @param l\n     */\n    addBaseLayer: function(l) {\n\n        var self = this;\n\n        // setting the zIndex and updating it\n        //console.log(this.zIndexBaseLayer);\n        l.layer.zindex = this.zIndexBaseLayer;\n        this.zIndexBaseLayer = this.zIndexBaseLayer + 2;\n\n        // setting the layer to the HashMap to handle the ID and ZIndex\n        this.baseLayersMap.set(l.id, l);\n        this.layersMapZIndexes.set(l.layer.zindex, l.id);\n\n        // creating the HTML controller-overlay-item structure\n        var idStructure =  '#'+ this.suffix + '-controller-baselayer-content',\n            idItem = '#'+ l.id + '-controller-item',\n            overlayStructure = FM.Util.replaceAll(FM.guiController.baselayer, 'REPLACE', l.id);\n\n        overlayStructure = FM.Util.replaceAll(overlayStructure, 'MAPID', this._fenixMap.id);\n\n        $(idStructure).append(overlayStructure);\n\n        // listeners\n        $(idItem + '-title').append(l.layer.layertitle);\n\n        if(self._guiController.layersthumbs)\n            $('#' + l.id + '-controller-item-baselayer-image').addClass(\"fm-icon-baselayer-\" + l.layer.layername);\n        else\n            $('#' + l.id + '-controller-item-baselayer-image').remove();\n\n        $(idItem+ '-enabledisable').on('click', {id:l.id}, function(e) {\n            self.showHide(e.data.id)\n        });\n\n        var opacity = 1;\n        if ( l.layer.opacity != null )\n            opacity = l.layer.opacity;\n        /*try {\n            $(idItem+ '-opacity').slider({\n                orientation: \"horizontal\",\n                range: \"min\",\n                min: 0,\n                max: 1,\n                step: 0.1,\n                value: opacity,\n                slide: function(e, ui) {\n                    FM.LayerUtils.setLayerOpacity(l, ui.value);\n                }\n            });\n        }catch(e) { }//*/\n\n        $('#' + l.id + '-controller-box-item')\n        .on('click', {\n            id:l.id\n        }, function(e) {\n            var id = e.data.id;\n            var l = self.baseLayersMap.get(id);\n\n            // removing the old baselayer\n            self.removeBaseLayerByID(self.currentBaseLayer.id);\n            var oldBaseLayer = self.baseLayersMap.get(self.currentBaseLayer.id);\n            $('#' + oldBaseLayer.id + \"-controller-box-item\").removeClass('fm-controller-box-item-baselayer-content-selected')\n            $('#' + oldBaseLayer.id + \"-controller-item-opacity\").hide();\n\n            // add the new baselayer to the map and setting as default one\n            $('#' + l.id + \"-controller-box-item\").addClass('fm-controller-box-item-baselayer-content-selected')\n            $('#' + l.id + \"-controller-item-opacity\").show();\n            self._map.addLayer(l.leafletLayer);\n            self.currentBaseLayer = l;\n            self.setZIndex(l)\n\n        });\n\n        // select baselayer item\n        if ( this.baseLayersMap.count() == 1 ){\n            $(idItem + '-radio').attr('checked', true);\n            // add the layer just if it's the first one\n            this._map.addLayer(l.leafletLayer);\n            this.currentBaseLayer = l;\n            $('#' + l.id + \"-controller-box-item\").addClass('fm-controller-box-item-baselayer-content-selected')\n            $('#' + l.id + \"-controller-item-opacity\").show();\n            self.setZIndex(l)\n        }\n\n    },\n\n    /*\n     * Remove a layer from the Map and from the HashMap\n     *\n     * @param l\n     */\n    removeLayer:function(l) {\n        if ( l.layer.jointype !=null && l.layer.jointype == 'point')\n            this.removeLayerPoint(l);\n        else\n            this.removeLayerDefault(l);\n    },\n\n\n    removeLayerDefault:function(l) {\n        // remove layer from the map\n        this._map.removeLayer(l.leafletLayer);\n        // remove layer from the hashmaps\n        this.layersMap.remove(l.id);\n        this.layersMapZIndexes.remove(l.layer.zindex);\n        $('#' + l.id + '-controller-item-box').remove();\n        $('#' + l.id + '-controller-item-getlegend-holder').remove();\n    },\n\n    /*\n     * Remove the layer Point from the Map and from the HashMap\n     *\n     * @param id\n     */\n    removeLayerPoint: function(l) {\n        for(var i=0; i < l.layer.pointsLayers.length; i++)\n            this._map.removeLayer(l.layer.pointsLayers[i]);\n\n        this.layersMap.remove(l.id);\n        this.layersMapZIndexes.remove(l.layer.zindex);\n        $('#' + id + '-controller-item-box').remove();\n    },\n\n    /*\n     * Remove the layer from the Map and from the HashMap\n     *\n     * @param id\n     */\n    removeBaseLayerByID: function(id) {\n        var l = this.baseLayersMap.get(id);\n        // remove layer from the map\n        this._map.removeLayer(l.leafletLayer);\n    },\n\n    /*\n     * Switch a jointype (from Point to Shaded and from Shaded to Point)\n     *\n     * @param id\n     */\n    switchJoinType: function(id) {\n        var l = this.layersMap.get(id);\n\n        if (  l.layer.jointype.toLowerCase() == 'point') {\n            // alert('point')\n            this.switchToShaded(id);\n        }\n        else if ( l.layer.jointype.toLowerCase() == 'shaded') {\n            // alert('shaded')\n            this.switchToPoint(id);\n        }\n    },\n\n    /*\n     * Switch a Shaded joined layer to a Point one\n     *\n     * TODO: da vedere\n     *\n     * @param id\n     */\n    switchToPointswitchToPoint: function(id) {\n        var l = this.layersMap.get(id);\n        l.layer.jointype = 'point';\n\n        if ( l.leafletLayer != null )\n            this._map.removeLayer(l.leafletLayer);\n\n        this._fenixMap.createPointLayerRequest(l);\n    },\n\n    /*\n     * Switch a Point joined layer to a Shaded one\n     *\n     * TODO: da vedere\n     *\n     * @param id\n     */\n    switchToShaded: function(id) {\n        var l = this.layersMap.get(id);\n        l.layer.jointype = 'shaded';\n\n        // cleaning the pointLayers\n        if ( l.layer.pointsLayers != null ) {\n            for(var i=0; i < l.layer.pointsLayers.length; i++) {\n                this._map.removeLayer(l.layer.pointsLayers[i]);\n            }\n        }\n        this._fenixMap.createShadeLayerRequest(l);\n    },\n\n    /**\n     *  Show/Hide the layer from the map\n     *\n     * @param id\n     */\n    showHide: function(id, isReload) {\n        try {\n            var l = this.layersMap.get(id);\n            if (l) {\n                if (l.layer.jointype && l.layer.jointype.toLowerCase() == 'point')\n                    this.showHidePointLayer(id);\n                else\n                    this.showHideLayer(id, isReload);\n            }\n        }catch (e) {\n           // console.warn(\"showHide warn:\" + e);\n        }\n    },\n\n    /***\n     *\n     * Show/Hide a Point Layer\n     *\n     * @param id\n     */\n    showHidePointLayer: function(id) {\n        var l = this.layersMap.get(id);\n        for(var i=0; i < l.layer.pointsLayers.length; i++) {\n            if (l.layer.visibility == null || l.layer.visibility) {\n                l.layer.visibility = false;\n                $('#'+ id+ '-controller-item-enabledisable').removeClass('fm-icon-enable');\n                $('#'+ id+ '-controller-item-enabledisable').addClass('fm-icon-disable');\n                for(var i=0; i < l.layer.pointsLayers.length; i++)\n                    this._map.removeLayer(l.layer.pointsLayers[i]);\n            }\n            else {\n                l.layer.visibility = true;\n                $('#'+ id+ '-controller-item-enabledisable').removeClass('fm-icon-disable');\n                $('#'+ id+ '-controller-item-enabledisable').addClass('fm-icon-enable');\n                for(var i=0; i < l.layer.pointsLayers.length; i++)\n                    this._map.addLayer(l.layer.pointsLayers[i]);\n            }\n        }\n    },\n\n    /**\n     * Show/Hide the layer  removing it and readding ti to leaflet for performance issues\n     *\n     * @param id\n     */\n    showHideLayer:function(id, isReload) {\n        try {\n            var l = this.layersMap.get(id);\n            if (isReload != null && !isReload) {\n                if (l.layer.visibility == false) {\n                    $('#' + id + '-controller-item-enabledisable').removeClass('fm-icon-enable');\n                    $('#' + id + '-controller-item-enabledisable').addClass('fm-icon-disable');\n                    this._map.removeLayer(l.leafletLayer)\n                }\n            }\n            else if (isReload != null && isReload) {\n                // do nothing (this will maintain the old status\n            }\n            else {\n                if (l.layer.visibility == null || l.layer.visibility) {\n                    l.layer.visibility = false;\n                    ;\n                    $('#' + id + '-controller-item-enabledisable').removeClass('fm-icon-enable');\n                    $('#' + id + '-controller-item-enabledisable').addClass('fm-icon-disable');\n                    //document.getElementById(id).style.display = 'none';\n                    this._map.removeLayer(l.leafletLayer)\n                }\n                else {\n                    l.layer.visibility = true;\n                    $('#' + id + '-controller-item-enabledisable').removeClass('fm-icon-disable');\n                    $('#' + id + '-controller-item-enabledisable').addClass('fm-icon-enable');\n                    //document.getElementById(id).style.display = 'block';\n                    this._map.addLayer(l.leafletLayer);\n                    this.setZIndex(l) // this method assigns the Z-Index and the ID to the layer\n                }\n            }\n        }catch (e) {\n           // console.warn(\"showHideLayer error:\"  + e);\n        }\n    },\n\n    /**\n     * Update the Z-Index of a layer retrieving it by ID\n     *\n     * @param layerID\n     * @param updatedZIndex\n     */\n    updateZIndex: function(layerID, updatedZIndex) {\n        var l = this.layersMap.get(layerID);\n        l.layer.zindex = updatedZIndex;\n        l.leafletLayer.setZindex = updatedZIndex;\n        try {\n            document.getElementById(l.id).style.zIndex=updatedZIndex;\n        }catch (e) {\n           // console.log('error updateZIndex: ' + l.id + ' doesnt exists');\n        }\n\n    },\n\n    /**\n     * This method search for the new layer added (a new layer or a layer that was hidden\n     * and set the index and the id of the layer that is missing the ID/Z-Index\n     *\n     * @param l\n     */\n    setZIndex: function (l) {\n        try {\n            var layers = document.getElementById(this._fenixMap.tilePaneID).childNodes;\n            for (i = 0, len = layers.length; i < len; i++) {\n                if (layers[i] !== this._container) {\n                    var zIndex = parseInt(layers[i].style.zIndex, 10);\n                    if ( isNaN(zIndex))  {\n                        layers[i].style.zIndex = l.layer.zindex;\n                        layers[i].id = l.id;\n                    }\n                }\n            }\n        } catch (e) {\n           // console.warn(\"setZIndex error:\"  + e);\n        }\n    },\n\n    selectGetFeatureInfoIcon:function (id) {\n        for(var i=0; i < this.layersMap.count(); i++) {\n            if ( this.layersMap._data[i] == id )\n                $('#' + id + '-controller-item-getfeatureinfo').addClass('fm-icon-getfeatureinfo-selected');\n            else\n                $('#' + id + '-controller-item-getfeatureinfo').removeClass('fm-icon-getfeatureinfo-selected');\n        }\n\n    },\n\n    exportOverlays:function() {\n        //console.log('exportOverlays');\n\n        /* TODO: make it simpler **/\n        var arrayZindex = [];\n        this.layersMap.forEach(function(l) {\n            arrayZindex.push(l.layer.zindex)\n        });\n        arrayZindex = arrayZindex.sort()\n\n        //console.log(arrayZindex);\n\n        /** get the id based on the zIndex **/\n        var arrayLayers = [];\n        for (var i = 0; i < arrayZindex.length; i++ ) {\n            var found = false;\n            if ( !found)\n                this.layersMap.forEach(function(l) {\n                    //console.log(e);\n                    if (l.layer.zindex == arrayZindex[i]) {\n                        arrayLayers.push(l.layer);\n                        found = true;\n                    }\n                });\n        }\n        var clonedArray = $.map(arrayLayers, function (obj) {\n            return $.extend(true, {}, obj);\n        });\n        return clonedArray;\n    },\n\n    exportBaselayers:function() {\n        /* TODO: make it easier the load of the baselayers\n        *  add a value to set the current selected one (also on startup)\n        * **/\n\n        return null;\n    }\n\n});\n\nFM.mapController = function (suffix, fenixMap, map, guiController) {\n    return new FM.MAPController(suffix, fenixMap, map, guiController);\n};;\nFM.guiController = {\n\n    boxIcons: '<div id=\"REPLACE-controller-box-icons-container\" class=\"fm-icon-box-background fm-controller-box-icons-container\"></div>',\n\n    boxMenu: '<div class=\"fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box\" id=\"REPLACE-controller-box\">' +\n                '<div id=\"REPLACE-controller-box-content\" class=\"clearfix\"></div>' +\n            '</div>',\n\n    baselayerIcon:\n    '<div class=\"fm-box-zindex fx-toolbar-map-holder \">'+\n        '<div class=\"fm-icon-sprite fm-baselayers\" id=\"REPLACE-controller-baselayerIcon\"><div>'+\n    '</div>',\n\n    baselayerBox:\n    '<div class=\"fm-box-zindex fx-toolbar-map-holder \" id=\"REPLACE-controller-baselayer-box\">' +\n        '<div id=\"REPLACE-controller-baselayer-title\" class=\"fm-controller-box-title\">Baselayers</div>' +\n        '<div id=\"REPLACE-controller-baselayer-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n        '<div class=\"fm-standard-hr\"></div>' +\n        '<div id=\"REPLACE-controller-baselayer-content\" class=\"fm-controller-box-content\"></div>' +\n    '</div>',\n\n    baselayer:\n    '<div id=\"REPLACE-controller-box-item\" class=\"fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item-baselayer-content\">' +\n    '<div id=\"REPLACE-controller-item\">' +\n        '<div class=\"fm-controller-box-item-baselayer-image\" id=\"REPLACE-controller-item-baselayer-image\"></div>' +\n        '<div class=\"fm-controller-box-item-baselayer-text\">' +\n            '<div>' +\n                '<label class=\"fm-controller-box-item-baselayer-text fm-controller-item-title\" id=\"REPLACE-controller-item-title\">'+\n                    '<input id=\"REPLACE-controller-item-radio\"  class=\"fm-checkbox-hide\" type=\"radio\" name=\"MAPID\" value=\"REPLACE\">'+\n                '<label>' +\n            '</div>' +\n            '<div style=\"clear:both\"></div>' +\n            '<div class=\"fm-opacity-slider-baselayers\" id=\"REPLACE-controller-item-opacity\" style=\"display:none\"></div>' +\n        '</div>' +\n    '</div>' +\n    '</div>',\n\n    overlayIcon:\n    \"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>\",\n\n    overlayBox:\n    '<div class=\"fm-box-zindex fx-toolbar-map-holder \" id=\"REPLACE-controller-overlay-box\">' +\n        '<div id=\"REPLACE-controller-overlay-title\" class=\"fm-controller-box-title\">Selected Layers</div>' +\n        '<div id=\"REPLACE-controller-overlay-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n        '<div class=\"fm-standard-hr\"></div>' +\n        '<div id=\"REPLACE-controller-overlay-content\" class=\"fm-controller-box-content\"></div>'+\n    '</div>',\n\n    overlay:\n    '<div id=\"REPLACE-controller-item-box\" class=\"fm-box-zindex fx-toolbar-map-holder  fm-controller-box-item\">' +\n        '<div id=\"REPLACE-controller-item\" class=\"fm-controller-box-header\">' +\n            '<div class=\"fm-controller-box-header-text\">' +\n                '<div class=\"fm-controller-item-title\" id=\"REPLACE-controller-item-title\" ></div>' +\n                '<div class=\"fm-icon-right fm-icon-layer-panel-sprite fm-icon-down\" id=\"REPLACE-controller-item-showhide-subicons\"></div>' +\n            '</div>' +\n            '<div style=\"clear:both\"></div>' +\n            '<div class=\"fm-controller-box-icons\">' +\n                '<div class=\"fm-icon-enable\" id=\"REPLACE-controller-item-enabledisable\"></div>' +\n                '<div class=\"fm-opacity-slider\" style=\"margin-right:10px;\" id=\"REPLACE-controller-item-opacity\"></div>' +\n            '</div>' +\n            '<div style=\"clear:both\"></div>' +\n            '<div class=\"fm-controller-box-subicons\" id=\"REPLACE-controller-item-subicons\" style=\"display:none;\">' +\n                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-getlegend\" id=\"REPLACE-controller-item-getlegend\"></div>' +\n                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo\" id=\"REPLACE-controller-item-getfeatureinfo\"></div>' +\n                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-switchJoinType\" id=\"REPLACE-controller-item-switchjointype\" style=\"display:none\"></div>' +\n                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-zoomto\" id=\"REPLACE-controller-item-zoomtolayer\" style=\"display:none\"></div>' +\n                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-swipe\" id=\"REPLACE-controller-item-swipe\"></div>' +\n                '<div class=\"fm-icon-layer-subicons-sprite fm-icon-switchJoinType\" id=\"REPLACE-controller-item-joinsettings\" style=\"display:none\"></div>' +\n            '</div>' +\n            /*    '</div>' +\n            '</div>' +*/\n        '</div>' +\n    '</div>',\n\n    wmsLoaderIcon:\n    \"<div class='fm-box-zindex fx-toolbar-map-holder '><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>\",\n    \n    wmsLoaderBox:\n    '<div class=\"fm-box-zindex fx-toolbar-map-holder \" id=\"REPLACE-controller-wmsLoader-box\" style=\"display:none; min-height:300px;\">' +\n        '<div id=\"REPLACE-controller-wmsLoader-title\" class=\"fm-controller-box-title\">WMS Loader</div>' +\n        '<div id=\"REPLACE-controller-wmsLoader-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n        '<div class=\"fm-standard-hr\"></div>' +\n        '<div class=\"clear:both\"></div>' +\n        '<div class=\"fm-WMSLoaderDropDown\" id=\"REPLACE-controller-wmsLoader-dropdown\"></div>' +\n        '<div id=\"REPLACE-controller-wmsLoader-content\" class=\"fm-controller-wmsLoader-content\"></div>' +\n     '</div>',\n\n    wmsLoaderLayer: '<div id=\"REPLACE-WMSLayer-box\" class=\"fm-WMSLayer-box\">' +\n                        '<div id=\"REPLACE-WMSLayer-icon\" class=\"fm-controller-box-icon fm-icon-info\"></div>' +\n                        '<div id=\"REPLACE-WMSLayer-title\" class=\"fm-WMSLayer-title\"></div>' +\n                    '</div>',\n\n    legend: '<div class=\"fm-icon-box-background fm-box-legend\" id=\"REPLACE-controller-item-getlegend-holder\">' +\n            '<div class=\"fm-legend-title-content\">' +\n                '<div id=\"REPLACE-controller-item-getlegend-legend-layertitle\" class=\"fm-legend-layertitle\"></div>' +\n                '<div id=\"REPLACE-controller-item-getlegend-remove\" class=\"fm-icon-close-panel-sprite fm-icon-close fm-icon-right\"></div>' +\n            '</div>' +\n            '<div class=\"fm-standard-hr\"></div>' +\n\n            '<div id=\"REPLACE-controller-item-getlegend-legendtitle\" class=\"fm-legendtitle\"></div>' +\n            '<div id=\"REPLACE-controller-item-getlegend-legendsubtitle\" class=\"fm-legendsubtitle\"></div>' +\n                '<div id=\"REPLACE-controller-item-getlegend-content\" ></div>' +\n            '</div>',\n\n    popUpJoinPoint: '<div class=\"fm-box fm-popup-join-point-holder\" id=\"REPLACE-popup-join-point-holder\" style=\"display:none\">' +\n                        '<div class=\"fm-popup-join-point-text\" id=\"REPLACE-popup-join-point-text\"></div>'+\n                        '<div class=\"fm-popup-join-point-value\" id=\"REPLACE-popup-join-point-value\"></div>'+\n                    '</div>'\n};;\nFM.guiMap = {\n    disclaimerfao_en:\n            'The designations employed and the presentation of material in the maps ' +\n            'do not imply the expression of any opinion whatsoever on the part of ' +\n            'FAO concerning the legal or constitutional status of any country,' +\n            'territory or sea area, or concerning the delimitation of frontiers. ' +\n            'South Sudan declared its independence on July 9, 2011.' +\n            'Due to data availability, the assessment presented in the map for Sudan ' +\n            'and South Sudan reflects thesituation up to 2011 for the former Sudan.',\n    disclaimerfao_es: '',\n    disclaimerfao_es_styled: '<div class=\"fm-disclaimerfao-text\"></div>',\n    disclaimerfao_fr: '',\n    disclaimerfao_fr_styled: '<div class=\"fm-disclaimerfao-text\"></div>'\n};\n;\n\nFM.Layer = FM.Class.extend({\n\n    _fenixmap: '',\n\n    id : '',\n\n    //layer: '',\n\n    layer: {\n        // WMS default parameters\n        styles:'', // could be better 'styles' to be passed directory to the WMS parameters\n        srs : 'EPSG:3857',\n        visibility: true, //enabled/disabled layer and also to the wms request\n        format: \"image/png\", // [\"image/png\", \"image/gif\"]\n        transparent: 'TRUE', //[TRUE, FALSE]\n        opacity: 1,\n        // Other Options\n        name: '',\n        tiitle: '',\n        abstract: '',\n        srs: '',\n        LatLonBoundingBox: '',\n        BoundingBox: '',\n        Style: {\n            name: '',\n            title: '',\n            abstract: '',\n            legendurl: {\n                format: '',\n                onlineresource: '' //differenct xml attributes (how to store it?\n            }\n        },\n        KeywordList: [],\n\n        layertitle: '',\n        enablegfi: true,\n        layertype: 'WMS', //['WMS', 'JOIN', 'TILE']\n        openlegend: false,\n        legendOptions: {\n            forceLabels: 'on',\n            forceRule: 'true',\n            dx: '0',\n            dy: '0',\n            mx: '0',\n            my: '0',\n            fontAntiAliasing: 'true',\n            fontColor: '0x47576F',\n            bgColor: '0xF9F7F3',\n            border: 'false',            \n            fontSize: '15'            \n        },\n        // JOIN default options\n        switchjointype: false,\n\n        // language\n        lang: 'EN' //ISO2\n\n    },\n\n    leafletLayer: '',\n\n    initialize: function(layer, options) { // (HTMLElement or String, Object)\n        this.layer = $.extend(true, {}, this.layer, layer);\n\n        if (options)\n            this.options = options;\n\n        this.id = FM.Util.randomID();\n\n        if (layer.joindata)\n            layer.defaultdata = layer.joindata;\n    },\n\n    createLayerWMS: function() {\n\n        var wmsParameters = this._getWMSParameters();\n\n        if ( this.leafletLayer ) {\n            if(this.layertype === 'WMS')\n                this.leafletLayer.setParams(wmsParameters);\n        }\n        else {\n            wmsParameters = (this.options)? $.extend(true, {}, this.options, wmsParameters): wmsParameters;\n            if(this.layer.urlWMS)\n                this.leafletLayer = new L.TileLayer.WMS( this.layer.urlWMS, wmsParameters );\n        }\n        return this.leafletLayer;\n    },\n\n    createLayerWMSSLD: function() {\n        var wmsParameters = this._getWMSParameters();\n        if ( this.leafletLayer ) {\n            this.leafletLayer.setParams(wmsParameters);\n        }\n        else {\n            if(this.layer.urlWMS)\n                this.leafletLayer = new L.TileLayer.WMS( this.layer.urlWMS, wmsParameters );\n        }\n        return this.leafletLayer;\n    },\n\n    /** TODO: make also the other parameters dynamic **/\n    _getWMSParameters:function() {\n        var options = {};\n\n        options.id = this.id;\n\n        // can be used layers (default WMS parameter or layername)\n        options.layers = ( this.layer.name )?  this.layer.name: this.layer.layers;\n        options.format= this.layer.format;\n        options.transparent = this.layer.transparent.toUpperCase();\n        options.visibility = this.layer.visibility;\n        options.opacity = this.layer.opacity;\n\n        /** TODO: handle additional parameters that are not default ones **/\n        /** i.e. http://nyc.freemap.in/cgi-bin/mapserv?MAP=/www/freemap.in/nyc/map/basemap.map **/\n\n        // check whether styles or style is set (styles is the default URL parameter)\n        options.styles=this.layer.styles;\n        if ( this.layer.style ) options.styles = this.layer.style;\n        if ( this.layer.sldurl ) options.sld = this.layer.sldurl;\n        if ( this.layer.cql_filter ) options.cql_filter = this.layer.cql_filter;\n        if ( this.layer.sld_body ) options.sld_body = this.layer.sld_body;\n        this.layer.layers = ( this.layer.layername )?  this.layer.layername: this.layer.layers;\n\n        return options;\n    },\n\n    // this is just to use with the WMS Layers // check layer type\n    redraw: function(fenixmap) {\n        var l = this;\n        if (l.layer.layertype ) {\n            switch(l.layer.layertype ) {\n                case 'JOIN':\n                    if (l.layer.jointype.toLocaleUpperCase() == 'SHADED') {\n                        if ( fenixmap ) fenixmap.addLayer(this);\n                        else if ( this._fenixmap ) this._fenixmap.addLayer(this);\n                    }\n                    else if (l.layer.jointype.toLocaleUpperCase() == 'POINT')\n                        console.log('TODO: handle redraw point');\n                    break;\n                case 'WMS':\n                    this.createLayerWMS();\n                    this.leafletLayer.redraw();\n                    break;\n                default:\n                    this.createLayerWMS();\n                    this.leafletLayer.redraw();\n                    break;\n            }\n        }\n    },\n\n    /** shortcut **/\n    addPointLayer: function(fenixmap) {\n        if ( fenixmap )\n            fenixmap.addPointLayer(this);\n        else if ( this._fenixmap)\n            this._fenixmap.addPointLayer(this);\n    },\n\n    addLayerWMS: function(fenixmap) {\n        if ( fenixmap )\n            fenixmap.addLayerWMS(this);\n        else if ( this._fenixmap)\n            this._fenixmap.addLayerWMS(this);\n    },\n\n    addLayer: function(fenixmap) {\n        if ( fenixmap )\n            fenixmap.addLayer(this);\n        else if ( this._fenixmap)\n            this._fenixmap.addLayer(this);\n    },\n    \n    /** TOODO: remove layer also from the layers list **/\n    removeLayer: function(fenixmap) {\n        /** TODO: remove it from the list **/\n        if ( fenixmap )\n            fenixmap.removeLayer(this);\n        else if ( this._fenixmap)\n            this._fenixmap.removeLayer(this);\n    },\n\n    addShadedLayer: function(fenixmap) {\n        if ( fenixmap )\n            fenixmap.addShadedLayer(this);\n        else if ( this._fenixmap)\n            this._fenixmap.addShadedLayer(this);\n    }\n\n});\n\nFM.layer = function (layer, map, options) {\n    return new FM.Layer(layer, map, options);\n};\n\n\n;\n\nFM.TileLayer = FM.Layer.extend({\n\n  createTileLayer: function() {\n    var info = this.layer.layername ? FM.TILELAYER[this.layer.layername] : FM.TILELAYER[this.layer.layers];\n\n    this.layer.layertype = 'TILE';\n    this.layer.layertitle = info[ 'title_' + this.layer.lang.toLowerCase() ];\n    var leafletLayer = new L.TileLayer( info.url );\n    return leafletLayer;\n  }\n\n});\n\nFM.TileLayer.createBaseLayer = function (layername, lang) {\n    var layer = {};\n    // this is replicated because in wms it's used \"layers\" instead of layername\n    layer.layername = layername;\n    layer.layers = layername;\n    layer.layertype = 'TILE';\n    layer.lang = lang;\n    var l = new FM.TileLayer(layer);\n    l.leafletLayer = l.createTileLayer(layer.layername);\n    return l;\n};\n return FM;\n\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/js/fenix-ui-map.src.js\n// module id = 2\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_3__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jquery\"\n// module id = 3\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_4__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"underscore\"\n// module id = 4\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_5__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"leaflet\"\n// module id = 5\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_6__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"hashmap\"\n// module id = 6\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_7__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bootstrap\"\n// module id = 7\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_8__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"ion-rangeslider\"\n// module id = 8\n// module chunks = 0","/*global define*/\ndefine([\n        \"./en/labels\",\n        \"./fr/labels\"\n    ],\n    function (i18nEn, i18nFr) {\n\n        'use strict';\n\n        return {\n\n            en: i18nEn,\n            fr: i18nFr\n        }\n    });\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/nls/labels.js\n// module id = 9\n// module chunks = 0","define({\n    \"movelayerup\": \"Move layer up\",\n    \"movelayerdown\": \"Move layer down\",\n    \"removelayer\": \"Remove Layer\",\n    \"enabledisablelayer\": \"Enable/Disable layer\",\n    \"showhidelegend\": \"Show/Hide legend\",\n    \"getfeatureinfo\": \"Inspect layer\",\n    \"layeropacity\": \"Modify layer opacity\",\n    \"switchtopoint\": \"Switch to Point layer\",\n    \"switchtoshaded\": \"Switch to Shaded layer\",\n    \"confirmremovelayer\": \"Are you sure you want to remove the layer?\",\n    \"dragdroplayer\": \"Drag and Drop the layer<br>to sort the layer's list\",\n    \"baselayer\": \"Control BaseLayers\",\n    \"overlay\": \"Control Overlays\",\n    \"wmsLoader\": \"Control External WMS Servers\",\n    \"fullscreen\": \"Fullscreen\",\n    \"layersubicons\": \"Click to open the layer's menu\",\n    \"selectaWMSServer\": \"Select a WMS Server\",\n    \"addaWMSServer\": \"Add a WMS Server\",\n    \"nolegendavailable\": \"The legend is not available\"\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/nls/en/labels.js\n// module id = 10\n// module chunks = 0","define({\n    \"movelayerup\": \"Monter la couche de donnes\",\n    \"movelayerdown\": \"Baisser la couche de donnes\",\n    \"removelayer\": \"Effacer la couche de donnes\",\n    \"enabledisablelayer\": \"Activer/Dsactiver la couche de donnes\",\n    \"showhidelegend\": \"Montrer/Cacher la legende\",\n    \"getfeatureinfo\": \"Inspecter la couche de donnes\",\n    \"layeropacity\": \"Modifier l'opacit de la couche\",\n    \"switchtopoint\": \"Mode couche de points\",\n    \"switchtoshaded\": \"Mode relief\",\n    \"confirmremovelayer\": \"Etes vous sur de vouloir ffacer cette couche?\",\n    \"dragdroplayer\": \"Glissez et dposez la couche<br>pour trier la liste de couches\",\n    \"baselayer\": \"Controle des couches de bases\",\n    \"overlay\": \"Controle des autres couches \",\n    \"wmsLoader\": \"Controle des serveurs  WMS externes\",\n    \"fullscreen\": \"Plein ecran\",\n    \"layersubicons\": \"Cliquez pour ouvrir le menu des couches\",\n    \"selectaWMSServer\": \"Selectionnez un serveur WMS\",\n    \"addaWMSServer\": \"Ajoutez un serveur WMS\",\n    \"nolegendavailable\": \"Legende non disponible\"\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/nls/fr/labels.js\n// module id = 11\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_12__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"loglevel\"\n// module id = 12\n// module chunks = 0","define(function () {\n\n    'use strict';\n\n    return {\n\n        MISSING_CONTAINER: 'missing_container'\n\n    };\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/config/errors.js\n// module id = 13\n// module chunks = 0","define(function () {\n\n    'use strict';\n\n    return {\n\n        WINDOW_RESIZE: 'fs.window.resize.event'\n\n    };\n});\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/config/events.js\n// module id = 14\n// module chunks = 0","define(function () {\n\n    'use strict';\n\n    return {\n        WMS_URL: \"http://fenix.fao.org/demo/fenix/geoserver\",\n        DEFAULT_WMS_SERVER: \"http://fenix.fao.org/demo/fenix/geoserver\",\n        url: {\n            wms: \"http://fenix.fao.org/demo/fenix/geoserver\"\n        },        \n        fenix_ui_map: {\n            plugins: {\n                disclaimerfao: true,\n                geosearch: true,\n                mouseposition: false,\n                controlloading : true,\n                zoomcontrol: 'bottomright'\n            },\n            guiController: {\n                overlay: false,\n                baselayer: true,\n                wmsLoader: false\n            },\n            gui: {\n                disclaimerfao: true\n            }\n        },\n        leaflet: {\n            zoomControl: false,\n            attributionControl: false,\n            minZoom: 1\n        },\n        layers: {\n            gaul0: {\n                layers: 'fenix:gaul0_3857',\n                urlWMS: 'http://fenix.fao.org/demo/fenix/geoserver',\n                opacity: '0.9',\n                joincolumn: 'adm0_code',\n                joincolumnlabel: 'areanamee',\n                layertype: 'JOIN',\n                jointype: 'shaded',\n                openlegend: true,\n                defaultgfi: true,\n                colorramp: 'YlGn',\n                lang: 'en'\n            }\n        },\n        geoSubject: 'geo',\n        colorRamp: 'Reds',  //Blues, Greens,\n        //colorRamp values: http://fenixrepo.fao.org/cdn/fenix/fenix-ui-map-datasets/colorramp.png        \n\n        valueSubject: 'value',\n        // measurement unit\n        muSubject: null,\n\n        // Mapping with the\n        join: {\n            style: {\n                layertype: 'JOIN',\n                jointype: 'shaded',\n                defaultgfi: true,\n                openlegend: true,\n                lang: 'EN',\n                opacity: '0.7',\n                colorramp: 'Greens',\n                decimalvalues: 2\n            },\n            layerMapping: {\n                escap_area: {\n                    layers: 'fenix:gaul0_3857',\n                    joincolumn: 'adm0_code',\n                    joincolumnlabel: 'adm0_name'\n                },\n                gaul0: {\n                    layers: 'fenix:gaul0_3857',\n                    joincolumn: 'adm0_code',\n                    joincolumnlabel: 'adm0_name'\n                },\n                gaul1: {\n                    layers: 'fenix:gaul1_3857',\n                    joincolumn: 'adm1_code',\n                    joincolumnlabel: 'adm1_name'\n                },\n                uae_gaul: {\n                    layers: 'fenix:gaul1_3857',\n                    joincolumn: 'adm1_code',\n                    joincolumnlabel: 'adm1_name'\n                },\n\n                gaul_adm1: {\n                    layers: 'fenix:gaul1_3857',\n                    joincolumn: 'adm1_code',\n                    joincolumnlabel: 'adm1_name'\n                },\n\n                faostat_countrycodes: {\n                    layers: 'fenix:gaul0_faostat_3857',\n                    joincolumn: 'faost_code',\n                    joincolumnlabel: 'areanamee',\n                },\n                faostat_countries: {\n                    layers: 'fenix:gaul0_faostat_3857',\n                    joincolumn: 'faost_code',\n                    joincolumnlabel: 'areanamee',\n                },\n                gaul: {\n                    layers: 'fenix:gaul1_3857',\n                    joincolumn: 'adm1_code',\n                    joincolumnlabel: 'adm1_name'\n                },\n                uneca_partner: {\n                    layers: 'fenix:gaul0_faostat3_3857',\n                    joincolumn: 'iso3',\n                    joincolumnlabel: 'areanamee'\n                },\n                gaul1_afg: {\n                    layers: 'fenix:gaul1_3857',\n                    joincolumn: 'adm1_code',\n                    joincolumnlabel: 'adm1_name'\n                },\n                iso3: {\n                    layers: 'fenix:gaul0_faostat3_3857',\n                    joincolumn: 'iso3',\n                    joincolumnlabel: 'areanamee'\n                },\n                uneca_iso3: {\n                    layers: 'fenix:gaul0_faostat3_3857',\n                    joincolumn: 'iso3',\n                    joincolumnlabel: 'areanamee'\n                }\n            }\n        }\n        // TODO: add boundaries option\n    };\n});\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/config/config.js\n// module id = 15\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_16__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fenix-ui-pivotator\"\n// module id = 16\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_17__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fenix-ui-pivotator-utils\"\n// module id = 17\n// module chunks = 0","module.exports = __WEBPACK_EXTERNAL_MODULE_18__;\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"amplify-pubsub\"\n// module id = 18\n// module chunks = 0"],"sourceRoot":""}