/* 
 * fenix-ui-map v0.0.1 - 2015-04-16 
 * Copyright 2015  
 * FENIX Development Team 
 * 
 * Licensed under the GPL3 license. 
 * 
 * Source: 
 * https://github.com/FENIX-Platform/fenix-ui-map.git 
 */
var FM,originalFM;if(!window.console)var console={};console.log||(console.log=function(){}),console.warn||(console.warn=function(){}),console.error||(console.error=function(){}),console.info||(console.info=function(){}),typeof exports!=void 0+""?FM=exports:(originalL=window.FM,FM={},FM.noConflict=function(){return window.FM=originalFM,this},window.FM=FM),FM.version="0.0.1",FM.author="Simone Murzilli - simone.murzilli@gmail.com; simone.murzilli@fao.org",FM.Class=function(){},FM.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},c=function(){};c.prototype=this.prototype;var d=new c;d.constructor=b,b.prototype=d;for(var e in this)this.hasOwnProperty(e)&&"prototype"!==e&&(b[e]=this[e]);a.statics&&(FM.extend(b,a.statics),delete a.statics),a.includes&&(FM.Util.extend.apply(null,[d].concat(a.includes)),delete a.includes),a.options&&d.options&&(a.options=FM.extend({},d.options,a.options)),FM.extend(d,a),d._initHooks=[];var f=this;return d.callInitHooks=function(){if(!this._initHooksCalled){f.prototype.callInitHooks&&f.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var a=0,b=d._initHooks.length;b>a;a++)d._initHooks[a].call(this)}},b},FM.Class.include=function(a){FM.extend(this.prototype,a)},FM.Class.mergeOptions=function(a){FM.extend(this.prototype.options,a)},FM.Class.addInitHook=function(a){var b=Array.prototype.slice.call(arguments,1),c="function"==typeof a?a:function(){this[a].apply(this,b)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(c)},FM.Util={initializeLangProperties:function(a){var b="";switch(a){case"FR":b="fr";break;case"ES":b="es";break;default:b="en"}var c=FMCONFIG.BASEURL_LANG;$.i18n.properties({name:"I18N",path:c,mode:"both",language:b})},extend:function(a){var b,c,d,e,f=Array.prototype.slice.call(arguments,1);for(c=0,d=f.length;d>c;c++){e=f[c]||{};for(b in e)e.hasOwnProperty(b)&&(a[b]=e[b])}return a},bind:function(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return a.apply(b,c||arguments)}},stamp:function(){var a=0,b="_leaflet_id";return function(c){return c[b]=c[b]||++a,c[b]}}(),limitExecByInterval:function(a,b,c){var d,e;return function f(){var g=arguments;return d?void(e=!0):(d=!0,setTimeout(function(){d=!1,e&&(f.apply(c,g),e=!1)},b),void a.apply(c,g))}},falseFn:function(){return!1},formatNum:function(a,b){var c=Math.pow(10,b||5);return Math.round(a*c)/c},splitWords:function(a){return a.replace(/^\s+|\s+$/g,"").split(/\s+/)},setOptions:function(a,b){return a.options=L.extend({},a.options,b),a.options},getParamString:function(a,b){var c=[];for(var d in a)a.hasOwnProperty(d)&&c.push(d+"="+a[d]);return(b&&-1!==b.indexOf("?")?"&":"?")+c.join("&")},template:function(a,b){return a.replace(/\{ *([\w_]+) *\}/g,function(a,c){var d=b[c];if(!b.hasOwnProperty(c))throw new Error("No value provided for variable "+a);return d})},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function getPrefixed(a){var b,c,d=["webkit","moz","o","ms"];for(b=0;b<d.length&&!c;b++)c=window[d[b]+a];return c}function timeoutDefer(a){var b=+new Date,c=Math.max(0,16-(b-lastTime));return lastTime=b+c,window.setTimeout(a,c)}var lastTime=0,requestFn=window.requestAnimationFrame||getPrefixed("RequestAnimationFrame")||timeoutDefer,cancelFn=window.cancelAnimationFrame||getPrefixed("CancelAnimationFrame")||getPrefixed("CancelRequestAnimationFrame")||function(a){window.clearTimeout(a)};FM.Util.requestAnimFrame=function(a,b,c,d){return a=L.bind(a,b),c&&requestFn===timeoutDefer?void a():requestFn.call(window,a,d)},FM.Util.cancelAnimFrame=function(a){a&&cancelFn.call(window,a)},FM.Util.replaceAll=function(a,b,c){return a.replace(new RegExp(b,"g"),c)},FM.Util.parseLayerRequest=function(layer){var layerValues=eval(layer),layerRequest="";return $.each(layerValues,function(a,b){layerRequest+="&"+a+"="+b}),layerRequest},FM.Util.randomID=function(){var a=Math.random().toString(36).substring(7);return(a+Date.now()).toLocaleLowerCase()},FM.Util.fire=function(a,b,c){var d=document.createEvent("CustomEvent");d.initCustomEvent(b,!0,!0,c),a.dispatchEvent(d)},FM.Util.on=function(a,b,c,d){a.addEventListener(b,d,!1)}}(),FM.extend=FM.Util.extend,FM.bind=FM.Util.bind,FM.stamp=FM.Util.stamp,FM.setOptions=FM.Util.setOptions,FM.replaceAll=FM.Util.replaceAll,FM.loadModuleLibs=FM.Util.loadModuleLibs,FM.initializeLangProperties=FM.Util.initializeLangProperties,function(a){function b(){this.clear()}function c(a,b){Object.defineProperty&&Object.defineProperty(a,b,{enumerable:!1})}b.prototype={constructor:b,get:function(a){var b=this._data[this.hash(a)];return b&&b[1]},set:function(a,b){this._data[this.hash(a)]=[a,b]},has:function(a){return this.hash(a)in this._data},remove:function(a){delete this._data[this.hash(a)]},type:function(a){var b=Object.prototype.toString.call(a),c=b.slice(8,-1).toLowerCase();return"domwindow"!==c||a?c:a+""},count:function(){var a=0;for(var b in this._data)a++;return a},clear:function(){this._data={}},hash:function(a){switch(this.type(a)){case"undefined":case"null":case"boolean":case"number":case"regexp":return a+"";case"date":return":"+a.getTime();case"string":return'"'+a;case"array":for(var d=[],e=0;e<a.length;e++)d[e]=this.hash(a[e]);return"["+d.join("|");case"object":default:return a._hmuid_||(a._hmuid_=++b.uid,c(a,"_hmuid_")),"{"+a._hmuid_}},forEach:function(a){for(var b in this._data){var c=this._data[b];a(c[1],c[0])}}},b.uid=0,a.HashMap=b}(this.exports||this),FM.UIUtils={fullscreen:function(a,b){var c=document.getElementById(b);window.fullScreenApi.supportsFullScreen&&$("#"+a).on("click",function(){window.fullScreenApi.requestFullScreen(c)})},loadingPanel:function(a,b){var c="25px";document.getElementById(a).innerHTML=b?"<div class='fm-loadingPanel' style='height:"+c+"'></div>":"<div class='fm-loadingPanel'></div>"}},$.fn.swapWith=function(a){return this.each(function(){var b=$(a).clone(),c=$(this).clone();$(a).replaceWith(c),$(this).replaceWith(b)})},FM.WMSUtils=FM.Class.extend({_divID:"",_dropdowndID:"",_outputID:"",_fenixMap:"",_wmsServers:"",_mapID:"",_lang:"EN",WMSCapabilities:function(a,b,c,d,e){this._divID=a,this._dropdowndID=a+"-dropdown",this._outputID=b,this._fenixmap=c,this._wmsServers=d,e&&(this._lang=e),this._createWMSDropDown(this._wmsServers,this._divID,this._dropdowndID,this._outputID,c)},_createWMSDropDown:function(a,b,c,d,e){var f='<select id="'+c+'" style="width:200px;" data-placeholder="'+$.i18n.prop("_selectaWMSServer")+'" class="">';f+='<option value=""></option>';for(var g=0;g<a.length;g++)f+='<option value="'+a[g].url+'">'+a[g].label+"</option>";f+="</select>",$("#"+b).empty(),$("#"+b).append(f);try{$("#"+c).chosen({disable_search_threshold:6,width:"100%"})}catch(h){}var i=this;$("#"+c).change({},function(){i._createWMSOutputRequest(d,e,$(this).val())})},_createWMSOutputRequest:function(a,b,c){$("#"+a).empty(),FM.UIUtils.loadingPanel(a,"30px");var d=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;d+=d.indexOf("?")>0?"&":"?",d+="SERVICE=WMS",d+="&VERSION=1.1.1",d+="&request=GetCapabilities",d+="&urlWMS="+c;var e=this;$.ajax({type:"GET",url:d,success:function(d){var f=$.parseXML(d);e._createWMSOutput(a,b,f,c)}})},_createWMSOutput:function(a,b,c,d){$("#"+a).empty(),$(c).find("Layer").each(function(){if($(this).children("Name").text()&&""!=$(this).children("Name").text()){var c={};c.layers=$(this).children("Name").text(),c.layername=$(this).children("Name").text(),c.layertitle=$(this).children("Title").text(),c.layertitle=c.layertitle.replace(/_/g," "),c.layertitle=c.layertitle.replace(/3857/g," "),c.styles=$(this).children("Style").children("Name").text(),c.urlWMS=d,c.srs=b.map.options.crs.code,c.openlegend=!0;var e=FM.Util.randomID(),f=FM.replaceAll(FM.guiController.wmsLoaderLayer,"REPLACE",e);$("#"+a).append(f),$("#"+e+"-WMSLayer-title").append(c.layertitle),$("#"+e+"-WMSLayer-title").attr("title",c.layertitle);try{$("#"+e+"-WMSLayer-title").powerTip({placement:"n"})}catch(g){}$("#"+e+"-WMSLayer-box").click({fenixmap:b,layer:c},function(a){a.data.layer.openlegend=!1;var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayer(b);var c="The Layer <b>"+a.data.layer.layertitle+"</b><br> has been added to the map";try{FMPopUp.init({parentID:a.data.fenixmap.id,content:c})}catch(d){}});var h=b,i=$.extend(!0,{},c),j=new FM.layer(i);try{$("#"+e+"-WMSLayer-box").hoverIntent({over:function(){h.addLayer(j)},out:function(){h.removeLayer(j)},timeout:500})}catch(g){}}})},addWMSServer:function(){},_WMSCapabilities:function(a,b,c){var d=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;d+=d.indexOf("?")>0?"&":"?",d+="SERVICE=WMS",d+="&VERSION=1.1.1",d+="&request=GetCapabilities",d+="&urlWMS="+c;var e=this;$.ajax({type:"GET",url:d,success:function(d){var f=$.parseXML(d);e._createWMSDropwDown(a,b,f,c)}})},_createWMSDropwDown:function(a,b,c,d){FM.Util.randomID();$(c).find("Layer").each(function(){var c=FM.Util.randomID();if($(this).children("Name").text()){var e={};e.layers=$(this).children("Name").text(),e.layername=$(this).children("Name").text(),e.layertitle=$(this).children("Title").text(),e.styles=$(this).children("Style").children("Name").text(),e.urlWMS=d,e.openlegend=!0,$("#"+a).append("<div id='WMSLayer-"+c+"'>ddd"+e.layertitle+" + "+e.styles+" <div>"),e.srs=b.map.options.crs.code,$("#WMSLayer-"+c).click({fenixmap:b,layer:e},function(a){var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayerWMS(b)})}})},WFSCapabilities:function(a,b,c){var d=FMCONFIG.BASEURL_MAPS+FMCONFIG.MAP_SERVICE_WMS_GET_CAPABILITIES;d+=d.indexOf("?")>0?"&":"?",d+="SERVICE=WFS",d+="&VERSION=1.0.0",d+="&request=GetCapabilities",d+="&urlWMS="+c;$.ajax({type:"GET",url:d,success:function(d){var e=$.parseXML(d);FM.WMSUtils._createWMSDropwDown(a,b,e,c)}})},_createWFSDropwDown:function(a,b,c,d){$(c).find("Layer").each(function(){var c=FM.Util.randomID();if($(this).children("Name").text()){$("#"+a).append("<div id='WMSLayer-"+c+"'>"+$(this).children("Title").text()+" + "+$(this).children("Style").children("Name").text()+" <div>");var e={};e.layers=$(this).children("Name").text(),e.layername=$(this).children("Name").text(),e.layertitle=$(this).children("Title").text(),e.style=$(this).children("Style").children("Name").text(),e.urlWMS=d,e.openlegend=!0,e.srs=b.map.options.crs.code,$("#WMSLayer-"+c).click({fenixmap:b,layer:e},function(a){var b=new FM.layer(a.data.layer);a.data.fenixmap.addLayerWMS(b)})}})}}),function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.exitFullscreen)a.supportsFullScreen=!0;else for(var c=0,d=b.length;d>c;c++)if(a.prefix=b[c],"undefined"!=typeof document[a.prefix+"CancelFullScreen"]){a.supportsFullScreen=!0;break}a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return""===this.prefix?a.requestFullscreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var b=jQuery(this);a.supportsFullScreen&&a.requestFullScreen(b)})}),window.fullScreenApi=a}(),FM.DEPENDENCIES={FENIX_REPOSITORY:"fenixapps.fao.org/repository",fenixmap:{js:["http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js","http://fenixapps.fao.org/repository/js/jquery/1.9.1/jquery.min.js","http://fenixapps.fao.org/repository/js/jquery/1.0.9/jquery.i18n.properties-min.js","http://code.jquery.com/ui/1.10.3/jquery-ui.js","http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/jquery.powertip.min.js","http://fenixapps.fao.org/repository/js/FENIX/utils/import-dependencies-1.0.js","http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.js","js/FENIXMap.js","js/core/Class.js","js/core/Util.js","js/core/hashmap.js","js/map/config/CONFIG.js","js/map/config/DEPENDENCIES.js","js/map/Map.js","js/map/controller/MapController.js","js/map/layer/Layer.js","js/map/layer/TileLayer.js","js/map/constants/TILELAYER.js","js/map/gui/gui-controller.js","js/map/gui/gui-map.js","js/core/fullscreen.js","js/core/UIUtils.js"],css:["http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css","http://fenixapps.fao.org/repository/js/jquery.power.tip/1.2.0/css/jquery.powertip.css","http://hqlprfenixapp2.hq.un.fao.org:13000/repository/js/jquery.pageslide/2.0/jquery.pageslide.min.css","css/fenix-map.css"]},geocoder:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geocoder/1.0/Control.OSMGeocoder.css"]},geosearch:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.control.geosearch.js","http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.provider.openstreetmap.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.geosearch/1.0/l.geosearch.css"]},mouseposition:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.mouseposition/1.0/L.Control.MousePosition.css"]},drawcontrol:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.draw/1.0/leaflet.draw.css"]},exportplugin:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.export/1.0/export.css"]},controlloading:{js:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.js"],css:["http://fenixapps.fao.org/repository/js/leaflet/plugins/leaflet.control.loading/1.0/Control.Loading.css"]}},FMDEFAULTLAYER={getLayer:function(a,b,c){switch(a.toUpperCase()){case"GAUL0":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","adm0_code","the_geom",b,"faost_n",c,"GAUL");case"GAUL0_FAOSTAT":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857","faost_code","the_geom",b,"faost_n",c,"FAOSTAT");case"GAUL0_ISO2":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso2_code","the_geom",b,"faost_n",c,"ISO2");case"GAUL0_ISO3":return FMDEFAULTLAYER._getGAUL("gaul0_faostat_3857_2","iso3_code","the_geom",b,"faost_n",c,"ISO3");case"GAUL0_BOUNDARIES":return FMDEFAULTLAYER._getWMSLayer("gaul0_line_3857");case"GAUL1":return FMDEFAULTLAYER._getGAUL("gaul1_3857","adm1_code","the_geom",b,"adm1_name",c,null);case"GAUL2":return FMDEFAULTLAYER._getGAUL("gaul2_3857","adm2_code","the_geom",b,"adm2_name",c,null)}},_getGAUL:function(a,b,c,d,e,f,g){var h={};return h.layers=a,h.styles="",h.joincolumn=b?b:null,h.joincolumnlabel=e?e:null,h.measurementunit=f?f:null,h.srs="EPSG:3857",h.geometrycolumn=c?c:"",d&&(FMDEFAULTLAYER.joinDefaultPopUp(h),h.joinboundary=g),h},_getWMSLayer:function(a,b,c,d){var e={};return e.layers=a,e.styles=c?c:"",e.srs=d?d:"EPSG:3857",e.urlWMS=b?b:FMCONFIG.DEFAULT_WMS_SERVER,e},joinDefaultPopUp:function(a){var b=a.measurementunit?" "+a.measurementunit:"",c=a.joincolumnlabel?"<div class='fm-popup-join-title'>{{"+a.joincolumnlabel+"}}</div>":"";a.customgfi={content:{en:"<div class='fm-popup'>"+c+"<div class='fm-popup-join-content'>{{{"+a.joincolumn+"}}} <i>"+b+"</i></div></div>",fr:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} <i>"+b+"</i></div>",es:"<div class='fm-popup'>"+c+"{{{"+a.joincolumn+"}}} <i>"+b+"</i></div>"},showpopup:!0,output:{show:!0,id:"gfiid"},callback:function(a,b){$("#"+b.outputid).empty(),$("#"+b.outputid).append(a)}}}},FM.TILELAYER={OSM:{URL:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",TITLE_EN:"OSM - OpenStreetMap",TITLE_FR:"OSM - OpenStreetMap"},OSM_GRAYSCALE:{URL:"http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png",TITLE_EN:"OSM - OpenStreetMap grayscale",TITLE_FR:"OSM - OpenStreetMap grayscale"},MAPQUEST:{URL:"http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",TITLE_EN:"MapQuest"},MAPQUEST_NASA_AERIAL:{URL:"http://tile21.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png",TITLE_EN:"MapQuest Aerial"},ESRI_WORLDSTREETMAP:{URL:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}.png",TITLE_EN:"ESRI - World Street Map",TITLE_FR:"ESRI - World Street Map"},ESRI_WORLDTERRAINBASE:{URL:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",TITLE_EN:"ESRI - World Terrain Base",TITLE_FR:"ESRI - World Terrain Base"},ACETATE_LABELS:{URL:"http://a{s}.acetate.geoiq.com/tiles/acetate-labels/{z}/{x}/{y}.png",TITLE_EN:"Acetate Labels"},ACETATE_TERRAIN:{URL:"http://a{s}.acetate.geoiq.com/tiles/terrain/{z}/{x}/{y}.png",TITLE_EN:"Acetate Terrain"},STAMEN_TONER_BACKGROUND:{URL:"http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.png",TITLE_EN:"Stamen"},ESRI_HISTORICAL_MERCATOR:{URL:"http://tiles2.arcgis.com/tiles/IEuSomXfi6iB7a25/arcgis/rest/services/World_Globe_1812/MapServer/{z}/{x}/{y}.png",TITLE_EN:"ESRI_HISTORICAL_MERCATOR"}},FM.WMSSERVERS={DEFAULT_EXTERNAL_WMS_SERVERS:[{label:"FENIX Crops Area",label_EN:"FENIX",url:"http://fenix.fao.org/demo/fenix/geoserver/earthstat/wms"},{label:"DATA.FAO.ORG",label_EN:"data.fao.org WMS Server",url:"http://data.fao.org/maps/wms"},{label:"UNREDD Congo",label_EN:"UNREDD Congo",url:"http://rdc-snsf.org/diss_geoserver/gwc/service/wms"},{label:"Wales OpenData",label_EN:"Wales OpenData",url:"http://inspire.wales.gov.uk/maps/ows"},{label:"Scotland OpenData",label_EN:"Scotland OpenData",url:"http://sedsh127.sedsh.gov.uk/arcgis/services/ScotGov/StatisticalUnits/MapServer/WMSServer"},{label:"Netherlands OpenData",label_EN:"Netherlands OpenData",url:"http://geodata.nationaalgeoregister.nl/ahn2/wcs"},{label:"German OpenData",label_EN:"German OpenData",url:"http://geo.sv.rostock.de/geodienste/verwaltung/wms"},{label:"ENVIRONMENT OpenData",label_EN:"Scotland OpenData",url:"http://lasigpublic.nerc-lancaster.ac.uk/ArcGIS/services/Biodiversity/GMFarmEvaluation/MapServer/WMSServer"},{label:"OpenGeo Demo Server",label_EN:"OpenGeo Demo Server",url:"http://demo.opengeo.org/geoserver/ows"},{label:"Alberts Map Service",url:"http://maps.gov.bc.ca/arcserver/services/Province/albers_cache/MapServer/WMSServer",urlParameters:"service=WMS"},{label:"Cubert Map Service",label_EN:"Cubert",url:"http://portal.cubewerx.com/cubewerx/cubeserv/cubeserv.cgi"},{label:"GP Map Service",label_EN:"gp map service201",url:"http://geoportal.logcluster.org:8081/gp_map_service201/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"},{label:"Vienna OpenData",label_EN:"Vienna OpenData",url:"http://data.wien.gv.at/daten/wms"}]},FM.Map=FM.Class.extend({id:"",suffix:"",mapContainerID:"",tilePaneID:"",map:"",controller:"",mapOptions:{center:[0,0],lat:0,lng:0,zoom:1},options:{guiController:{enablegfi:!0},gui:{fullscreen:!0,fullscreenID:""},usedefaultbaselayers:!0,lang:"EN",url:{}},initialize:function(a,b,c){this.options=$.extend(!0,{},this.options,b),this.mapOptions=$.extend(!0,{},this.mapOptions,c),FMCONFIG&&(this.options.url=$.extend(!0,{},FMCONFIG,b.url)),FM.initializeLangProperties(this.options.lang);var d=FM.Util.randomID(),e=d+"-container-map",f=d+"-map";$(a).append("<div class='fm-map-box fm-box' id='"+e+"'><div>"),$("#"+e).append("<div style='width:100%; height: 100%;' id='"+f+"'><div>"),this.id=f,this.mapContainerID=e,this.suffix=d,this.options.gui.fullscreenID=""!=this.options.gui.fullscreenID?this.options.gui.fullscreenID:this.mapContainerID,this.map=new L.Map(this.id,this.mapOptions),this.setTilePaneID(),$("#"+e).append("<div style='width:350px;' id='"+d+"-controller'><div>"),this.controller=new FM.mapController(d,this,this.map,this.options.guiController),this.controller.initializeGUI();var g=this;this.map._fenixMap=this,this.map.on("click",function(a){g.options.guiController.enablegfi&&g.getFeatureInfo(a)}),$("#"+e).append("<div id='"+d+"-popup'><div>"),$("#"+e).append("<div  class='fm-swipe' id='"+d+"-swipe'><div style='display:none' class='fm-swipe-handle'id='"+d+"-handle'>&nbsp</div></div>"),$("#"+e).append(FM.replaceAll(FM.guiController.popUpJoinPoint,"REPLACE",d))},createMap:function(a,b,c){a&&(this.mapOptions.lat=a),b&&(this.mapOptions.lng=b),c&&(this.mapOptions.zoom=c),this.map.setView(new L.LatLng(this.mapOptions.lat,this.mapOptions.lng),this.mapOptions.zoom),L.control.scale("bottomright").addTo(this.map),this.initializePlugins(),this.initializeMapGUI(),this.options.usedefaultbaselayers&&this._addDefaultBaseLayers(),$("#"+this.id+" .leaflet-control-zoom-in").html(""),$("#"+this.id+" .leaflet-control-zoom-out").html("")},_addDefaultBaseLayers:function(){this.addTileLayer(FM.TileLayer.createBaseLayer("OSM","EN"),!0),this.addTileLayer(FM.TileLayer.createBaseLayer("OSM_GRAYSCALE","EN"),!0),this.addTileLayer(FM.TileLayer.createBaseLayer("ESRI_WORLDSTREETMAP","EN"),!0),this.addTileLayer(FM.TileLayer.createBaseLayer("ESRI_WORLDTERRAINBASE","EN"),!0)},setTilePaneID:function(){this.tilePaneID=this.suffix+"-leaflet-tile-pane";var a=document.getElementById(this.id).childNodes,b=a[1].childNodes;$(b[0]).attr("id",this.tilePaneID)},addTileLayer:function(a,b){b?this.controller.addBaseLayer(a):(this.controller.layerAdded(a),this.map.addLayer(a.leafletLayer)),this.controller.setZIndex(a)},addLayer:function(a){if(a._fenixmap=this,a.layer.layertype)switch(a.layer.layertype){case"JOIN":"SHADED"==a.layer.jointype.toLocaleUpperCase()?this.addShadedLayer(a):"POINT"==a.layer.jointype.toLocaleUpperCase()&&this.addPointLayer(a);break;case"WMS":this.addLayerWMS(a);break;default:this.addLayerWMS(a)}else this.addLayerWMS(a)},removeLayer:function(a){this.controller.removeLayer(a)},addLayerWMS:function(a){this.controller.layerAdded(a),this.map.addLayer(a.createLayerWMS()),this.controller.setZIndex(a),this._openlegend(a,!1),this.controller.showHide(a.id,!1)},addShadedLayer:function(a){a.layerAdded||this.controller.layerAdded(a),this.createShadeLayerRequest(a,a.isadded)},createShadeLayerRequest:function(a,b){b||($("#"+a.id+"-controller-item-getlegend").css("display","inline-block"),$("#"+a.id+"-controller-item-opacity").css("display","block"));var c=this,d=this.options.url.MAP_SERVICE_SHADED;$.ajax({type:"POST",url:d,data:JSON.stringify(a.layer),contentType:"application/json; charset=utf-8",dataType:"json",success:function(d){c._createShadeLayer(a,d,b)}})},_createShadeLayer:function(a,b,c){"string"==typeof b&&(b=$.parseJSON(b)),a.layer.sldurl=b.url,a.layer.urlWMS=this.options.url.DEFAULT_WMS_SERVER,b.geoserverwms&&(a.layer.urlWMS=b.geoserverwms),a.layer.legendHTML=b.legendHTML,a.createLayerWMSSLD(),this._loadLayer(a,c)},createShadedLayerRequestCached:function(a,b){a.layer.sldurl?this._loadLayer(a,b):this.createShadeLayerRequest(a,b)},_loadLayer:function(a,b){var b=null!=b&&b?!0:!1;b?a.leafletLayer.redraw():(this.map.addLayer(a.leafletLayer),this.controller.setZIndex(a),a.isadded=!0),this._openlegend(a,b),this.controller.showHide(a.id,b)},reAddLayer:function(a){this.map.addLayer(a.leafletLayer),this.controller.setZIndex(a)},_openlegend:function(a,b){try{a.layer.openlegend&&FM.LayerLegend.getLegend(a,a.id+"-controller-item-getlegend",b)}catch(c){console.war("_openlegend error:"+c)}},addPointLayer:function(a){this.controller.layerAdded(a),this.createPointLayerRequest(a)},createPointLayerRequest:function(a){$("#"+a.id+"-controller-item-getlegend").css("display","none"),$("#"+a.id+"-controller-item-getlegend-holder").slideUp("slow"),$("#"+a.id+"-controller-item-opacity").css("display","none");var b=this,c=this.options.url.MAP_SERVICE_SHADED,d=new RequestHandler;d.open("POST",c),d.setContentType("application/x-www-form-urlencoded"),d.request.onload=function(){b._createPointLayer(a,this.responseText)},d.send(FM.Util.parseLayerRequest(a.layer)),d.request.onerror=function(){if(a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this.map.removeLayer(a.layer.pointsLayers[b])}},_createPointLayer:function(a,b){"string"==typeof b&&(b=$.parseJSON(b)),a.layer.sldurl=b.sldurl,a.layer.urlWMS=b.geoserverwms,a.layer.legendHTML=b.legendHTML,a.layer.pointsJSON=b.pointsJSON,this._refreshPointLayer(a)},_refreshPointLayer:function(a){if(a.layer.pointsLayers)for(var b=0;b<a.layer.pointsLayers.length;b++)this.map.removeLayer(a.layer.pointsLayers[b]);"string"==typeof a.layer.pointsJSON&&(a.layer.pointsJSON=$.parseJSON(a.layer.pointsJSON));var c=this;a.layer.pointsLayers=[];for(var b=0;b<a.layer.pointsJSON.length;b++){var d=new L.LatLng(a.layer.pointsJSON[b].lat,a.layer.pointsJSON[b].lon),e=a.layer.pointsJSON[b].properties;a.layer.pointsJSON[b].properties.measurementunit="",null!=a.layer.measurementuni&&(a.layer.pointsJSON[b].properties.measurementunit=a.layer.measurementunit),null!=a.layer.pointColor&&(e.color=a.layer.pointColor),null!=a.layer.pointFillColor&&(e.fillColor=a.layer.pointFillColor),null!=a.layer.pointFillOpacity&&(e.fillOpacity=a.layer.pointFillOpacity);var f=new L.CircleMarker(d,e).addTo(this.map);f.setRadius(a.layer.pointsJSON[b].radius),f.bindPopup(e.title+" - "+e.value),f.on("mouseover",function(){$("#"+c.suffix+"-popup-join-point-holder").show(),$("#"+c.suffix+"-popup-join-point-text").empty(),$("#"+c.suffix+"-popup-join-point-value").empty(),$("#"+c.suffix+"-popup-join-point-text").append(this.options.title),$("#"+c.suffix+"-popup-join-point-value").append(this.options.value+"  <i>"+a.layer.measurementunit+"</i>")}),f.on("mouseout",function(){$("#"+c.suffix+"-popup-join-point-holder").hide()}),a.layer.pointsLayers.push(f)}},addGeoJSON:function(){console.log("TODO")},syncOnMove:function(a){FM.MapUtils.syncMapsOnMove(this.map,a)},getFeatureInfo:function(a,b){var c=this,b=b?b:c.controller.selectedLayer;b&&(null!=b.layer.layertype&&"JOIN"==b.layer.layertype?FM.SpatialQuery.getFeatureInfoJoin(b,a.layerPoint,a.latlng,c):FM.SpatialQuery.getFeatureInfoStandard(b,a.layerPoint,a.latlng,c))},addClickEffect:function(a,b){var c='<div id="reveal-cards"><div class="cards-card"><div style="clear:both"></div></div>';L.marker([a.lat,a.lng],{icon:L.divIcon({html:c,iconSize:[40,40]})}).addTo(b)},invalidateSize:function(){this.map.invalidateSize()},initializeMapGUI:function(){if(null!=this.options.gui){var a=this;$.each(this.options.gui,function(b,c){var d="_add"+b.toLowerCase();try{FM.Plugins[d]&&FM.Plugins[d](a,c)}catch(e){throw new Error("Plugin: "+d+" doesn't exist")}})}},initializePlugins:function(){if(null!=this.options.plugins){var a=this;$.each(this.options.plugins,function(b,c){var d="_add"+b.toLowerCase();FM.Plugins[d](a,c)})}},cloneMap:function(a){var b=this.exportMap(),c=(JSON.stringify(b.layers,function(a,b){return"function"==typeof b?b+"":b}),new FM.Map(a,b.map.options,b.map.mapOptions));return c.createMap(),c.createMapFromJSON(b),c},createMapFromJSON:function(a){this.loadOverlays(a.layers.overlays)},exportMap:function(){var a={};return a.map=this._getMapOptions(),a.layers=this._getMapLayers(),a},exportMapToJSONFile:function(){var a=this.exportMap(),b=FM.Util.randomID(),c="data:application/octet-stream;filename=mapview-"+b+".fnx,"+encodeURIComponent(JSON.stringify(a)),d=window.open(c,"mapview-"+b+".fnx");d.focus()},_getMapOptions:function(){var a={options:{},mapOptions:{}};return a.options=$.extend(!0,{},this.options),a.mapOptions=$.extend(!0,{},this.mapOptions),this._getCurrentMapOptions(a.mapOptions),a},_getCurrentMapOptions:function(a){a.lat=this.map.getCenter().lat,a.lng=this.map.getCenter().lng,a.zoom=this.map.getZoom()},_getMapLayers:function(){var a={};return a.overlays=this.controller.exportOverlays(),a},loadOverlays:function(a){for(var b=0;b<a.length;b++){var c=new FM.layer(a[b]);this.addLayer(c)}},zoomTo:function(a,b,c){FM.LayerUtils.zoomToBoundary(this.map,a,b,c)},zoomTo:function(a,b){FM.LayerUtils.zoomToBoundary(this.map,a,b,"EPSG:3827")},zoomTo:function(a,b,c){FM.MapUtils.zoomTo(this,a,b,c)},zoomToCountry:function(a,b){FM.MapUtils.zoomToCountry(this,a,b)},getSLDfromCSS:function(a,b){FM.MapUtils.getSLDfromCSS(a,b,this.options.url.CSS_TO_SLD)}}),FM.map=function(a,b,c){return new FM.Map(a,b,c)},FM.LayerLegend={getLegend:function(a,b,c){$("#"+b+"-legend-layertitle").empty(),$("#"+b+"-legendtitle").empty(),$("#"+b+"-legendsubtitle").empty(),$("#"+b+"-content").empty(),a.layer.layertitle&&$("#"+b+"-legend-layertitle").append(a.layer.layertitle),a.layer.legendtitle&&$("#"+b+"-legendtitle").append(a.layer.legendtitle),a.layer.legendsubtitle&&$("#"+b+"-legendsubtitle").append(a.layer.legendsubtitle);var d="";if(a.layer.legendHTML)d=a.layer.legendHTML,$("#"+b+"-content").append(d);else{var e=a.layer.urlWMS+"?";e+="&service=WMS&version=1.1.0&REQUEST=GetLegendGraphic&layer="+a.layer.layers+"&Format=image/png",null!=a.layer.style&&""!=a.layer.style&&(e+="&style="+a.layer.style),a.layer.sldurl&&(e+="&sld="+a.layer.sldurl);var f=e;e+="&LEGEND_OPTIONS=forceLabels:on;forceRule:True;dx:0;dy:0;mx:0;my:0;border:false;fontAntiAliasing:true;fontColor:0x47576F;fontSize:10;bgColor:0xF9F7F3",FM.LayerLegend._loadLegend(e,f,b)}c?$("#"+b+"-holder").is(":visible")&&($("#"+b+"-holder").hide(),$("#"+b+"-holder").slideDown(),a.layer.openlegend=!0):$("#"+b+"-holder").is(":visible")?($("#"+b+"-holder").slideUp(),a.layer.openlegend=!1):($("#"+b+"-holder").slideDown(),a.layer.openlegend=!0),$("#"+b+"-remove").click({id:b+"-holder"},function(b){$("#"+b.data.id).slideUp(),a.layer.openlegend=!1})},_loadLegend:function(a,b,c){var d=new Image;d.name=a,d.src=a;var e='<img id="'+c+'-img" src="'+d.src+'" class="decoded">';d.onload=function(){$("#"+c+"-content").append(e),$("#"+c+"-img").css("width",this.width),$("#"+c+"-img").css("height",this.height)},d.onerror=function(){b?FM.LayerLegend._loadLegend(b,null,c):FM.LayerLegend._nolegend(c)}},_nolegend:function(a){var b='<div class="fm-legend-layertitle">'+$.i18n.prop("_nolegendavailable")+"</div>";$("#"+a+"-content").append(b)}},FM.MAPController=FM.Class.extend({id:"",suffix:"",_map:"",_fenixMap:"",_guiController:{overlay:!0,baselayer:!0},baseLayersMap:"",currentBaseLayer:"",layersMap:"",layersMapZIndexes:"",zIndexBaseLayer:10,zIndex:100,selectedLayer:"",$boxIcons:"",$menuBox:"",$menuBoxContainer:"",$selectedMenuBox:"",getFeautureInfoLayer:[],initialize:function(a,b,c,d){this._map=c,this._fenixMap=b,this.suffix=a,this.id=a+"-controller",this._guiController=$.extend({},this._guiController,d),this.baseLayersMap=new HashMap,this.layersMap=new HashMap,this.layersMapZIndexes=new HashMap},initializeGUI:function(){if(this._guiController&&($("#"+this.id).append(FM.replaceAll(FM.guiController.box,"REPLACE",this.suffix)),$("#"+this.id).append(FM.replaceAll(FM.guiController.boxIcons,"REPLACE",this.suffix)),this.$menuBox=$("#"+this.suffix+"-controller-box"),this.$menuBoxContainer=$("#"+this.suffix+"-controller-box-content"),this.$boxIcons=$("#"+this.suffix+"-controller-box-icons-container"),this.$boxIcons,this._guiController.overlay&&(this.loadIcon("overlay"),this.initializeOverlayDragging()),this._guiController.baselayer&&this.loadIcon("baselayer"),this._guiController.wmsLoader)){this.loadIcon("wmsLoader");var a=new FM.WMSUtils,b=this.suffix+"-controller-wmsLoader-dropdown",c=this.suffix+"-controller-wmsLoader-content",d=FM.WMSSERVERS.DEFAULT_EXTERNAL_WMS_SERVERS;a.WMSCapabilities(b,c,this._fenixMap,d)}},loadIcon:function(a){var b=FM.guiController,c=a+"Box",d=a+"Icon";this.$boxIcons.show(),this.$boxIcons.append(FM.replaceAll(b[d],"REPLACE",this.suffix)),this.$menuBoxContainer.append(FM.replaceAll(b[c],"REPLACE",this.suffix));
var e=$("#"+this.suffix+"-controller-"+a+"Icon");e.attr("title",$.i18n.prop("_"+a));try{e.powerTip({placement:"ne"})}catch(f){}var g=this,h=$("#"+g.suffix+"-controller-"+a+"-box");$("#"+this.suffix+"-controller-"+a+"Icon").click({$id:h,suffix:this.suffix},function(a){{var b=a.data.$id;a.data.suffix}g.$menuBox.is(":visible")?g.$selectedMenuBox==b?(g.$menuBox.slideUp("slow"),b.hide(),g.$selectedMenuBox=""):(g.$selectedMenuBox.hide(),b.slideDown("slow"),g.$selectedMenuBox=b):(g.$selectedMenuBox=b,g.$selectedMenuBox.show(),g.$menuBox.slideDown("slow",function(){}))}),$("#"+this.suffix+"-controller-"+a+"-remove").click({$id:h,suffix:this.suffix},function(a){var b=a.data.$id,c=a.data.suffix;$("#"+c+"-controller-box").slideUp("slow"),b.hide()})},initializeOverlayDragging:function(){var a=this;$("#"+this.suffix+"-controller-overlay-content").sortable({cursor:"move",opacity:"0.5",start:function(){},stop:function(b,c){for(var d=$(c.item).parent().children(),e=[],f=0,g=d.length-1;g>=0;g--){var h=$(d[g]).data("layer").id,i=($(d[g]).data("layer").layer.layertitle,f+100);e.push($(d[g]).data("layer").id),a.updateZIndex(h,i),f++}}})},layerAdded:function(a){if(a.layerAdded=!0,a.layer.zindex||(a.layer.zindex=this.zIndex,a.leafletLayer.setZIndex=a.layer.zindex),this.zIndex=this.zIndex+2,a.layer.hideLayerInControllerList);else{var b=FM.replaceAll(FM.guiController.legend,"REPLACE",a.id),c="#"+this.suffix+"-container-map";$(c).append(b);var d="#"+this.suffix+"-controller-overlay-content",e="#"+a.id+"-controller-item",f=a.id+"-controller-item",g=FM.replaceAll(FM.guiController.overlay,"REPLACE",a.id);$(d).prepend(g),$("#"+a.id+"-controller-item-box").data("layer",a);{$("#"+a.id+"-controller-item-box").index()+1}this._layerGUIOptions(a),this.layersMap.set(a.id,a),this.layersMapZIndexes.set(a.layer.zindex,a.id),$(e).attr("title",$.i18n.prop("_dragdroplayer"));try{$(e).powerTip({placement:"e"})}catch(h){}var i=this;$(e+"-title").append(a.layer.layertitle),$(e+"-title").attr("title",a.layer.layertitle);try{$(e+"-title").powerTip({placement:"se"})}catch(h){}var j=$(e+"-remove");j.click({l:a},function(a){a.stopPropagation(),confirm($.i18n.prop("_confirmremovelayer"))&&i.removeLayer(a.data.l),a.preventDefault()}),j.attr("title",$.i18n.prop("_removelayer"));try{removeLayer.powerTip({placement:"n"})}catch(h){}var k=$(e+"-enabledisable");k.click({id:a.id},function(a){i.showHide(a.data.id)}),k.attr("title",$.i18n.prop("_enabledisablelayer"));try{k.powerTip({placement:"se"})}catch(h){}var l=1;null!=a.layer.opacity&&(l=a.layer.opacity);try{var m=$(e+"-opacity");m.slider({orientation:"horizontal",range:"min",min:0,max:1,step:.1,value:l,slide:function(b,c){FM.LayerUtils.setLayerOpacity(a,c.value)}}),m.attr("title",$.i18n.prop("_layeropacity"));try{m.powerTip({placement:"se"})}catch(h){}}catch(h){}var n=$(e+"-getfeatureinfo");if(a.layer.enablegfi){n.click({id:a.id},function(a){var b=i.layersMap.get(a.data.id);i.selectedLayer.id==a.data.id?($("#"+i.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),i.selectedLayer="",b.layer.defaultgfi=!1):($("#"+i.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+a.data.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"),i.selectedLayer=b,b.layer.defaultgfi=!0)}),n.attr("title",$.i18n.prop("_getfeatureinfo"));try{n.powerTip({placement:"se"})}catch(h){}a.layer.defaultgfi&&(this.selectedLayer=a,$("#"+this.selectedLayer.id+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected"),$("#"+a.id+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"))}else $(e+"-getfeatureinfo").css("display","none");var o=$(e+"-getlegend");(null==a.layer.showlegend||0!=a.layer.showlegend)&&o.click({id:a.id,idToRender:f+"-getlegend"},function(a){var b=i.layersMap.get(a.data.id);FM.LayerLegend.getLegend(b,a.data.idToRender)}),o.attr("title",$.i18n.prop("_showhidelegend"));try{o.powerTip({placement:"se"})}catch(h){}if(o.css("display","inline-block"),a.layer.layertype&&"JOIN"==a.layer.layertype&&(null==a.layer.switchjointype||a.layer.switchjointype)){$(e+"-switchjointype").css("display","inline-block"),$(e+"-switchjointype").click({id:a.id},function(a){i.switchJoinType(a.data.id)}),"point"==a.layer.jointype.toLowerCase()?$(e+"-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")):"shaded"==a.layer.jointype.toLowerCase()&&$(e+"-switchjointype").attr("title",$.i18n.prop("_switchtopoint"));try{$(e+"-switchjointype").powerTip({placement:"se"})}catch(h){}}var p=$(e+"-swipe");p.click({id:a.id},function(a){var b=i.layersMap.get(a.data.id);null!=b.layer.swipeActive&&b.layer.swipeActive?(FM.LayerSwipe.swipeDeactivate(b,i._map),p.removeClass("fm-icon-swipe-selected")):(FM.LayerSwipe.swipeActivate(b,i._fenixMap.suffix+"-handle",i._fenixMap.suffix+"-map",i._map),p.addClass("fm-icon-swipe-selected"))});var q=$(e+"-zoomtolayer");a.layer.zoomToBBOX&&(q.css("display","inline-block"),q.attr("title",$.i18n.prop("_zoomtolayer")),q.click({id:a.id},function(a){var b=i.layersMap.get(a.data.id);FM.LayerUtils.zoomToLayer(i._map,b.layer)})),a.layer.zoomTo&&(q.css("display","inline-block"),q.attr("title",$.i18n.prop("_zoomtolayer")),q.click({id:a.id},function(a){var b=i.layersMap.get(a.data.id);FM.LayerUtils.zoomToLayer(i._map,b.layer)}));var r=$(e+"-showhide-subicons"),s=$(e+"-subicons");r.click(function(){s.slideToggle(),r.hasClass("fm-icon-up")?(r.removeClass("fm-icon-up"),r.addClass("fm-icon-down")):(r.removeClass("fm-icon-down"),r.addClass("fm-icon-up"))}),r.attr("title",$.i18n.prop("_layersubicons"));try{r.powerTip({placement:"n"})}catch(h){}}},_layerGUIOptions:function(a){a.gui;"JOIN"==a.layer.layertype&&null!=a.layer.gui&&null!=a.layer.gui.nojoinlayerswitch&&a.layer.gui.nojoinlayerswitch&&$("#"+a.id+"-controller-item-switchjointype").css("display","none")},addBaseLayer:function(a){a.layer.zindex=this.zIndexBaseLayer,this.zIndexBaseLayer=this.zIndexBaseLayer+2,this.baseLayersMap.set(a.id,a),this.layersMapZIndexes.set(a.layer.zindex,a.id);var b="#"+this.suffix+"-controller-baselayer-content",c="#"+a.id+"-controller-item",d=FM.replaceAll(FM.guiController.baselayer,"REPLACE",a.id);d=FM.replaceAll(d,"MAPID",this._fenixMap.id),$(b).append(d);var e=this;$(c+"-title").append(a.layer.layertitle),$("#"+a.id+"-controller-item-baselayer-image").addClass("fm-icon-baselayer-"+a.layer.layername),$(c+"-enabledisable").click({id:a.id},function(a){e.showHide(a.data.id)});var f=1;null!=a.layer.opacity&&(f=a.layer.opacity);try{$(c+"-opacity").slider({orientation:"horizontal",range:"min",min:0,max:1,step:.1,value:f,slide:function(b,c){FM.LayerUtils.setLayerOpacity(a,c.value)}})}catch(g){}$("#"+a.id+"-controller-box-item").click({id:a.id},function(a){var b=a.data.id,c=e.baseLayersMap.get(b);e.removeBaseLayerByID(e.currentBaseLayer.id);var d=e.baseLayersMap.get(e.currentBaseLayer.id);$("#"+d.id+"-controller-box-item").removeClass("fm-controller-box-item-baselayer-content-selected"),$("#"+d.id+"-controller-item-opacity").hide(),$("#"+c.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+c.id+"-controller-item-opacity").show(),e._map.addLayer(c.leafletLayer),e.currentBaseLayer=c,e.setZIndex(c)}),1==this.baseLayersMap.count()&&($(c+"-radio").attr("checked",!0),this._map.addLayer(a.leafletLayer),this.currentBaseLayer=a,$("#"+a.id+"-controller-box-item").addClass("fm-controller-box-item-baselayer-content-selected"),$("#"+a.id+"-controller-item-opacity").show(),e.setZIndex(a))},removeLayer:function(a){null!=a.layer.jointype&&"point"==a.layer.jointype?this.removeLayerPoint(a):this.removeLayerDefault(a)},removeLayerDefault:function(a){this._map.removeLayer(a.leafletLayer),this.layersMap.remove(a.id),this.layersMapZIndexes.remove(a.layer.zindex),$("#"+a.id+"-controller-item-box").remove(),$("#"+a.id+"-controller-item-getlegend-holder").remove()},removeLayerPoint:function(a){for(var b=0;b<a.layer.pointsLayers.length;b++)this._map.removeLayer(a.layer.pointsLayers[b]);this.layersMap.remove(a.id),this.layersMapZIndexes.remove(a.layer.zindex),$("#"+id+"-controller-item-box").remove()},removeBaseLayerByID:function(a){var b=this.baseLayersMap.get(a);this._map.removeLayer(b.leafletLayer)},switchJoinType:function(a){var b=this.layersMap.get(a);try{$.powerTip.destroy($("#"+b.id+"-controller-item-switchjointype"))}catch(c){}"point"==b.layer.jointype.toLowerCase()?($("#"+b.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtopoint")),this.switchToShaded(a)):"shaded"==b.layer.jointype.toLowerCase()&&($("#"+b.id+"-controller-item-switchjointype").attr("title",$.i18n.prop("_switchtoshaded")),this.switchToPoint(a));try{$("#"+b.id+"-controller-item-switchjointype").powerTip({placement:"se"})}catch(c){}},switchToPointswitchToPoint:function(a){var b=this.layersMap.get(a);b.layer.jointype="point",null!=b.leafletLayer&&this._map.removeLayer(b.leafletLayer),this._fenixMap.createPointLayerRequest(b)},switchToShaded:function(a){var b=this.layersMap.get(a);if(b.layer.jointype="shaded",null!=b.layer.pointsLayers)for(var c=0;c<b.layer.pointsLayers.length;c++)this._map.removeLayer(b.layer.pointsLayers[c]);this._fenixMap.createShadeLayerRequest(b)},showHide:function(a,b){try{var c=this.layersMap.get(a);c&&(c.layer.jointype&&"point"==c.layer.jointype.toLowerCase()?this.showHidePointLayer(a):this.showHideLayer(a,b))}catch(d){console.warn("showHide warn:"+d)}},showHidePointLayer:function(a){for(var b=this.layersMap.get(a),c=0;c<b.layer.pointsLayers.length;c++)if(null==b.layer.visibility||b.layer.visibility){b.layer.visibility=!1,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable");for(var c=0;c<b.layer.pointsLayers.length;c++)this._map.removeLayer(b.layer.pointsLayers[c])}else{b.layer.visibility=!0,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-enable");for(var c=0;c<b.layer.pointsLayers.length;c++)this._map.addLayer(b.layer.pointsLayers[c])}},showHideLayer:function(a,b){try{var c=this.layersMap.get(a);null==b||b?null!=b&&b||(null==c.layer.visibility||c.layer.visibility?(c.layer.visibility=!1,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(c.leafletLayer)):(c.layer.visibility=!0,$("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-disable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-enable"),this._map.addLayer(c.leafletLayer),this.setZIndex(c))):0==c.layer.visibility&&($("#"+a+"-controller-item-enabledisable").removeClass("fm-icon-enable"),$("#"+a+"-controller-item-enabledisable").addClass("fm-icon-disable"),this._map.removeLayer(c.leafletLayer))}catch(d){console.warn("showHideLayer error:"+d)}},updateZIndex:function(a,b){var c=this.layersMap.get(a);c.layer.zindex=b,c.leafletLayer.setZindex=b;try{document.getElementById(c.id).style.zIndex=b}catch(d){}},setZIndex:function(a){try{var b=document.getElementById(this._fenixMap.tilePaneID).childNodes;for(i=0,len=b.length;i<len;i++)if(b[i]!==this._container){var c=parseInt(b[i].style.zIndex,10);isNaN(c)&&(b[i].style.zIndex=a.layer.zindex,b[i].id=a.id)}}catch(d){console.warn("setZIndex error:"+d)}},selectGetFeatureInfoIcon:function(a){for(var b=0;b<this.layersMap.count();b++)this.layersMap._data[b]==a?$("#"+a+"-controller-item-getfeatureinfo").addClass("fm-icon-getfeatureinfo-selected"):$("#"+a+"-controller-item-getfeatureinfo").removeClass("fm-icon-getfeatureinfo-selected")},exportOverlays:function(){var a=[];this.layersMap.forEach(function(b){a.push(b.layer.zindex)}),a=a.sort();for(var b=[],c=0;c<a.length;c++){var d=!1;d||this.layersMap.forEach(function(e){e.layer.zindex==a[c]&&(b.push(e.layer),d=!0)})}var e=$.map(b,function(a){return $.extend(!0,{},a)});return e},exportBaselayers:function(){return null},updateZindexCounter:function(){}}),FM.mapController=function(a,b,c,d){return new FM.MAPController(a,b,c,d)},FM.guiController={boxIcons:'<div id="REPLACE-controller-box-icons-container" class="fm-icon-box-background fm-controller-box-icons-container"></div>',box:'<div class="fm-box-zindex fm-icon-box-background fm-controller-box-icons-container fm-controller-box" style="display:none" id="REPLACE-controller-box"><div id="REPLACE-controller-box-content"></div></div>',baselayerIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-baselayers' id='REPLACE-controller-baselayerIcon'><div></div>",baselayerBox:'<div class="fm-box-zindex" id="REPLACE-controller-baselayer-box" style="display:none"><div id="REPLACE-controller-baselayer-title" class="fm-controller-box-title">Baselayers</div><div id="REPLACE-controller-baselayer-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-baselayer-content" class="fm-controller-box-content"></div></div>',baselayer:'<div id="REPLACE-controller-box-item" class="fm-box-zindex fm-controller-box-item-baselayer-content"><div id="REPLACE-controller-item"><div class="fm-controller-box-item-baselayer-image" id="REPLACE-controller-item-baselayer-image"></div><div class="fm-controller-box-item-baselayer-text"><div><label class="fm-controller-box-item-baselayer-text fm-controller-item-title" id="REPLACE-controller-item-title"><input id="REPLACE-controller-item-radio"  class="fm-checkbox-hide" type="radio" name="MAPID" value="REPLACE"><label></div><div style="clear:both"></div><div class="fm-opacity-slider-baselayers" id="REPLACE-controller-item-opacity" style="display:none"></div></div></div></div>',overlayIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-overlays' id='REPLACE-controller-overlayIcon'></div></div>",overlayBox:'<div class="fm-box-zindex" id="REPLACE-controller-overlay-box" style="display:none;"><div id="REPLACE-controller-overlay-title" class="fm-controller-box-title">Selected Layers</div><div id="REPLACE-controller-overlay-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-overlay-content" class="fm-controller-box-content"></div></div>',overlay:'<div id="REPLACE-controller-item-box" class="fm-box-zindex fm-controller-box-item"><div id="REPLACE-controller-item" class="fm-controller-box-header"><div class="fm-controller-box-header-text"><div class="fm-controller-item-title" id="REPLACE-controller-item-title" ></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-down" id="REPLACE-controller-item-showhide-subicons"></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-remove" id="REPLACE-controller-item-remove"></div><div class="fm-icon-right fm-icon-layer-panel-sprite fm-icon-panel-info" id="REPLACE-controller-item-icon" ></div></div><div style="clear:both"></div><div class="fm-controller-box-icons"><div class="fm-icon-enable" id="REPLACE-controller-item-enabledisable"></div><div  class="fm-opacity-slider" style="margin-right:10px;" id="REPLACE-controller-item-opacity"></div></div><div style="clear:both"></div><div class="fm-controller-box-subicons" id="REPLACE-controller-item-subicons" style="display:none;"><div class="fm-icon-layer-subicons-sprite fm-icon-getlegend" id="REPLACE-controller-item-getlegend"></div><div class="fm-icon-layer-subicons-sprite fm-icon-getfeatureinfo" id="REPLACE-controller-item-getfeatureinfo"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-switchjointype" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-zoomto" id="REPLACE-controller-item-zoomtolayer" style="display:none"></div><div class="fm-icon-layer-subicons-sprite fm-icon-swipe" id="REPLACE-controller-item-swipe"></div><div class="fm-icon-layer-subicons-sprite fm-icon-switchJoinType" id="REPLACE-controller-item-joinsettings" style="display:none"></div></div></div></div></div></div>',wmsLoaderIcon:"<div class='fm-box-zindex'><div class='fm-icon-sprite fm-wmsloader' id='REPLACE-controller-wmsLoaderIcon'></div></div>",wmsLoaderBox:'<div class="fm-box-zindex" id="REPLACE-controller-wmsLoader-box" style="display:none; min-height:300px;"><div id="REPLACE-controller-wmsLoader-title" class="fm-controller-box-title">WMS Loader</div><div id="REPLACE-controller-wmsLoader-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div><div class="fm-standard-hr"></div><div class="clear:both"></div><div class="fm-WMSLoaderDropDown" id="REPLACE-controller-wmsLoader-dropdown"></div><div id="REPLACE-controller-wmsLoader-content" class="fm-controller-wmsLoader-content"></div></div>',wmsLoaderLayer:'<div id="REPLACE-WMSLayer-box" class="fm-WMSLayer-box"><div id="REPLACE-WMSLayer-icon" class="fm-controller-box-icon fm-icon-info"></div><div id="REPLACE-WMSLayer-title" class="fm-WMSLayer-title"></div></div>',legend:'<div class="fm-icon-box-background fm-box-legend" id="REPLACE-controller-item-getlegend-holder"><div class="fm-legend-title-content"><div id="REPLACE-controller-item-getlegend-legend-layertitle" class="fm-legend-layertitle"></div><div id="REPLACE-controller-item-getlegend-remove" class="fm-icon-close-panel-sprite fm-icon-close fm-icon-right"></div></div><div class="fm-standard-hr"></div><div id="REPLACE-controller-item-getlegend-legendtitle" class="fm-legendtitle"></div><div id="REPLACE-controller-item-getlegend-legendsubtitle" class="fm-legendsubtitle"></div><div id="REPLACE-controller-item-getlegend-content" ></div></div>',popUpJoinPoint:'<div class="fm-box fm-popup-join-point-holder" id="REPLACE-popup-join-point-holder" style="display:none"><div class="fm-popup-join-point-text" id="REPLACE-popup-join-point-text"></div><div class="fm-popup-join-point-value" id="REPLACE-popup-join-point-value"></div></div>'},FM.guiMap={disclaimerfao:'<div class="fm-icon-box-background fm-disclaimerfao fm-btn-icon"><div class="fm-icon-sprite fm-icon-info" id="REPLACE-disclaimerfao"></div></div>',disclaimerfao_E:'<div class="fm-disclaimerfao-text">The designations employed and the presentation of material in the maps  <br>do not imply the expression of any opinion whatsoever on the part of <br>FAO concerning the legal or constitutional status of any country,<br>territory or sea area, or concerning the delimitation of frontiers.<br>South Sudan declared its independence on July 9, 2011. <br>Due to data availability, the assessment presented in the map for Sudan<br>and South Sudan reflects thesituation up to 2011 for the former Sudan.</div> ',disclaimerfao_E:"The designations employed and the presentation of material in the maps  <br>do not imply the expression of any opinion whatsoever on the part of  <br>FAO concerning the legal or constitutional status of any country, <br>territory or sea area, or concerning the delimitation of frontiers.  <br>South Sudan declared its independence on July 9, 2011. <br>Due to data availability, the assessment presented in the map for Sudan  <br>and South Sudan reflects thesituation up to 2011 for the former Sudan.",disclaimerfao_S:"",disclaimerfao_S_styled:'<div class="fm-disclaimerfao-text"></div> ',disclaimerfao_F:"",disclaimerfao_F_styled:'<div class="fm-disclaimerfao-text"></div> '},FM.WCS=function(){var a={url:{}},b=a.url.MAP_SERVICE_PROXY?a.url.MAP_SERVICE_PROXY:"http://fenixapps2.fao.org/maps/rest/service/request",c="1.1.1",d={"1.1.1":"identifiers","2.0":"identifiers"},e=function(a,e){var g=b;g+="?service=wcs",g+=a.version?"&version="+a.version:"&version="+c,g+="&request=DescribeCoverage",g+="&"+d[c]+"="+a.layername,g+="&urlWMS="+a.url,$.ajax({type:"GET",url:g,success:function(a){f(a,e)},error:function(){console.log("WCS error getDescription() REQUEST")}})},f=function(a,b){var c="TODO: parse XML if there are useful information";b&&b(c)};return{getDescription:e,getVersion:function(){return c}}}(),FM.WFS=function(a){var a={url:{}},b=a.url.BASEURL_MAPS?a.url.MAP_SERVICE_PROXY:"http://fenixapps2.fao.org/maps/rest/service/request",c="1.1.0",d={"1.1.0":"typeName","2.0":"typeNames"},e=function(a,e){var g=b;g+="?SERVICE=WFS",g+=a.version?"&VERSION="+a.version:"&VERSION="+c,g+="&request=DescribeFeatureType",g+="&"+d[c]+"="+a.layername,g+="&urlWMS="+a.url,$.ajax({type:"GET",url:g,success:function(a){f(a,e)},error:function(){console.log("WFS error getDescription() REQUEST")}})},f=function(a,b){var c=$.parseXML(a),d=$(c),e=[];d.find("xsd\\:sequence xsd\\:element").each(function(){e.push({name:$(this).attr("name"),type:$(this).attr("type")})}),b&&b(e)},g=function(a,e){var f=b;f+="?SERVICE=WFS",f+=a.version?"&VERSION="+a.version:"&VERSION="+c,f+="&request=GetFeature",f+="&"+d[c]+"="+a.layername,f+=a.propertyname?"&propertyname="+a.propertyname:"",f+=a.sortby?"&sortby="+a.sortby:"",f+="&outputFormat=json",f+="&urlWMS="+a.url,$.ajax({type:"GET",url:f,success:function(a){e&&e(a)},error:function(){console.log("WFS error getDescription() REQUEST")}})};return{getFields:e,getFieldsValues:g,getVersion:function(){return c}}}(),FM.LayerSwipe={swipeActivate:function(a,b,c,d){function e(a){a=Math.max(0,Math.min(a,d.getSize().x)),g.style.left=a+"px";var b=d.containerPointToLayerPoint(a,0).x;f.style.clip="rect(-99999px "+b+"px 999999px -99999px)"}a.layer.swipeActive=!0;var f=a.leafletLayer._container,g=document.getElementById(b),h=!1;g.onmousedown=function(){return h=!0,!1},document.onmouseup=function(){h=!1},document.onmousemove=function(a){h&&e(a.x)};a.redraw=function(){f=a.leafletLayer._container,e(parseInt(g.style.left))},a.mousemoveSwipe=function(b){f=a.leafletLayer._container,e(b.containerPoint.x)},d.on("zoomend",a.redraw),d.on("moveend",a.redraw),d.on("drag",a.redraw),d.on("mousemove",a.mousemoveSwipe);var i=$("#"+c).width();e(i/2)},swipeDeactivate:function(a,b){b.off("zoomend",a.redraw),b.off("moveend",a.redraw),b.off("drag",a.redraw),b.off("mousemove",a.mousemoveSwipe),a.layer.swipeActive=!1;var c=a.leafletLayer._container;c.style.clip="auto"}},FM.LayerUtils={zoomToLayer:function(a,b){b.bbox?FM.LayerUtils.zoomTOBBOX(a,b.bbox):b.zoomTo&&FM.LayerUtils.zoomToBoundary(a,b.zoomTo.boundary,b.zoomTo.code,b.zoomTo.srs)},zoomToBoundary:function(a,b,c,d){FM.LayerUtils._zoomToRequest(a,b,c,d)},zoomTOBBOX:function(a,b){var c;if(b.ymin){var d=new L.LatLng(b.ymin,b.xmin),e=new L.LatLng(b.ymax,b.xmax);c=new L.LatLngBounds(d,e)}else if(b&&b.length>0){var d=new L.LatLng(b[0],b[1]),e=new L.LatLng(b[2],b[3]);c=new L.LatLngBounds(d,e)}c&&FM.LayerUtils.zoomToBounds(a,c)},zoomToBounds:function(a,b){a.fitBounds(b)},_zoomToRequest:function(a,b,c,d){var e=a.options.url.MAP_SERVICE_ZOOM_TO_BOUNDARY+"/"+b+"/"+c+"/"+d;$.ajax({type:"GET",url:e,data:FM.Util.parseLayerRequest(l.layer),success:function(b){"string"==typeof b&&(b=$.parseJSON(b));var c=new L.LatLng(b.ymin,b.xmin),d=new L.LatLng(b.ymax,b.xmax),e=new L.LatLngBounds(c,d);a.fitBounds(e)}})},setLayerOpacity:function(a,b){a.leafletLayer&&a.leafletLayer.setOpacity(b),a.layer.opacity=b,a.leafletLayer.options.opacity=b},filterLayerMinEqualThan:function(a,b,c){b=FM.LayerUtils.getValuesMinEqualThan(b,c),FM.LayerUtils._refreshLayer(a,b)},filterLayerGreaterEqualThan:function(a,b,c){b=FM.LayerUtils.getValuesGreaterEqualThan(b,c),FM.LayerUtils._refreshLayer(a,b)},filterLayerInBetweenEqualThan:function(a,b,c,d){b=FM.LayerUtils.getValuesInBetweenEqualThan(b,c,d),FM.LayerUtils._refreshLayer(a,b)},filterLayerOuterEqualThan:function(a,b,c,d){b=FM.LayerUtils.getValuesOuterEqualThan(b,c,d),FM.LayerUtils._refreshLayer(a,b)},_refreshLayer:function(a,b){switch(b.layer.jointype){case"point":a.createPointLayerRequest(b);break;case"shaded":a.createShadeLayerRequest(b,!0)}},getValuesMinEqualThan:function(a,b){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(c,d){b>=d&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a},getValuesGreaterEqualThan:function(a,b){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(c,d){d>=b&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a},getValuesInBetweenEqualThan:function(a,b,c){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(d,e){e>=b&&c>=e&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a},getValuesOuterEqualThan:function(a,b,c){for("string"==typeof a.layer.defaultdata&&(a.layer.defaultdata=$.parseJSON(a.layer.defaultdata)),a.layer.joindata=[],i=0;i<a.layer.defaultdata.length;i++)$.each(a.layer.defaultdata[i],function(d,e){(b&&b>=e||c&&e>=c)&&a.layer.joindata.push(a.layer.defaultdata[i])});return a.layer.joindata=JSON.stringify(a.layer.joindata),a}},FM.MapUtils=function(){var a=function(a,b){var c=a.map?a.map:a,d=b.map?b.map:b;c.on("dragend zoomend",function(){c.getCenter()!=d.getCenter&&c.getZoom()!=d.getZoom&&d.setView(c.getCenter(),c.getZoom())})},b=function(){},c=function(a,b,c,d){var e=a.options.url.ZOOM_TO_BBOX+b+"/"+c+"/"+d.toString();$.ajax({type:"GET",url:e,success:function(b){a.hasOwnProperty("map")?a.map.fitBounds(b):a.fitBounds(b)}})},d=function(a,b,d){c(a,"country",b,d)},e=function(a,b,c){var d="";return $.ajax({url:c,data:{stylename:a,style:b},async:!1,type:"POST",success:function(a){d=a}}),d},f=function(a,b){var c=L.latLngBounds([[-90,-180],[90,180]]),d=b instanceof L.LatLngBounds?b:c,e=190,f=190,g=d.getSouthWest().lng,h=d.getNorthEast().lng,i=h-g,j=d.getNorthEast().lat,k=d.getSouthWest().lat,l=j-k,m=a.getSize().x,n=a.getSize().y;0>i&&(i+=360),0>l&&(l+=360);var o=Math.round(Math.log(360*m/i/e)/Math.LN2),p=Math.round(Math.log(360*n/l/f)/Math.LN2),q=Math.max(o,p)-1;a.setZoom(q,{animate:!1})};return{syncMapsOnMove:a,exportLayers:b,zoomTo:c,zoomToCountry:d,getSLDfromCSS:e,fitWorldByScreen:f}}(),FM.Plugins={_addfullscreen:function(a,b){b&&($("#"+a.mapContainerID).append("<div class='fm-icon-box-background fm-btn-icon fm-fullscreen'><div class='fm-icon-sprite fm-icon-fullscreen' id='"+a.suffix+"-fullscreenBtn'><div></div>"),FM.UIUtils.fullscreen(a.suffix+"-fullscreenBtn",a.options.gui.fullscreenID))},_addlayercontroller:function(a,b){b?$("#"+this.suffix+"-controller").show():$("#"+this.suffix+"-controller").hide()},_addgeosearch:function(a,b){b&&L.GeoSearch&&new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.OpenStreetMap}).addTo(a.map)},_addgeocoder:function(a,b){if(b&&L.Control.OSMGeocoder){var c=new L.Control.OSMGeocoder;a.map.addControl(c)}},_addmouseposition:function(a,b){b&&L.control.mousePosition&&L.control.mousePosition().addTo(a.map)},_addexport:function(a,b){b&&L.Control.Export&&a.map.addControl(new L.Control.Export)},_addzoomcontrol:function(a){var b=new L.Control.Zoom;b.setPosition("bottomright"),a.map.addControl(b)},_addprintmodule:function(a,b){if(b&&L.print)var c=L.print.provider({method:"GET",url:"http://hqlprfenixapp1.hq.un.fao.org:10090/geoserver/pdf",autoLoad:!0,dpi:254});var d=L.control.print({provider:c});a.map.addControl(d)},_adddisclaimerfao:function(a,b){if(b){var c=FM.replaceAll(FM.guiMap.disclaimerfao,"REPLACE",a.suffix);$("#"+a.suffix+"-container-map").append(c);var d="";switch(a.options.lang.toUpperCase()){case"ES":d=FM.guiMap.disclaimerfao_S;break;case"FR":d=FM.guiMap.disclaimerfao_F;break;default:d=FM.guiMap.disclaimerfao_E}d=FM.replaceAll(d,"REPLACE",a.suffix),$("#"+a.suffix+"-disclaimerfao").attr("title",d);try{$("#"+a.suffix+"-disclaimerfao").powerTip({placement:"nw"})}catch(e){}}},_adddrawcontrol:function(a,b){if(b&&L.Control.Draw){var c=new L.FeatureGroup;a.map.addLayer(c);var d=new L.Control.Draw({draw:{position:"topleft",polygon:{title:"Draw a polygon!",allowIntersection:!1,drawError:{color:"#b00b00",timeout:1e3},shapeOptions:{color:"#bada55"}},circle:{shapeOptions:{color:"#662d91"}}},edit:{featureGroup:c}});a.map.addControl(d),a.map.on("draw:created",function(b){var d=b.layerType,e=b.layer;"marker"===d&&e.bindPopup("A popup!"),l=e,l.layerType=d,c.addLayer(e),a.spatialQuery(e)}),a.map.on("draw:edited",function(a){var b=a.layers,c=0;b.eachLayer(function(){c++})})}},_addcontrolloading:function(a,b){if(b&&L.Control.loading){var c=L.Control.loading({separate:!0,position:"topright"});a.map.addControl(c)}}},FM.SpatialQuery={getFeatureInfoJoin:function(a,b,c,d){null==a.layer.customgfi&&FMDEFAULTLAYER.joinDefaultPopUp(a.layer),FM.SpatialQuery.getFeatureInfoStandard(a,b,c,d)},getFeatureInfoStandard:function(a,b,c,d){var e=d.map,f=e.getBounds(),g=e.options.crs.project(f.getSouthWest()),h=e.options.crs.project(f.getNorthEast()),i=g.x+","+g.y+","+h.x+","+h.y,j=e.getSize().x,k=e.getSize().y,l=e.layerPointToContainerPoint(b).x,m=e.layerPointToContainerPoint(b).y;l=new Number(l),l=l.toFixed(0),m=new Number(m),m=m.toFixed(0);var n=d.options.url.MAP_SERVICE_GFI_STANDARD;n+="?SERVICE=WMS",n+="&VERSION=1.1.1",n+="&REQUEST=GetFeatureInfo",n+="&BBOX="+i,n+="&HEIGHT="+k,n+="&WIDTH="+j,n+="&X="+l,n+="&Y="+m,n+="&FORMAT=image/png",n+="&INFO_FORMAT=text/html",""!=a&&null!=a&&(n+="&LAYERS="+a.layer.layers,n+="&QUERY_LAYERS="+a.layer.layers,n+="&STYLES=",n+="&SRS=EPSG:3857",n+="&urlWMS="+a.layer.urlWMS,FM.SpatialQuery.getFeatureInfoJoinRequest(n,"GET",c,e,a))},getFeatureInfoJoinRequest:function(a,b,c,d,e){var f=null!=e.layer.lang?e.layer.lang:d.options.lang,g=d,h=e;$.ajax({type:"GET",url:a,success:function(a){if(null!=a){var b=$("#"+g._fenixMap.id).width()-15,d=$("#"+g._fenixMap.id).height()-15,e=new L.Popup({maxWidth:b,maxHeight:d}),i=a;if(h.layer.customgfi){var j=null!=h.layer.joindata?h.layer.joindata:h.layer.data,k=FM.SpatialQuery.customPopup(a,h.layer.customgfi,f,j);i=null!=k?k[0]:a}else{var k=FM.SpatialQuery.transposeHTMLTable(a,h.layer.layertitle);i=null!=k?k[0]:a}i=FM.SpatialQuery._checkGeoserverDefaultEmptyOutput(i),h.layer.customgfi?(h.layer.customgfi&&h.layer.customgfi.callback&&h.layer.customgfi.callback(i,h.layer),h.layer.customgfi&&h.layer.customgfi.output&&h.layer.customgfi.output.show&&($("#"+h.layer.customgfi.output.id).empty(),i&&$("#"+h.layer.customgfi.output.id).append(i)),h.layer.customgfi&&h.layer.customgfi.showpopup&&i&&(e.setLatLng(c).setContent(i),g.openPopup(e))):i&&(e.setLatLng(c).setContent(i),g.openPopup(e))}}})},customPopup:function(a,b,c,d){var e=this._parseHTML(b.content[c]);if(e.id.length>0||e.joinid.length>0){var f=$("<div></div>").append(a),g=f.find("table");if(g)return FM.SpatialQuery._customizePopUp(b.content[c],e,g,d)}},_checkGeoserverDefaultEmptyOutput:function(a){return a},_customizePopUp:function(a,b,c,d){for(var e=c.find("tr"),f=$(e[0]).find("th"),g=[],h=[],i=0;i<f.length;i++)for(var j=0;j<b.id.length;j++)if(b.id[j].toUpperCase()==f[i].innerHTML.toUpperCase()){h.push(i);break}if(d)for(var k=[],i=0;i<f.length;i++)for(var j=0;j<b.joinid.length;j++)if(b.joinid[j].toUpperCase()==f[i].innerHTML.toUpperCase()){k.push(i);break}for(var i=1;i<e.length;i++)g.push($(e[i]).find("td"));for(var l=[],j=0;j<g.length;j++){for(var m=a,i=0;i<h.length;i++){var n="{{"+f[h[i]].innerHTML+"}}",o=g[j][h[i]].innerHTML;m=FM.Util.replaceAll(m,n,o)}if(d)for(var i=0;i<k.length;i++){var n="{{{"+f[k[i]].innerHTML+"}}}",o=g[j][k[i]].innerHTML,p=FM.SpatialQuery._getJoinValueFromCode(o,d);m=FM.Util.replaceAll(m,n,p)}l.push(m)}return l},_getJoinValueFromCode:function(a,b){for(var c=parseInt(a)?parseInt(a):null,d="string"==typeof b?$.parseJSON(b):b,e=0;e<d.length;e++)if(d[e][a]||d[e][c])return d[e][a]?d[e][a]:d[e][c];return""},_parseHTML:function(a){var b={};b.id=[],b.joinid=[];for(var c=a.match(/\{\{.*?\}\}/g),d=0;d<c.length;d++)c[d]=FM.Util.replaceAll(c[d],"{{",""),c[d]=FM.Util.replaceAll(c[d],"}}",""),c[d].indexOf("{")>=0?(c[d]=FM.Util.replaceAll(c[d],"{",""),c[d]=FM.Util.replaceAll(c[d],"}",""),b.joinid.push(c[d])):b.id.push(c[d]);
return b},transposeHTMLTable:function(a,b){var c=$("<div></div>").append(a),d=c.find("table");if(d){var e=FM.SpatialQuery.transposeHTML(d,b);if(null!=e)return e}return null},transposeHTML:function(a,b){{var c=$('<div class="fm-transpose-popup"></div>');a.find("caption")}try{c.append(b);for(var d=a.find("tr"),e=$(d[0]).find("th"),f=[],g=1;g<d.length;g++)f.push($(d[g]).find("td"));for(var h=$("<table></table>"),i=$("<tbody></tbody>"),g=0;g<e.length;g++){for(var j="<tr>",k="<td>"+e[g].innerHTML+"</td>",l=0;l<f.length;l++)k+="<td>"+f[l][g].innerHTML+"</td>";j+=k,j+="</tr>",i.append(j)}return c.append(h.append(i))}catch(m){return null}},scatterLayerFilter:function(a,b,c,d,e,f,g,h,i,j){(!a.leafletLayer||j)&&(a.layer.joindata=[]);for(var k="",l=0;l<c.length;l++)if(c[l].data[0][0]>=d&&c[l].data[0][0]<=e&&c[l].data[0][1]>=f&&c[l].data[0][1]<=g){var m=c[l].geocode;""!=k&&(k+=","),m&&(k+="'"+m+"'");var n={},o=c[l].data[0][0]/c[l].data[0][1];n[c[l].geocode]=o,(!a.leafletLayer||j)&&a.layer.joindata.push(n)}(!a.leafletLayer||j)&&(a.layer.joindata=JSON.stringify(a.layer.joindata)),a.leafletLayer?(i&&FM.SpatialQuery.highlightFeaturesOfLayer(i,k),j&&b.createShadeLayerRequest(a,!0),h&&FM.SpatialQuery._sampleSpatialQueryBoundingBox(b.map,k,a.layer)):b.addShadedLayer(a)},scatterLayerFilterFaster:function(l,fenixMap,series,xmin,xmax,ymin,ymax,layerHighlight,reclassify,formula){console.log("----------scatterLayerFilterFaster"),console.log(formula),console.log(series),console.log(l),console.log(layerHighlight);var zoomToFeatures=l.layer.zoomToFeatures?l.layer.zoomToFeatures:!1;(!l.leafletLayer||reclassify)&&(l.layer.joindata=[]);for(var spCodes="",i=0;i<series.length;i++)for(var j=0;j<series[i].data.length;j++)if(series[i].data[j].x>=xmin&&series[i].data[j].x<=xmax&&series[i].data[j].y>=ymin&&series[i].data[j].y<=ymax){var code=series[i].data[j].code;""!=spCodes&&(spCodes+=","),code&&(spCodes+="'"+code+"'");var s={};if(0!=series[i].data[j].x&&0!=series[i].data[j].y){var value=formula?eval(formula):series[i].data[j].x/series[i].data[j].y;s[series[i].data[j].code]=value,(!l.leafletLayer||reclassify)&&l.layer.joindata.push(s)}}(!l.leafletLayer||reclassify)&&(l.layer.joindata=JSON.stringify(l.layer.joindata)),l.leafletLayer?(layerHighlight&&FM.SpatialQuery.highlightFeaturesOfLayer(layerHighlight,spCodes),reclassify&&fenixMap.createShadeLayerRequest(l,!0),zoomToFeatures&&FM.SpatialQuery._sampleSpatialQueryBoundingBox(fenixMap.map,spCodes,l.layer)):fenixMap.addShadedLayer(l)},highlightFeaturesOfLayer:function(a,b){console.log("highlightFeaturesOfLayer"),console.log(a),console.log(b);var b=FM.Util.replaceAll(b,"'","");a.layer.cql_filter=a.layer.joincolumn+" IN ("+b+")",a.layerAdded?a.redraw():a.addLayerWMS()},_sampleSpatialQueryBoundingBox:function(a,b,c){var d={};d.datasource="FENIX";c.geometrycolumn?c.geometrycolumn:"geom";d.select="ST_AsText(ST_Transform(ST_Envelope(ST_Collect("+c.geometrycolumn+")), 4326)) ",d.from=c.layername?c.layername:c.layers,d.where=c.joincolumn+" IN ("+b+") ",$.ajax({type:"POST",url:a.options.url.WDS_SERVICE_SPATIAL_QUERY,data:d,success:function(b){var c=new Wkt.Wkt;c.read(b);var d={xmin:c.components[0][0].x,xmax:c.components[0][2].x,ymax:c.components[0][1].y,ymin:c.components[0][0].y};FM.LayerUtils.zoomTOBBOX(a,d)},error:function(){}})},_sampleSpatialQueryCentroid:function(a,b){var c={};c.datasource="FENIX",c.select="ST_AsText(ST_Transform(ST_Centroid(ST_Collect(geom)), 4326)) ",c.from="gaul0_faostat_3857",c.where="faost_code IN ("+b+") ",$.ajax({type:"POST",url:a.config.url.WDS_SERVICE_SPATIAL_QUERY,data:c,success:function(b){var c=new Wkt.Wkt;c.read(b),a.panTo([c.components[0].y,c.components[0].x])},error:function(){}})},filterLayerMinEqualThan:function(a,b){FM.LayerUtils.filterLayerMinEqualThan(this,a,b)},filterLayerGreaterEqualThan:function(a,b){FM.LayerUtils.filterLayerGreaterEqualThan(this,a,b)},filterLayerInBetweenEqualThan:function(a,b,c){FM.LayerUtils.filterLayerInBetweenEqualThan(this,a,b,c)},filterLayerOuterEqualThan:function(a,b,c){FM.LayerUtils.filterLayerOuterEqualThan(this,a,b,c)}},FM.Layer=FM.Class.extend({_fenixmap:"",id:"",layer:{styles:"",srs:"EPSG:3857",visibility:!0,format:"image/png",transparent:"TRUE",opacity:1,name:"",tiitle:"","abstract":"",srs:"",LatLonBoundingBox:"",BoundingBox:"",Style:{name:"",title:"","abstract":"",legendurl:{format:"",onlineresource:""}},KeywordList:[],layertitle:"",enablegfi:!0,layertype:"WMS",openlegend:!1,switchjointype:!1,lang:"EN"},leafletLayer:"",initialize:function(a,b){this.layer=$.extend(!0,{},this.layer,a),b&&(this.options=b),this.id=FM.Util.randomID(),a.joindata&&(a.defaultdata=a.joindata)},createLayerWMS:function(){var a=this._getWMSParameters();return this.leafletLayer?this.leafletLayer.setParams(a):(a=this.options?$.extend(!0,{},this.options,a):a,this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,a)),this.leafletLayer},createLayerWMSSLD:function(){var a=this._getWMSParameters();return this.leafletLayer?this.leafletLayer.setParams(a):this.leafletLayer=new L.TileLayer.WMS(this.layer.urlWMS,a),this.leafletLayer},_getWMSParameters:function(){var a={};return a.id=this.id,a.layers=this.layer.name?this.layer.name:this.layer.layers,a.format=this.layer.format,a.transparent=this.layer.transparent.toUpperCase(),a.visibility=this.layer.visibility,a.opacity=this.layer.opacity,a.styles=this.layer.styles,this.layer.style&&(a.styles=this.layer.style),this.layer.sldurl&&(a.sld=this.layer.sldurl),this.layer.cql_filter&&(a.cql_filter=this.layer.cql_filter),this.layer.sld_body&&(a.sld_body=this.layer.sld_body),this.layer.layers=this.layer.layername?this.layer.layername:this.layer.layers,a},redraw:function(a){var b=this;if(b.layer.layertype)switch(b.layer.layertype){case"JOIN":"SHADED"==b.layer.jointype.toLocaleUpperCase()?a?a.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this):"POINT"==b.layer.jointype.toLocaleUpperCase()&&console.log("TODO: handle redraw point");break;case"WMS":this.createLayerWMS(),this.leafletLayer.redraw();break;default:this.createLayerWMS(),this.leafletLayer.redraw()}},removeLayer:function(a){a?a.removeLayer(this):this._fenixmap&&this._fenixmap.removeLayer(this)},addPointLayer:function(a){a?a.addPointLayer(this):this._fenixmap&&this._fenixmap.addPointLayer(this)},addLayerWMS:function(a){a?a.addLayerWMS(this):this._fenixmap&&this._fenixmap.addLayerWMS(this)},addLayer:function(a){a?a.addLayer(this):this._fenixmap&&this._fenixmap.addLayer(this)},addShadedLayer:function(a){a?a.addShadedLayer(this):this._fenixmap&&this._fenixmap.addShadedLayer(this)},createShadedLayerRequestCached:function(a){a?(a.controller.layerAdded(this),a.createShadedLayerRequestCached(this)):this._fenixmap&&(this._fenixmap.controller.layerAdded(this),this._fenixmap.createShadedLayerRequestCached(this))},createShadeLayerRequestCached:function(a,b){this._fenixmap&&(a=this._fenixmap);var c=this,d=new RequestHandler,e=a.options.url.MAP_SERVICE_SHADED;d.open("POST",e),d.setContentType("application/x-www-form-urlencoded"),d.onload(function(){var d=this.responseText;"string"==typeof d&&(d=$.parseJSON(d)),c.layer.sldurl=d.sldurl,c.layer.urlWMS=d.geoserverwms,c.layer.legendHTML=d.legendHTML,c.createLayerWMSSLD(),b&&(a.controller.layerAdded(c),a._loadLayer(c,!1))}),d.send(FM.Util.parseLayerRequest(c.layer))}}),FM.layer=function(a,b,c){return new FM.Layer(a,b,c)},FM.TileLayer=FM.Layer.extend({createTileLayer:function(){var a="TITLE_"+this.layer.lang.toUpperCase(),b=this.layer.layername?FM.TILELAYER[this.layer.layername]:FM.TILELAYER[this.layer.layers];this.layer.layertitle={},this.layer.layertitle=b[a],this.layer.layertype="TILE";var c=new L.TileLayer(b.URL);return c}}),FM.TileLayer.createBaseLayer=function(a,b){var c={};c.layername=a,c.layers=a,c.layertype="TILE",c.lang=b;var d=new FM.TileLayer(c);return d.leafletLayer=d.createTileLayer(c.layername),d};